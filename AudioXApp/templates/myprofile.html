{% extends 'Homepage.html' %}
{% load static %}

{% block content %}
{# Add SweetAlert2 CDN if not already in Homepage.html #}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{# Use a standard Font Awesome CDN link #}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
{# Tailwind CSS Script - Ensure this is loaded, usually in base template #}
<script src="https://cdn.tailwindcss.com"></script>
{# Google Font (Inter) #}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f8fafc; /* slate-50 */
    }

    /* Custom theme color */
    .bg-theme-blue { background-color: #091e65; }
    .text-theme-blue { color: #091e65; }
    .border-theme-blue { border-color: #091e65; }
    .hover\:bg-theme-blue-dark:hover { background-color: #071852; } /* Darker shade for hover */
    .focus\:ring-theme-blue-light:focus { --tw-ring-color: #bfdbfe; } /* blue-200 for focus ring */

    /* Sidebar active link style */
    .sidebar-link[aria-current="page"] {
        background-color: #eef2ff; /* indigo-50 */
        color: #091e65; /* Theme blue */
        font-weight: 600; /* semibold */
    }
    .sidebar-link[aria-current="page"] i { color: #091e65; }

    /* Input field styling */
    .form-input:not(:read-only) {
        background-color: #fff !important;
        color: #1e293b !important; /* slate-800 */
        border-color: #cbd5e1; /* slate-300 */
    }
    .form-input:read-only {
        background-color: #f1f5f9 !important; /* slate-100 */
        color: #475569 !important; /* slate-600 - Slightly darker for better contrast */
        border-color: #e2e8f0 !important; /* slate-200 */
        cursor: default;
    }
    .form-input:read-only:focus {
        outline: none;
        box-shadow: none;
        border-color: #e2e8f0; /* slate-200 */
    }
    /* General input focus */
    .form-input:focus {
        border-color: #091e65; /* Theme blue */
        box-shadow: 0 0 0 2px #dbeafe; /* blue-100 focus ring */
        outline: none;
    }


    /* Modal Animation */
    #confirm-save-modal.flex { opacity: 1; }
    #confirm-save-modal.flex #confirm-modal-content { transform: scale(1); opacity: 1; }

    /* Hide scrollbar for sidebar nav */
    .sidebar-nav::-webkit-scrollbar { display: none; }
    .sidebar-nav { -ms-overflow-style: none; scrollbar-width: none; }

    /* --- PREMIUM Toggle Switch Styles --- */
    .toggle-checkbox:checked {
        /* Changes for the circle when checked */
        transform: translateX(100%);
        background-color: #ffffff; /* White circle */
        border-color: #091e65; /* Theme blue border */
    }
    .toggle-checkbox:checked + .toggle-path {
        /* Background path when checked */
        background-color: #091e65; /* Theme blue */
    }
    .toggle-checkbox {
        /* Base styles for the moving circle */
        appearance: none;
        position: absolute;
        top: 2px; /* Adjust vertical alignment */
        left: 2px; /* Adjust horizontal alignment */
        width: 1.25rem; /* 20px */
        height: 1.25rem; /* 20px */
        border-width: 1px;
        border-color: #cbd5e1; /* slate-300 */
        border-radius: 9999px;
        background-color: white;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .toggle-path {
        /* Base styles for the background path */
        display: block;
        width: 2.75rem; /* 44px */
        height: 1.5rem; /* 24px */
        border-radius: 9999px;
        background-color: #cbd5e1; /* slate-300 */
        transition: background-color 0.2s ease-in-out;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
    }
    .toggle-container:focus-within .toggle-path {
         /* Add focus ring to the path for accessibility */
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05), 0 0 0 2px #bfdbfe; /* blue-200 */
    }
    /* --- End Toggle Switch Styles --- */

    /* --- PREMIUM Password Input Styles --- */
    .password-input-wrapper .form-input {
        padding-left: 2.75rem; /* Make space for icon */
        padding-right: 1rem;
        border-width: 1px; /* Ensure border width is explicit */
        border-radius: 0.5rem; /* Slightly larger radius */
    }
    .password-input-wrapper .input-icon {
        position: absolute;
        left: 0.875rem; /* 14px */
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8; /* slate-400 */
        pointer-events: none;
        font-size: 0.875rem; /* 14px */
    }

</style>

<div class="min-h-screen flex flex-col">

    {# Sticky Secondary Navbar (Profile Page Specific) - z-40 #}
    <nav class="bg-white text-slate-800 py-3 shadow-sm sticky top-0 z-40 border-b border-slate-200 flex-shrink-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <span class="text-lg md:text-xl font-semibold tracking-tight text-theme-blue transition">
                My Account
            </span>
            <div class="space-x-4 md:space-x-6 flex items-center">
                <a href="{% url 'AudioXApp:home' %}" class="text-sm font-medium text-slate-600 hover:text-theme-blue transition">Home</a>
                <a href="{% url 'AudioXApp:logout' %}" class="bg-theme-blue hover\:bg-theme-blue-dark text-white px-4 py-1.5 rounded-full transition text-xs font-semibold shadow-sm hover:shadow-md">Logout</a>
            </div>
        </div>
    </nav>

    {# Main Content Area with Sidebar #}
    <div class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12 pt-6 md:pt-10">
        <div class="flex flex-col md:flex-row md:space-x-8 lg:space-x-12">

            {# --- Sidebar Navigation (Left Column) --- #}
            <aside class="w-full md:w-64 lg:w-72 flex-shrink-0 mb-8 md:mb-0">
                <div class="sticky top-24">
                    {# Sidebar Profile Info #}
                    <div class="flex items-center space-x-4 p-4 rounded-lg bg-white border border-slate-200 shadow-sm mb-6">
                         <div class="relative flex-shrink-0">
                             <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-slate-300">
                                 {% if user.profile_pic %}
                                 <img src="{{ user.profile_pic.url }}" alt="Profile" class="w-full h-full object-cover" id="profile-img-sidebar">
                                 {% else %}
                                 <div class="w-full h-full bg-slate-200 flex items-center justify-center text-slate-400" id="profile-img-placeholder-sidebar"> <i class="fas fa-user fa-lg"></i> </div>
                                 <img src="" alt="" class="w-full h-full object-cover hidden" id="profile-img-sidebar">
                                 {% endif %}
                             </div>
                         </div>
                         <div class="flex-grow min-w-0">
                             <p class="text-sm font-semibold text-slate-800 truncate" title="{{ user.username }}">{{ user.username }}</p>
                             <p class="text-xs text-slate-500 truncate" title="{{ user.email }}">{{ user.email }}</p>
                         </div>
                    </div>

                    {# Sidebar Navigation Links #}
                    <nav class="space-y-1 sidebar-nav overflow-y-auto" aria-label="Sidebar">
                        <button id="profile-info-link" class="sidebar-link group w-full flex items-center px-4 py-2.5 text-sm font-medium rounded-md text-slate-600 hover:bg-slate-100 hover:text-slate-900 transition" aria-current="page">
                            <i class="fas fa-user-edit mr-3 text-slate-400 group-hover:text-slate-500 transition-colors" style="width: 1.25rem;"></i> Profile Settings
                        </button>
                        <button id="security-link" class="sidebar-link group w-full flex items-center px-4 py-2.5 text-sm font-medium rounded-md text-slate-600 hover:bg-slate-100 hover:text-slate-900 transition">
                            <i class="fas fa-shield-alt mr-3 text-slate-400 group-hover:text-slate-500 transition-colors" style="width: 1.25rem;"></i> Security
                        </button>
                    </nav>
                </div>
            </aside>

            {# --- Main Content Area (Right Column) --- #}
            <main class="flex-grow min-w-0">
                {# Message Area #}
                <div id="profile-update-message" class="mb-6"></div>
                <input type="hidden" id="update-profile-url" data-url="{% url 'AudioXApp:update_profile' %}">
                <input type="hidden" id="update-2fa-url" data-url="{% url 'AudioXApp:update_profile' %}"> {# Adjust URL if needed #}

                {# --- Profile Settings Section --- #}
                <section id="profile-info-content" class="profile-section bg-white p-6 md:p-8 rounded-xl shadow-lg border border-slate-200/80 mb-8">
                    <h2 class="text-xl font-semibold text-slate-800 mb-6 border-b border-slate-200 pb-4">Profile Information</h2>
                    <div class="space-y-6">
                        {# Profile Picture Upload Area #}
                        <div>
                             <label class="block text-xs font-bold text-slate-600 mb-2 uppercase tracking-wider">Profile Picture</label>
                             <div class="flex flex-col sm:flex-row items-start sm:items-center sm:space-x-5 space-y-4 sm:space-y-0">
                                 <div class="relative flex-shrink-0">
                                     <div class="w-20 h-20 rounded-full overflow-hidden border-2 border-slate-300 bg-slate-100">
                                         {% if user.profile_pic %}
                                         <img src="{{ user.profile_pic.url }}" alt="Profile Picture" class="w-full h-full object-cover" id="profile-img-main">
                                         {% else %}
                                         <div class="w-full h-full flex items-center justify-center text-slate-400" id="profile-img-placeholder-main"> <i class="fas fa-user fa-2x"></i> </div>
                                         <img src="" alt="" class="w-full h-full object-cover hidden" id="profile-img-main">
                                         {% endif %}
                                     </div>
                                 </div>
                                 <div class="flex items-center space-x-3 flex-wrap gap-2">
                                     <label for="photo" class="cursor-pointer bg-white hover:bg-slate-50 border border-slate-300 text-slate-700 font-medium py-1.5 px-4 rounded-md transition duration-150 text-xs shadow-sm"> Change </label>
                                     <input type="file" id="photo" name="profile_pic" accept="image/png, image/jpeg, image/gif" class="hidden">
                                     <button type="button" id="save-profile-pic" class="hidden bg-green-100 hover:bg-green-200 text-green-700 font-medium py-1.5 px-3 rounded-md transition duration-150 text-xs shadow-sm"> <i class="fas fa-check mr-1"></i> Save </button>
                                     <button type="button" id="remove-profile-pic" class="{% if not user.profile_pic %}hidden{% endif %} bg-red-100 hover:bg-red-200 text-red-700 font-medium py-1.5 px-3 rounded-md transition duration-150 text-xs shadow-sm" title="Remove Photo"> <i class="fas fa-times"></i> Remove </button>
                                 </div>
                             </div>
                             <p class="text-xs text-slate-500 mt-2">PNG, JPG or GIF. Max size of 5MB.</p>
                        </div>

                        {# Form Fields #}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5 pt-4 border-t border-slate-200">
                            {# Username Field #}
                            <div>
                                <label for="username" class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Username</label>
                                <div class="relative mt-1">
                                    <span class="absolute left-3 inset-y-0 flex items-center text-slate-400 text-sm pointer-events-none"><i class="fas fa-at"></i></span>
                                    <input type="text" id="username" name="username" value="{{ user.username }}" class="form-input" readonly>
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-2">
                                         <button type="button" class="edit-icon form-icon-button p-1 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition duration-150 focus:outline-none text-xs" data-target="username" title="Edit Username"> <i class="fas fa-pencil-alt"></i> </button>
                                         <button type="button" class="save-icon hidden form-icon-button p-1 rounded-full text-green-600 hover:text-green-700 hover:bg-green-100 transition duration-150 focus:outline-none text-xs" data-target="username" title="Save Username"> <i class="fas fa-check-circle text-base"></i> </button>
                                    </div>
                                </div>
                            </div>
                            {# Full Name Field #}
                            <div>
                                <label for="name" class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Full Name</label>
                                <div class="relative mt-1">
                                     <span class="absolute left-3 inset-y-0 flex items-center text-slate-400 text-sm pointer-events-none"><i class="fas fa-user"></i></span>
                                    <input type="text" id="name" name="full_name" value="{{ user.full_name|default:'' }}" class="form-input" readonly placeholder="Not set">
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-2">
                                         <button type="button" class="edit-icon form-icon-button p-1 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition duration-150 focus:outline-none text-xs" data-target="name" title="Edit Name"> <i class="fas fa-pencil-alt"></i> </button>
                                         <button type="button" class="save-icon hidden form-icon-button p-1 rounded-full text-green-600 hover:text-green-700 hover:bg-green-100 transition duration-150 focus:outline-none text-xs" data-target="name" title="Save Name"> <i class="fas fa-check-circle text-base"></i> </button>
                                    </div>
                                </div>
                            </div>
                            {# Email Field #}
                            <div class="md:col-span-2">
                                <label for="email" class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Email Address</label>
                                <div class="relative mt-1">
                                     <span class="absolute left-3 inset-y-0 flex items-center text-slate-400 text-sm pointer-events-none"><i class="fas fa-envelope"></i></span>
                                    <input type="email" id="email" name="email" value="{{ user.email }}" class="form-input" readonly>
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-2">
                                         <button type="button" class="edit-icon form-icon-button p-1 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition duration-150 focus:outline-none text-xs" data-target="email" title="Edit Email"> <i class="fas fa-pencil-alt"></i> </button>
                                         <button type="button" class="save-icon hidden form-icon-button p-1 rounded-full text-green-600 hover:text-green-700 hover:bg-green-100 transition duration-150 focus:outline-none text-xs" data-target="email" title="Save Email"> <i class="fas fa-check-circle text-base"></i> </button>
                                    </div>
                                </div>
                            </div>
                             {# Bio Field #}
                            <div class="md:col-span-2">
                                <label for="bio" class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Bio</label>
                                <div class="relative mt-1">
                                    <textarea id="bio" name="bio" rows="4" class="form-input" readonly placeholder="Tell us a little about yourself...">{{ user.bio|default:'' }}</textarea>
                                    <div class="absolute top-2 right-0 flex items-center pr-2">
                                         <button type="button" class="edit-icon form-icon-button p-1 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition duration-150 focus:outline-none text-xs" data-target="bio" title="Edit Bio"> <i class="fas fa-pencil-alt"></i> </button>
                                         <button type="button" class="save-icon hidden form-icon-button p-1 rounded-full text-green-600 hover:text-green-700 hover:bg-green-100 transition duration-150 focus:outline-none text-xs" data-target="bio" title="Save Bio"> <i class="fas fa-check-circle text-base"></i> </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                {# --- PREMIUM Security Section --- #}
                <section id="security-content" class="profile-section hidden bg-white p-6 md:p-8 rounded-xl shadow-lg border border-slate-200/80">
                    {# Change Password Sub-section #}
                    <div class="mb-10">
                        <div class="flex items-center mb-6">
                             <div class="bg-theme-blue text-white p-2.5 rounded-lg mr-4 shadow-md"> {# Enhanced Icon BG #}
                                 <i class="fas fa-key fa-fw text-lg"></i>
                             </div>
                             <h2 class="text-xl font-semibold text-slate-800">Change Password</h2>
                        </div>
                        <form method="post" id="change-password-form" action="{% url 'AudioXApp:change_password' %}" class="space-y-6 max-w-lg ml-4 md:ml-14"> {# Increased indent #}
                            {% csrf_token %}
                            {# Current Password #}
                            <div class="relative password-input-wrapper">
                                <label for="old_password" class="block text-sm font-medium text-slate-700 mb-1">Current Password</label> {# Adjusted label style #}
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="old_password" name="old_password" required
                                       class="form-input block w-full py-2.5 border rounded-lg text-slate-900 placeholder-slate-400 text-sm shadow-sm" placeholder="Enter current password">
                                <div id="error-old_password" class="form-error text-red-600 text-xs mt-1 h-4"></div>
                            </div>
                            {# New Password #}
                             <div class="relative password-input-wrapper">
                                <label for="new_password1" class="block text-sm font-medium text-slate-700 mb-1">New Password</label>
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="new_password1" name="new_password1" required
                                       class="form-input block w-full py-2.5 border rounded-lg text-slate-900 placeholder-slate-400 text-sm shadow-sm" placeholder="Choose a strong password"> {# Changed placeholder #}
                                <div id="error-new_password1" class="form-error text-red-600 text-xs mt-1 h-4"></div>
                            </div>
                            {# Confirm New Password #}
                             <div class="relative password-input-wrapper">
                                <label for="new_password2" class="block text-sm font-medium text-slate-700 mb-1">Confirm New Password</label>
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="new_password2" name="new_password2" required
                                       class="form-input block w-full py-2.5 border rounded-lg text-slate-900 placeholder-slate-400 text-sm shadow-sm" placeholder="Re-enter new password"> {# Changed placeholder #}
                                <div id="error-new_password2" class="form-error text-red-600 text-xs mt-1 h-4"></div>
                            </div>
                            {# Submit Button #}
                            <div class="pt-4"> {# Increased top padding #}
                                <button type="submit" class="w-full sm:w-auto bg-theme-blue hover\:bg-theme-blue-dark text-white font-semibold py-3 px-10 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus\:ring-theme-blue-light shadow-md hover:shadow-lg text-sm transform hover:-translate-y-0.5">
                                    Update Password
                                </button>
                            </div>
                            <div id="password-change-message" class="mt-4 text-sm"></div>
                        </form>
                    </div>

                    {# Styled Divider #}
                    <div class="relative my-10">
                        <div class="absolute inset-0 flex items-center" aria-hidden="true">
                            <div class="w-full border-t border-slate-200"></div>
                        </div>
                        <div class="relative flex justify-center">
                            <span class="bg-white px-3 text-slate-400">
                                <i class="fas fa-shield-alt"></i>
                            </span>
                        </div>
                    </div>


                    {# Two-Factor Authentication Sub-section #}
                    <div> {# Removed inner card #}
                        <div class="flex items-center mb-4">
                             <div class="bg-theme-blue text-white p-2.5 rounded-lg mr-4 shadow-md"> {# Consistent icon style #}
                                 <i class="fas fa-mobile-alt fa-fw text-lg"></i> {# Changed icon #}
                             </div>
                             <h3 class="text-xl font-semibold text-slate-800">Two-Factor Authentication</h3>
                        </div>
                        <div class="ml-4 md:ml-14"> {# Indent content #}
                            <p class="text-sm text-slate-600 mb-6 max-w-xl">
                                Add an extra layer of security. When enabled, we'll send a verification code to your email (<strong class="font-medium">{{ user.email }}</strong>) each time you sign in.
                            </p>
                            <div class="flex items-center space-x-4">
                                {# Premium Toggle Switch #}
                                <div class="relative inline-block w-11 h-6 toggle-container"> {# Adjusted size slightly #}
                                    <input type="checkbox" name="toggle_2fa" id="toggle_2fa"
                                           class="toggle-checkbox"
                                           {% if user.is_2fa_enabled %}checked{% endif %}
                                           aria-labelledby="2fa-label" {# Link to label for accessibility #}
                                    />
                                    <label for="toggle_2fa" class="toggle-path"></label>
                                </div>
                                {# Status Indicator & Label #}
                                <span id="2fa-label" class="text-sm font-medium text-slate-700">
                                    Status:
                                    <span id="2fa-status" class="font-semibold ml-1">
                                        {% if user.is_2fa_enabled %}
                                            <span class="text-green-700">Enabled</span>
                                        {% else %}
                                            <span class="text-slate-500">Disabled</span>
                                        {% endif %}
                                    </span>
                                </span>
                                {# Loading Spinner #}
                                <div id="2fa-spinner" class="hidden ml-2">
                                    <i class="fas fa-spinner fa-spin text-slate-500"></i>
                                </div>
                            </div>
                             <div id="2fa-update-message" class="mt-3 text-sm"></div>
                         </div>
                    </div>

                </section>
            </main>

        </div>
    </div>

    {# Confirmation Modal - z-[110] #}
    <div id="confirm-save-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[110] p-4 transition-opacity duration-300 ease-out opacity-0">
        <div class="bg-white rounded-xl p-6 md:p-8 shadow-2xl border border-slate-300 w-full max-w-md transform transition-all duration-300 ease-out scale-95 opacity-0" id="confirm-modal-content">
            <h2 class="text-xl font-semibold text-slate-800 mb-3">Confirm Change</h2>
            <p class="text-sm text-slate-600 mb-6" id="confirm-save-message"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-save-cancel" class="px-4 py-1.5 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-100 transition duration-150 font-medium text-sm">Cancel</button>
                <button id="confirm-save-confirm" class="px-4 py-1.5 rounded-md bg-blue-600 text-white hover:bg-blue-700 transition duration-150 font-medium text-sm shadow-sm hover:shadow">Confirm</button>
            </div>
        </div>
    </div>

</div>

{# JavaScript (No changes needed to JS logic for this redesign) #}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- DOM Element References ---
        // Profile Info & General
        const profilePictureImgSidebar = document.getElementById('profile-img-sidebar');
        const profilePicturePlaceholderSidebar = document.getElementById('profile-img-placeholder-sidebar');
        const profilePictureImgMain = document.getElementById('profile-img-main');
        const profilePicturePlaceholderMain = document.getElementById('profile-img-placeholder-main');
        const photoInput = document.getElementById('photo');
        const saveProfilePicButton = document.getElementById('save-profile-pic');
        const removeProfilePicButton = document.getElementById('remove-profile-pic');
        const updateMessageDiv = document.getElementById('profile-update-message');
        const updateProfileURL = document.getElementById('update-profile-url')?.getAttribute('data-url');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const contentSections = document.querySelectorAll('.profile-section');
        const profileInfoLink = document.getElementById('profile-info-link');
        // Confirmation Modal
        const confirmSaveModal = document.getElementById('confirm-save-modal');
        const confirmModalContent = document.getElementById('confirm-modal-content');
        const confirmSaveMessage = document.getElementById('confirm-save-message');
        const confirmSaveCancel = document.getElementById('confirm-save-cancel');
        const confirmSaveConfirm = document.getElementById('confirm-save-confirm');
        // Password Change
        const changePasswordForm = document.getElementById('change-password-form');
        const passwordChangeMessage = document.getElementById('password-change-message');
        // 2FA Elements
        const toggle2FA = document.getElementById('toggle_2fa');
        const status2FA = document.getElementById('2fa-status');
        const spinner2FA = document.getElementById('2fa-spinner');
        const message2FA = document.getElementById('2fa-update-message');
        const update2FA_URL = document.getElementById('update-2fa-url')?.getAttribute('data-url'); // Use specific URL if needed


        // --- Class Definitions for JS Styling ---
        const commonInputBaseClasses = 'block w-full px-3 py-2 border rounded-lg transition duration-150 text-sm shadow-sm ring-0'.split(' ');
        const commonInputPaddingClasses = 'pl-10 pr-10'.split(' ');
        const commonTextareaBaseClasses = 'block w-full px-3 py-2 border rounded-lg transition duration-150 text-sm shadow-sm resize-none min-h-[70px] ring-0'.split(' ');
        const commonTextareaPaddingClasses = 'pr-10'.split(' ');
        const readOnlyStateClasses = 'bg-slate-100 border-slate-200 text-slate-600 focus:ring-0 focus:border-slate-200 cursor-default'.split(' '); // Updated text/border color
        const editableStateClasses = 'bg-white border-slate-300 text-slate-900 placeholder-slate-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500'.split(' ');

        let pendingChanges = {};
        let fieldToSave = null;

        // --- Helper Functions (showMessage, getCookie, etc. - remain the same) ---
        function showSection(sectionId) { /* ... same as before ... */
            contentSections.forEach(section => section.classList.add('hidden'));
            const sectionToShow = document.getElementById(sectionId);
            if (sectionToShow) { sectionToShow.classList.remove('hidden'); }
            else { console.error("Section not found:", sectionId); }
        }
        function activateSidebarLink(activeLink) { /* ... same as before ... */
            sidebarLinks.forEach(link => { link.removeAttribute('aria-current'); });
            if (activeLink) { activeLink.setAttribute('aria-current', 'page'); }
        }
        function getCookie(name) { /* ... same as before ... */
            let cookieValue = null; if (document.cookie && document.cookie !== '') { const cookies = document.cookie.split(';'); for (let i = 0; i < cookies.length; i++) { const cookie = cookies[i].trim(); if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; } } } return cookieValue;
        }
        function showMessage(title, text, icon = 'info') { /* ... same as before ... */
             if (typeof Swal !== 'undefined') { Swal.fire({ title: title, text: text, icon: icon, confirmButtonColor: '#091e65', /* Theme blue */ customClass: { popup: 'rounded-xl shadow-lg text-sm font-inter', title: 'text-lg font-semibold text-slate-800', confirmButton: 'px-4 py-1.5 rounded-md bg-theme-blue hover:bg-theme-blue-dark transition duration-150 font-medium text-sm shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-theme-blue-light', cancelButton: 'px-4 py-1.5 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-100 transition duration-150 font-medium text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400' }, buttonsStyling: false }); } else { console.error("SweetAlert2 (Swal) is not loaded. Displaying alert instead."); alert(`${title}\n\n${text}`); }
        }
        function displayFieldErrors(errors) { /* ... same as before ... */
             const errorDivs = changePasswordForm ? changePasswordForm.querySelectorAll('.form-error') : []; errorDivs.forEach(el => { el.textContent = ''; el.classList.add('invisible'); }); if (passwordChangeMessage) passwordChangeMessage.textContent = ''; let generalErrorMessage = ''; let hasErrors = false; for (const field in errors) { hasErrors = true; const errorDiv = document.getElementById(`error-${field}`); const message = Array.isArray(errors[field]) ? errors[field].join(' ') : errors[field]; if (errorDiv) { errorDiv.textContent = message; errorDiv.classList.remove('invisible'); } else { generalErrorMessage += `${field}: ${message}\n`; } } if (generalErrorMessage && passwordChangeMessage) { hasErrors = true; passwordChangeMessage.textContent = generalErrorMessage.trim(); passwordChangeMessage.className = 'text-red-600 text-sm mt-2'; } return hasErrors;
        }
        function showConfirmationModal(message, fieldId) { /* ... same as before ... */
            fieldToSave = fieldId; pendingChanges = {}; const inputField = document.getElementById(fieldId); if (inputField) { pendingChanges[fieldId] = inputField.value; } else { console.error("Input field not found for confirmation:", fieldId); return; } confirmSaveMessage.textContent = message; confirmSaveModal.classList.remove('hidden'); setTimeout(() => { confirmSaveModal.classList.remove('opacity-0'); if(confirmModalContent) { confirmModalContent.classList.remove('scale-95', 'opacity-0'); confirmModalContent.classList.add('scale-100', 'opacity-100'); } }, 10);
        }
        function hideConfirmationModal() { /* ... same as before ... */
            if(confirmModalContent) { confirmModalContent.classList.remove('scale-100', 'opacity-100'); confirmModalContent.classList.add('scale-95', 'opacity-0'); } confirmSaveModal.classList.add('opacity-0'); setTimeout(() => { confirmSaveModal.classList.add('hidden'); pendingChanges = {}; fieldToSave = null; }, 300);
        }
        function setInputState(inputField, isEditable) { /* ... same as before ... */
            if (!inputField) return; const isTextarea = inputField.tagName === 'TEXTAREA'; const baseClasses = isTextarea ? commonTextareaBaseClasses : commonInputBaseClasses; const paddingClasses = isTextarea ? commonTextareaPaddingClasses : commonInputPaddingClasses; const stateClasses = isEditable ? editableStateClasses : readOnlyStateClasses; inputField.readOnly = !isEditable; inputField.className = ''; inputField.classList.add('form-input', ...baseClasses, ...paddingClasses, ...stateClasses); if (isTextarea && inputField.id === 'bio') { inputField.classList.remove('pl-10'); }
        }

        // --- AJAX Save Functions (saveProfileField, saveProfilePicture, removeProfilePicture, handlePasswordChangeSubmit - remain the same) ---
        function saveProfileField(fieldId, fieldValue) { /* ... same as before ... */
             if (!updateProfileURL) { showMessage('Error', 'Configuration error: Update URL not found.', 'error'); return; } const backendFieldName = (fieldId === 'name') ? 'full_name' : fieldId; const dataToSave = { [backendFieldName]: fieldValue }; const saveIconElement = document.querySelector(`.save-icon[data-target="${fieldId}"]`); const originalIconHTML = saveIconElement ? saveIconElement.innerHTML : ''; if (saveIconElement) { saveIconElement.innerHTML = '<i class="fas fa-spinner fa-spin text-base text-slate-500"></i>'; saveIconElement.disabled = true; } fetch(updateProfileURL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify(dataToSave) }) .then(async response => { const isJson = response.headers.get('content-type')?.includes('application/json'); const responseData = isJson ? await response.json() : null; if (!response.ok) { let errorMsg = `HTTP error! Status: ${response.status} ${response.statusText}`; if (responseData?.message) errorMsg = responseData.message; else if (responseData?.error) errorMsg = responseData.error; else if (responseData?.errors) errorMsg = Object.values(responseData.errors).flat().join(' '); const error = new Error(errorMsg); error.data = responseData; error.status = response.status; throw error; } return responseData; }) .then(data => { if (data && data.status === 'success') { showMessage('Success', data.message || 'Profile updated successfully.', 'success'); const inputField = document.getElementById(fieldId); if (inputField) { setInputState(inputField, false); const parentDiv = inputField.closest('.relative'); if (parentDiv) { const saveIcon = parentDiv.querySelector(`.save-icon[data-target="${fieldId}"]`); const editIcon = parentDiv.querySelector(`.edit-icon[data-target="${fieldId}"]`); if (saveIcon) saveIcon.classList.add('hidden'); if (editIcon) editIcon.classList.remove('hidden'); } } if (fieldId === 'username' && document.querySelector('aside p.font-semibold')) { document.querySelector('aside p.font-semibold').textContent = fieldValue; document.querySelector('aside p.font-semibold').title = fieldValue; } else if (fieldId === 'email' && document.querySelector('aside p.text-xs')) { document.querySelector('aside p.text-xs').textContent = fieldValue; document.querySelector('aside p.text-xs').title = fieldValue; } } else { showMessage('Error', data?.message || 'Failed to update profile. Unexpected response.', 'error'); } }) .catch(error => { console.error('Error updating profile field:', error); showMessage('Error', error.message || 'An error occurred while saving. Please try again.', 'error'); const inputField = document.getElementById(fieldId); if (inputField) { setInputState(inputField, false); const parentDiv = inputField.closest('.relative'); if (parentDiv) { const saveIcon = parentDiv.querySelector(`.save-icon[data-target="${fieldId}"]`); const editIcon = parentDiv.querySelector(`.edit-icon[data-target="${fieldId}"]`); if (saveIcon) saveIcon.classList.add('hidden'); if (editIcon) editIcon.classList.remove('hidden'); } } }) .finally(() => { if (saveIconElement) { saveIconElement.innerHTML = originalIconHTML; saveIconElement.disabled = false; } });
        }
        function saveProfilePicture() { /* ... same as before ... */
             if (!photoInput || !photoInput.files || photoInput.files.length === 0) { showMessage('Info', 'Please select an image file first.', 'info'); return; } if (!updateProfileURL) { showMessage('Error', 'Configuration error: Update URL not found.', 'error'); return; } const formData = new FormData(); formData.append('profile_pic', photoInput.files[0]); const originalButtonHTML = saveProfilePicButton.innerHTML; saveProfilePicButton.disabled = true; saveProfilePicButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Saving...'; if(removeProfilePicButton) removeProfilePicButton.disabled = true; fetch(updateProfileURL, { method: 'POST', body: formData, headers: { 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' } }) .then(async response => { const isJson = response.headers.get('content-type')?.includes('application/json'); const data = isJson ? await response.json() : null; if (!response.ok) { const errorText = !isJson ? await response.text() : null; const errorMsg = data?.message || data?.error || (data?.errors ? Object.values(data.errors).flat().join(' ') : null) || errorText || `HTTP error! Status: ${response.status}`; const error = new Error(errorMsg); error.data = data; error.status = response.status; throw error; } return data; }) .then(data => { if (data.status === 'success') { showMessage('Success', data.message || 'Profile picture updated.', 'success'); saveProfilePicButton.classList.add('hidden'); if (removeProfilePicButton) removeProfilePicButton.classList.remove('hidden'); photoInput.value = ''; if (data.profile_pic_url) { const newUrl = data.profile_pic_url + '?t=' + new Date().getTime(); if(profilePictureImgMain) { profilePictureImgMain.src = newUrl; profilePictureImgMain.classList.remove('hidden'); } if(profilePicturePlaceholderMain) profilePicturePlaceholderMain.classList.add('hidden'); if(profilePictureImgSidebar) { profilePictureImgSidebar.src = newUrl; profilePictureImgSidebar.classList.remove('hidden'); } if(profilePicturePlaceholderSidebar) profilePicturePlaceholderSidebar.classList.add('hidden'); } } else { const errorMsg = data?.message || data?.error || (data?.errors ? Object.values(data.errors).flat().join(' ') : 'Failed to update profile picture.'); showMessage('Error', errorMsg, 'error'); } }) .catch(error => { console.error('Error saving profile picture:', error); showMessage('Error', error.message || 'An error occurred while saving the picture.', 'error'); }) .finally(() => { saveProfilePicButton.disabled = false; saveProfilePicButton.innerHTML = originalButtonHTML; if(removeProfilePicButton) removeProfilePicButton.disabled = false; });
        }
        function removeProfilePicture() { /* ... same as before ... */
             if (!updateProfileURL) { showMessage('Error', 'Configuration error: Update URL not found.', 'error'); return; } Swal.fire({ title: 'Are you sure?', text: "Do you want to remove your profile picture?", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#6b7280', confirmButtonText: 'Yes, remove it!', customClass: { popup: 'rounded-xl shadow-lg text-sm font-inter', title: 'text-lg font-semibold text-slate-800', confirmButton: 'px-4 py-1.5 rounded-md bg-red-600 text-white hover:bg-red-700 transition duration-150 font-medium text-sm shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 mr-2', cancelButton: 'px-4 py-1.5 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-100 transition duration-150 font-medium text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400' }, buttonsStyling: false }) .then((result) => { if (result.isConfirmed) { const originalButtonHTML = removeProfilePicButton.innerHTML; removeProfilePicButton.disabled = true; removeProfilePicButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Removing...'; if(saveProfilePicButton) saveProfilePicButton.disabled = true; fetch(updateProfileURL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ remove_profile_pic: true }) }) .then(async response => { const isJson = response.headers.get('content-type')?.includes('application/json'); const data = isJson ? await response.json() : null; if (!response.ok) { const errorText = !isJson ? await response.text() : null; const errorMsg = data?.message || data?.error || errorText || `HTTP error! Status: ${response.status}`; const error = new Error(errorMsg); error.data = data; error.status = response.status; throw error; } return data; }) .then(data => { if (data.status === 'success') { showMessage('Success', data.message || 'Profile picture removed.', 'success'); if (profilePictureImgMain) { profilePictureImgMain.src = ''; profilePictureImgMain.classList.add('hidden'); } if (profilePicturePlaceholderMain) profilePicturePlaceholderMain.classList.remove('hidden'); if (profilePictureImgSidebar) { profilePictureImgSidebar.src = ''; profilePictureImgSidebar.classList.add('hidden'); } if (profilePicturePlaceholderSidebar) profilePicturePlaceholderSidebar.classList.remove('hidden'); removeProfilePicButton.classList.add('hidden'); if (saveProfilePicButton) saveProfilePicButton.classList.add('hidden'); if (photoInput) photoInput.value = ''; } else { const errorMsg = data?.message || data?.error || 'Failed to remove profile picture.'; showMessage('Error', errorMsg, 'error'); } }) .catch(error => { console.error('Error removing profile picture:', error); showMessage('Error', error.message || 'An error occurred while removing the picture.', 'error'); }) .finally(() => { removeProfilePicButton.disabled = false; removeProfilePicButton.innerHTML = originalButtonHTML; if(saveProfilePicButton) { saveProfilePicButton.disabled = true; saveProfilePicButton.classList.add('hidden'); } }); } });
        }
        function handlePasswordChangeSubmit(event) { /* ... same as before ... */
             event.preventDefault(); const submitButton = changePasswordForm.querySelector('button[type="submit"]'); const originalButtonText = submitButton.innerHTML; submitButton.disabled = true; submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...'; const formData = new FormData(changePasswordForm); displayFieldErrors({}); if (passwordChangeMessage) passwordChangeMessage.textContent = ''; fetch(changePasswordForm.action, { method: 'POST', body: formData, headers: { 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' } }) .then(async response => { const isJson = response.headers.get('content-type')?.includes('application/json'); const data = isJson ? await response.json() : null; if (!response.ok) { const errorText = !isJson ? await response.text() : null; const error = data || { message: errorText || `HTTP error! Status: ${response.status}` }; error.status = response.status; error.data = data; throw error; } return data; }) .then(data => { if (data.status === 'success') { showMessage('Success', data.message || 'Password changed successfully!', 'success'); changePasswordForm.reset(); if (passwordChangeMessage) { passwordChangeMessage.textContent = data.message || 'Password changed successfully!'; passwordChangeMessage.className = 'text-green-600 text-sm mt-2'; } displayFieldErrors({}); } else { let displayedErrors = false; if (data.errors) { displayedErrors = displayFieldErrors(data.errors); } if (!displayedErrors || data.message) { showMessage('Error', data.message || 'Failed to change password. Please check the form.', 'error'); } if (passwordChangeMessage && data.message && !displayedErrors) { passwordChangeMessage.textContent = data.message; passwordChangeMessage.className = 'text-red-600 text-sm mt-2'; } } }) .catch(error => { console.error('Error changing password:', error); let displayedErrors = false; if (error.status === 400 && error.data && error.data.errors) { displayedErrors = displayFieldErrors(error.data.errors); } showMessage('Error', error.message || 'An unexpected error occurred. Please try again.', 'error'); if (passwordChangeMessage && !displayedErrors) { passwordChangeMessage.textContent = error.message || 'An unexpected error occurred.'; passwordChangeMessage.className = 'text-red-600 text-sm mt-2'; } }) .finally(() => { submitButton.disabled = false; submitButton.innerHTML = originalButtonText; });
        }

        // --- Function to handle 2FA Toggle ---
        function handle2FAToggle() {
            if (!toggle2FA || !status2FA || !spinner2FA || !message2FA) { console.error("2FA elements not found."); return; }
            if (!update2FA_URL) { showMessage('Error', 'Configuration error: 2FA Update URL not found.', 'error'); toggle2FA.checked = !toggle2FA.checked; return; }

            const isEnabled = toggle2FA.checked;
            const statusSpan = status2FA.querySelector('span'); // Get the inner span to update text/color
            const originalStatusText = statusSpan ? statusSpan.textContent : (isEnabled ? 'Disabled' : 'Enabled'); // Get opposite for revert
            const originalStatusClass = statusSpan ? statusSpan.className : (isEnabled ? 'text-slate-500' : 'text-green-700');

            spinner2FA.classList.remove('hidden');
            if (statusSpan) statusSpan.textContent = 'Updating...'; // Indicate loading
            if (statusSpan) statusSpan.className = 'text-slate-500'; // Neutral color while loading
            toggle2FA.disabled = true;
            message2FA.textContent = '';
            message2FA.className = 'mt-3 text-sm ml-4 md:ml-14'; // Reset message class, keep indent

            console.log(`Simulating 2FA update: Set to ${isEnabled}`);
            fetch(update2FA_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ is_2fa_enabled: isEnabled }) })
            .then(async response => {
                const isJson = response.headers.get('content-type')?.includes('application/json');
                const responseData = isJson ? await response.json() : { status: 'error', message: 'Invalid response from server.' };
                if (!response.ok || responseData.status !== 'success') {
                    let errorMsg = responseData.message || `Failed to update 2FA status (HTTP ${response.status})`;
                    const error = new Error(errorMsg); error.data = responseData; throw error;
                }
                return responseData;
            })
            .then(data => {
                const successMsg = isEnabled ? 'Two-Factor Authentication enabled successfully.' : 'Two-Factor Authentication disabled successfully.';
                showMessage('Success', successMsg, 'success');
                if (statusSpan) {
                    statusSpan.textContent = isEnabled ? 'Enabled' : 'Disabled';
                    statusSpan.className = isEnabled ? 'text-green-700' : 'text-slate-500';
                }
                // message2FA.textContent = successMsg; // Optional persistent message
                // message2FA.classList.add('text-green-600');
            })
            .catch(error => {
                console.error('Error updating 2FA status:', error);
                showMessage('Error', error.message || 'Failed to update 2FA status.', 'error');
                toggle2FA.checked = !isEnabled; // Revert toggle
                if (statusSpan) { // Restore status text/color
                    statusSpan.textContent = originalStatusText;
                    statusSpan.className = originalStatusClass;
                }
                message2FA.textContent = error.message || 'An error occurred. Please try again.';
                message2FA.classList.add('text-red-600');
            })
            .finally(() => {
                spinner2FA.classList.add('hidden');
                toggle2FA.disabled = false;
                 // Ensure status text is correct if it wasn't restored properly in catch
                 if (statusSpan && statusSpan.textContent === 'Updating...') {
                    statusSpan.textContent = toggle2FA.checked ? 'Enabled' : 'Disabled';
                    statusSpan.className = toggle2FA.checked ? 'text-green-700' : 'text-slate-500';
                 }
            });
        }


        // --- Event Listeners ---
        sidebarLinks.forEach(link => { link.addEventListener('click', function(event) { event.preventDefault(); const sectionId = this.id.replace('-link', '-content'); showSection(sectionId); activateSidebarLink(this); }); });
        if (changePasswordForm) { changePasswordForm.addEventListener('submit', handlePasswordChangeSubmit); }
        if (photoInput) { photoInput.addEventListener('change', function() { /* ... same as before ... */ if (this.files && this.files[0]) { const file = this.files[0]; const allowedTypes = ['image/png', 'image/jpeg', 'image/gif']; const maxSize = 5 * 1024 * 1024; if (!allowedTypes.includes(file.type)) { showMessage('Error', 'Invalid file type. Please select a PNG, JPG, or GIF.', 'error'); this.value = ''; return; } if (file.size > maxSize) { showMessage('Error', `File too large (${(file.size / 1024 / 1024).toFixed(1)}MB). Max 5MB.`, 'error'); this.value = ''; return; } const reader = new FileReader(); reader.onload = function(e) { if (profilePictureImgMain) { profilePictureImgMain.src = e.target.result; profilePictureImgMain.classList.remove('hidden'); } if (profilePicturePlaceholderMain) profilePicturePlaceholderMain.classList.add('hidden'); if (removeProfilePicButton) removeProfilePicButton.classList.remove('hidden'); if (saveProfilePicButton) saveProfilePicButton.classList.remove('hidden'); }; reader.readAsDataURL(file); } }); }
        if (saveProfilePicButton) { saveProfilePicButton.addEventListener('click', saveProfilePicture); }
        if (removeProfilePicButton) { removeProfilePicButton.addEventListener('click', removeProfilePicture); }
        const editIcons = document.querySelectorAll('.edit-icon'); editIcons.forEach(icon => { icon.addEventListener('click', function() { /* ... same as before ... */ const targetId = this.dataset.target; const inputField = document.getElementById(targetId); if (!inputField) return; setInputState(inputField, true); inputField.focus(); if (inputField.tagName === 'INPUT' && inputField.type !== 'file') { inputField.select(); } else if (inputField.tagName === 'TEXTAREA') { inputField.setSelectionRange(inputField.value.length, inputField.value.length); } this.classList.add('hidden'); const parentDiv = this.closest('.relative'); if(parentDiv) { const saveIcon = parentDiv.querySelector(`.save-icon[data-target="${targetId}"]`); if (saveIcon) saveIcon.classList.remove('hidden'); } }); });
        const saveIcons = document.querySelectorAll('.save-icon'); saveIcons.forEach(icon => { icon.addEventListener('click', function() { /* ... same as before ... */ const targetId = this.dataset.target; const inputField = document.getElementById(targetId); if (!inputField) return; const trimmedValue = inputField.value.trim(); let isValid = true; let errorMsg = ''; const labelElement = document.querySelector(`label[for="${targetId}"]`); const fieldLabel = labelElement ? labelElement.textContent : (targetId.charAt(0).toUpperCase() + targetId.slice(1)); if (!trimmedValue && (targetId === 'username' || targetId === 'email')) { isValid = false; errorMsg = `${fieldLabel} cannot be empty.`; } else if (targetId === 'email') { const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; if (!emailRegex.test(trimmedValue)) { isValid = false; errorMsg = 'Please enter a valid email address.'; } } else if (targetId === 'username' && trimmedValue.length < 3) { isValid = false; errorMsg = 'Username must be at least 3 characters long.'; } if (!isValid) { showMessage('Validation Error', errorMsg, 'error'); inputField.focus(); return; } let confirmMsg = `Are you sure you want to update your ${fieldLabel}?`; if (targetId !== 'bio' && trimmedValue) { confirmMsg = `Are you sure you want to change your ${fieldLabel} to "${trimmedValue}"?`; } else if (targetId !== 'bio' && !trimmedValue && targetId !== 'name') { confirmMsg = `Are you sure you want to clear your ${fieldLabel}?`; } else if (targetId === 'bio') { confirmMsg = `Are you sure you want to update your Bio?`; } showConfirmationModal(confirmMsg, targetId); }); });
        if (confirmSaveCancel) { confirmSaveCancel.addEventListener('click', hideConfirmationModal); }
        if (confirmSaveConfirm) { confirmSaveConfirm.addEventListener('click', function() { if (fieldToSave && pendingChanges.hasOwnProperty(fieldToSave)) { saveProfileField(fieldToSave, pendingChanges[fieldToSave]); } hideConfirmationModal(); }); }
        if (confirmSaveModal) { confirmSaveModal.addEventListener('click', function(event) { if (event.target === confirmSaveModal) hideConfirmationModal(); }); }
        if (toggle2FA) { toggle2FA.addEventListener('change', handle2FAToggle); }

        // --- Initial Setup ---
        document.querySelectorAll('#profile-info-content .form-input').forEach(input => { setInputState(input, false); });
        // Note: Password inputs in the redesigned section don't use setInputState, styling is direct HTML/CSS
        document.querySelectorAll('.form-error').forEach(el => el.classList.add('invisible'));
        if (profileInfoLink) { showSection('profile-info-content'); activateSidebarLink(profileInfoLink); }
        else if (sidebarLinks.length > 0) { const firstLink = sidebarLinks[0]; const sectionId = firstLink.id.replace('-link', '-content'); showSection(sectionId); activateSidebarLink(firstLink); }

    }); // End DOMContentLoaded
</script>

{% endblock %}

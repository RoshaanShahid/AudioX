{% extends 'Homepage.html' %}
{% load static %}
{% load tz %}

{% block title %}AudioX - My Wallet{% endblock %}

{% block content %}
<!-- ============================================================================ -->
<!-- MY WALLET PAGE - CLEAN MODERN DESIGN                                        -->
<!-- Colors: Solid #091e65 and Red Only - Custom Notifications, Clean & Elegant -->
<!-- ============================================================================ -->

<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- ======================================== -->
        <!-- PAGE HEADER                              -->
        <!-- ======================================== -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">My Wallet</h1>
            <p class="text-gray-600">Manage your AudioX coins and transaction history</p>
        </div>

        <!-- ======================================== -->
        <!-- USAGE STATUS BANNER (FREE USERS ONLY)   -->
        <!-- ======================================== -->
        {% if user.subscription_type == 'FR' %}
        <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-xl p-6 mb-8">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <!-- Usage Information -->
                <div class="flex items-start space-x-4">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-red-900 mb-2">FREE Plan Limits</h3>
                        <!-- Usage Counters Grid -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-red-800">
                            <!-- Document Conversions Counter -->
                            <div class="flex items-center justify-between bg-white/50 rounded-lg px-3 py-2">
                                <span class="font-medium">Document Conversions:</span>
                                <span class="font-bold" id="document-usage-display">
                                    {% if usage_status.document_conversions %}{{ usage_status.document_conversions.remaining|default:0 }}{% else %}{{ user.get_remaining_document_conversions|default:0 }}{% endif %}/{% if usage_status.document_conversions %}{{ usage_status.document_conversions.limit|default:3 }}{% else %}3{% endif %}
                                </span>
                            </div>
                            <!-- Coin Gifts Counter -->
                            <div class="flex items-center justify-between bg-white/50 rounded-lg px-3 py-2">
                                <span class="font-medium">Coin Gifts:</span>
                                <span class="font-bold" id="gift-usage-display">
                                    {% if usage_status.coin_gifts %}{{ usage_status.coin_gifts.remaining|default:0 }}{% else %}{{ user.get_remaining_coin_gifts|default:0 }}{% endif %}/{% if usage_status.coin_gifts %}{{ usage_status.coin_gifts.limit|default:3 }}{% else %}3{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Upgrade Button -->
                <a href="{% url 'AudioXApp:buycoins' %}" class="inline-flex items-center px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                    </svg>
                    Upgrade to Premium
                </a>
            </div>
        </div>
        {% endif %}

        <!-- ======================================== -->
        <!-- MAIN CONTENT GRID                       -->
        <!-- ======================================== -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">

            <!-- ======================================== -->
            <!-- BALANCE CARD                             -->
            <!-- ======================================== -->
            <div class="lg:col-span-1">
                <div class="bg-gradient-to-br from-blue-900 to-blue-800 text-white rounded-xl p-6 shadow-lg" style="background: linear-gradient(135deg, #091e65 0%, #1e40af 100%);">
                    <!-- Balance Header -->
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold opacity-90">Available Balance</h2>
                        <svg class="w-8 h-8 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <!-- Balance Display -->
                    <div class="mb-6">
                        <span id="coin-balance" class="text-4xl font-bold block">{{ user.coins|default:"0" }}</span>
                        <span class="text-sm opacity-80 font-medium">AUDIOX COINS</span>
                    </div>
                    <!-- Add Coins Button -->
                    <a href="{% url 'AudioXApp:buycoins' %}" class="inline-flex items-center justify-center w-full bg-red-600 text-blue-900 font-semibold py-3 px-4 rounded-lg hover:bg-gray-50 transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Add More Coins
                    </a>
                </div>
            </div>

            <!-- ======================================== -->
            <!-- GIFT COINS CARD                         -->
            <!-- ======================================== -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl p-6 shadow-lg border border-gray-200">
                    <!-- Gift Card Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <svg class="w-6 h-6 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                            </svg>
                            <h2 class="text-xl font-semibold text-gray-900">Send AudioX Gift</h2>
                            <!-- FREE User Limit Badge -->
                            {% if user.subscription_type == 'FR' %}
                            <span class="ml-3 px-2 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded-full">
                                {% if usage_status.coin_gifts %}{{ usage_status.coin_gifts.remaining|default:0 }}{% else %}{{ user.get_remaining_coin_gifts|default:0 }}{% endif %}/{% if usage_status.coin_gifts %}{{ usage_status.coin_gifts.limit|default:3 }}{% else %}3{% endif %} LEFT
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Gift Description -->
                    <p class="text-gray-600 text-sm mb-6">
                        {% if user.subscription_type == 'PR' %}
                        Enter the username or email of a registered AudioX user and the amount of coins you wish to send them.
                        {% else %}
                        You can gift coins {% if usage_status.coin_gifts %}{{ usage_status.coin_gifts.remaining|default:0 }}{% else %}{{ user.get_remaining_coin_gifts|default:0 }}{% endif %} more times this month. Upgrade to Premium for unlimited gifting!
                        {% endif %}
                    </p>

                    <!-- Gift Form -->
                    <form id="gift-form" method="post" action="{% url 'AudioXApp:gift_coins' %}">
                        {% csrf_token %}
                        <!-- Form Fields Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <!-- Recipient Field -->
                            <div>
                                <label for="recipient" class="block text-sm font-medium text-gray-700 mb-2">Recipient</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                                        </svg>
                                    </div>
                                    <input type="text" id="recipient" name="recipient" class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="Username or Email" required style="--tw-ring-color: #091e65;">
                                </div>
                            </div>
                            <!-- Amount Field -->
                            <div>
                                <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                        </svg>
                                    </div>
                                    <input type="number" id="amount" name="amount" class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="Number of Coins" min="1" required style="--tw-ring-color: #091e65;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Send Gift Button -->
                        <button type="button" id="send-gift-btn" class="w-full inline-flex items-center justify-center px-6 py-3 font-semibold text-white rounded-lg transition-colors {% if user.subscription_type == 'FR' and usage_status.coin_gifts.remaining <= 0 %}bg-gray-400 cursor-not-allowed{% else %}bg-red-600 hover:bg-red-700{% endif %}" {% if user.subscription_type == 'FR' and usage_status.coin_gifts.remaining <= 0 %}disabled{% endif %}>
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                            {% if user.subscription_type == 'FR' and usage_status.coin_gifts.remaining <= 0 %}
                            Limit Reached - Upgrade to Continue
                            {% else %}
                            Send Gift Now
                            {% endif %}
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ======================================== -->
        <!-- TRANSACTION HISTORY SECTION             -->
        <!-- ======================================== -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <!-- History Header -->
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">Transaction History</h2>
            </div>

            <!-- ======================================== -->
            <!-- TRANSACTION TABS                        -->
            <!-- ======================================== -->
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                <nav class="flex space-x-1" role="tablist" id="historyTabs">
                    <!-- All Transactions Tab -->
                    <button class="px-4 py-2 text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 bg-blue-900 text-white" id="all-tab" data-tabs-target="#all" type="button" role="tab" aria-controls="all" aria-selected="true" style="background-color: #091e65;">All Transactions</button>
                    <!-- Purchases Tab -->
                    <button class="px-4 py-2 text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100" id="purchased-tab" data-tabs-target="#purchased" type="button" role="tab" aria-controls="purchased" aria-selected="false">Purchases</button>
                    <!-- Gifts Received Tab -->
                    <button class="px-4 py-2 text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100" id="received-tab" data-tabs-target="#received" type="button" role="tab" aria-controls="received" aria-selected="false">Gifts Received</button>
                    <!-- Gifts Sent Tab -->
                    <button class="px-4 py-2 text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100" id="sent-tab" data-tabs-target="#sent" type="button" role="tab" aria-controls="sent" aria-selected="false">Gifts Sent</button>
                </nav>
            </div>

            <!-- ======================================== -->
            <!-- TAB CONTENT AREA                        -->
            <!-- ======================================== -->
            <div id="historyTabContent" class="p-6 min-h-[400px]">
                
                <!-- ======================================== -->
                <!-- ALL TRANSACTIONS TAB                    -->
                <!-- ======================================== -->
                <div id="all" role="tabpanel" aria-labelledby="all-tab">
                    <div class="history-list space-y-3">
                        {% for transaction in gift_history %}
                            <!-- Transaction Item -->
                            <div class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                <!-- Transaction Icon -->
                                <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center mr-4
                                    {% if transaction.transaction_type == 'purchase' %}bg-blue-100 text-blue-600{% elif transaction.transaction_type == 'gift_sent' %}bg-red-100 text-red-600{% elif transaction.transaction_type == 'gift_received' %}bg-green-100 text-green-600{% elif transaction.transaction_type == 'reward' %}bg-yellow-100 text-yellow-600{% elif transaction.transaction_type == 'spent' %}bg-red-100 text-red-600{% elif transaction.transaction_type == 'refund' %}bg-gray-100 text-gray-600{% else %}bg-gray-100 text-gray-600{% endif %}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        {% if transaction.transaction_type == 'purchase' %}
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m6-5v6a2 2 0 11-4 0v-6m4 0V9a2 2 0 10-4 0v4.01"></path>
                                        {% elif transaction.transaction_type == 'gift_sent' %}
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                        {% elif transaction.transaction_type == 'gift_received' %}
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                                        {% elif transaction.transaction_type == 'reward' %}
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                        {% else %}
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        {% endif %}
                                    </svg>
                                </div>
                                <!-- Transaction Details -->
                                <div class="flex-grow min-w-0">
                                    <p class="text-sm font-semibold text-gray-900 truncate">
                                        {% if transaction.transaction_type == 'purchase' %}{{ transaction.pack_name|default:'Coin Purchase' }}{% elif transaction.transaction_type == 'gift_sent' %}Sent to: {{ transaction.recipient.username|default:'N/A' }}{% elif transaction.transaction_type == 'gift_received' %}Received from: {{ transaction.sender.username|default:'N/A' }}{% else %}{{ transaction.get_transaction_type_display }}{% endif %}
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        {% timezone "Asia/Karachi" %}{{ transaction.transaction_date|date:"M d, Y, P" }}{% endtimezone %}
                                    </p>
                                </div>
                                <!-- Transaction Amount -->
                                <div class="flex-shrink-0 text-right">
                                    <span class="text-sm font-semibold
                                        {% if transaction.transaction_type == 'gift_sent' or transaction.transaction_type == 'spent' %}text-red-600{% elif transaction.transaction_type == 'gift_received' or transaction.transaction_type == 'purchase' or transaction.transaction_type == 'reward' or transaction.transaction_type == 'refund' %}text-green-600{% else %}text-gray-700{% endif %}">
                                        {% if transaction.transaction_type == 'gift_sent' or transaction.transaction_type == 'spent' %}- {{ transaction.amount|default:"0" }}{% elif transaction.transaction_type == 'gift_received' or transaction.transaction_type == 'purchase' or transaction.transaction_type == 'reward' or transaction.transaction_type == 'refund' %}+ {{ transaction.amount|default:"0" }}{% else %}{{ transaction.amount|default:"0" }}{% endif %}
                                    </span>
                                    {% if transaction.transaction_type == 'purchase' and transaction.price %}
                                        <p class="text-xs text-gray-500">PKR {{ transaction.price|floatformat:2 }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        {% empty %}
                            <!-- Empty State -->
                            <div class="text-center py-12">
                                <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">No transactions yet</h3>
                                <p class="text-gray-500">Your transaction history will appear here once you buy coins or send/receive gifts.</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- ======================================== -->
                <!-- PURCHASES TAB                            -->
                <!-- ======================================== -->
                <div class="hidden" id="purchased" role="tabpanel" aria-labelledby="purchased-tab">
                    <div class="history-list space-y-3">
                        {% for transaction in gift_history %}
                            {% if transaction.transaction_type == 'purchase' %}
                                <!-- Purchase Transaction Item -->
                                <div class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                    <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center mr-4 bg-blue-100 text-blue-600">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m6-5v6a2 2 0 11-4 0v-6m4 0V9a2 2 0 10-4 0v4.01"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-grow min-w-0">
                                        <p class="text-sm font-semibold text-gray-900 truncate">{{ transaction.pack_name|default:'Coin Purchase' }}</p>
                                        <p class="text-xs text-gray-500">{% timezone "Asia/Karachi" %}{{ transaction.transaction_date|date:"M d, Y, P" }}{% endtimezone %}</p>
                                    </div>
                                    <div class="flex-shrink-0 text-right">
                                        <span class="text-sm font-semibold text-green-600">+ {{ transaction.amount|default:"0" }}</span>
                                        {% if transaction.price %}<p class="text-xs text-gray-500">PKR {{ transaction.price|floatformat:2 }}</p>{% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- ======================================== -->
                <!-- GIFTS RECEIVED TAB                      -->
                <!-- ======================================== -->
                <div class="hidden" id="received" role="tabpanel" aria-labelledby="received-tab">
                    <div class="history-list space-y-3">
                        {% for transaction in gift_history %}
                            {% if transaction.transaction_type == 'gift_received' %}
                                <!-- Gift Received Transaction Item -->
                                <div class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                    <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center mr-4 bg-green-100 text-green-600">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-grow min-w-0">
                                        <p class="text-sm font-semibold text-gray-900 truncate">Received from: {{ transaction.sender.username|default:'N/A' }}</p>
                                        <p class="text-xs text-gray-500">{% timezone "Asia/Karachi" %}{{ transaction.transaction_date|date:"M d, Y, P" }}{% endtimezone %}</p>
                                    </div>
                                    <div class="flex-shrink-0 text-right">
                                        <span class="text-sm font-semibold text-green-600">+ {{ transaction.amount|default:"0" }}</span>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- ======================================== -->
                <!-- GIFTS SENT TAB                          -->
                <!-- ======================================== -->
                <div class="hidden" id="sent" role="tabpanel" aria-labelledby="sent-tab">
                    <div class="history-list space-y-3">
                        {% for transaction in gift_history %}
                            {% if transaction.transaction_type == 'gift_sent' %}
                                <!-- Gift Sent Transaction Item -->
                                <div class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                    <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center mr-4 bg-red-100 text-red-600">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-grow min-w-0">
                                        <p class="text-sm font-semibold text-gray-900 truncate">Sent to: {{ transaction.recipient.username|default:'N/A' }}</p>
                                        <p class="text-xs text-gray-500">{% timezone "Asia/Karachi" %}{{ transaction.transaction_date|date:"M d, Y, P" }}{% endtimezone %}</p>
                                    </div>
                                    <div class="flex-shrink-0 text-right">
                                        <span class="text-sm font-semibold text-red-600">- {{ transaction.amount|default:"0" }}</span>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ======================================== -->
<!-- CUSTOM CONFIRMATION MODAL               -->
<!-- ======================================== -->
<div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden items-center justify-center p-4 transition-opacity duration-300">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-auto transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
        <div class="p-6">
            <!-- Modal Header -->
            <div class="text-center mb-6">
                <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style="background-color: #091e65;">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Confirm Gift Transfer</h3>
                <p class="text-gray-600">Please verify the details below</p>
            </div>

            <!-- Transaction Details -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6 space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">From:</span>
                    <span class="font-semibold text-gray-900">{{ user.username }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">To:</span>
                    <span id="confirm-to" class="font-semibold text-gray-900"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Amount:</span>
                    <div class="text-right">
                        <span id="confirm-amount" class="font-bold text-xl" style="color: #091e65;"></span>
                        <span class="text-gray-600 text-sm ml-1">Coins</span>
                    </div>
                </div>
            </div>

            <!-- Modal Actions -->
            <div class="flex space-x-3">
                <button id="cancel-send" type="button" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button id="confirm-send" type="button" class="flex-1 px-4 py-2 text-white rounded-lg transition-colors" style="background-color: #091e65;">
                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Confirm & Send
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ======================================== -->
<!-- CUSTOM UPGRADE MODAL (FREE USERS)       -->
<!-- ======================================== -->
{% if user.subscription_type == 'FR' %}
<div id="upgradeModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-auto p-6 text-center">
        <!-- Upgrade Icon -->
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
            </svg>
        </div>
        <!-- Upgrade Content -->
        <h3 class="text-2xl font-bold text-gray-900 mb-4">Upgrade to Premium</h3>
        <p class="text-gray-600 mb-6">You've reached your monthly limit for coin gifting. Upgrade to Premium for unlimited gifting!</p>
        <!-- Upgrade Actions -->
        <div class="space-y-3">
            <a href="{% url 'AudioXApp:buycoins' %}" class="block w-full bg-red-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                Upgrade Now
            </a>
            <button id="closeUpgradeModal" class="block w-full bg-gray-100 text-gray-700 py-3 px-6 rounded-lg font-semibold hover:bg-gray-200 transition-colors">
                Maybe Later
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- ======================================== -->
<!-- CUSTOM NOTIFICATION CONTAINER           -->
<!-- ======================================== -->
<div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- ======================================== -->
<!-- HIDDEN DATA FOR JAVASCRIPT              -->
<!-- ======================================== -->
<script id="wallet-usage-data" type="application/json">
{
    "isUserPremium": {% if user.subscription_type == 'PR' %}true{% else %}false{% endif %},
    "giftUsageRemaining": {% if usage_status.coin_gifts %}{{ usage_status.coin_gifts.remaining|default:0 }}{% else %}{{ user.get_remaining_coin_gifts|default:0 }}{% endif %},
    "giftUsageLimit": {% if usage_status.coin_gifts %}{{ usage_status.coin_gifts.limit|default:3 }}{% else %}3{% endif %},
    "documentUsageRemaining": {% if usage_status.document_conversions %}{{ usage_status.document_conversions.remaining|default:0 }}{% else %}{{ user.get_remaining_document_conversions|default:0 }}{% endif %},
    "documentUsageLimit": {% if usage_status.document_conversions %}{{ usage_status.document_conversions.limit|default:3 }}{% else %}3{% endif %}
}
</script>

<!-- ======================================== -->
<!-- WALLET JAVASCRIPT FUNCTIONALITY         -->
<!-- ======================================== -->
<script>
/**
 * ============================================================================
 * WALLET PAGE JAVASCRIPT - MODERN IMPLEMENTATION
 * ============================================================================
 * Handles all wallet functionality including:
 * - Coin gifting with validation and confirmation
 * - Custom notification system
 * - Modal management
 * - Tab switching for transaction history
 * - Balance animations
 * - Usage limit enforcement
 * 
 * Author: AudioX Development Team
 * Version: 2.0
 * Last Updated: 2024
 * ============================================================================
 */

document.addEventListener('DOMContentLoaded', function() {
    console.log('🎵 Wallet page JavaScript initialized');

    // ============================================================================
    // DOM ELEMENT REFERENCES
    // ============================================================================
    
    // Form and input elements
    const giftForm = document.getElementById('gift-form');
    const sendGiftBtn = document.getElementById('send-gift-btn');
    const recipientInput = document.getElementById('recipient');
    const amountInput = document.getElementById('amount');
    
    // Modal elements
    const confirmationModal = document.getElementById('confirmation-modal');
    const modalContent = document.getElementById('modal-content');
    const confirmTo = document.getElementById('confirm-to');
    const confirmAmount = document.getElementById('confirm-amount');
    const confirmSendBtn = document.getElementById('confirm-send');
    const cancelSendBtn = document.getElementById('cancel-send');
    
    // Balance and display elements
    const coinBalanceElement = document.getElementById('coin-balance');
    const headerCoinBalance = document.getElementById('header-coin-balance');
    const giftUsageDisplay = document.getElementById('gift-usage-display');
    
    // Tab navigation elements
    const historyTabs = document.querySelectorAll('#historyTabs button[role="tab"]');
    
    // Upgrade modal elements
    const upgradeModal = document.getElementById('upgradeModal');
    const closeUpgradeModalBtn = document.getElementById('closeUpgradeModal');
    
    // Notification system
    const notificationContainer = document.getElementById('notification-container');

    // ============================================================================
    // APPLICATION STATE AND CONFIGURATION
    // ============================================================================
    
    // Get usage data from JSON script
    const walletUsageDataScript = document.getElementById('wallet-usage-data');
    const walletUsageData = JSON.parse(walletUsageDataScript.textContent);
    
    // Extract usage limits and user status
    const isUserPremium = walletUsageData.isUserPremium;
    const giftUsageRemaining = walletUsageData.giftUsageRemaining;
    
    // Current gift transaction data
    let giftData = {};

    console.log(`👤 User Premium Status: ${isUserPremium}`);
    console.log(`🎁 Gift Usage Remaining: ${giftUsageRemaining}`);

    // ============================================================================
    // CUSTOM NOTIFICATION SYSTEM
    // ============================================================================
    
    /**
     * Shows a custom notification toast with AudioX branding
     * @param {string} message - The message to display
     * @param {string} type - The type of notification (success, error, info)
     */
    function showNotification(message, type = 'info') {
        console.log(`📢 Showing ${type} notification: ${message}`);
        
        const notification = document.createElement('div');
        notification.className = `max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden transform transition-all duration-300 translate-x-full opacity-0`;
        
        // Determine notification styling based on type
        let iconColor, bgColor, icon;
        switch(type) {
            case 'success':
                iconColor = 'text-green-600';
                bgColor = 'bg-green-50';
                icon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>`;
                break;
            case 'error':
                iconColor = 'text-red-600';
                bgColor = 'bg-red-50';
                icon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>`;
                break;
            default:
                iconColor = 'text-blue-600';
                bgColor = 'bg-blue-50';
                icon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>`;
        }

        // Build notification HTML
        notification.innerHTML = `
            <div class="p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 ${bgColor} rounded-full flex items-center justify-center">
                            <div class="${iconColor}">${icon}</div>
                        </div>
                    </div>
                    <div class="ml-3 w-0 flex-1 pt-0.5">
                        <p class="text-sm font-medium text-gray-900">${type.charAt(0).toUpperCase() + type.slice(1)}</p>
                        <p class="mt-1 text-sm text-gray-500">${message}</p>
                    </div>
                    <div class="ml-4 flex-shrink-0 flex">
                        <button class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none" onclick="this.closest('.max-w-sm').remove()">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `;

        // Add to container and animate in
        notificationContainer.appendChild(notification);

        // Animate notification entrance
        setTimeout(() => {
            notification.classList.remove('translate-x-full', 'opacity-0');
            notification.classList.add('translate-x-0', 'opacity-100');
        }, 100);

        // Auto-remove notification after 5 seconds
        setTimeout(() => {
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    
    /**
     * Gets CSRF token from cookies for Django AJAX requests
     * @param {string} name - Cookie name to retrieve
     * @returns {string|null} Cookie value or null if not found
     */
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    /**
     * Animates a number value change with smooth transition
     * @param {HTMLElement} element - Element to animate
     * @param {number} start - Starting value
     * @param {number} end - Ending value
     * @param {number} duration - Animation duration in milliseconds
     */
    function animateValue(element, start, end, duration) {
        if (!element) return;
        
        console.log(`🎬 Animating balance from ${start} to ${end}`);
        
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const currentValue = Math.floor(progress * (end - start) + start);
            element.textContent = currentValue.toLocaleString();
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    // ============================================================================
    // MODAL MANAGEMENT FUNCTIONS
    // ============================================================================
    
    /**
     * Shows the confirmation modal with animation
     */
    function showModal() {
        console.log('📋 Showing confirmation modal');
        confirmationModal.classList.remove('hidden');
        confirmationModal.classList.add('flex');
        setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    /**
     * Hides the confirmation modal with animation
     */
    function hideModal() {
        console.log('❌ Hiding confirmation modal');
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            confirmationModal.classList.add('hidden');
            confirmationModal.classList.remove('flex');
        }, 300);
        giftData = {};
    }

    /**
     * Shows the upgrade modal for FREE users
     */
    function showUpgradeModal() {
        console.log('⬆️ Showing upgrade modal');
        if (upgradeModal) {
            upgradeModal.classList.remove('hidden');
            upgradeModal.classList.add('flex');
        }
    }

    /**
     * Hides the upgrade modal
     */
    function hideUpgradeModal() {
        console.log('❌ Hiding upgrade modal');
        if (upgradeModal) {
            upgradeModal.classList.add('hidden');
            upgradeModal.classList.remove('flex');
        }
    }

    // ============================================================================
    // USAGE LIMIT FUNCTIONS
    // ============================================================================
    
    /**
     * Checks if user can send gifts based on subscription and usage limits
     * @returns {boolean} True if user can send gifts, false otherwise
     */
    function checkGiftUsageLimit() {
        const canGift = isUserPremium || giftUsageRemaining > 0;
        console.log(`🎁 Gift usage check: ${canGift} (Premium: ${isUserPremium}, Remaining: ${giftUsageRemaining})`);
        return canGift;
    }

    // ============================================================================
    // TAB SWITCHING FUNCTIONALITY
    // ============================================================================
    
    /**
     * Activates a specific tab and shows its content
     * @param {HTMLElement} selectedTab - The tab button to activate
     */
    function activateTab(selectedTab) {
        console.log(`📑 Activating tab: ${selectedTab.textContent.trim()}`);
        
        historyTabs.forEach(tab => {
            const targetId = tab.dataset.tabsTarget;
            const targetContent = document.querySelector(targetId);
            if (!targetContent) return;

            if (tab === selectedTab) {
                // Activate selected tab
                tab.setAttribute('aria-selected', 'true');
                tab.style.backgroundColor = '#091e65';
                tab.classList.add('text-white');
                tab.classList.remove('text-gray-600', 'hover:text-gray-900', 'hover:bg-gray-100');
                targetContent.classList.remove('hidden');
            } else {
                // Deactivate other tabs
                tab.setAttribute('aria-selected', 'false');
                tab.style.backgroundColor = '';
                tab.classList.remove('text-white');
                tab.classList.add('text-gray-600', 'hover:text-gray-900', 'hover:bg-gray-100');
                targetContent.classList.add('hidden');
            }
        });
    }

    // ============================================================================
    // FORM VALIDATION FUNCTIONS
    // ============================================================================
    
    /**
     * Validates the gift form inputs
     * @param {string} recipient - Recipient username or email
     * @param {number} amount - Gift amount
     * @returns {Object} Validation result with success flag and error message
     */
    function validateGiftForm(recipient, amount) {
        // Validate recipient
        if (!recipient) {
            return {
                success: false,
                error: "Please enter the recipient's username or email.",
                field: 'recipient'
            };
        }

        // Validate amount
        if (isNaN(amount) || amount <= 0) {
            return {
                success: false,
                error: "Please enter a valid, positive amount of coins.",
                field: 'amount'
            };
        }

        // Check user balance
        const currentBalance = parseInt(coinBalanceElement.textContent.replace(/,/g, ''), 10);
        if (amount > currentBalance) {
            return {
                success: false,
                error: "Insufficient balance for this gift amount.",
                field: 'amount'
            };
        }

        return { success: true };
    }

    // ============================================================================
    // GIFT SENDING FUNCTIONALITY
    // ============================================================================
    
    /**
     * Handles the gift form submission process
     * @param {Event} event - Click event from send gift button
     */
    function handleGiftSubmission(event) {
        event.preventDefault();
        console.log('🎁 Processing gift submission');
        
        // Check usage limits first
        if (!checkGiftUsageLimit()) {
            console.log('⚠️ Gift usage limit reached');
            showUpgradeModal();
            return;
        }

        // Get form values
        const recipient = recipientInput.value.trim();
        const amount = parseInt(amountInput.value, 10);

        // Validate form inputs
        const validation = validateGiftForm(recipient, amount);
        if (!validation.success) {
            console.log(`❌ Validation failed: ${validation.error}`);
            showNotification(validation.error, 'error');
            
            // Focus the problematic field
            if (validation.field === 'recipient') {
                recipientInput.focus();
            } else if (validation.field === 'amount') {
                amountInput.focus();
            }
            return;
        }

        // Store gift data and show confirmation modal
        giftData = { recipient, amount };
        confirmTo.textContent = recipient;
        confirmAmount.textContent = amount.toLocaleString();
        showModal();
    }

    /**
     * Sends the gift via AJAX to the server
     */
    function sendGiftToServer() {
        console.log('📤 Sending gift to server:', giftData);
        
        // Disable button and show loading state
        confirmSendBtn.disabled = true;
        confirmSendBtn.innerHTML = '<svg class="w-4 h-4 inline mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Sending...';

        // Make AJAX request
        fetch("{% url 'AudioXApp:gift_coins' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(giftData)
        })
        .then(async response => {
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.message || 'Server error');
            }
            return data;
        })
        .then(data => {
            console.log('✅ Gift sent successfully:', data);
            
            // Handle different response statuses
            if (data.status === 'limit_reached') {
                hideModal();
                showUpgradeModal();
                return;
            }
            
            if (data.status !== 'success') {
                throw new Error(data.message || 'Gift transfer failed');
            }
            
            // Success handling
            hideModal();
            showNotification(data.message || 'Gift sent successfully!', 'success');

            // Update balance displays with animation
            if (coinBalanceElement && typeof data.new_balance !== 'undefined') {
                const startBalance = parseInt(coinBalanceElement.textContent.replace(/,/g, ''), 10) || 0;
                animateValue(coinBalanceElement, startBalance, data.new_balance, 800);
            }
            
            if (headerCoinBalance && typeof data.new_balance !== 'undefined') {
                const startHeaderBalance = parseInt(headerCoinBalance.textContent.replace(/,/g, ''), 10) || 0;
                animateValue(headerCoinBalance, startHeaderBalance, data.new_balance, 800);
            }

            // Reset form
            if (giftForm) {
                giftForm.reset();
            }
        })
        .catch(error => {
            console.error('❌ Error sending gift:', error);
            hideModal();
            showNotification(error.message || 'An error occurred. Please try again.', 'error');
        })
        .finally(() => {
            // Reset button state
            confirmSendBtn.disabled = false;
            confirmSendBtn.innerHTML = '<svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Confirm & Send';
        });
    }

    // ============================================================================
    // EVENT LISTENERS SETUP
    // ============================================================================
    
    // Gift form submission
    if (sendGiftBtn && giftForm) {
        sendGiftBtn.addEventListener('click', handleGiftSubmission);
        console.log('🎁 Gift form event listener attached');
    }

    // Modal event listeners
    if (cancelSendBtn) {
        cancelSendBtn.addEventListener('click', hideModal);
    }
    
    if (confirmSendBtn) {
        confirmSendBtn.addEventListener('click', sendGiftToServer);
    }

    // Upgrade modal event listeners
    if (closeUpgradeModalBtn) {
        closeUpgradeModalBtn.addEventListener('click', hideUpgradeModal);
    }

    // Tab switching event listeners
    historyTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            activateTab(e.currentTarget);
        });
    });

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    
    // Initialize first tab as active
    if (historyTabs.length > 0) {
        activateTab(historyTabs[0]);
        console.log('📑 Initialized first tab as active');
    }

    // Animate initial balance display
    if (coinBalanceElement) {
        const endValue = parseInt(coinBalanceElement.textContent.replace(/,/g, ''), 10);
        if (!isNaN(endValue) && endValue >= 0) {
            coinBalanceElement.textContent = '0';
            setTimeout(() => {
                animateValue(coinBalanceElement, 0, endValue, 1200);
            }, 100);
        }
    }

    console.log('✅ Wallet page JavaScript initialization complete');
});

/**
 * ============================================================================
 * END OF WALLET JAVASCRIPT MODULE
 * ============================================================================
 */
</script>

{% endblock %}

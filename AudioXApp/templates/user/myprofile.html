{% extends 'Homepage.html' %}
{% load static %}
{% load tz %} {# Load timezone if needed #}

{% block title %}AudioX - Account Settings{% endblock %}

{% block content %}
{# Tailwind CSS, JS libraries, and config are inherited from Homepage.html #}

{# Main content wrapper with a subtle background #}
<div class="min-h-screen bg-gradient-to-b from-slate-50 via-white to-slate-100 py-12 md:py-20">

    {# Page Header - Centered #}
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 mb-10 md:mb-14 text-center">
        <h1 class="text-4xl md:text-5xl font-bold text-theme-primary tracking-tight">Account Settings</h1>
        <p class="mt-2 text-base text-slate-600">Manage your profile details and security preferences.</p>
    </div>

    {# Main Content Area - Centered Card Layout #}
    <div class="max-w-5xl w-full mx-auto px-4 sm:px-6 lg:px-8"> {# Slightly wider card container #}

        {# Combined Card for Settings #}
        <div class="bg-white rounded-2xl shadow-xl border border-slate-200/60 ring-1 ring-black/5 overflow-hidden">

            {# Tab Navigation - Enhanced Pill style #}
            <div class="px-4 sm:px-6 pt-5 border-b border-slate-200 bg-slate-50/50">
                <nav class="flex space-x-2 sm:space-x-3" aria-label="Tabs">
                    <button id="profile-info-tab" data-target="profile-info-content" class="profile-tab group inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-semibold rounded-t-lg border-b-2 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-theme-primary/80 transition-all duration-150 ease-in-out" aria-current="page">
                        <i class="fas fa-user-edit text-base opacity-70 group-aria-[current=page]:opacity-100"></i>
                        Profile
                    </button>
                    <button id="security-tab" data-target="security-content" class="profile-tab group inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-medium rounded-t-lg border-b-2 border-transparent text-slate-500 hover:text-slate-800 hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-theme-primary/80 transition-all duration-150 ease-in-out" aria-current="false">
                        <i class="fas fa-shield-alt text-base opacity-70 group-aria-[current=page]:opacity-100"></i>
                        Security
                    </button>
                    {# Add more tabs here if needed #}
                </nav>
                {# Active Tab Indicator Styling (using aria-current) - Refined #}
                <style>
                    .profile-tab[aria-current="page"] {
                        color: var(--theme-primary, #091e65);
                        border-color: var(--theme-primary, #091e65);
                        background-color: #ffffff; /* Match card background */
                        font-weight: 600; /* Semibold for active tab */
                    }
                    .profile-tab[aria-current="page"] i {
                        color: var(--theme-primary, #091e65);
                    }
                </style>
            </div>

            {# Message Area - Placed prominently #}
            <div id="profile-update-message" class="px-6 md:px-8 pt-5 min-h-[2.5rem]"></div> {# Placeholder #}
            <input type="hidden" id="update-profile-url" data-url="{% url 'AudioXApp:update_profile' %}">
            <input type="hidden" id="update-2fa-url" data-url="{% url 'AudioXApp:update_profile' %}">

            {# Content Sections #}
            <div class="p-6 md:p-10"> {# Increased padding #}
                {# --- Profile Settings Section --- #}
                <section id="profile-info-content" class="profile-section">
                    <div class="space-y-10"> {# Increased spacing #}
                        {# Profile Picture Upload Area #}
                        <div>
                            <h3 class="text-lg font-semibold text-slate-800 mb-1">Profile Picture</h3>
                            <p class="text-sm text-slate-500 mb-5">Update your avatar.</p>
                            <div class="flex flex-col sm:flex-row items-start sm:items-center sm:space-x-6 space-y-4 sm:space-y-0 pl-1">
                                <div class="relative flex-shrink-0">
                                    <div class="w-28 h-28 rounded-full overflow-hidden border-2 border-slate-300 bg-slate-100 shadow-md ring-4 ring-offset-1 ring-theme-primary/20"> {# Larger size, added ring #}
                                        {% if user.profile_pic %}
                                        <img src="{{ user.profile_pic.url }}" alt="Profile Picture" class="w-full h-full object-cover" id="profile-img-main">
                                        {% else %}
                                        <div class="w-full h-full flex items-center justify-center text-slate-400" id="profile-img-placeholder-main"> <i class="fas fa-user fa-3x"></i> </div>
                                        <img src="" alt="" class="w-full h-full object-cover hidden" id="profile-img-main">
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3 flex-wrap gap-2">
                                    <label for="photo" class="cursor-pointer inline-flex items-center justify-center gap-1.5 bg-white hover:bg-slate-50 border border-slate-300 text-slate-700 font-medium py-2 px-5 rounded-lg transition duration-150 text-sm shadow-sm focus-within:ring-2 focus-within:ring-offset-1 focus-within:ring-theme-primary">
                                        <i class="fas fa-upload text-xs opacity-70"></i> Change
                                    </label>
                                    <input type="file" id="photo" name="profile_pic" accept="image/png, image/jpeg, image/gif" class="hidden">
                                    <button type="button" id="save-profile-pic" class="hidden inline-flex items-center justify-center gap-1 bg-theme-green-light hover:bg-green-200 text-theme-green font-medium py-2 px-4 rounded-lg transition duration-150 text-sm shadow-sm"> <i class="fas fa-check mr-1"></i> Save </button>
                                    <button type="button" id="remove-profile-pic" class="{% if not user.profile_pic %}hidden{% endif %} inline-flex items-center justify-center gap-1 bg-theme-error-light hover:bg-red-200 text-theme-error font-medium py-2 px-4 rounded-lg transition duration-150 text-sm shadow-sm" title="Remove Photo"> <i class="fas fa-times"></i> Remove </button>
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-3 pl-1">PNG, JPG or GIF. Max size of 5MB.</p>
                        </div>

                        {# Divider #}
                        <hr class="border-slate-200/80">

                        {# Form Fields - Refined Styling #}
                        <div>
                            <h3 class="text-lg font-semibold text-slate-800 mb-1">Personal Details</h3>
                            <p class="text-sm text-slate-500 mb-6">Update your account information.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6"> {# Increased gap #}
                                {# Username Field - EDITABLE #}
                                <div class="relative group"> {# Added group for floating label effect #}
                                    <input type="text" id="username" name="username" value="{{ user.username }}"
                                           class="form-input peer block w-full px-3.5 pb-2 pt-5 border border-slate-300 rounded-lg text-sm shadow-sm bg-white text-slate-900 placeholder-transparent focus:outline-none focus:border-theme-primary focus:ring-1 focus:ring-theme-primary read-only:bg-slate-100 read-only:text-slate-600 read-only:cursor-default"
                                           placeholder="Username" readonly> {# Placeholder needed for floating label #}
                                    <label for="username"
                                           class="absolute text-sm text-slate-500 duration-300 transform -translate-y-3.5 scale-75 top-4 z-10 origin-[0] start-3.5 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-3.5 peer-focus:text-theme-primary rtl:peer-focus:translate-x-1/4 rtl:peer-focus:left-auto pointer-events-none">
                                        Username
                                    </label>
                                    <div class="absolute top-1/2 -translate-y-1/2 right-0 flex items-center pr-3">
                                        <button type="button" class="edit-icon form-icon-button p-1.5 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition duration-150 focus:outline-none text-sm" data-target="username" title="Edit Username"> <i class="fas fa-pencil-alt"></i> </button>
                                        <button type="button" class="save-icon hidden form-icon-button p-1.5 rounded-full text-green-600 hover:text-green-700 hover:bg-green-100 transition duration-150 focus:outline-none text-sm" data-target="username" title="Save Username"> <i class="fas fa-check-circle text-base"></i> </button>
                                    </div>
                                </div>
                                {# Full Name Field #}
                                <div class="relative group">
                                    <input type="text" id="name" name="full_name" value="{{ user.full_name|default:'' }}"
                                           class="form-input peer block w-full px-3.5 pb-2 pt-5 border border-slate-300 rounded-lg text-sm shadow-sm bg-white text-slate-900 placeholder-transparent focus:outline-none focus:border-theme-primary focus:ring-1 focus:ring-theme-primary read-only:bg-slate-100 read-only:text-slate-600 read-only:cursor-default"
                                           placeholder="Full Name" readonly>
                                    <label for="name"
                                           class="absolute text-sm text-slate-500 duration-300 transform -translate-y-3.5 scale-75 top-4 z-10 origin-[0] start-3.5 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-3.5 peer-focus:text-theme-primary rtl:peer-focus:translate-x-1/4 rtl:peer-focus:left-auto pointer-events-none">
                                        Full Name
                                    </label>
                                    <div class="absolute top-1/2 -translate-y-1/2 right-0 flex items-center pr-3">
                                        <button type="button" class="edit-icon form-icon-button p-1.5 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition duration-150 focus:outline-none text-sm" data-target="name" title="Edit Name"> <i class="fas fa-pencil-alt"></i> </button>
                                        <button type="button" class="save-icon hidden form-icon-button p-1.5 rounded-full text-green-600 hover:text-green-700 hover:bg-green-100 transition duration-150 focus:outline-none text-sm" data-target="name" title="Save Name"> <i class="fas fa-check-circle text-base"></i> </button>
                                    </div>
                                </div>
                                {# Email Field #}
                                <div class="relative group"> {# Changed from md:col-span-2 to allow phone number next to it #}
                                    <input type="email" id="email" name="email" value="{{ user.email }}"
                                           class="form-input peer block w-full px-3.5 pb-2 pt-5 border border-slate-300 rounded-lg text-sm shadow-sm bg-white text-slate-900 placeholder-transparent focus:outline-none focus:border-theme-primary focus:ring-1 focus:ring-theme-primary read-only:bg-slate-100 read-only:text-slate-600 read-only:cursor-default"
                                           placeholder="Email Address" readonly>
                                    <label for="email"
                                           class="absolute text-sm text-slate-500 duration-300 transform -translate-y-3.5 scale-75 top-4 z-10 origin-[0] start-3.5 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-3.5 peer-focus:text-theme-primary rtl:peer-focus:translate-x-1/4 rtl:peer-focus:left-auto pointer-events-none">
                                        Email Address
                                    </label>
                                    <div class="absolute top-1/2 -translate-y-1/2 right-0 flex items-center pr-3">
                                        <button type="button" class="edit-icon form-icon-button p-1.5 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition duration-150 focus:outline-none text-sm" data-target="email" title="Edit Email"> <i class="fas fa-pencil-alt"></i> </button>
                                        <button type="button" class="save-icon hidden form-icon-button p-1.5 rounded-full text-green-600 hover:text-green-700 hover:bg-green-100 transition duration-150 focus:outline-none text-sm" data-target="email" title="Save Email"> <i class="fas fa-check-circle text-base"></i> </button>
                                    </div>
                                </div>
                                {# Phone Number Field - NEW #}
                                <div class="relative group">
                                    <input type="tel" id="phone_number" name="phone_number" value="{{ user.phone_number|default:'' }}"
                                           class="form-input peer block w-full px-3.5 pb-2 pt-5 border border-slate-300 rounded-lg text-sm shadow-sm bg-white text-slate-900 placeholder-transparent focus:outline-none focus:border-theme-primary focus:ring-1 focus:ring-theme-primary read-only:bg-slate-100 read-only:text-slate-600 read-only:cursor-default"
                                           placeholder="Phone Number (e.g., +923xxxxxxxxx)" readonly>
                                    <label for="phone_number"
                                           class="absolute text-sm text-slate-500 duration-300 transform -translate-y-3.5 scale-75 top-4 z-10 origin-[0] start-3.5 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-3.5 peer-focus:text-theme-primary rtl:peer-focus:translate-x-1/4 rtl:peer-focus:left-auto pointer-events-none">
                                        Phone Number
                                    </label>
                                    <div class="absolute top-1/2 -translate-y-1/2 right-0 flex items-center pr-3">
                                        <button type="button" class="edit-icon form-icon-button p-1.5 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition duration-150 focus:outline-none text-sm" data-target="phone_number" title="Edit Phone Number"> <i class="fas fa-pencil-alt"></i> </button>
                                        <button type="button" class="save-icon hidden form-icon-button p-1.5 rounded-full text-green-600 hover:text-green-700 hover:bg-green-100 transition duration-150 focus:outline-none text-sm" data-target="phone_number" title="Save Phone Number"> <i class="fas fa-check-circle text-base"></i> </button>
                                    </div>
                                </div>
                                {# Bio Field #}
                                <div class="md:col-span-2 relative group">
                                    <textarea id="bio" name="bio" rows="4"
                                              class="form-input peer block w-full px-3.5 pb-2 pt-5 border border-slate-300 rounded-lg text-sm shadow-sm bg-white text-slate-900 placeholder-transparent focus:outline-none focus:border-theme-primary focus:ring-1 focus:ring-theme-primary read-only:bg-slate-100 read-only:text-slate-600 read-only:cursor-default resize-none min-h-[120px]"
                                              placeholder="Bio" readonly>{{ user.bio|default:'' }}</textarea>
                                    <label for="bio"
                                           class="absolute text-sm text-slate-500 duration-300 transform -translate-y-3.5 scale-75 top-4 z-10 origin-[0] start-3.5 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-3.5 peer-focus:text-theme-primary rtl:peer-focus:translate-x-1/4 rtl:peer-focus:left-auto pointer-events-none">
                                        Bio (Optional)
                                    </label>
                                    <div class="absolute top-3 right-0 flex items-center pr-3"> {# Adjusted position for textarea #}
                                        <button type="button" class="edit-icon form-icon-button p-1.5 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition duration-150 focus:outline-none text-sm" data-target="bio" title="Edit Bio"> <i class="fas fa-pencil-alt"></i> </button>
                                        <button type="button" class="save-icon hidden form-icon-button p-1.5 rounded-full text-green-600 hover:text-green-700 hover:bg-green-100 transition duration-150 focus:outline-none text-sm" data-target="bio" title="Save Bio"> <i class="fas fa-check-circle text-base"></i> </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                {# --- Security Section --- #}
                <section id="security-content" class="profile-section hidden">
                    <div class="space-y-10">
                        {# Change Password Sub-section #}
                        <div class="p-6 rounded-lg border border-slate-200 bg-slate-50/50">
                            <div class="flex items-start mb-5 gap-4">
                                <div class="bg-theme-primary text-white p-3 rounded-lg shadow-md flex-shrink-0 ring-1 ring-black/5 mt-1">
                                    <i class="fas fa-key fa-fw text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-slate-800">Change Password</h3>
                                    <p class="text-sm text-slate-500 mt-0.5">Update your password regularly for better security.</p>
                                </div>
                            </div>
                            <form method="post" id="change-password-form" action="{% url 'AudioXApp:change_password' %}" class="space-y-5 max-w-lg ml-4 md:ml-[4.25rem]">
                                {% csrf_token %}
                                {# Current Password #}
                                <div class="relative">
                                    <label for="old_password" class="block text-sm font-medium text-slate-700 mb-1.5 sr-only">Current Password</label>
                                    <div class="password-input-wrapper relative">
                                        <i class="fas fa-lock input-icon absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                        <input type="password" id="old_password" name="old_password" required
                                               class="form-input block w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg text-slate-900 placeholder-slate-400 text-sm shadow-sm bg-white focus:ring-1 focus:ring-theme-primary focus:border-theme-primary" placeholder="Current Password">
                                    </div>
                                    <div id="error-old_password" class="form-error text-red-600 text-xs mt-1 h-4 invisible"></div>
                                </div>
                                {# New Password #}
                                <div class="relative">
                                    <label for="new_password1" class="block text-sm font-medium text-slate-700 mb-1.5 sr-only">New Password</label>
                                    <div class="password-input-wrapper relative">
                                        <i class="fas fa-lock input-icon absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                        <input type="password" id="new_password1" name="new_password1" required
                                               class="form-input block w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg text-slate-900 placeholder-slate-400 text-sm shadow-sm bg-white focus:ring-1 focus:ring-theme-primary focus:border-theme-primary" placeholder="New Password">
                                    </div>
                                    <div id="error-new_password1" class="form-error text-red-600 text-xs mt-1 h-4 invisible"></div>
                                </div>
                                {# Confirm New Password #}
                                <div class="relative">
                                    <label for="new_password2" class="block text-sm font-medium text-slate-700 mb-1.5 sr-only">Confirm New Password</label>
                                    <div class="password-input-wrapper relative">
                                        <i class="fas fa-lock input-icon absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                        <input type="password" id="new_password2" name="new_password2" required
                                               class="form-input block w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg text-slate-900 placeholder-slate-400 text-sm shadow-sm bg-white focus:ring-1 focus:ring-theme-primary focus:border-theme-primary" placeholder="Confirm New Password">
                                    </div>
                                    <div id="error-new_password2" class="form-error text-red-600 text-xs mt-1 h-4 invisible"></div>
                                </div>
                                {# Submit Button #}
                                <div class="pt-2">
                                    <button type="submit" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 bg-theme-primary hover:bg-theme-primary-hover text-white font-semibold py-2.5 px-8 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-theme-primary shadow-md hover:shadow-lg text-sm transform hover:-translate-y-0.5">
                                        <i class="fas fa-save mr-1"></i> Update Password
                                    </button>
                                </div>
                                <div id="password-change-message" class="mt-4 text-sm h-5"></div> {# Placeholder #}
                            </form>
                        </div>

                        {# Two-Factor Authentication Sub-section #}
                        <div class="p-6 rounded-lg border border-slate-200 bg-slate-50/50">
                            <div class="flex items-start mb-4 gap-4">
                                <div class="bg-theme-primary text-white p-3 rounded-lg shadow-md flex-shrink-0 ring-1 ring-black/5 mt-1">
                                    <i class="fas fa-mobile-alt fa-fw text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-slate-800">Two-Factor Authentication</h3>
                                    <p class="text-sm text-slate-500 mt-0.5">Add an extra layer of security to your account.</p>
                                </div>
                            </div>
                            <div class="ml-4 md:ml-[4.25rem]"> {# Align with content below icon #}
                                <p class="text-sm text-slate-600 mb-5 max-w-xl leading-relaxed">
                                    When enabled, we'll send a verification code to your email (<strong class="font-medium text-slate-800">{{ user.email }}</strong>) each time you sign in from a new device or browser.
                                </p>
                                <div class="flex items-center space-x-4 p-4 bg-white rounded-lg border border-slate-200 shadow-sm">
                                    {# Tailwind Toggle Switch #}
                                    <div class="relative inline-block w-11 h-6 toggle-container flex-shrink-0">
                                        <input type="checkbox" name="toggle_2fa" id="toggle_2fa"
                                               class="absolute w-5 h-5 top-0.5 left-0.5 appearance-none rounded-full bg-white border border-slate-300 shadow-sm cursor-pointer transition-all duration-200 ease-in-out checked:bg-white checked:border-theme-primary checked:translate-x-full checked:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-theme-primary/50 peer"
                                               {% if user.is_2fa_enabled %}checked{% endif %}
                                               aria-labelledby="2fa-label"
                                        />
                                        <label for="toggle_2fa" class="block w-full h-full rounded-full bg-slate-300 transition-colors duration-200 ease-in-out cursor-pointer peer-checked:bg-theme-primary"></label>
                                    </div>
                                    {# Status Indicator & Label #}
                                    <span id="2fa-label" class="text-sm font-medium text-slate-700 flex-grow">
                                        Two-Factor Authentication is currently
                                        <span id="2fa-status" class="font-semibold ml-1">
                                            {% if user.is_2fa_enabled %}
                                                <span class="text-theme-green">Enabled</span>
                                            {% else %}
                                                <span class="text-slate-500">Disabled</span>
                                            {% endif %}
                                        </span>
                                    </span>
                                    {# Loading Spinner #}
                                    <div id="2fa-spinner" class="hidden ml-2 flex-shrink-0">
                                        <i class="fas fa-spinner fa-spin text-slate-500"></i>
                                    </div>
                                </div>
                                <div id="2fa-update-message" class="mt-3 text-sm h-5 ml-1"></div> {# Placeholder #}
                            </div>
                        </div>

                    </div>
                </section>
            </div>
        </div>

    </div>

    {# Confirmation Modal (Tailwind Styled - Refined) #}
    <div id="confirm-save-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[110] p-4 transition-opacity duration-300 ease-out opacity-0">
        <div class="bg-white rounded-xl p-6 md:p-8 shadow-2xl border border-slate-300 w-full max-w-md transform transition-all duration-300 ease-out scale-95 opacity-0" id="confirm-modal-content">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-semibold text-slate-800">Confirm Change</h2>
                <button type="button" id="confirm-save-cancel-x" class="text-slate-400 hover:text-slate-600 transition-colors" aria-label="Close"> <i class="fas fa-times text-lg"></i> </button>
            </div>
            <p class="text-sm text-slate-600 mb-6" id="confirm-save-message">Are you sure you want to save this change?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-save-cancel" class="inline-flex items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white px-5 py-2 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">Cancel</button>
                <button id="confirm-save-confirm" class="inline-flex items-center justify-center gap-2 rounded-lg bg-theme-primary px-5 py-2 text-sm font-semibold text-white shadow-md hover:bg-theme-primary-hover focus:outline-none focus:ring-2 focus:ring-theme-primary focus:ring-offset-2 transition duration-150 ease-in-out">Confirm</button>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block javascript %}
{# Ensure SweetAlert2 is loaded in Homepage.html #}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- DOM Element References ---
    const profilePictureImgMain = document.getElementById('profile-img-main');
    const profilePicturePlaceholderMain = document.getElementById('profile-img-placeholder-main');
    const photoInput = document.getElementById('photo');
    const saveProfilePicButton = document.getElementById('save-profile-pic');
    const removeProfilePicButton = document.getElementById('remove-profile-pic');
    const updateMessageDiv = document.getElementById('profile-update-message');
    const updateProfileURL = document.getElementById('update-profile-url')?.getAttribute('data-url');
    // Tab Navigation
    const profileTabs = document.querySelectorAll('.profile-tab');
    const contentSections = document.querySelectorAll('.profile-section');
    // Confirmation Modal
    const confirmSaveModal = document.getElementById('confirm-save-modal');
    const confirmModalContent = document.getElementById('confirm-modal-content');
    const confirmSaveMessage = document.getElementById('confirm-save-message');
    const confirmSaveCancel = document.getElementById('confirm-save-cancel');
    const confirmSaveConfirm = document.getElementById('confirm-save-confirm');
    const confirmSaveCancelX = document.getElementById('confirm-save-cancel-x'); // Added X button
    // Password Change
    const changePasswordForm = document.getElementById('change-password-form');
    const passwordChangeMessage = document.getElementById('password-change-message');
    // 2FA Elements
    const toggle2FA = document.getElementById('toggle_2fa');
    const status2FA = document.getElementById('2fa-status');
    const spinner2FA = document.getElementById('2fa-spinner');
    const message2FA = document.getElementById('2fa-update-message');
    const update2FA_URL = document.getElementById('update-2fa-url')?.getAttribute('data-url');

    let pendingChanges = {};
    let fieldToSave = null;

    // --- Helper: Get CSRF Token ---
    function getCookie(name) {
        let cookieValue = null; if (document.cookie && document.cookie !== '') { const cookies = document.cookie.split(';'); for (let i = 0; i < cookies.length; i++) { const cookie = cookies[i].trim(); if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; } } } return cookieValue;
    }

    // --- Helper: Show Notifications (Uses SwalStyled from Homepage.html with premium overrides) ---
    function showMessage(title, text, icon = 'info') {
        // Use the base styled Swal from Homepage.html if available
        const BaseSwal = typeof SwalStyled !== 'undefined' ? SwalStyled : Swal;

        // Apply further premium customizations
        const PremiumSwal = BaseSwal.mixin({
            customClass: {
                popup: 'rounded-xl shadow-xl border border-slate-100 p-6', // Enhanced popup style
                title: `text-xl font-semibold mb-2 ${icon === 'success' ? 'text-theme-green' : icon === 'error' ? 'text-theme-error' : 'text-theme-primary'}`, // Colored title based on icon
                htmlContainer: 'text-sm text-slate-600 leading-relaxed',
                confirmButton: 'inline-flex items-center justify-center gap-2 rounded-lg bg-theme-primary px-5 py-2.5 text-sm font-semibold text-white shadow-md hover:bg-theme-primary-hover focus:outline-none focus:ring-2 focus:ring-theme-primary focus:ring-offset-2 transition duration-150 ease-in-out', // Re-apply base confirm style if needed
                cancelButton: 'inline-flex items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white px-5 py-2.5 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out', // Re-apply base cancel style if needed
                icon: `p-2 rounded-full text-2xl ${icon === 'success' ? 'bg-theme-green-light text-theme-green' : icon === 'error' ? 'bg-theme-error-light text-theme-error' : 'bg-theme-primary-lighter text-theme-primary'}`, // Styled icon background
            },
            buttonsStyling: false, // Ensure custom classes are used
            showClass: { popup: 'animate__animated animate__fadeInDown animate__faster' }, // Example animation (requires Animate.css)
            hideClass: { popup: 'animate__animated animate__fadeOutUp animate__faster' }
        });

        PremiumSwal.fire({ title: title, text: text, icon: icon });
    }

    // --- Helper: Show/Hide Sections based on Tabs ---
    function showSection(sectionId) {
        contentSections.forEach(section => {
            if (section.id === sectionId) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        });
    }

    // --- Helper: Activate Tab ---
    function activateTab(activeTab) {
        profileTabs.forEach(tab => {
            if (tab === activeTab) {
                tab.setAttribute('aria-current', 'page');
                // Style is handled by CSS selector [aria-current="page"]
            } else {
                tab.removeAttribute('aria-current');
            }
        });
    }

    // --- Helper: Set Input State (Readonly/Editable) using Tailwind ---
    function setInputState(inputField, isEditable) {
        if (!inputField) return;
        // Use the 'peer' class approach for floating labels
        const readOnlyClasses = ['bg-slate-100', 'text-slate-600', 'cursor-default', 'focus:ring-0', 'focus:border-slate-300'];
        const editableClasses = ['bg-white', 'text-slate-900', 'placeholder-slate-400', 'focus:ring-1', 'focus:ring-theme-primary', 'focus:border-theme-primary'];

        inputField.readOnly = !isEditable;
        if (isEditable) {
            inputField.classList.remove(...readOnlyClasses);
            inputField.classList.add(...editableClasses);
            // Ensure placeholder is set for floating label to work correctly when empty
            // For phone number, we can use a specific placeholder when editable.
            if (inputField.id === 'phone_number' && !inputField.placeholder) {
                 inputField.placeholder = '+923xxxxxxxxx';
            } else if (!inputField.placeholder) {
                const label = document.querySelector(`label[for="${inputField.id}"]`);
                if (label) inputField.placeholder = label.textContent.trim();
            }
        } else {
            inputField.classList.remove(...editableClasses);
            inputField.classList.add(...readOnlyClasses);
            // Remove placeholder when readonly if using floating labels, looks cleaner
            inputField.placeholder = ' '; // Use space to keep label floated if needed, or ""
        }
    }


    // --- Helper: Display Password Field Errors ---
    function displayFieldErrors(errors) {
        const errorDivs = changePasswordForm ? changePasswordForm.querySelectorAll('.form-error') : [];
        errorDivs.forEach(el => { el.textContent = ''; el.classList.add('invisible'); }); // Hide all first
        if (passwordChangeMessage) passwordChangeMessage.textContent = '';

        let hasErrors = false;
        for (const field in errors) {
            hasErrors = true;
            const errorDiv = document.getElementById(`error-${field}`);
            const message = Array.isArray(errors[field]) ? errors[field].join(' ') : errors[field];
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('invisible'); // Show specific error
            } else {
                // Fallback for general errors if specific div not found
                if (passwordChangeMessage) {
                    passwordChangeMessage.textContent += `${field}: ${message}\n`;
                    passwordChangeMessage.className = 'text-red-600 text-xs mt-1 h-5'; // Ensure style is error
                }
            }
        }
        return hasErrors;
    }

    // --- Confirmation Modal Logic ---
    function showConfirmationModal(message, fieldId) {
        fieldToSave = fieldId;
        pendingChanges = {};
        const inputField = document.getElementById(fieldId);
        if (inputField) { pendingChanges[fieldId] = inputField.value; }
        else { console.error("Input field not found for confirmation:", fieldId); return; }

        confirmSaveMessage.textContent = message;
        confirmSaveModal.classList.remove('hidden');
        setTimeout(() => {
            confirmSaveModal.classList.remove('opacity-0');
            if(confirmModalContent) {
                confirmModalContent.classList.remove('scale-95', 'opacity-0');
                confirmModalContent.classList.add('scale-100', 'opacity-100');
            }
        }, 10); // Small delay for transition start
    }

    function hideConfirmationModal() {
        if(confirmModalContent) {
            confirmModalContent.classList.remove('scale-100', 'opacity-100');
            confirmModalContent.classList.add('scale-95', 'opacity-0');
        }
        confirmSaveModal.classList.add('opacity-0');
        setTimeout(() => {
            confirmSaveModal.classList.add('hidden');
            pendingChanges = {};
            fieldToSave = null;
        }, 300); // Match transition duration
    }

    // --- AJAX Save Functions ---
    function saveProfileField(fieldId, fieldValue) {
        if (!updateProfileURL) { showMessage('Error', 'Configuration error: Update URL not found.', 'error'); return; }
        
        // Map frontend ID 'name' to backend 'full_name'. Other fields should match.
        const backendFieldName = (fieldId === 'name') ? 'full_name' : fieldId;
        const dataToSave = { [backendFieldName]: fieldValue };

        const saveIconElement = document.querySelector(`.save-icon[data-target="${fieldId}"]`);
        const editIconElement = document.querySelector(`.edit-icon[data-target="${fieldId}"]`);
        const originalIconHTML = saveIconElement ? saveIconElement.innerHTML : '';

        // Show loading state
        if (saveIconElement) {
            saveIconElement.innerHTML = '<i class="fas fa-spinner fa-spin text-base text-slate-500"></i>';
            saveIconElement.disabled = true;
        }
        if (editIconElement) editIconElement.classList.add('hidden'); // Hide edit icon during save

        fetch(updateProfileURL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify(dataToSave) })
        .then(async response => { 
            const isJson = response.headers.get('content-type')?.includes('application/json');
            const responseData = isJson ? await response.json() : null;
            if (!response.ok) { 
                let errorMsg = `HTTP error! Status: ${response.status} ${response.statusText}`; 
                if (responseData?.message) errorMsg = responseData.message; 
                else if (responseData?.error) errorMsg = responseData.error; 
                else if (responseData?.errors) errorMsg = Object.values(responseData.errors).flat().join(' '); 
                const error = new Error(errorMsg); 
                error.data = responseData; 
                error.status = response.status; 
                throw error; 
            } 
            return responseData;
        })
        .then(data => {
            if (data && data.status === 'success') {
                showMessage('Success', data.message || 'Profile updated successfully.', 'success');
                const inputField = document.getElementById(fieldId);
                if (inputField) setInputState(inputField, false); // Set back to readonly
                
                // Update sidebar/header if needed (e.g., username in header dropdown)
                if (fieldId === 'username') {
                    const headerUsername = document.querySelector('#profile-dropdown p[title*="username"]'); // Adjust selector if needed
                    if(headerUsername) headerUsername.textContent = fieldValue;
                }
            } else {
                showMessage('Error', data?.message || 'Failed to update profile.', 'error');
            }
        })
        .catch(error => {
            console.error('Error updating profile field:', error);
            showMessage('Error', error.message || 'An error occurred.', 'error');
            // Revert input state on error ONLY if it's not a validation error from backend
            if (!error.data || !error.data.errors) { // if no specific field errors from backend
                const inputField = document.getElementById(fieldId);
                if (inputField) {
                    // Potentially revert to original value if available, or just set to readonly
                    // For now, just setting to readonly. A more complex state management might be needed for perfect revert.
                    setInputState(inputField, false);
                }
            } else if (error.data && error.data.errors) {
                 // If there are specific field errors, keep the field editable for correction.
                const inputField = document.getElementById(fieldId);
                if (inputField) {
                    setInputState(inputField, true); // Keep editable
                    inputField.focus();
                }
            }
        })
        .finally(() => {
            // Restore icon state
            if (saveIconElement) {
                saveIconElement.innerHTML = originalIconHTML;
                saveIconElement.disabled = false;
                saveIconElement.classList.add('hidden'); // Hide save icon again
            }
            if (editIconElement) editIconElement.classList.remove('hidden'); // Show edit icon again
        });
    }

    function saveProfilePicture() {
        if (!photoInput || !photoInput.files || photoInput.files.length === 0) { showMessage('Info', 'Please select an image file first.', 'info'); return; }
        if (!updateProfileURL) { showMessage('Error', 'Config error: Update URL missing.', 'error'); return; }

        const formData = new FormData();
        formData.append('profile_pic', photoInput.files[0]);
        const originalButtonHTML = saveProfilePicButton.innerHTML;
        saveProfilePicButton.disabled = true;
        saveProfilePicButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Saving...';
        if(removeProfilePicButton) removeProfilePicButton.disabled = true;

        fetch(updateProfileURL, { method: 'POST', body: formData, headers: { 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' } })
        .then(async response => { 
            const isJson = response.headers.get('content-type')?.includes('application/json'); const data = isJson ? await response.json() : null; if (!response.ok) { const errorText = !isJson ? await response.text() : null; const errorMsg = data?.message || data?.error || (data?.errors ? Object.values(data.errors).flat().join(' ') : null) || errorText || `HTTP error! Status: ${response.status}`; const error = new Error(errorMsg); error.data = data; error.status = response.status; throw error; } return data;
        })
        .then(data => {
            if (data.status === 'success') {
                showMessage('Success', data.message || 'Profile picture updated.', 'success');
                saveProfilePicButton.classList.add('hidden');
                if (removeProfilePicButton) removeProfilePicButton.classList.remove('hidden');
                photoInput.value = ''; // Clear file input
                if (data.profile_pic_url) {
                    const newUrl = data.profile_pic_url + '?t=' + new Date().getTime(); // Cache buster
                    // Update main image
                    if(profilePictureImgMain) { profilePictureImgMain.src = newUrl; profilePictureImgMain.classList.remove('hidden'); }
                    if(profilePicturePlaceholderMain) profilePicturePlaceholderMain.classList.add('hidden');
                    // Update header image (if header dropdown uses it)
                    const headerProfilePic = document.querySelector('#profile-dropdown-toggle img'); // Get header img
                    const headerProfilePlaceholder = document.querySelector('#profile-dropdown-toggle span:not(.sr-only)'); // Get header placeholder span
                    if(headerProfilePic) { headerProfilePic.src = newUrl; headerProfilePic.classList.remove('hidden'); }
                    if(headerProfilePlaceholder) headerProfilePlaceholder.classList.add('hidden');
                }
            } else {
                showMessage('Error', data?.message || 'Failed to update picture.', 'error');
            }
        })
        .catch(error => {
            console.error('Error saving profile picture:', error);
            showMessage('Error', error.message || 'An error occurred.', 'error');
        })
        .finally(() => {
            saveProfilePicButton.disabled = false;
            saveProfilePicButton.innerHTML = originalButtonHTML; // Restore original text/icon
            if(removeProfilePicButton) removeProfilePicButton.disabled = false;
        });
    }

    function removeProfilePicture() {
        if (!updateProfileURL) { showMessage('Error', 'Config error: Update URL missing.', 'error'); return; }
        // Use styled Swal if available
        const SwalToShow = typeof SwalStyled !== 'undefined' ? SwalStyled : Swal;
        SwalToShow.fire({
            title: 'Are you sure?', text: "Do you want to remove your profile picture?", icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#6b7280',
            confirmButtonText: 'Yes, remove it!', cancelButtonText: 'Cancel',
            // customClass inherited via mixin usually, add specifics if needed
        }).then((result) => {
            if (result.isConfirmed) {
                const originalButtonHTML = removeProfilePicButton.innerHTML;
                removeProfilePicButton.disabled = true;
                removeProfilePicButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Removing...';
                if(saveProfilePicButton) saveProfilePicButton.disabled = true;

                fetch(updateProfileURL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ remove_profile_pic: true }) })
                .then(async response => { 
                    const isJson = response.headers.get('content-type')?.includes('application/json'); const data = isJson ? await response.json() : null; if (!response.ok) { const errorText = !isJson ? await response.text() : null; const errorMsg = data?.message || data?.error || errorText || `HTTP error! Status: ${response.status}`; const error = new Error(errorMsg); error.data = data; error.status = response.status; throw error; } return data;
                })
                .then(data => {
                    if (data.status === 'success') {
                        showMessage('Success', data.message || 'Profile picture removed.', 'success');
                        // Update main image
                        if (profilePictureImgMain) { profilePictureImgMain.src = ''; profilePictureImgMain.classList.add('hidden'); }
                        if (profilePicturePlaceholderMain) profilePicturePlaceholderMain.classList.remove('hidden');
                        // Update header image (if header dropdown uses it)
                        const headerProfilePic = document.querySelector('#profile-dropdown-toggle img');
                        const headerProfilePlaceholder = document.querySelector('#profile-dropdown-toggle span:not(.sr-only)');
                        if(headerProfilePic) { headerProfilePic.src = ''; headerProfilePic.classList.add('hidden'); } // Hide img
                        if(headerProfilePlaceholder) headerProfilePlaceholder.classList.remove('hidden'); // Show placeholder

                        // Hide buttons
                        removeProfilePicButton.classList.add('hidden');
                        if (saveProfilePicButton) saveProfilePicButton.classList.add('hidden');
                        if (photoInput) photoInput.value = ''; // Clear file input
                    } else {
                        showMessage('Error', data?.message || 'Failed to remove picture.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error removing profile picture:', error);
                    showMessage('Error', error.message || 'An error occurred.', 'error');
                })
                .finally(() => {
                    removeProfilePicButton.disabled = false;
                    removeProfilePicButton.innerHTML = originalButtonHTML; // Restore icon
                    if(saveProfilePicButton) {
                        saveProfilePicButton.disabled = true; // Keep save disabled if pic removed
                        saveProfilePicButton.classList.add('hidden');
                    }
                });
            }
        });
    }

    function handlePasswordChangeSubmit(event) {
        event.preventDefault();
        const submitButton = changePasswordForm.querySelector('button[type="submit"]');
        const originalButtonHTML = submitButton.innerHTML; // Store full HTML
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';

        const formData = new FormData(changePasswordForm);
        displayFieldErrors({}); // Clear previous errors
        if (passwordChangeMessage) passwordChangeMessage.textContent = '';

        fetch(changePasswordForm.action, { method: 'POST', body: formData, headers: { 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' } })
        .then(async response => { 
            const isJson = response.headers.get('content-type')?.includes('application/json'); const data = isJson ? await response.json() : null; if (!response.ok) { const errorText = !isJson ? await response.text() : null; const error = data || { message: errorText || `HTTP error! Status: ${response.status}` }; error.status = response.status; error.data = data; throw error; } return data;
        })
        .then(data => {
            if (data.status === 'success') {
                showMessage('Success', data.message || 'Password changed successfully!', 'success');
                changePasswordForm.reset();
                if (passwordChangeMessage) {
                    passwordChangeMessage.textContent = data.message || 'Password changed successfully!';
                    passwordChangeMessage.className = 'text-green-600 text-xs mt-1 h-5'; // Use success class
                }
                displayFieldErrors({}); // Clear errors on success
            } else {
                let displayedErrors = false;
                if (data.errors) { displayedErrors = displayFieldErrors(data.errors); }
                // Show general message only if no specific field errors were shown OR if a general message exists
                if (!displayedErrors || data.message) {
                    showMessage('Error', data.message || 'Failed to change password.', 'error');
                }
                if (passwordChangeMessage && data.message && !displayedErrors) {
                    passwordChangeMessage.textContent = data.message;
                    passwordChangeMessage.className = 'text-red-600 text-xs mt-1 h-5'; // Use error class
                }
            }
        })
        .catch(error => {
            console.error('Error changing password:', error);
            let displayedErrors = false;
            if (error.status === 400 && error.data && error.data.errors) {
                displayedErrors = displayFieldErrors(error.data.errors);
            }
            showMessage('Error', error.message || 'An unexpected error occurred.', 'error');
            if (passwordChangeMessage && !displayedErrors) {
                passwordChangeMessage.textContent = error.message || 'An unexpected error occurred.';
                passwordChangeMessage.className = 'text-red-600 text-xs mt-1 h-5'; // Use error class
            }
        })
        .finally(() => {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonHTML; // Restore original HTML
        });
    }

    // --- Function to handle 2FA Toggle ---
    function handle2FAToggle() {
        if (!toggle2FA || !status2FA || !spinner2FA || !message2FA || !update2FA_URL) {
            console.error("2FA elements or URL not found.");
            if(toggle2FA) toggle2FA.checked = !toggle2FA.checked; // Revert if elements missing
            return;
        }

        const isEnabled = toggle2FA.checked;
        const statusSpan = status2FA.querySelector('span');
        const originalStatusText = statusSpan ? statusSpan.textContent : (isEnabled ? 'Disabled' : 'Enabled');
        const originalStatusClass = statusSpan ? statusSpan.className : (isEnabled ? 'text-slate-500' : 'text-theme-green');

        // Show loading state
        spinner2FA.classList.remove('hidden');
        if (statusSpan) { statusSpan.textContent = 'Updating...'; statusSpan.className = 'text-slate-500'; }
        toggle2FA.disabled = true;
        message2FA.textContent = '';
        message2FA.className = 'mt-3 text-sm h-5 ml-1'; // Reset message class

        fetch(update2FA_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ is_2fa_enabled: isEnabled }) })
        .then(async response => { 
            const isJson = response.headers.get('content-type')?.includes('application/json'); const responseData = isJson ? await response.json() : { status: 'error', message: 'Invalid response from server.' }; if (!response.ok || responseData.status !== 'success') { let errorMsg = responseData.message || `Failed to update 2FA status (HTTP ${response.status})`; const error = new Error(errorMsg); error.data = responseData; throw error; } return responseData;
        })
        .then(data => {
            const successMsg = isEnabled ? 'Two-Factor Authentication enabled.' : 'Two-Factor Authentication disabled.';
            showMessage('Success', successMsg, 'success');
            if (statusSpan) {
                statusSpan.textContent = isEnabled ? 'Enabled' : 'Disabled';
                statusSpan.className = isEnabled ? 'text-theme-green' : 'text-slate-500';
            }
        })
        .catch(error => {
            console.error('Error updating 2FA status:', error);
            showMessage('Error', error.message || 'Failed to update 2FA status.', 'error');
            toggle2FA.checked = !isEnabled; // Revert toggle
            if (statusSpan) { // Restore status text/color
                statusSpan.textContent = originalStatusText;
                statusSpan.className = originalStatusClass;
            }
            message2FA.textContent = error.message || 'An error occurred.';
            message2FA.classList.add('text-red-600');
        })
        .finally(() => {
            spinner2FA.classList.add('hidden');
            toggle2FA.disabled = false;
            // Final check for status text consistency
            if (statusSpan && statusSpan.textContent === 'Updating...') {
                statusSpan.textContent = toggle2FA.checked ? 'Enabled' : 'Disabled';
                statusSpan.className = toggle2FA.checked ? 'text-theme-green' : 'text-slate-500';
            }
        });
    }

    // --- Event Listeners Setup ---
    // Tab Navigation
    profileTabs.forEach(tab => {
        tab.addEventListener('click', function(event) {
            event.preventDefault();
            const sectionId = this.dataset.target;
            showSection(sectionId);
            activateTab(this);
        });
    });

    // Password Form Submit
    if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', handlePasswordChangeSubmit);
    }

    // Profile Picture
    if (photoInput) {
        photoInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                const allowedTypes = ['image/png', 'image/jpeg', 'image/gif'];
                const maxSize = 5 * 1024 * 1024; // 5MB

                if (!allowedTypes.includes(file.type)) { showMessage('Error', 'Invalid file type. Please select a PNG, JPG, or GIF.', 'error'); this.value = ''; return; }
                if (file.size > maxSize) { showMessage('Error', `File too large (${(file.size / 1024 / 1024).toFixed(1)}MB). Max 5MB.`, 'error'); this.value = ''; return; }

                const reader = new FileReader();
                reader.onload = function(e) {
                    if (profilePictureImgMain) { profilePictureImgMain.src = e.target.result; profilePictureImgMain.classList.remove('hidden'); }
                    if (profilePicturePlaceholderMain) profilePicturePlaceholderMain.classList.add('hidden');
                    if (removeProfilePicButton) removeProfilePicButton.classList.remove('hidden');
                    if (saveProfilePicButton) saveProfilePicButton.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });
    }
    if (saveProfilePicButton) { saveProfilePicButton.addEventListener('click', saveProfilePicture); }
    if (removeProfilePicButton) { removeProfilePicButton.addEventListener('click', removeProfilePicture); }

    // Edit/Save Icons for Profile Fields
    document.querySelectorAll('.edit-icon').forEach(icon => {
        icon.addEventListener('click', function() {
            const targetId = this.dataset.target;
            const inputField = document.getElementById(targetId);
            if (!inputField) return;
            setInputState(inputField, true); // Make editable
            inputField.focus();
            // Select text for inputs, move cursor to end for textareas
            if (inputField.tagName === 'INPUT' && inputField.type !== 'file') { inputField.select(); }
            else if (inputField.tagName === 'TEXTAREA') { inputField.setSelectionRange(inputField.value.length, inputField.value.length); }
            // Toggle icon visibility
            this.classList.add('hidden');
            this.closest('.relative.group').querySelector(`.save-icon[data-target="${targetId}"]`)?.classList.remove('hidden');
        });
    });

    document.querySelectorAll('.save-icon').forEach(icon => {
        icon.addEventListener('click', function() {
            const targetId = this.dataset.target;
            const inputField = document.getElementById(targetId);
            if (!inputField) return;
            const trimmedValue = inputField.value.trim();
            let isValid = true;
            let errorMsg = '';
            const labelElement = document.querySelector(`label[for="${targetId}"]`);
            let fieldLabel = labelElement ? labelElement.textContent.replace('(Optional)', '').trim() : (targetId.charAt(0).toUpperCase() + targetId.slice(1));
            if (fieldLabel === "Bio (Optional)") fieldLabel = "Bio";


            // Basic Validation
            if (targetId === 'email') {
                if (!trimmedValue) { isValid = false; errorMsg = `${fieldLabel} cannot be empty.`; }
                else { const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; if (!emailRegex.test(trimmedValue)) { isValid = false; errorMsg = 'Please enter a valid email address.'; } }
            } else if (targetId === 'username') {
                 if (!trimmedValue) { isValid = false; errorMsg = 'Username cannot be empty.'; } // Username cannot be empty
                 else if (trimmedValue.length < 3) { isValid = false; errorMsg = 'Username must be at least 3 characters long.'; }
            } else if (targetId === 'name') { // Assuming 'name' is for 'Full Name'
                 if (!trimmedValue) { isValid = false; errorMsg = 'Full Name cannot be empty.'; }
            } else if (targetId === 'phone_number') {
                const phoneRegex = /^\+923\d{9}$/; // Example: +923001234567
                if (!trimmedValue) {
                    // Phone number can be optional, so allow empty string.
                    // If it's not optional, uncomment the next two lines:
                    // isValid = false;
                    // errorMsg = `${fieldLabel} cannot be empty.`;
                } else if (!phoneRegex.test(trimmedValue)) {
                    isValid = false;
                    errorMsg = 'Please enter a valid phone number in the format +923xxxxxxxxx.';
                }
            }
            // Bio can be empty, so no validation needed for emptiness unless other rules apply.

            if (!isValid) { showMessage('Validation Error', errorMsg, 'error'); inputField.focus(); return; }

            // Confirmation Message Logic
            let confirmMsg = `Are you sure you want to update your ${fieldLabel}?`;
            showConfirmationModal(confirmMsg, targetId);
        });
    });

    // Confirmation Modal Buttons
    if (confirmSaveCancel) { confirmSaveCancel.addEventListener('click', hideConfirmationModal); }
    if (confirmSaveCancelX) { confirmSaveCancelX.addEventListener('click', hideConfirmationModal); } // Added listener for X button
    if (confirmSaveConfirm) {
        confirmSaveConfirm.addEventListener('click', function() {
            if (fieldToSave && pendingChanges.hasOwnProperty(fieldToSave)) {
                saveProfileField(fieldToSave, pendingChanges[fieldToSave]);
            }
            hideConfirmationModal();
        });
    }
    // Close confirmation modal on backdrop click
    if (confirmSaveModal) {
        confirmSaveModal.addEventListener('click', function(event) {
            if (event.target === confirmSaveModal) hideConfirmationModal();
        });
    }

    // 2FA Toggle Listener
    if (toggle2FA) {
        toggle2FA.addEventListener('change', handle2FAToggle);
    }

    // --- Initial Setup ---
    // Set initial input states (readonly)
    document.querySelectorAll('#profile-info-content .form-input').forEach(input => {
        setInputState(input, false);
    });
    // Hide password error divs initially
    document.querySelectorAll('.form-error').forEach(el => el.classList.add('invisible'));
    // Show the first section (Profile Info) and activate first tab by default
    const initialTab = document.getElementById('profile-info-tab');
    if (initialTab) {
        showSection('profile-info-content');
        activateTab(initialTab);
    } else if (profileTabs.length > 0) { // Fallback
        const firstTab = profileTabs[0];
        const sectionId = firstTab.dataset.target;
        showSection(sectionId);
        activateTab(firstTab);
    }

}); // End DOMContentLoaded
</script>
{% endblock %}

{% extends 'Homepage.html' %}
{% load static %}

{% block title %}Subscribe to Premium - AudioX{% endblock %}

{% block content %}
{# Tailwind CSS and JS libraries are inherited from Homepage.html #}
{# Font Awesome is loaded in Homepage.html or via the script block below if needed #}
<script src="https://cdn.tailwindcss.com"></script> {# Ensure Tailwind is loaded #}
{# Stripe.js is loaded in Homepage.html, no need to load again if block inheritance is correct #}
{# <script src="https://js.stripe.com/v3/"></script> #}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"> {# Load Inter font #}
<style>
  body { font-family: 'Inter', sans-serif; }
  /* Add any additional specific styles here if needed */
</style>

<div class="bg-white min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 font-sans"> {# Added font-sans #}
    <div class="max-w-7xl w-full space-y-12">

        <div class="text-center">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold tracking-tight text-[#091e65]">
                Upgrade to AudioX Premium
            </h1>
            <p class="mt-4 text-xl sm:text-2xl text-gray-600">
                Experience the best of AudioX.
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 lg:gap-12 items-stretch"> {# Added items-stretch #}

            <div class="bg-[#091e65] rounded-3xl shadow-xl p-8 text-white flex flex-col"> {# Added flex flex-col #}
                <h2 class="text-3xl font-semibold text-yellow-400 mb-8">Premium Benefits</h2>
                <ul class="space-y-6 flex-grow"> {# Added flex-grow #}
                    <li class="flex items-center">
                        <svg class="w-7 h-7 text-green-400 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="text-lg">Unlimited Access</span>
                    </li>
                    <li class="flex items-center">
                       <svg class="w-7 h-7 text-yellow-400 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                        <span class="text-lg">Ad-Free Listening</span>
                    </li>
                    <li class="flex items-center">
                        <svg class="w-7 h-7 text-blue-400 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <span class="text-lg">Offline Downloads</span>
                    </li>
                    <li class="flex items-center">
                         <svg class="w-7 h-7 text-red-400 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="text-lg">High-Quality Audio</span>
                    </li>
                    <li class="flex items-center">
                        <svg class="w-7 h-7 text-yellow-400 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
                        <span class="text-lg">Exclusive Content</span>
                    </li>
                     <li class="flex items-center">
                         <svg class="w-7 h-7 text-indigo-400 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <span class="text-lg">Support Creators</span>
                    </li>
                </ul>
            </div>

            <div class="bg-white rounded-3xl shadow-xl p-8 hover:scale-105 transition-transform duration-300 relative border-4 border-yellow-500 flex flex-col"> {# Added flex flex-col #}
                <div class="absolute top-0 right-0 bg-yellow-500 text-white px-4 py-2 rounded-br-3xl rounded-tl-md text-sm font-bold"> {# Adjusted size #}
                    Most Popular
                </div>
                <div class="flex-grow"> {# Added flex-grow #}
                    <h3 class="text-4xl font-bold text-[#091e65] text-center mb-4">Monthly</h3>
                    <p class="text-center text-gray-600 mb-6">Flexibility and premium features.</p>
                    <div class="text-center text-5xl font-extrabold text-[#091e65] mb-6">
                        <span class="text-xl align-top">PKR</span> 350 <span class="text-lg text-gray-500">/ month</span> {# UPDATED PRICE #}
                    </div>
                </div>
                {# *** ADDED data-item-type, data-item-id and data-plan-display *** #}
                <button type="button" data-item-type="subscription" data-item-id="monthly" data-plan-display="Monthly" class="subscribe-btn block w-full py-4 px-8 bg-[#091e65] hover:bg-indigo-700 text-white font-bold rounded-full text-lg transition-colors duration-200 mt-auto"> {# Added mt-auto #}
                    Subscribe Monthly
                </button>
                 <p class="text-center text-sm text-gray-400 mt-4">Cancel anytime.</p>
            </div>

            <div class="bg-white rounded-3xl shadow-xl p-8 hover:scale-105 transition-transform duration-300 relative border-4 border-green-500 flex flex-col"> {# Added flex flex-col #}
                <div class="absolute top-0 right-0 bg-green-500 text-white px-4 py-2 rounded-br-3xl rounded-tl-md text-sm font-bold"> {# Adjusted size #}
                    Best Value
                </div>
                 <div class="flex-grow"> {# Added flex-grow #}
                    <h3 class="text-4xl font-bold text-[#091e65] text-center mb-4">Annually</h3>
                     <p class="text-center text-gray-600 mb-2">The ultimate AudioX experience.</p>
                     <div class="text-center text-5xl font-extrabold text-[#091e65] mb-2">
                        <span class="text-xl align-top">PKR</span> 3,500 <span class="text-lg text-gray-500">/ year</span> {# UPDATED PRICE #}
                    </div>
                    <p class="text-center text-sm text-green-600 font-bold mb-6">
                        Save PKR 700! {# UPDATED SAVING (12 * 350 = 4200; 4200 - 3500 = 700) #}
                    </p>
                </div>
                 {# *** ADDED data-item-type, data-item-id and data-plan-display *** #}
                <button type="button" data-item-type="subscription" data-item-id="annual" data-plan-display="Annual" class="subscribe-btn block w-full py-4 px-8 bg-[#091e65] hover:bg-indigo-700 text-white font-bold rounded-full text-lg transition-colors duration-200 mt-auto"> {# Added mt-auto #}
                    Subscribe Annually
                </button>
                 <p class="text-center text-sm text-gray-400 mt-4">Cancel anytime.</p>
            </div>

        </div>

        <div class="mt-16 bg-white rounded-3xl shadow-xl p-8 md:p-10 border border-gray-200">
             <h2 class="text-3xl font-semibold text-[#091e65] mb-8 text-center">Frequently Asked Questions</h2>
            <div class="space-y-6 max-w-3xl mx-auto"> {# Added max-width and centering #}
                <details class="group border-b pb-4"> {# Added border #}
                    <summary class="text-lg font-medium text-gray-700 cursor-pointer list-none flex items-center justify-between hover:text-[#091e65] transition-colors">
                        <span class="flex-1">What payment methods do you accept?</span>
                        <span class="ml-4 group-open:rotate-180 transition-transform transform"> {# Added transform #}
                            <svg class="w-5 h-5 text-gray-500 group-hover:text-[#091e65]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </span>
                    </summary>
                    <p class="mt-3 text-gray-600 pl-2 text-sm leading-relaxed"> {# Adjusted padding/size #}
                        We currently accept all major credit and debit cards through our secure payment partner, Stripe. We are working on adding more options like JazzCash soon!
                    </p>
                </details>
                 <details class="group border-b pb-4">
                    <summary class="text-lg font-medium text-gray-700 cursor-pointer list-none flex items-center justify-between hover:text-[#091e65] transition-colors">
                        <span class="flex-1">Can I cancel my subscription anytime?</span>
                        <span class="ml-4 group-open:rotate-180 transition-transform transform">
                            <svg class="w-5 h-5 text-gray-500 group-hover:text-[#091e65]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </span>
                    </summary>
                    <p class="mt-3 text-gray-600 pl-2 text-sm leading-relaxed">
                        Yes, you can cancel your subscription at any time from your account settings page. Your premium access will remain active until the end of your current billing period.
                    </p>
                </details>
                <details class="group border-b pb-4">
                     <summary class="text-lg font-medium text-gray-700 cursor-pointer list-none flex items-center justify-between hover:text-[#091e65] transition-colors">
                        <span class="flex-1">Is there a free trial?</span>
                        <span class="ml-4 group-open:rotate-180 transition-transform transform">
                            <svg class="w-5 h-5 text-gray-500 group-hover:text-[#091e65]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </span>
                    </summary>
                    <p class="mt-3 text-gray-600 pl-2 text-sm leading-relaxed">
                        We currently offer a selection of free content for all users to explore before committing to a premium subscription. Check out our free library!
                    </p>
                </details>
                <details class="group border-b pb-4">
                    <summary class="text-lg font-medium text-gray-700 cursor-pointer list-none flex items-center justify-between hover:text-[#091e65] transition-colors">
                        <span class="flex-1">How do I access premium content after subscribing?</span>
                        <span class="ml-4 group-open:rotate-180 transition-transform transform">
                            <svg class="w-5 h-5 text-gray-500 group-hover:text-[#091e65]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </span>
                    </summary>
                    <p class="mt-3 text-gray-600 pl-2 text-sm leading-relaxed">
                        Once your subscription is active, all premium content and features will be automatically unlocked. Just ensure you are logged in to enjoy the full AudioX library.
                    </p>
                </details>

            </div>
        </div>
    </div>
</div>

<div id="confirm-modal" class="fixed z-50 inset-0 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-gray-200">
            <div class="bg-white px-6 pt-6 pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                         <svg class="h-6 w-6 text-[#091e65]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"> <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /> </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-xl leading-6 font-medium text-[#091e65]" id="modal-title"> Confirm Subscription </h3>
                        <div class="mt-4">
                            <p class="text-base text-gray-700" id="modal-plan-text"> You are about to subscribe to the <span id="modal-plan-name" class="font-semibold text-[#091e65]"></span> plan. </p>
                            <p class="text-sm text-gray-500 mt-3"> You will be redirected to our secure payment partner (Stripe) to complete your subscription. </p>
                        </div>
                    </div>
                </div>
            </div>
             <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                {# Button type is 'button' to prevent form submission if it were inside a form #}
                <button type="button" id="proceed-to-payment-btn" class="w-full inline-flex justify-center rounded-full border border-transparent shadow-sm px-6 py-3 bg-[#091e65] text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm transition-colors duration-200 disabled:opacity-70 disabled:cursor-not-allowed">
                    Proceed to Payment
                </button>
                <button type="button" id="cancel-modal" class="mt-3 w-full inline-flex justify-center rounded-full border border-gray-300 shadow-sm px-6 py-3 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
                {# Hidden inputs to store plan details for JS when modal is confirmed #}
                <input type="hidden" id="selected-item-type" value="">
                <input type="hidden" id="selected-item-id" value="">
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascript_extra %} {# <<< CORRECTED BLOCK NAME HERE #}
{# Font Awesome JS and SweetAlert2 are loaded in Homepage.html (base template) #}
{# Stripe.js is also loaded in Homepage.html #}

<script>
// DEBUG LINE 1: Check if this script block is even being parsed and executed.
console.log('DEBUG SubscribersPage: JavaScript block started.');

document.addEventListener('DOMContentLoaded', function() {
    // DEBUG LINE 2: Check if DOMContentLoaded event is firing.
    console.log('DEBUG SubscribersPage: DOMContentLoaded event fired.');

    // --- Element Selectors ---
    const subscribeButtons = document.querySelectorAll('.subscribe-btn');
    const confirmModal = document.getElementById('confirm-modal');
    const modalPlanName = document.getElementById('modal-plan-name');
    const proceedToPaymentBtn = document.getElementById('proceed-to-payment-btn');
    const cancelModalBtn = document.getElementById('cancel-modal');
    const selectedItemTypeInput = document.getElementById('selected-item-type');
    const selectedItemIdInput = document.getElementById('selected-item-id');

    // DEBUG LINE 3: Log before Stripe key processing.
    console.log('DEBUG SubscribersPage: About to process Stripe key.');

    // --- Get Stripe Instance ---
    // The STRIPE_PUBLISHABLE_KEY is passed from the Django view context.
    const stripePublishableKey = "{{ STRIPE_PUBLISHABLE_KEY|escapejs }}";
    let stripe; // Declare stripe instance variable

    // DEBUG LINE 4: Log the retrieved Stripe key.
    console.log('DEBUG SubscribersPage: stripePublishableKey from template = ', stripePublishableKey);

    if (stripePublishableKey && stripePublishableKey !== 'None' && stripePublishableKey.startsWith('pk_')) {
        // DEBUG LINE 5: Log before attempting to initialize Stripe.
        console.log('DEBUG SubscribersPage: Valid Stripe key format detected. Attempting to initialize Stripe.');
        try {
            // Check if Stripe object is available (it should be, as it's loaded in Homepage.html)
            if (typeof Stripe === 'function') {
                stripe = Stripe(stripePublishableKey);
                // DEBUG LINE 6: Log if Stripe initialized successfully.
                console.log('DEBUG SubscribersPage: Stripe initialized successfully.', stripe);
            } else {
                console.error('DEBUG SubscribersPage: Stripe function not found. Stripe.js might not be loaded correctly from Homepage.html.');
                showGenericError("Payment system script (Stripe.js) not loaded. Please contact support.");
                subscribeButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
            }
        } catch (error) {
            console.error("Error initializing Stripe:", error);
            showGenericError("Payment system could not be initialized. Please check the console or contact support.");
            subscribeButtons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            });
        }
    } else {
        console.error("Stripe Publishable Key not found, is invalid, or not set in Django context. Key Value:", stripePublishableKey);
        showGenericError("Payment configuration error. Subscription buttons are disabled. Please contact support.");
        subscribeButtons.forEach(btn => {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
        });
    }

    // --- Modal Handling ---
    function showModal(itemType, itemId, planDisplay) {
        console.log('DEBUG SubscribersPage: showModal called with', itemType, itemId, planDisplay);
        if (modalPlanName) modalPlanName.textContent = planDisplay;
        if (selectedItemTypeInput) selectedItemTypeInput.value = itemType;
        if (selectedItemIdInput) selectedItemIdInput.value = itemId;
        if (confirmModal) confirmModal.classList.remove('hidden');
        
        if (proceedToPaymentBtn && stripe) {
            proceedToPaymentBtn.disabled = false;
            proceedToPaymentBtn.innerHTML = 'Proceed to Payment';
        } else if (proceedToPaymentBtn) {
             proceedToPaymentBtn.disabled = true; 
             proceedToPaymentBtn.innerHTML = 'Payment Unavailable';
             console.warn('DEBUG SubscribersPage: Proceed to payment button disabled as Stripe object is not available.');
        }
        if (cancelModalBtn) cancelModalBtn.disabled = false;
    }

    function hideModal() {
        console.log('DEBUG SubscribersPage: hideModal called.');
        if (confirmModal) confirmModal.classList.add('hidden');
        if (selectedItemTypeInput) selectedItemTypeInput.value = ""; // Clear hidden inputs
        if (selectedItemIdInput) selectedItemIdInput.value = "";
    }

    // --- CSRF Token Helper ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- Error Notification (uses SweetAlert2 loaded in Homepage.html) ---
    function showGenericError(message) {
        console.error('DEBUG SubscribersPage: showGenericError called with message:', message);
        // Check if Swal is defined (it should be from Homepage.html)
        if (typeof Swal === 'undefined') {
            console.error('DEBUG SubscribersPage: SweetAlert (Swal) is not defined!');
            alert('Error: ' + message); // Fallback to basic alert
            return;
        }
        Swal.fire({
            title: 'Error',
            text: message,
            icon: 'error',
            confirmButtonColor: '#091e65' // Theme color
        });
    }

    // --- Subscribe Button Listeners ---
    console.log('DEBUG SubscribersPage: Setting up subscribe button listeners. Stripe object:', stripe);
    // Add listeners only if Stripe was initialized (or at least a valid key was present to attempt init)
    // This ensures we don't add listeners to buttons that are meant to be non-functional.
    if (stripe || (stripePublishableKey && stripePublishableKey !== 'None' && stripePublishableKey.startsWith('pk_'))) {
        subscribeButtons.forEach(button => {
            // Check if button is already disabled by Stripe init failure
            if (!button.disabled) {
                button.addEventListener('click', (event) => {
                    console.log('DEBUG SubscribersPage: Subscribe button clicked.');
                    const itemType = event.currentTarget.dataset.itemType;
                    const itemId = event.currentTarget.dataset.itemId;
                    const planDisplay = event.currentTarget.dataset.planDisplay;
                    showModal(itemType, itemId, planDisplay);
                });
            } else {
                console.warn('DEBUG SubscribersPage: Subscribe button was already disabled, listener not added.', button);
            }
        });
    } else {
         console.warn('DEBUG SubscribersPage: Stripe not available, subscribe button listeners not added.');
    }


    // --- Modal Close/Cancel Listeners ---
    if(cancelModalBtn){ cancelModalBtn.addEventListener('click', hideModal); }
    if(confirmModal){
        // Close modal if user clicks outside of it
        confirmModal.addEventListener('click', (event) => {
            if (event.target === confirmModal) {
                hideModal();
            }
        });
        // Close modal if user presses Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !confirmModal.classList.contains('hidden')) {
                hideModal();
            }
        });
    }

    // --- Proceed to Payment Logic ---
    console.log('DEBUG SubscribersPage: Setting up "Proceed to Payment" button listener. Stripe object:', stripe);
    // Add listener only if Stripe object is available
    if (proceedToPaymentBtn && stripe) {
        proceedToPaymentBtn.addEventListener('click', function() {
            console.log('DEBUG SubscribersPage: "Proceed to Payment" button clicked.');
            // Get selected plan details from hidden inputs
            const itemType = selectedItemTypeInput.value;
            const itemId = selectedItemIdInput.value;

            if (!itemType || !itemId) {
                console.error("Could not determine selected plan in modal.");
                showGenericError("An error occurred. Please close the modal and try again.");
                return;
            }

            // Disable buttons, show loading state
            proceedToPaymentBtn.disabled = true;
            if(cancelModalBtn) cancelModalBtn.disabled = true;
            proceedToPaymentBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';

            const sessionData = { item_type: itemType, item_id: itemId };
            console.log('DEBUG SubscribersPage: Fetching create_checkout_session with data:', sessionData);

            // Call backend to create checkout session
            fetch("{% url 'AudioXApp:create_checkout_session' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'), // Ensure this function works
                    'X-Requested-With': 'XMLHttpRequest' // Often useful for Django to identify AJAX
                },
                body: JSON.stringify(sessionData)
            })
            .then(response => {
                console.log('DEBUG SubscribersPage: create_checkout_session response received:', response);
                if (!response.ok) {
                    // Try to parse error from backend if available
                    return response.json().then(errData => {
                        console.error('DEBUG SubscribersPage: create_checkout_session error response data:', errData);
                        throw new Error(errData.error || `Server error: ${response.status}`);
                    }).catch((initialError) => { // Catches if response.json() fails or if errData.error is not set
                        console.error('DEBUG SubscribersPage: create_checkout_session error (non-JSON or no errData.error):', initialError, 'Status:', response.status, response.statusText);
                        throw new Error(`Server error: ${response.status} - ${response.statusText}`); // Provide more context
                    });
                }
                return response.json();
            })
            .then(session => {
                console.log('DEBUG SubscribersPage: create_checkout_session success data:', session);
                if (session.sessionId) {
                    console.log("Redirecting to Stripe Checkout with session ID:", session.sessionId);
                    // Redirect to Stripe Checkout
                    return stripe.redirectToCheckout({ sessionId: session.sessionId });
                } else {
                    // If backend returns an error in JSON format like {error: "message"}
                    throw new Error(session.error || 'Failed to create checkout session (no session ID).');
                }
            })
            .then(result => {
                // This .then block is for the result of redirectToCheckout.
                // If redirectToCheckout fails (e.g., network issue before redirect), result.error will be set.
                // If successful, the user is redirected, and this code might not run.
                if (result && result.error) {
                    console.error('Stripe redirectToCheckout error:', result.error);
                    showGenericError(result.error.message || 'Could not redirect to payment page.');
                    // Re-enable buttons only if redirection fails immediately
                    proceedToPaymentBtn.disabled = false;
                    if(cancelModalBtn) cancelModalBtn.disabled = false;
                    proceedToPaymentBtn.innerHTML = 'Proceed to Payment';
                }
            })
            .catch(error => {
                console.error('Error creating checkout session or redirecting:', error);
                hideModal(); // Hide the modal on error
                showGenericError(error.message || 'An error occurred while preparing your subscription. Please try again.');
                // Re-enable buttons in the modal (they are hidden anyway, but good practice)
                proceedToPaymentBtn.disabled = false; // Will be re-evaluated when modal is shown again
                if(cancelModalBtn) cancelModalBtn.disabled = false;
                proceedToPaymentBtn.innerHTML = 'Proceed to Payment';
            });
        });
    } else if (proceedToPaymentBtn && !stripe) {
        // If Stripe is not initialized, ensure the proceed button is disabled and gives feedback
        console.warn("Stripe object not available, Proceed to Payment button listener not fully functional or disabled.");
        proceedToPaymentBtn.disabled = true;
        proceedToPaymentBtn.innerHTML = 'Payment Unavailable';
        proceedToPaymentBtn.classList.add('opacity-70', 'cursor-not-allowed');
    }


    // --- Handle Redirect Status Messages (Optional but good for UX) ---
    const urlParams = new URLSearchParams(window.location.search);
    const paymentStatus = urlParams.get('status');
    const stripeSessionId = urlParams.get('stripe_session_id'); // For new success status
    const legacySuccess = urlParams.get('success'); // For old success param
    const legacyError = urlParams.get('error'); // For old error param

    if (paymentStatus === 'success' && stripeSessionId) {
        console.log("DEBUG SubscribersPage: Returned from Stripe with success status.");
        // Check if Swal is defined
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: 'Payment Submitted!',
                text: 'Your subscription is being processed and will be active shortly. Please check your account.',
                icon: 'info',
                timer: 5000, // Show for 5 seconds
                timerProgressBar: true,
                showConfirmButton: true, // Allow user to dismiss
                confirmButtonColor: '#091e65',
                allowOutsideClick: false
            });
        } else {
            alert('Payment Submitted! Your subscription is being processed.'); // Fallback
        }
        // Clean the URL parameters to prevent re-showing message on refresh
        window.history.replaceState(null, null, window.location.pathname);
    } else if (paymentStatus === 'cancel') {
        console.log("DEBUG SubscribersPage: Returned from Stripe with cancel status.");
        showGenericError('Your subscription process was cancelled.'); // showGenericError checks for Swal
        window.history.replaceState(null, null, window.location.pathname);
    } else if (legacySuccess === 'true') { // Handle old success param if needed
         console.log("DEBUG SubscribersPage: Legacy success param found.");
        if (typeof Swal !== 'undefined') {
            Swal.fire({ title: 'Subscription Successful!', text: 'Welcome to AudioX Premium!', icon: 'success', confirmButtonColor: '#091e65' });
        } else {
            alert('Subscription Successful! Welcome to AudioX Premium!'); // Fallback
        }
        window.history.replaceState(null, null, window.location.pathname);
    } else if (legacyError) { // Handle old error param
        console.log("DEBUG SubscribersPage: Legacy error param found:", decodeURIComponent(legacyError));
        if (typeof Swal !== 'undefined') {
            Swal.fire({ title: 'Subscription Error', text: decodeURIComponent(legacyError), icon: 'error', confirmButtonColor: '#091e65' });
        } else {
            alert('Subscription Error: ' + decodeURIComponent(legacyError)); // Fallback
        }
        window.history.replaceState(null, null, window.location.pathname);
    }
    // DEBUG LINE - End of DOMContentLoaded
    console.log('DEBUG SubscribersPage: End of DOMContentLoaded execution.');

}); // End DOMContentLoaded

// DEBUG LINE - End of script block
console.log('DEBUG SubscribersPage: JavaScript block finished parsing.');
</script>
{% endblock javascript_extra %} 
{% extends 'admin/admin_base.html' %}
{% load static humanize %}

{% block title %}User Details: {{ user_to_view.username }} - Admin Dashboard{% endblock %}

{% block header_title %}User Details: <span class="text-red-600">{{ user_to_view.username }}</span>{% endblock %}

{% block content %}
<div class="bg-gray-100 min-h-full py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <div class="mb-6">
            <a href="{% url 'AudioXApp:admin_all_users_list' %}" class="inline-flex items-center text-sm font-medium text-red-600 hover:text-red-800 transition-colors duration-150 group">
                <i class="fas fa-arrow-left mr-2 transform group-hover:-translate-x-1 transition-transform duration-150"></i>
                Back to All Users
            </a>
        </div>

        {% if messages %}
        <div class="mb-6 space-y-3">
            {% for message in messages %}
            <div class="p-4 rounded-lg border
                {% if message.tags == 'success' %} bg-green-50 border-green-300 text-green-700
                {% elif message.tags == 'error' %} bg-red-50 border-red-300 text-red-700
                {% elif message.tags == 'warning' %} bg-yellow-50 border-yellow-300 text-yellow-700
                {% else %} bg-blue-50 border-blue-300 text-blue-700 {% endif %}"
                role="alert">
                <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-times-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %} mr-2"></i>
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {# Left Column / Main Details Column #}
            <div class="lg:col-span-2 space-y-8">
                {# User Profile Card #}
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-6">
                        <div class="flex flex-col sm:flex-row items-center sm:items-start">
                            {% if user_to_view.profile_pic %}
                                <img src="{{ user_to_view.profile_pic.url }}" alt="{{ user_to_view.username }}" class="w-32 h-32 rounded-full object-cover border-4 border-red-500 shadow-md mb-4 sm:mb-0 sm:mr-6 flex-shrink-0">
                            {% else %}
                                <div class="w-32 h-32 rounded-full bg-red-100 text-red-600 flex items-center justify-center text-5xl font-bold border-4 border-red-200 shadow-md mb-4 sm:mb-0 sm:mr-6 flex-shrink-0">
                                    {{ user_to_view.username|slice:":1"|upper }}
                                </div>
                            {% endif %}
                            <div class="text-center sm:text-left flex-grow">
                                <h2 class="text-2xl font-bold text-gray-900">{{ user_to_view.full_name|default:user_to_view.username }}</h2>
                                <p class="text-sm text-gray-500 mb-1">@{{ user_to_view.username }}</p>
                                <p class="text-sm text-gray-600 break-words">{{ user_to_view.bio|default:""|linebreaksbr }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="border-t border-gray-200 px-6 py-5">
                        <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">User ID</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ user_to_view.user_id }}</dd>
                            </div>
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">Email</dt>
                                <dd class="mt-1 text-sm text-gray-900 break-all">{{ user_to_view.email }}</dd>
                            </div>
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">Phone</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ user_to_view.phone_number|default:"N/A" }}</dd>
                            </div>
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">Date Joined</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ user_to_view.date_joined|date:"M d, Y @ H:i" }}</dd>
                            </div>
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">Last Login</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ user_to_view.last_login|date:"M d, Y @ H:i"|default:"Never" }}</dd>
                            </div>
                             <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">2FA Enabled</dt>
                                <dd class="mt-1 text-sm text-gray-900">{% if user_to_view.is_2fa_enabled %}<span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Yes</span>{% else %}<span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">No</span>{% endif %}</dd>
                            </div>
                        </dl>
                    </div>
                </div>

                {# Tabs for Transactions and Purchases #}
                <div x-data="{ activeTab: 'coin_transactions' }" class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-2 sm:space-x-4 px-3 sm:px-6 text-xs sm:text-sm" aria-label="Tabs">
                            <button @click="activeTab = 'coin_transactions'"
                                    :class="{ 'border-red-500 text-red-600': activeTab === 'coin_transactions', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'coin_transactions' }"
                                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium transition-colors duration-150 focus:outline-none">
                                Coin Transactions
                            </button>
                            <button @click="activeTab = 'subscription_transactions'"
                                    :class="{ 'border-red-500 text-red-600': activeTab === 'subscription_transactions', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'subscription_transactions' }"
                                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium transition-colors duration-150 focus:outline-none">
                                Subscription Transactions
                            </button>
                            <button @click="activeTab = 'audiobook_purchases'"
                                    :class="{ 'border-red-500 text-red-600': activeTab === 'audiobook_purchases', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'audiobook_purchases' }"
                                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium transition-colors duration-150 focus:outline-none">
                                Audiobook Purchases
                            </button>
                        </nav>
                    </div>

                    {# Other Coin Transactions Table (excluding subscriptions) #}
                    <div x-show="activeTab === 'coin_transactions'" class="p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Other Coin Transactions</h3>
                        <div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for tx in all_coin_transactions %} {# This context variable now holds OTHER coin transactions from the view #}
                                    <tr class="hover:bg-gray-50/50">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ tx.transaction_date|date:"M d, Y @ H:i" }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ tx.get_transaction_type_display }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-right">{{ tx.amount|intcomma }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                                            {% if tx.pack_name %}{{ tx.pack_name }}{% endif %}
                                            {% if tx.price %} <span class="text-xs text-gray-500">(PKR {{ tx.price|floatformat:2 }})</span>{% endif %}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                                            <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full
                                                {% if tx.status == 'completed' %} bg-green-100 text-green-800
                                                {% elif tx.status == 'pending' %} bg-yellow-100 text-yellow-800
                                                {% elif tx.status == 'failed' %} bg-red-100 text-red-800
                                                {% else %} bg-gray-100 text-gray-800 {% endif %}">
                                                {{ tx.get_status_display|capfirst }}
                                            </span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-700 break-words max-w-xs truncate" title="{{ tx.description|default_if_none:"" }}">{{ tx.description|default_if_none:""|truncatewords:8 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center py-6 text-sm text-gray-500">
                                            <i class="fas fa-exchange-alt fa-2x text-gray-400 mb-2"></i><br>
                                            No other coin transactions found.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if all_coin_transactions.has_other_pages %}
                        <div class="mt-6 px-4 py-3 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                            <nav class="flex items-center justify-between text-sm" aria-label="Pagination">
                                <div class="flex-1 flex justify-between sm:hidden">
                                    {% if all_coin_transactions.has_previous %}
                                    <a href="?coin_page={{ all_coin_transactions.previous_page_number }}{% if request.GET.purchase_page %}&purchase_page={{ request.GET.purchase_page }}{% endif %}{% if request.GET.sub_tx_page %}&sub_tx_page={{ request.GET.sub_tx_page }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Previous</a>
                                    {% else %}<span class="relative inline-flex items-center px-4 py-2 border border-gray-200 text-sm font-medium rounded-md text-gray-400 bg-gray-100 cursor-not-allowed">Previous</span>{% endif %}
                                    {% if all_coin_transactions.has_next %}
                                    <a href="?coin_page={{ all_coin_transactions.next_page_number }}{% if request.GET.purchase_page %}&purchase_page={{ request.GET.purchase_page }}{% endif %}{% if request.GET.sub_tx_page %}&sub_tx_page={{ request.GET.sub_tx_page }}{% endif %}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Next</a>
                                    {% else %}<span class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-200 text-sm font-medium rounded-md text-gray-400 bg-gray-100 cursor-not-allowed">Next</span>{% endif %}
                                </div>
                                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                    <div><p class="text-sm text-gray-700">Page <span class="font-medium">{{ all_coin_transactions.number }}</span> of <span class="font-medium">{{ all_coin_transactions.paginator.num_pages }}</span><span class="hidden md:inline"> ({{ all_coin_transactions.paginator.count }} items)</span></p></div>
                                    <div>
                                        <span class="relative z-0 inline-flex shadow-sm rounded-md">
                                            {% if all_coin_transactions.has_previous %}<a href="?coin_page={{ all_coin_transactions.previous_page_number }}{% if request.GET.purchase_page %}&purchase_page={{ request.GET.purchase_page }}{% endif %}{% if request.GET.sub_tx_page %}&sub_tx_page={{ request.GET.sub_tx_page }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-red-500 focus:border-red-500"><span class="sr-only">Previous</span><i class="fas fa-chevron-left h-5 w-5"></i></a>
                                            {% else %}<span class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-200 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed"><span class="sr-only">Previous</span><i class="fas fa-chevron-left h-5 w-5"></i></span>{% endif %}
                                            <span aria-current="page" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">{{ all_coin_transactions.number }}</span>
                                            {% if all_coin_transactions.has_next %}<a href="?coin_page={{ all_coin_transactions.next_page_number }}{% if request.GET.purchase_page %}&purchase_page={{ request.GET.purchase_page }}{% endif %}{% if request.GET.sub_tx_page %}&sub_tx_page={{ request.GET.sub_tx_page }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-red-500 focus:border-red-500"><span class="sr-only">Next</span><i class="fas fa-chevron-right h-5 w-5"></i></a>
                                            {% else %}<span class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-200 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed"><span class="sr-only">Next</span><i class="fas fa-chevron-right h-5 w-5"></i></span>{% endif %}
                                        </span>
                                    </div>
                                </div>
                            </nav>
                        </div>
                        {% endif %}
                    </div>

                    {# Subscription Transactions Table - NEW #}
                    <div x-show="activeTab === 'subscription_transactions'" class="p-6" style="display: none;">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Subscription Transactions</h3>
                        <div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (PKR)</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pack/Plan Name</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for tx in all_subscription_transactions %} {# Use the new context variable #}
                                    <tr class="hover:bg-gray-50/50">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ tx.transaction_date|date:"M d, Y @ H:i" }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ tx.get_transaction_type_display }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-right">{% if tx.price %}{{ tx.price|floatformat:2|intcomma }}{% else %}{{tx.amount|intcomma}} Coins{% endif %}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ tx.pack_name|default_if_none:"" }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                                            <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full
                                                {% if tx.status == 'completed' %} bg-green-100 text-green-800
                                                {% elif tx.status == 'pending' %} bg-yellow-100 text-yellow-800
                                                {% elif tx.status == 'failed' %} bg-red-100 text-red-800
                                                {% else %} bg-gray-100 text-gray-800 {% endif %}">
                                                {{ tx.get_status_display|capfirst }}
                                            </span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-700 break-words max-w-xs truncate" title="{{ tx.description|default_if_none:"" }}">{{ tx.description|default_if_none:""|truncatewords:8 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center py-6 text-sm text-gray-500">
                                            <i class="fas fa-receipt fa-2x text-gray-400 mb-2"></i><br>
                                            No subscription transactions found.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if all_subscription_transactions.has_other_pages %}
                        <div class="mt-6 px-4 py-3 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                            <nav class="flex items-center justify-between text-sm" aria-label="Pagination">
                                <div class="flex-1 flex justify-between sm:hidden">
                                    {% if all_subscription_transactions.has_previous %}
                                    <a href="?sub_tx_page={{ all_subscription_transactions.previous_page_number }}{% if request.GET.coin_page %}&coin_page={{ request.GET.coin_page }}{% endif %}{% if request.GET.purchase_page %}&purchase_page={{ request.GET.purchase_page }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Previous</a>
                                    {% else %}<span class="relative inline-flex items-center px-4 py-2 border border-gray-200 text-sm font-medium rounded-md text-gray-400 bg-gray-100 cursor-not-allowed">Previous</span>{% endif %}
                                    {% if all_subscription_transactions.has_next %}
                                    <a href="?sub_tx_page={{ all_subscription_transactions.next_page_number }}{% if request.GET.coin_page %}&coin_page={{ request.GET.coin_page }}{% endif %}{% if request.GET.purchase_page %}&purchase_page={{ request.GET.purchase_page }}{% endif %}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Next</a>
                                    {% else %}<span class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-200 text-sm font-medium rounded-md text-gray-400 bg-gray-100 cursor-not-allowed">Next</span>{% endif %}
                                </div>
                                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                    <div><p class="text-sm text-gray-700">Page <span class="font-medium">{{ all_subscription_transactions.number }}</span> of <span class="font-medium">{{ all_subscription_transactions.paginator.num_pages }}</span><span class="hidden md:inline"> ({{ all_subscription_transactions.paginator.count }} items)</span></p></div>
                                    <div>
                                        <span class="relative z-0 inline-flex shadow-sm rounded-md">
                                            {% if all_subscription_transactions.has_previous %}<a href="?sub_tx_page={{ all_subscription_transactions.previous_page_number }}{% if request.GET.coin_page %}&coin_page={{ request.GET.coin_page }}{% endif %}{% if request.GET.purchase_page %}&purchase_page={{ request.GET.purchase_page }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-red-500 focus:border-red-500"><span class="sr-only">Previous</span><i class="fas fa-chevron-left h-5 w-5"></i></a>
                                            {% else %}<span class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-200 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed"><span class="sr-only">Previous</span><i class="fas fa-chevron-left h-5 w-5"></i></span>{% endif %}
                                            <span aria-current="page" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">{{ all_subscription_transactions.number }}</span>
                                            {% if all_subscription_transactions.has_next %}<a href="?sub_tx_page={{ all_subscription_transactions.next_page_number }}{% if request.GET.coin_page %}&coin_page={{ request.GET.coin_page }}{% endif %}{% if request.GET.purchase_page %}&purchase_page={{ request.GET.purchase_page }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-red-500 focus:border-red-500"><span class="sr-only">Next</span><i class="fas fa-chevron-right h-5 w-5"></i></a>
                                            {% else %}<span class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-200 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed"><span class="sr-only">Next</span><i class="fas fa-chevron-right h-5 w-5"></i></span>{% endif %}
                                        </span>
                                    </div>
                                </div>
                            </nav>
                        </div>
                        {% endif %}
                    </div>

                    {# Audiobook Purchases Table - Embedded #}
                    <div x-show="activeTab === 'audiobook_purchases'" class="p-6" style="display: none;">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Audiobook Purchases (Completed)</h3>
                        <div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Audiobook</th>
                                        <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount Paid</th>
                                        <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Platform Fee</th>
                                        <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Creator Share</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for purchase in all_audiobook_purchases %}
                                    <tr class="hover:bg-gray-50/50">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ purchase.purchase_date|date:"M d, Y @ H:i" }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                                            {% if purchase.audiobook %}
                                            <a href="{% url 'AudioXApp:audiobook_detail' purchase.audiobook.slug %}" target="_blank" class="text-red-600 hover:text-red-800 hover:underline" title="{{ purchase.audiobook.title }}">
                                                {{ purchase.audiobook.title|truncatechars:35 }}
                                            </a>
                                            {% else %} Audiobook not found {% endif %}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-right">PKR {{ purchase.amount_paid|floatformat:2|intcomma }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-right">PKR {{ purchase.platform_fee_amount|floatformat:2|intcomma }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-right">PKR {{ purchase.creator_share_amount|floatformat:2|intcomma }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center py-6 text-sm text-gray-500">
                                            <i class="fas fa-book-open fa-2x text-gray-400 mb-2"></i><br>
                                            No completed audiobook purchases found.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if all_audiobook_purchases.has_other_pages %}
                        <div class="mt-6 px-4 py-3 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                             <nav class="flex items-center justify-between text-sm" aria-label="Pagination">
                                <div class="flex-1 flex justify-between sm:hidden">
                                    {% if all_audiobook_purchases.has_previous %}<a href="?purchase_page={{ all_audiobook_purchases.previous_page_number }}{% if request.GET.coin_page %}&coin_page={{ request.GET.coin_page }}{% endif %}{% if request.GET.sub_tx_page %}&sub_tx_page={{ request.GET.sub_tx_page }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Previous</a>
                                    {% else %}<span class="relative inline-flex items-center px-4 py-2 border border-gray-200 text-sm font-medium rounded-md text-gray-400 bg-gray-100 cursor-not-allowed">Previous</span>{% endif %}
                                    {% if all_audiobook_purchases.has_next %}<a href="?purchase_page={{ all_audiobook_purchases.next_page_number }}{% if request.GET.coin_page %}&coin_page={{ request.GET.coin_page }}{% endif %}{% if request.GET.sub_tx_page %}&sub_tx_page={{ request.GET.sub_tx_page }}{% endif %}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Next</a>
                                    {% else %}<span class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-200 text-sm font-medium rounded-md text-gray-400 bg-gray-100 cursor-not-allowed">Next</span>{% endif %}
                                </div>
                                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                    <div><p class="text-sm text-gray-700">Page <span class="font-medium">{{ all_audiobook_purchases.number }}</span> of <span class="font-medium">{{ all_audiobook_purchases.paginator.num_pages }}</span><span class="hidden md:inline"> ({{ all_audiobook_purchases.paginator.count }} items)</span></p></div>
                                    <div>
                                        <span class="relative z-0 inline-flex shadow-sm rounded-md">
                                            {% if all_audiobook_purchases.has_previous %}<a href="?purchase_page={{ all_audiobook_purchases.previous_page_number }}{% if request.GET.coin_page %}&coin_page={{ request.GET.coin_page }}{% endif %}{% if request.GET.sub_tx_page %}&sub_tx_page={{ request.GET.sub_tx_page }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-red-500 focus:border-red-500"><span class="sr-only">Previous</span><i class="fas fa-chevron-left h-5 w-5"></i></a>
                                            {% else %}<span class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-200 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed"><span class="sr-only">Previous</span><i class="fas fa-chevron-left h-5 w-5"></i></span>{% endif %}
                                            <span aria-current="page" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">{{ all_audiobook_purchases.number }}</span>
                                            {% if all_audiobook_purchases.has_next %}<a href="?purchase_page={{ all_audiobook_purchases.next_page_number }}{% if request.GET.coin_page %}&coin_page={{ request.GET.coin_page }}{% endif %}{% if request.GET.sub_tx_page %}&sub_tx_page={{ request.GET.sub_tx_page }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-red-500 focus:border-red-500"><span class="sr-only">Next</span><i class="fas fa-chevron-right h-5 w-5"></i></a>
                                            {% else %}<span class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-200 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed"><span class="sr-only">Next</span><i class="fas fa-chevron-right h-5 w-5"></i></span>{% endif %}
                                        </span>
                                    </div>
                                </div>
                            </nav>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# Right Sidebar / Status & Actions Column #}
            <div class="lg:col-span-1 space-y-8">
                <div class="bg-white rounded-xl shadow-lg">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Account Status & Wallet</h3>
                        <dl class="space-y-3">
                            <div class="flex justify-between items-center">
                                <dt class="text-sm font-medium text-gray-500">Platform Status</dt>
                                <dd class="text-sm text-gray-900">
                                    {% if user_to_view.is_banned_by_admin %}
                                        <span class="px-2.5 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Platform Banned</span>
                                    {% elif not user_to_view.is_active %}
                                        <span class="px-2.5 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Inactive</span>
                                    {% else %}
                                        <span class="px-2.5 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                                    {% endif %}
                                </dd>
                            </div>
                            {% if user_to_view.is_banned_by_admin %}
                            <div><dt class="text-sm font-medium text-gray-500 mb-0.5">Ban Reason</dt><dd class="mt-1 text-sm text-gray-700 bg-gray-50 p-2 rounded-md border border-gray-200 whitespace-pre-wrap break-words">{{ user_to_view.platform_ban_reason|default:"No reason provided."|linebreaksbr }}</dd></div>
                            <div><dt class="text-sm font-medium text-gray-500">Banned At</dt><dd class="mt-1 text-sm text-gray-900">{{ user_to_view.platform_banned_at|date:"M d, Y @ H:i" }}</dd></div>
                            <div><dt class="text-sm font-medium text-gray-500">Banned By</dt><dd class="mt-1 text-sm text-gray-900">{{ user_to_view.platform_banned_by.username|default:"N/A" }}</dd></div>
                            {% endif %}
                            <div class="flex justify-between items-center pt-2 border-t border-gray-200"><dt class="text-sm font-medium text-gray-500">Coins Balance</dt><dd class="text-sm text-gray-900 font-semibold flex items-center">{{ user_to_view.coins|intcomma }} <i class="fas fa-coins text-yellow-500 ml-1.5"></i></dd></div>
                        </dl>
                    </div>
                    {% if not user_to_view.is_superuser %}
                    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 rounded-b-xl">
                        <h4 class="text-sm font-medium text-gray-600 mb-2">Admin Actions:</h4>
                        <div class="space-y-2">
                             <a href="{% url 'AudioXApp:admin_user_activity_log_specific' user_to_view.user_id %}"
                               class="w-full flex items-center justify-center px-4 py-2.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 border border-transparent rounded-lg transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-sm">
                                <i class="fas fa-history mr-2"></i>View Activity Log
                            </a>
                            {% if user_to_view.is_banned_by_admin or not user_to_view.is_active %}
                                <form method="POST" action="{% url 'AudioXApp:admin_unban_user' user_to_view.user_id %}" class="w-full" onsubmit="return confirm('Are you sure you want to unban this user? This will also unban their creator profile if applicable and was banned due to platform ban.');">{% csrf_token %}<input type="hidden" name="next" value="{{ request.get_full_path }}"><button type="submit" class="w-full flex items-center justify-center px-4 py-2.5 text-sm font-medium text-green-700 bg-green-100 hover:bg-green-200 border border-green-200 rounded-lg transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 shadow-sm"><i class="fas fa-check-circle mr-2"></i>Unban & Activate User</button></form>
                            {% else %}
                                <button type="button" onclick="openBanModal('{{ user_to_view.user_id }}', '{{ user_to_view.username|escapejs }}')" class="w-full flex items-center justify-center px-4 py-2.5 text-sm font-medium text-red-700 bg-red-100 hover:bg-red-200 border border-red-200 rounded-lg transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 shadow-sm"><i class="fas fa-ban mr-2"></i>Ban User</button>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                {% if creator_profile %}
                <div class="bg-white rounded-xl shadow-lg">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Creator Profile</h3>
                        <dl class="space-y-3">
                            <div class="flex justify-between items-center"><dt class="text-sm font-medium text-gray-500">Creator ID (CID)</dt><dd class="text-sm text-gray-900">{{ creator_profile.cid|default:"N/A" }}</dd></div>
                            <div class="flex justify-between items-center"><dt class="text-sm font-medium text-gray-500">Creator Name</dt><dd class="text-sm text-gray-900">{{ creator_profile.creator_name }}</dd></div>
                            <div class="flex justify-between items-center"><dt class="text-sm font-medium text-gray-500">Unique Handle</dt><dd class="text-sm text-gray-900">@{{ creator_profile.creator_unique_name }}</dd></div>
                            <div class="flex justify-between items-center">
                                <dt class="text-sm font-medium text-gray-500">Verification Status</dt>
                                <dd class="text-sm">
                                    {% if creator_profile.is_banned %}
                                        <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Banned</span>
                                    {% elif creator_profile.verification_status == 'approved' %}
                                        <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Approved</span>
                                    {% elif creator_profile.verification_status == 'pending' %}
                                        <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                                    {% elif creator_profile.verification_status == 'rejected' %}
                                        <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-700">Rejected</span>
                                    {% else %}
                                        <span class="text-gray-900">{{ creator_profile.get_verification_status_display }}</span>
                                    {% endif %}
                                </dd>
                            </div>
                            {% if creator_profile.is_banned and creator_profile.ban_reason %}<div><dt class="text-sm font-medium text-gray-500">Creator Ban Reason</dt><dd class="mt-1 text-sm text-gray-700 bg-gray-50 p-2 rounded-md border border-gray-200 whitespace-pre-wrap break-words">{{ creator_profile.ban_reason|linebreaksbr }}</dd></div>{% endif %}
                            {% if creator_profile.verification_status == 'rejected' and creator_profile.rejection_reason %}<div><dt class="text-sm font-medium text-gray-500">Last Rejection Reason</dt><dd class="mt-1 text-sm text-gray-700 bg-gray-50 p-2 rounded-md border border-gray-200 whitespace-pre-wrap break-words">{{ creator_profile.rejection_reason|linebreaksbr }}</dd></div>{% endif %}
                            <div class="flex justify-between items-center"><dt class="text-sm font-medium text-gray-500">Available Balance</dt><dd class="text-sm text-gray-900 font-semibold">PKR {{ creator_profile.available_balance|floatformat:2|intcomma }}</dd></div>
                            <div class="flex justify-between items-center"><dt class="text-sm font-medium text-gray-500">Total Earnings</dt><dd class="text-sm text-gray-900 font-semibold">PKR {{ creator_profile.total_earning|floatformat:2|intcomma }}</dd></div>
                            <div class="flex justify-between items-center"><dt class="text-sm font-medium text-gray-500">Approved At</dt><dd class="text-sm text-gray-900">{{ creator_profile.approved_at|date:"M d, Y @ H:i"|default:"N/A" }}</dd></div>
                            <div class="pt-3 border-t border-gray-200">
                                <dt class="text-sm font-medium text-gray-500 mb-1">CNIC Images</dt>
                                <dd class="text-sm text-gray-900 flex space-x-4">
                                    <span>Front: {% if creator_profile.cnic_front %}<a href="{{ creator_profile.cnic_front.url }}" target="_blank" class="text-red-600 hover:text-red-800 underline">View</a>{% else %}N/A{% endif %}</span>
                                    <span>Back: {% if creator_profile.cnic_back %}<a href="{{ creator_profile.cnic_back.url }}" target="_blank" class="text-red-600 hover:text-red-800 underline">View</a>{% else %}N/A{% endif %}</span>
                                </dd>
                            </div>
                        </dl>
                    </div>
                </div>
                {% endif %}

                {% if subscription_info %}
                <div class="bg-white rounded-xl shadow-lg">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Subscription Details</h3>
                        <dl class="space-y-3">
                            <div class="flex justify-between items-center"><dt class="text-sm font-medium text-gray-500">Plan</dt><dd class="text-sm text-gray-900">{{ subscription_info.get_plan_display }}</dd></div>
                            <div class="flex justify-between items-center"><dt class="text-sm font-medium text-gray-500">Status</dt><dd class="text-sm text-gray-900">{{ subscription_info.get_status_display|capfirst }}</dd></div>
                            <div class="flex justify-between items-center"><dt class="text-sm font-medium text-gray-500">Start Date</dt><dd class="text-sm text-gray-900">{{ subscription_info.start_date|date:"M d, Y @ H:i" }}</dd></div>
                            <div class="flex justify-between items-center"><dt class="text-sm font-medium text-gray-500">End Date</dt><dd class="text-sm text-gray-900">{{ subscription_info.end_date|date:"M d, Y @ H:i"|default:"N/A" }}</dd></div>
                            {% if subscription_info.stripe_subscription_id %}<div class="flex justify-between items-center"><dt class="text-sm font-medium text-gray-500">Stripe Sub ID</dt><dd class="text-sm text-gray-900 break-all" title="{{ subscription_info.stripe_subscription_id }}">{{ subscription_info.stripe_subscription_id|truncatechars:20 }}</dd></div>{% endif %}
                            {% if subscription_info.stripe_payment_method_brand %}<div class="flex justify-between items-center"><dt class="text-sm font-medium text-gray-500">Payment Card</dt><dd class="text-sm text-gray-900">{{ subscription_info.stripe_payment_method_brand|capfirst }} ending in {{ subscription_info.stripe_payment_method_last4 }}</dd></div>{% endif %}
                        </dl>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div id="banUserModal" class="fixed inset-0 z-[1050] hidden items-center justify-center overflow-y-auto overflow-x-hidden bg-gray-900/75 p-4 transition-opacity duration-300 ease-in-out">
            <div class="relative w-full max-w-lg transform rounded-xl bg-white text-gray-800 shadow-2xl transition-all duration-300 ease-in-out">
                <div class="flex items-center justify-between p-5 border-b border-gray-200 rounded-t"><h5 class="text-xl font-semibold text-gray-900" id="banModalTitle">Ban User</h5><button type="button" class="p-1 text-2xl text-gray-400 hover:text-gray-600 transition-colors" onclick="closeBanModal()" aria-label="Close">&times;</button></div>
                <form id="banUserForm" method="POST" action=""> {% csrf_token %}<input type="hidden" name="next" id="banModalNextUrl_userDetail" value="{{ request.get_full_path }}"><div class="p-6 space-y-4"><p class="text-sm text-gray-600">You are about to ban the user: <strong id="banUserUsername_userDetail" class="text-gray-800 font-medium"></strong>. This action will also deactivate their account and prevent login.</p><p class="text-sm text-gray-600">If the user is also a creator, their creator profile will also be marked as banned.</p><div><label for="ban_reason_modal_userDetail" class="block mb-1.5 text-sm font-medium text-gray-700">Reason for Banning (Required):</label><textarea id="ban_reason_modal_userDetail" name="ban_reason" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm text-gray-900 placeholder-gray-400 min-h-[100px]" rows="4" required placeholder="Enter reason for banning..."></textarea></div></div>
                <div class="flex items-center justify-end p-5 space-x-3 border-t border-gray-200 bg-gray-50 rounded-b"><button type="button" onclick="closeBanModal()" class="px-5 py-2.5 text-sm font-medium text-gray-700 bg-white hover:bg-gray-100 border border-gray-300 rounded-lg transition-all duration-150 shadow-sm">Cancel</button><button type="submit" class="px-5 py-2.5 text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-500/50 rounded-lg transition-all duration-150 shadow-md"><i class="fas fa-ban mr-1.5"></i>Confirm Ban</button></div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
    const banUserModal = document.getElementById('banUserModal'); // Use a consistent ID
    const banUserForm = document.getElementById('banUserForm');
    const banModalTitle = document.getElementById('banModalTitle');
    const banUserUsernameSpan = document.getElementById('banUserUsername_userDetail'); // Ensure this ID matches the span
    const banReasonTextarea = document.getElementById('ban_reason_modal_userDetail');
    const banModalNextInput = document.getElementById('banModalNextUrl_userDetail');

    function openBanModal(userId, username) {
        if (banUserForm) {
            let banUrl = "{% url 'AudioXApp:admin_ban_user' 0 %}".replace('0', userId.toString());
            banUserForm.action = banUrl;
        }
        if (banModalTitle) banModalTitle.textContent = 'Ban User: ' + username;
        if (banUserUsernameSpan) banUserUsernameSpan.textContent = username; // Corrected variable name
        if (banModalNextInput) banModalNextInput.value = window.location.pathname + window.location.search;

        if (banUserModal) {
            banUserModal.classList.remove('hidden');
            banUserModal.classList.add('flex'); // For flex centering
        }
        if (banReasonTextarea) banReasonTextarea.focus();
    }

    function closeBanModal() {
        if (banUserModal) {
            banUserModal.classList.add('hidden');
            banUserModal.classList.remove('flex');
        }
        if (banUserForm) banUserForm.action = ''; // Reset action
        if (banReasonTextarea) banReasonTextarea.value = ''; // Clear textarea
    }

    // Close modal on escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape" && banUserModal && !banUserModal.classList.contains('hidden')) {
            closeBanModal();
        }
    });

    // Close modal on outside click
    window.addEventListener('click', function(event) {
      if (banUserModal && event.target == banUserModal) {
        closeBanModal();
      }
    });
</script>
{% endblock %}
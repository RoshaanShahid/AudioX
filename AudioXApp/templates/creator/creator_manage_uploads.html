{% extends 'creator/creator_base.html' %}
{% load static %}
{% load humanize %}
{% load l10n %}

{% block title %}Manage Audiobook: {{ audiobook.title|default:"Untitled" }} - Creator Area{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    /* Styles for input type toggle buttons (file vs TTS) 
       These are now primarily driven by Tailwind on the buttons themselves,
       but keeping for potential fallback or other elements if any.
    */
    .input-type-toggle-btn-base.active { /* More specific base for active if needed */
        background-color: #091e65; /* theme-primary */
        color: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .input-type-toggle-btn-base { /* More specific base for inactive if needed */
        background-color: #e2e8f0; /* slate-200 */
        color: #475569; /* slate-600 */
    }
    .input-type-toggle-btn-base:hover:not(.active) {
        background-color: #cbd5e1; /* slate-300 */
    }

    /* Smooth transitions for chapter control visibility */
    .chapter-card .tts-generation-controls,
    .chapter-card .file-upload-controls,
    .chapter-card .locked-generated-audio-display,
    #addChapterFormContainer .tts-generation-controls,
    #addChapterFormContainer .file-upload-controls,
    #addChapterFormContainer .locked-generated-audio-display {
        transition: all 0.3s ease-in-out;
    }

    /* Styling for TTS preview player */
    .chapter-tts-preview-player { 
        width: 100%;
        margin-top: 0.75rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    /* Ensure hidden elements are truly hidden */
    .chapter-tts-preview-player-container.hidden,
    .confirm-use-generated-audio-btn.hidden,
    .locked-generated-audio-display.hidden {
        display: none;
    }
    /* Styling for TTS generation button (remains specific) */
    .generate-chapter-tts-preview-btn { 
        background-color: #091e65; /* theme-primary */
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        padding-left: 1rem;
        padding-right: 1rem;
        font-size: 0.75rem; 
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .generate-chapter-tts-preview-btn:hover {
        background-color: #071852; /* theme-primary-darker */
    }
    /* Styling for locked generated audio display box */
    .locked-generated-audio-display .info-box {
        background-color: #e0f2fe; /* sky-100 */
        border-color: #7dd3fc; /* sky-300 */
        color: #0c4a6e; /* sky-800 */
    }
    /* Custom scrollbar for chapter list */
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1; 
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1; 
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8; 
    }
</style>
{% endblock %}

{% block page_title %}Manage Audiobook{% endblock %}

{% block page_subtitle %}
<p class="mt-1 text-sm text-[#091e65]/80">Edit details and manage chapters for "<span class="font-semibold">{{ audiobook.title|default:"Untitled Audiobook" }}</span>".</p>
{% endblock %}

{% block content %}
<div class="w-full py-8">

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 xl:gap-10">

        <div class="lg:col-span-1 space-y-8">
            <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100">
                <h2 class="text-lg font-semibold text-[#091e65] mb-4 pb-3 border-b border-slate-200 flex items-center">
                    <i class="fas fa-image mr-3 text-[#091e65]/70 text-xl"></i> Cover Art
                </h2>
                <div class="flex-grow flex flex-col justify-center">
                    <div class="relative group aspect-[4/3] rounded-xl border-2 border-dashed border-slate-300 flex items-center justify-center text-center bg-slate-50 overflow-hidden hover:border-[#091e65]/60 transition-colors duration-200 {% if audiobook.cover_image %}border-solid border-[#091e65]/80{% endif %}">
                        <img id="coverImagePreview" 
                             src="{% if submitted_values.current_cover_image_url %}{{ submitted_values.current_cover_image_url }}{% elif audiobook.cover_image and audiobook.cover_image.url %}{{ audiobook.cover_image.url }}{% else %}https://placehold.co/400x300/e2e8f0/64748b?text=No+Cover{% endif %}" 
                             alt="Cover Preview" 
                             class="absolute inset-0 h-full w-full object-cover z-0 transition-opacity duration-300">
                        <label for="cover_image_input_main_form" class="absolute inset-0 cursor-pointer z-20 flex items-center justify-center opacity-0 hover:opacity-100 bg-black/50 rounded-xl transition-opacity duration-300">
                            <div class="text-white text-center">
                                <svg class="mx-auto h-10 w-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                                <span class="mt-2 block text-xs font-semibold">Change Cover</span>
                            </div>
                        </label>
                    </div>
                    <div id="coverImageNameDisplay" class="mt-1.5 text-xs text-slate-500 font-medium truncate max-w-full text-center">
                        {% if audiobook.cover_image and audiobook.cover_image.name %}{{ audiobook.cover_image.name|cut:"audiobook_covers/" }}{% else %}No image uploaded{% endif %}
                    </div>
                    {% if form_errors.cover_image %}<p class="text-red-500 text-sm mt-1 text-center">{{ form_errors.cover_image }}</p>{% endif %}
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100">
                <h2 class="text-lg font-semibold text-[#091e65] mb-4 pb-3 border-b border-slate-200 flex items-center">
                   <i class="fas fa-tags mr-3 text-[#091e65]/70 text-xl"></i> Pricing
                </h2>
                <div class="space-y-2">
                    <p class="text-sm text-slate-600">Pricing Type:</p>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold {% if audiobook.is_paid %}bg-blue-100 text-[#091e65]{% else %}bg-green-100 text-green-800{% endif %}">
                        <i class="fas mr-2 {% if audiobook.is_paid %}fa-dollar-sign{% else %}fa-gift{% endif %}"></i>
                        {% if audiobook.is_paid %}Paid{% else %}Free{% endif %}
                    </span>
                    {% if audiobook.is_paid %}
                    <div>
                        <p class="text-sm text-slate-600 mt-3">Price:</p>
                        <p class="text-lg font-bold text-slate-800">PKR {{ audiobook.price|floatformat:2|intcomma }}</p>
                    </div>
                    {% endif %}
                    <p class="text-xs text-slate-400 pt-2">Pricing cannot be changed after creation.</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100">
                <div class="flex justify-between items-center mb-4 pb-3 border-b border-slate-200">
                    <h2 class="text-lg font-semibold text-[#091e65] flex items-center">
                        <i class="fas fa-sliders-h mr-3 text-[#091e65]/70 text-xl"></i> Audiobook Status
                    </h2>
                    {% with status_val=audiobook.status %}
                        {% if status_val == 'PUBLISHED' %}<span class="px-3 py-1.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 items-center"><i class="fas fa-check-circle mr-1.5"></i> Published</span>
                        {% elif status_val == 'PENDING' %}<span class="px-3 py-1.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-amber-100 text-amber-800 items-center"><i class="fas fa-clock mr-1.5"></i> Pending Review</span>
                        {% elif status_val == 'INACTIVE' %}<span class="px-3 py-1.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-slate-100 text-slate-800 items-center"><i class="fas fa-pause-circle mr-1.5"></i> Inactive</span>
                        {% elif status_val == 'REJECTED' %}<span class="px-3 py-1.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 items-center"><i class="fas fa-times-circle mr-1.5"></i> Rejected</span>
                        {% elif status_val == 'PAUSED_BY_ADMIN' %}<span class="px-3 py-1.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800 items-center"><i class="fas fa-exclamation-triangle mr-1.5"></i> Paused by Admin</span>
                        {% else %}<span class="px-3 py-1.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-slate-100 text-slate-700 items-center"><i class="fas fa-question-circle mr-1.5"></i> {{ audiobook.get_status_display }}</span>
                        {% endif %}
                    {% endwith %}
                </div>

                <div class="space-y-3">
                    {% if audiobook.status == 'PAUSED_BY_ADMIN' or audiobook.status == 'REJECTED' %}
                        <div class="p-3.5 rounded-lg {% if audiobook.status == 'REJECTED' %}bg-red-50 border border-red-200{% else %}bg-orange-50 border border-orange-200{% endif %}">
                            <p class="text-sm {% if audiobook.status == 'REJECTED' %}text-red-700{% else %}text-orange-700{% endif %}">
                                This audiobook's status ({{ audiobook.get_status_display|lower }}) was set by an administrator.
                                {% if audiobook.status == 'PAUSED_BY_ADMIN' %}Please <a href="{% url 'AudioXApp:contactus' %}" class="font-medium underline hover:text-orange-800">contact support</a> if you have questions.{% endif %}
                                {% if audiobook.status == 'REJECTED' %}It cannot be changed by you.{% endif %}
                            </p>
                        </div>
                    {% endif %}

                    {% if can_creator_change_status %}
                        <form method="post" action="{% url 'AudioXApp:creator_manage_upload_detail' audiobook_slug=audiobook.slug %}" id="statusUpdateFormHtml" class="manage-audiobook-form">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="update_status_only">
                            <div>
                                <label for="status_only_select_html" class="block text-sm font-medium text-slate-700 mb-1.5">Change Status to:</label>
                                <div class="relative">
                                    <select name="status_only_select" id="status_only_select_html" data-initial-status="{{ audiobook.status|escapejs }}"
                                            class="block w-full pl-3 pr-10 py-2.5 text-base border-slate-300 focus:outline-none focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm rounded-lg shadow-sm appearance-none transition duration-150 ease-in-out">
                                        {% for value, display_name in creator_allowed_status_choices_for_toggle %}
                                            <option value="{{ value }}" {% if submitted_values.status_only_select|default:audiobook.status == value %}selected{% endif %}>
                                                {{ display_name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                                        <svg class="fill-current h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                                    </div>
                                </div>
                                {% if form_errors.status_update_status %} 
                                    <p class="text-red-500 text-sm mt-1">{{ form_errors.status_update_status }}</p>
                                {% endif %}
                            </div>
                            <div class="mt-5 flex justify-end">
                                <button type="submit" 
                                        class="inline-flex items-center px-5 py-2.5 border border-transparent text-sm font-medium rounded-lg shadow-md text-white bg-[#091e65] hover:bg-[#071852] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#091e65] transition-all duration-150 ease-in-out disabled:opacity-60 disabled:cursor-not-allowed">
                                    <i class="fas fa-check-circle mr-2"></i>Update Status
                                </button>
                            </div>
                        </form>
                    {% else %}
                        <p class="text-sm text-slate-500 bg-slate-50 p-3 rounded-md border border-slate-200">
                            The current status (<span class="font-semibold">{{ audiobook.get_status_display }}</span>) does not allow for changes from your end.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-8">
            <form method="post" enctype="multipart/form-data" action="{% url 'AudioXApp:creator_manage_upload_detail' audiobook_slug=audiobook.slug %}" id="detailsForm" class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl border border-slate-100 manage-audiobook-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="edit_audiobook_details">
                <input type="file" name="cover_image" id="cover_image_input_main_form" class="hidden" accept="image/jpeg, image/png, image/jpg">

                <h2 class="text-lg font-semibold text-[#091e65] mb-6 pb-4 border-b border-slate-200 flex items-center">
                    <i class="fas fa-info-circle mr-3 text-[#091e65]/70 text-xl"></i> Audiobook Information
                </h2>
                <div class="space-y-5">
                    <div>
                        <label for="title-edit" class="block text-sm font-medium text-slate-700 mb-1">Audiobook Title <span class="text-red-600">*</span></label>
                        <input type="text" name="title" id="title-edit" required value="{{ submitted_values.title|default:audiobook.title|default_if_none:'' }}" class="block w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#091e65]/50 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out">
                        {% if form_errors.title %}<p class="text-red-500 text-sm mt-1">{{ form_errors.title }}</p>{% endif %}
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                        <div>
                            <label for="author-edit" class="block text-sm font-medium text-slate-700 mb-1">Author Name <span class="text-red-600">*</span></label>
                            <input type="text" name="author" id="author-edit" required value="{{ submitted_values.author|default:audiobook.author|default_if_none:'' }}" class="block w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#091e65]/50 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out">
                           {% if form_errors.author %}<p class="text-red-500 text-sm mt-1">{{ form_errors.author }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="narrator-edit" class="block text-sm font-medium text-slate-700 mb-1">Narrator Name <span class="text-red-600">*</span></label>
                            <input type="text" name="narrator" id="narrator-edit" required value="{{ submitted_values.narrator|default:audiobook.narrator|default_if_none:'' }}" class="block w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#091e65]/50 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out">
                            {% if form_errors.narrator %}<p class="text-red-500 text-sm mt-1">{{ form_errors.narrator }}</p>{% endif %}
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                        <div>
                            <label for="genre-edit" class="block text-sm font-medium text-slate-700 mb-1">Genre <span class="text-red-600">*</span></label>
                            <input type="text" name="genre" id="genre-edit" required value="{{ submitted_values.genre|default:audiobook.genre|default_if_none:'' }}" class="block w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#091e65]/50 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out">
                            {% if form_errors.genre %}<p class="text-red-500 text-sm mt-1">{{ form_errors.genre }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="language-edit" class="block text-sm font-medium text-slate-700 mb-1">Language <span class="text-red-600">*</span></label>
                            <div class="relative">
                                <select name="language" id="language-edit" required class="block w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#091e65]/50 focus:border-[#091e65] sm:text-sm appearance-none pr-10 bg-no-repeat transition duration-150 ease-in-out" style="background-position: right 0.5rem center; background-size: 1.5em 1.5em;">
                                    <option value="" {% if not submitted_values.language and not audiobook.language %}selected{% endif %} disabled>Select Language...</option>
                                    {% with current_lang=submitted_values.language|default:audiobook.language %}
                                    <option value="English" {% if current_lang == "English" %}selected{% endif %}>English</option>
                                    <option value="Urdu" {% if current_lang == "Urdu" %}selected{% endif %}>Urdu (اردو)</option>
                                    <option value="Punjabi" {% if current_lang == "Punjabi" %}selected{% endif %}>Punjabi (پنجابی)</option>
                                    <option value="Sindhi" {% if current_lang == "Sindhi" %}selected{% endif %}>Sindhi (سنڌي)</option>
                                    {% endwith %}
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                                    <svg class="fill-current h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                                </div>
                            </div>
                           {% if form_errors.language %}<p class="text-red-500 text-sm mt-1">{{ form_errors.language }}</p>{% endif %}
                        </div>
                    </div>
                    <div>
                        <label for="description-edit" class="block text-sm font-medium text-slate-700 mb-1">Description <span class="text-red-600">*</span></label>
                        <textarea name="description" id="description-edit" rows="6" required class="block w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#091e65]/50 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out">{{ submitted_values.description|default:audiobook.description|default_if_none:'' }}</textarea>
                        {% if form_errors.description %}<p class="text-red-500 text-sm mt-1">{{ form_errors.description }}</p>{% endif %}
                    </div>
                    {% if form_errors.general_error %}<div class="mt-3 p-3 bg-red-50 border-l-4 border-red-500 rounded-md"><p class="text-sm text-red-700 font-medium">{{ form_errors.general_error }}</p></div>{% endif %}
                    <div class="pt-5 border-t border-slate-200 flex justify-end">
                        <button type="submit" class="inline-flex justify-center items-center py-2.5 px-6 border border-transparent rounded-lg shadow-md text-sm font-semibold text-white bg-[#091e65] hover:bg-[#071852] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#091e65] transition duration-150 ease-in-out">
                            <i class="fas fa-save w-4 h-4 mr-2 -ml-1"></i> Save Details
                        </button>
                    </div>
                </div>
            </form>

            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl border border-slate-100">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 pb-4 border-b border-slate-200">
                    <h2 class="text-lg font-semibold text-[#091e65] flex items-center">
                       <i class="fas fa-list-ol mr-3 text-[#091e65]/70 text-xl"></i> Chapters
                    </h2>
                    <button type="button" id="toggleAddChapterFormBtn" 
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-md text-white bg-[#091e65] hover:bg-[#071852] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#091e65] transition duration-150 ease-in-out whitespace-nowrap">
                        <i id="addChapterIcon" class="fas {% if form_errors.add_chapter_active_with_errors %}fa-times{% else %}fa-plus{% endif %} transition-transform duration-300 ease-in-out"></i>
                        <span id="addChapterText" class="ml-2">{% if form_errors.add_chapter_active_with_errors %}Cancel Adding{% else %}Add New Chapter{% endif %}</span>
                    </button>
                </div>

                <div id="addChapterFormContainer" class="border border-blue-300 bg-blue-50 p-5 rounded-xl mb-6 {% if not form_errors.add_chapter_active_with_errors %}hidden{% endif %}"> 
                    <h4 class="text-md font-semibold text-blue-800 mb-4 border-b border-blue-200 pb-2">Add New Chapter Details</h4>
                    <form method="post" enctype="multipart/form-data" action="{% url 'AudioXApp:creator_manage_upload_detail' audiobook_slug=audiobook.slug %}" id="addChapterForm" class="manage-audiobook-form">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add_chapter">
                        <input type="hidden" name="new_chapter_input_type_hidden" value="{{ submitted_values.new_chapter_input_type_hidden|default:'file' }}" class="new-chapter-input-type-hidden-js">
                        <input type="hidden" name="new_chapter_generated_tts_url" value="{{ submitted_values.new_chapter_generated_tts_url|default:'' }}" class="new-chapter-generated-tts-url-input-js">

                        <div class="space-y-4">
                            <div>
                                <label for="new_chapter_title" class="block text-sm font-medium text-slate-700 mb-1">Chapter Title <span class="text-red-600">*</span></label>
                                <input type="text" name="new_chapter_title" id="new_chapter_title" required 
                                       value="{{ submitted_values.new_chapter_title|default:'' }}" 
                                       class="block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:ring-1 focus:ring-[#091e65] focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out bg-white">
                                {% if form_errors.add_chapter_errors.new_chapter_title %}
                                    <p class="text-red-500 text-xs mt-1">{{ form_errors.add_chapter_errors.new_chapter_title }}</p>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label class="block text-xs font-medium text-slate-600 mb-1.5">Audio Source:</label>
                                <div class="flex rounded-lg p-0.5 bg-slate-200 border border-slate-300">
                                    <button type="button" class="new-chapter-input-type-toggle-btn input-type-toggle-btn-base flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors {% if submitted_values.new_chapter_input_type_hidden|default:'file' == 'file' %}active{% endif %}" data-type="file">Upload File</button>
                                    <button type="button" class="new-chapter-input-type-toggle-btn input-type-toggle-btn-base flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors {% if submitted_values.new_chapter_input_type_hidden == 'tts' or submitted_values.new_chapter_input_type_hidden == 'generated_tts' %}active{% endif %}" data-type="tts">Use AudioX TTS</button>
                                </div>
                                {% if form_errors.add_chapter_errors.new_chapter_input_type %}
                                    <p class="text-red-500 text-xs mt-1">{{ form_errors.add_chapter_errors.new_chapter_input_type }}</p>
                                {% endif %}
                            </div>

                            <div class="new-chapter-file-upload-controls {% if submitted_values.new_chapter_input_type_hidden == 'tts' or submitted_values.new_chapter_input_type_hidden == 'generated_tts' %}hidden{% endif %}">
                                <label for="new_chapter_audio" class="block text-sm font-medium text-slate-700 mb-1">Audio File <span class="text-red-600">*</span> <span class="text-slate-400 text-xs">(MP3, WAV, OGG, M4A - Max 50MB)</span></label>
                                <input type="file" name="new_chapter_audio" id="new_chapter_audio" accept="audio/mpeg, audio/mp3, audio/wav, audio/ogg, audio/x-m4a, audio/m4a" class="block w-full text-sm text-slate-500 file:mr-3 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-[#091e65]/10 file:text-[#091e65] hover:file:bg-[#091e65]/20 cursor-pointer transition duration-150 ease-in-out"/>
                                {% if form_errors.add_chapter_errors.new_chapter_audio %}
                                    <p class="text-red-500 text-xs mt-1">{{ form_errors.add_chapter_errors.new_chapter_audio }}</p>
                                {% endif %}
                            </div>

                            <div class="new-chapter-tts-generation-controls {% if submitted_values.new_chapter_input_type_hidden == 'file' or not submitted_values.new_chapter_input_type_hidden %}hidden{% endif %}">
                                <div class="mb-2">
                                    <label for="new_chapter_text_content" class="block text-sm font-medium text-slate-700 mb-1">Text for TTS <span class="text-red-600">*</span></label>
                                    <textarea name="new_chapter_text_content" id="new_chapter_text_content" rows="3" class="block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:ring-1 focus:ring-[#091e65] focus:border-[#091e65] sm:text-sm placeholder-slate-400 bg-white">{{ submitted_values.new_chapter_text_content|default:'' }}</textarea>
                                    {% if form_errors.add_chapter_errors.new_chapter_text_content %}
                                        <p class="text-red-500 text-xs mt-1">{{ form_errors.add_chapter_errors.new_chapter_text_content }}</p>
                                    {% endif %}
                                </div>
                                <div class="mb-2">
                                    <label for="new_chapter_tts_voice" class="block text-sm font-medium text-slate-700 mb-1">Narrator Voice <span class="text-red-600">*</span></label>
                                    <select name="new_chapter_tts_voice" id="new_chapter_tts_voice" class="block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:ring-1 focus:ring-[#091e65] focus:border-[#091e65] sm:text-sm bg-white">
                                        <option value="" {% if not submitted_values.new_chapter_tts_voice or submitted_values.new_chapter_tts_voice == 'default' %}selected{% endif %} disabled>Select Narrator...</option>
                                        {% for voice_choice_val, voice_display_name_val in TTS_VOICE_CHOICES_FOR_JS %} 
                                            <option value="{{ voice_choice_val }}" {% if submitted_values.new_chapter_tts_voice == voice_choice_val %}selected{% endif %}>{{ voice_display_name_val }}</option>
                                        {% endfor %}
                                    </select>
                                    {% if form_errors.add_chapter_errors.new_chapter_tts_voice %}
                                        <p class="text-red-500 text-xs mt-1">{{ form_errors.add_chapter_errors.new_chapter_tts_voice }}</p>
                                    {% endif %}
                                </div>
                                <div class="new-chapter-tts-preview-player-container hidden my-2">
                                    <audio controls class="chapter-tts-preview-player w-full"></audio>
                                </div>
                                <div class="new-chapter-tts-message text-xs my-1.5 min-h-[16px]"></div>
                                <div class="flex flex-wrap gap-2 items-center">
                                    <button type="button" class="generate-new-chapter-tts-preview-btn text-xs text-white transition-colors flex items-center gap-1.5"> {# py-1.5 px-3 rounded-md shadow-sm generate-chapter-tts-preview-btn #}
                                        <span class="btn-text"><i class="fas fa-magic mr-1"></i>Generate & Preview</span>
                                        <span class="spinner hidden"><svg class="animate-spin h-3 w-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></span>
                                    </button>
                                    <button type="button" class="confirm-use-new-chapter-generated-audio-btn hidden text-xs py-1.5 px-3 rounded-md bg-green-600 hover:bg-green-700 text-white shadow-sm transition-colors flex items-center gap-1.5">
                                        <i class="fas fa-check-circle mr-1"></i>Use This Audio
                                    </button>
                                </div>
                                {% if form_errors.add_chapter_errors.new_chapter_tts_general %}
                                    <p class="text-red-500 text-xs mt-1">{{ form_errors.add_chapter_errors.new_chapter_tts_general }}</p>
                                {% endif %}
                            </div>
                            
                            <div class="new-chapter-locked-generated-audio-display locked-generated-audio-display mt-3 {% if not submitted_values.new_chapter_generated_tts_url %}hidden{% endif %}">
                                <p class="text-xs font-medium text-slate-700 mb-0.5">Selected Audio for New Chapter:</p>
                                <div class="info-box p-2.5 border rounded-lg text-sm">
                                        <i class="fas fa-volume-up mr-1.5 text-blue-600"></i>
                                    <span class="new-chapter-generated-tts-filename-js font-medium">
                                        {% if submitted_values.new_chapter_generated_tts_url %}
                                            Generated Audio File
                                            {% if submitted_values.new_chapter_tts_voice_display_name %}
                                                (Voice: {{ submitted_values.new_chapter_tts_voice_display_name }})
                                            {% endif %}
                                        {% else %}
                                            Generated Audio
                                        {% endif %}
                                    </span>
                                </div>
                                    {% if form_errors.add_chapter_errors.new_chapter_generated_tts_url %}
                                        <p class="text-red-500 text-xs mt-1">{{ form_errors.add_chapter_errors.new_chapter_generated_tts_url }}</p>
                                    {% endif %}
                            </div>

                            {% if form_errors.add_chapter_errors.add_chapter_general %}
                                <p class="text-red-500 text-sm mt-2 text-center">{{ form_errors.add_chapter_errors.add_chapter_general }}</p>
                            {% endif %}
                            <div class="flex justify-end pt-3">
                                <button type="submit" class="inline-flex items-center px-4 py-2.5 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    <i class="fas fa-plus-circle mr-1.5"></i> Confirm Add Chapter
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                {% if chapters_context_list %}
                    <div class="space-y-6 max-h-[90vh] overflow-y-auto pr-2 -mr-2 custom-scrollbar">
                        {% for chapter_item in chapters_context_list %}
                        {% with chapter=chapter_item.instance chapter_errors=chapter_item.errors initial_input_type=chapter_item.input_type_for_template existing_audio_url=chapter_item.existing_audio_file_url file_size_display=chapter_item.file_size_display %}
                        <div class="chapter-card border border-slate-200 p-5 rounded-xl bg-slate-50 shadow-lg relative" data-chapter-id="{{ chapter.chapter_id }}">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex items-center">
                                    <span class="chapter-number-js flex-shrink-0 w-8 h-8 flex items-center justify-center bg-[#091e65]/10 text-[#091e65] rounded-full text-sm font-semibold mr-3.5">{{ chapter.chapter_order }}</span>
                                    <h3 class="chapter-title-display-js text-lg font-medium text-gray-800 flex-grow">{{ chapter.chapter_name }}</h3>
                                </div>
                                <div class="flex-shrink-0 flex items-center space-x-1">
                                    <button type="button" onclick="toggleEditChapterForm('{{ chapter.chapter_id }}')" class="edit-chapter-btn p-2 rounded-full text-slate-500 hover:text-[#091e65] hover:bg-[#091e65]/10 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-[#091e65]/50 transition-colors duration-150" title="Edit Chapter">
                                        <i class="fas fa-edit fa-fw text-sm"></i>
                                    </button>
                                    <form method="post" action="{% url 'AudioXApp:creator_manage_upload_detail' audiobook_slug=audiobook.slug %}" style="display:inline;" onsubmit="return confirmDeleteChapter('{{ chapter.chapter_name|escapejs }}');" class="manage-audiobook-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="delete_chapter_{{ chapter.chapter_id }}">
                                        <button type="submit" class="p-2 rounded-full text-red-400 hover:bg-red-100 hover:text-red-600 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-red-500 transition-colors duration-150" title="Delete Chapter">
                                            <i class="fas fa-trash-alt fa-fw text-sm"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="px-0 py-1 text-xs text-slate-600 truncate mb-3">
                                <i class="fas fa-file-audio mr-1.5 opacity-70 text-slate-500"></i> 
                                <span class="font-medium">Current Audio:</span>
                                {% if chapter.audio_file and chapter.audio_file.name %}{{ chapter.audio_file.name|cut:"chapters_audio/"|cut:audiobook.slug|cut:"/" }}{% if file_size_display %} <span class="ml-1 opacity-80">({{ file_size_display }})</span>{% endif %}{% else %}No audio file.{% endif %}
                                {% if chapter.is_tts_generated and chapter_item.tts_voice_display_name %}
                                    <span class="ml-2 px-1.5 py-0.5 bg-sky-100 text-sky-700 text-[10px] font-medium rounded-full">TTS: {{ chapter_item.tts_voice_display_name }}</span>
                                {% endif %}
                            </div>

                            <div id="editChapterFormContainer_{{ chapter.chapter_id }}" class="border-t border-slate-300 pt-5 {% if not chapter_errors %}hidden{% endif %}">
                                <form method="post" enctype="multipart/form-data" action="{% url 'AudioXApp:creator_manage_upload_detail' audiobook_slug=audiobook.slug %}" class="space-y-4 manage-audiobook-form edit-chapter-form-js" data-chapter-id="{{ chapter.chapter_id }}">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="edit_chapter_{{ chapter.chapter_id }}">
                                    <input type="hidden" name="edit_chapter_input_type_hidden_{{ chapter.chapter_id }}" value="{{ initial_input_type }}" class="edit-chapter-input-type-hidden-js">
                                    <input type="hidden" name="edit_chapter_generated_tts_url_{{ chapter.chapter_id }}" value="{% if chapter.is_tts_generated and existing_audio_url %}{{ existing_audio_url }}{% endif %}" class="edit-chapter-generated-tts-url-input-js">

                                    <div>
                                        <label for="chapter_title_{{ chapter.chapter_id }}" class="block text-xs font-medium text-slate-600 mb-1">New Chapter Title <span class="text-red-600">*</span></label>
                                        <input type="text" name="chapter_title_{{ chapter.chapter_id }}" id="chapter_title_{{ chapter.chapter_id }}" required 
                                               value="{{ chapter_errors.title.0|default:chapter.chapter_name }}" 
                                               class="block w-full px-3.5 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out shadow-sm bg-white">
                                        {% if chapter_errors.title %}<p class="text-red-500 text-sm mt-1">{{ chapter_errors.title.0 }}</p>{% endif %}
                                    </div>

                                    <div class="mb-3">
                                        <label class="block text-xs font-medium text-slate-600 mb-1.5">Update Audio Source:</label>
                                        <div class="flex rounded-lg p-0.5 bg-slate-200 border border-slate-300">
                                            <button type="button" class="edit-chapter-input-type-toggle-btn input-type-toggle-btn-base flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors {% if initial_input_type == 'file' %}active{% endif %}" data-type="file">Replace with File</button>
                                            <button type="button" class="edit-chapter-input-type-toggle-btn input-type-toggle-btn-base flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors {% if initial_input_type == 'tts' or initial_input_type == 'generated_tts' %}active{% endif %}" data-type="tts">Remake with TTS</button>
                                        </div>
                                        {% if chapter_errors.input_type %}<p class="text-red-500 text-sm mt-1">{{ chapter_errors.input_type.0 }}</p>{% endif %}
                                    </div>

                                    <div class="edit-chapter-file-upload-controls mt-4 {% if initial_input_type == 'tts' or initial_input_type == 'generated_tts' %}hidden{% endif %}">
                                        <label for="chapter_audio_{{ chapter.chapter_id }}" class="block text-xs font-medium text-slate-600 mb-1">New Audio File <span class="text-slate-400 text-[10px]">(Optional, Max 50MB)</span></label>
                                        <label class="block w-full px-3.5 py-2.5 border border-slate-300 rounded-lg bg-white hover:border-[#091e65]/50 transition duration-150 ease-in-out cursor-pointer group/file shadow-sm">
                                            <input type="file" name="chapter_audio_{{ chapter.chapter_id }}" id="chapter_audio_{{ chapter.chapter_id }}" accept="audio/mpeg, audio/mp3, audio/wav, audio/ogg, audio/x-m4a, audio/m4a" class="chapter-audio-input-js hidden">
                                            <div class="flex items-center justify-between text-xs text-slate-500 group-hover/file:text-[#091e65]">
                                                <span class="chapter-filename-js truncate pr-2">Choose new audio file...</span>
                                                <i class="fas fa-upload opacity-60"></i>
                                            </div>
                                        </label>
                                        <p class="text-xs text-slate-500/80 mt-1">MP3, WAV, OGG, M4A (Max 50MB)</p>
                                        {% if chapter_errors.audio %}<p class="text-red-500 text-sm mt-1 chapter-audio-error-js">{{ chapter_errors.audio.0 }}</p>{% endif %}
                                    </div>

                                    <div class="edit-chapter-tts-generation-controls mt-4 {% if initial_input_type == 'file' %}hidden{% endif %}">
                                        <div class="mb-3">
                                            <label for="chapter_text_content_{{ chapter.chapter_id }}" class="block text-xs font-medium text-slate-600 mb-1">Text for TTS <span class="text-red-600">*</span></label>
                                            <textarea name="chapter_text_content_{{ chapter.chapter_id }}" id="chapter_text_content_{{ chapter.chapter_id }}" rows="4" 
                                                      class="chapter-text-content-input-js block w-full px-3.5 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out shadow-sm bg-white"
                                                      placeholder="Enter text for this chapter's audio...">{{ chapter_errors.text.0|default:chapter.text_content|default:'' }}</textarea>
                                            {% if chapter_errors.text %}<p class="text-red-500 text-sm mt-1 chapter-text-error-js">{{ chapter_errors.text.0 }}</p>{% endif %}
                                        </div>
                                        <div class="mb-3">
                                            <label for="chapter_tts_voice_{{ chapter.chapter_id }}" class="block text-xs font-medium text-slate-600 mb-1">Narrator Voice <span class="text-red-600">*</span></label>
                                            <div class="relative">
                                                <select name="chapter_tts_voice_{{ chapter.chapter_id }}" id="chapter_tts_voice_{{ chapter.chapter_id }}" class="chapter-tts-voice-select-js block w-full px-3.5 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm appearance-none pr-10 bg-no-repeat transition duration-150 ease-in-out text-slate-700 shadow-sm">
                                                    <option value="" {% if not chapter.tts_voice_id and not chapter_errors.voice.0 %}selected{% endif %} disabled>Select Narrator...</option>
                                                    {% for voice_choice_val, voice_display_name_val in TTS_VOICE_CHOICES_FOR_JS %} 
                                                        <option value="{{ voice_choice_val }}" {% if chapter_errors.voice.0|default:chapter.tts_voice_id == voice_choice_val %}selected{% endif %}>{{ voice_display_name_val }}</option>
                                                    {% endfor %}
                                                </select>
                                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                                                    <svg class="fill-current h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                                                </div>
                                            </div>
                                            {% if chapter_errors.voice %}<p class="text-red-500 text-sm mt-1 chapter-voice-error-js">{{ chapter_errors.voice.0 }}</p>{% endif %}
                                        </div>
                                        
                                        <div class="chapter-tts-preview-player-container hidden my-3">
                                            <audio controls class="chapter-tts-preview-player w-full"></audio>
                                        </div>
                                        <div class="chapter-tts-message text-xs my-2 min-h-[16px]"></div>
                                        <div class="flex flex-wrap gap-2 items-center">
                                            <button type="button" class="generate-chapter-tts-preview-btn text-xs text-white transition-colors flex items-center gap-1.5"> 
                                                <span class="btn-text"><i class="fas fa-magic mr-1.5"></i>Generate & Preview Audio</span>
                                                <span class="spinner hidden"><svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></span>
                                            </button>
                                            <button type="button" class="confirm-use-generated-audio-btn hidden text-xs py-2 px-4 rounded-lg bg-green-600 hover:bg-green-700 text-white shadow-md transition-colors flex items-center gap-1.5">
                                                <i class="fas fa-check-circle mr-1.5"></i>Use This Audio for Chapter
                                            </button>
                                        </div>
                                        {% if chapter_errors.general %}<p class="text-red-500 text-sm mt-1">{{ chapter_errors.general.0 }}</p>{% endif %}
                                        {% if chapter_errors.tts_general %}<p class="text-red-500 text-sm mt-1">{{ chapter_errors.tts_general.0 }}</p>{% endif %}
                                    </div>
                                    
                                    <div class="locked-generated-audio-display mt-4 {% if initial_input_type != 'generated_tts' or not existing_audio_url %}hidden{% endif %}">
                                        <p class="text-xs font-medium text-slate-700 mb-1">Selected Audio for this Chapter:</p>
                                        <div class="info-box p-3 border rounded-lg text-sm">
                                               <i class="fas fa-volume-up mr-2 text-blue-600"></i>
                                            <span class="chapter-generated-tts-filename-js font-medium">
                                                {% if chapter.is_tts_generated and existing_audio_url %}{{ chapter.audio_file.name|cut:"chapters_audio/"|cut:audiobook.slug|cut:"/" }}{% if chapter_item.tts_voice_display_name %} (Voice: {{ chapter_item.tts_voice_display_name }}){% endif %}{% else %}Generated Audio{% endif %}
                                            </span>
                                        </div>
                                        {% if chapter_errors.generated_tts %}<p class="text-red-500 text-sm mt-1">{{ chapter_errors.generated_tts.0 }}</p>{% endif %}
                                    </div>

                                    <div class="flex justify-end space-x-3 pt-4 mt-4 border-t border-slate-300">
                                        <button type="button" onclick="toggleEditChapterForm('{{ chapter.chapter_id }}')" class="px-5 py-2.5 border border-slate-300 rounded-lg shadow-sm text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 transition duration-150 ease-in-out">Cancel</button>
                                        <button type="submit" class="inline-flex items-center px-5 py-2.5 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-[#091e65] hover:bg-[#071852] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#091e65] transition duration-150 ease-in-out">
                                            <i class="fas fa-save mr-1.5"></i> Save Chapter Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endwith %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-12 px-4 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50">
                        <i class="fas fa-folder-open text-5xl text-slate-300"></i>
                        <p class="mt-4 text-sm font-semibold text-slate-700">No chapters added yet.</p>
                        <p class="mt-1 text-xs text-slate-500">Click 'Add New Chapter' above to get started.</p>
                    </div>
                {% endif %}
                {% if form_errors.general_error_chapter %}<div class="mt-4 p-3 bg-red-50 border-l-4 border-red-500 rounded-md"><p class="text-sm text-red-700 font-medium">{{ form_errors.general_error_chapter }}</p></div>{% endif %}
            </div>
        </div> 
    </div> 
</div>

<div id="loadingOverlayManage" class="fixed inset-0 z-[9999] flex items-center justify-center bg-slate-900/75 backdrop-blur-sm hidden">
    <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-sm w-full">
        <div class="mb-6">
            <svg class="animate-spin h-12 w-12 text-[#091e65] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
        <h2 id="loaderMessageManage" class="text-xl font-semibold text-[#091e65] mb-2">Processing Request...</h2>
        <p class="text-slate-500 text-sm">Please wait a moment.</p>
    </div>
</div>

<script id="django_messages_json" type="application/json">{{ django_messages_json|safe }}</script>
<script id="django-form-errors-data-for-js" type="application/json">{{ form_errors|json_script:"django-form-errors-data-for-js" }}</script>
<script id="generate-tts-preview-url-manage" type="text/plain">{% url 'AudioXApp:generate_tts_preview_audio' %}</script>
<script id="tts-voice-choices-data" type="application/json">{{ TTS_VOICE_CHOICES_FOR_JS|json_script:"tts-voice-choices-data" }}</script>

{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/creator/creator_manage_uploads.js' %}"></script>
{% endblock %}
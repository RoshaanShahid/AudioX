{% extends 'creator/creator_base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Create New Audiobook - AudioX Creator Platform{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    .input-type-toggle-btn.active {
        background-color: #091e65; /* theme-primary */
        color: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .input-type-toggle-btn {
        background-color: #e2e8f0; /* slate-200 */
        color: #475569; /* slate-600 */
    }
    .input-type-toggle-btn:hover:not(.active) {
        background-color: #cbd5e1; /* slate-300 */
    }

    .chapter-card .tts-generation-controls,
    .chapter-card .file-upload-controls,
    .chapter-card .locked-generated-audio-display {
        transition: all 0.3s ease-in-out;
    }

    .chapter-card .chapter-tts-preview-player {
        width: 100%;
        margin-top: 0.75rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .chapter-card .chapter-tts-preview-player-container.hidden {
        display: none;
    }
    .chapter-card .confirm-use-generated-audio-btn.hidden {
        display: none;
    }
    .generate-chapter-tts-preview-btn {
        background-color: #091e65; 
    }
    .generate-chapter-tts-preview-btn:hover {
        background-color: #071852; 
    }

    .locked-generated-audio-display .info-box {
        background-color: #e0f2fe; 
        border-color: #7dd3fc; 
        color: #0c4a6e; 
    }
    /* Style for the select dropdown arrow */
    select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        padding-right: 2.5rem; /* Ensure space for arrow */
    }
</style>
{% endblock %}

{% block content %}
    <div class="mb-10 md:mb-14 text-center">
        <i class="fas fa-microphone-alt text-5xl text-[#091e65] mb-4"></i>
        <h1 class="text-4xl sm:text-5xl font-bold text-gray-800 tracking-tight">Publish Your Audiobook</h1>
        <p class="mt-3 text-lg text-gray-600 max-w-2xl mx-auto">
            Bring your story to life. Provide the details below to publish your audiobook directly.
        </p>
    </div>

    <div>
        <form method="post" enctype="multipart/form-data" action="{% url 'AudioXApp:creator_upload_audiobook' %}" id="audiobookUploadForm" class="space-y-10 md:space-y-12">
            {% csrf_token %}

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-x-8 gap-y-10">

                <div class="lg:col-span-4 space-y-10">
                    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl border border-transparent hover:border-[#091e65]/30 transition-all duration-300">
                        <h2 class="text-xl font-semibold text-[#091e65] mb-6 pb-4 border-b border-slate-200 flex items-center">
                            <i class="fas fa-image mr-3 text-2xl text-[#091e65]/80"></i>
                            Cover Art <span class="text-red-500 text-xs ml-1.5">*</span>
                        </h2>
                        <div class="flex-grow flex flex-col justify-center">
                            <div id="coverPreviewContainer" class="relative group aspect-[4/3] rounded-xl border-2 border-dashed border-slate-300 hover:border-[#091e65] flex items-center justify-center text-center bg-slate-50 hover:bg-slate-100 overflow-hidden transition-all duration-300 ease-in-out">
                                <img id="coverImagePreview" src="{% if submitted_values.cover_image_preview_url %}{{ submitted_values.cover_image_preview_url }}{% else %}https://placehold.co/400x300/e2e8f0/64748b?text=Upload+Cover{% endif %}" alt="Cover Preview" class="absolute inset-0 h-full w-full object-cover z-0 transition-opacity duration-300">
                                <div id="coverUploadPlaceholder" class="relative z-10 p-5 transition-opacity duration-300 flex flex-col items-center justify-center text-slate-400 group-hover:text-[#091e65] {% if submitted_values.cover_image_preview_url %}opacity-0 group-hover:opacity-100 bg-black/70 rounded-xl text-white{% endif %}">
                                    <div id="coverUploadInitialText" {% if submitted_values.cover_image_preview_url %}style="display:none;"{% endif %}>
                                        <i class="fas fa-cloud-upload-alt text-5xl mb-2"></i>
                                        <span class="mt-1.5 block text-sm font-medium">Upload Cover</span>
                                        <span class="mt-0.5 block text-xs">Max 2MB</span>
                                    </div>
                                    <div id="coverChangeText" {% if not submitted_values.cover_image_preview_url %}style="display:none;"{% endif %} class="text-center">
                                        <i class="fas fa-sync-alt text-4xl"></i>
                                        <span class="mt-1.5 block text-sm font-medium">Change</span>
                                    </div>
                                </div>
                                <label for="cover_image" class="absolute inset-0 cursor-pointer z-20"><span class="sr-only">Upload new cover image</span></label>
                                <input type="file" name="cover_image" id="cover_image" accept="image/jpeg, image/png, image/jpg" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            </div>
                            <div id="coverImageNameDisplay" class="mt-3 text-xs text-slate-500 font-medium truncate max-w-full text-center">
                                {{ submitted_values.cover_image_filename|default:"PNG, JPG, JPEG (Max 2MB)" }}
                            </div>
                            {% if form_errors.cover_image %}<p class="text-red-500 text-sm mt-1 text-center">{{ form_errors.cover_image }}</p>{% endif %}
                        </div>
                    </div>

                    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl border border-transparent hover:border-[#091e65]/30 transition-all duration-300">
                        <h2 class="text-xl font-semibold text-[#091e65] mb-6 pb-4 border-b border-slate-200 flex items-center">
                           <i class="fas fa-tags mr-3 text-2xl text-[#091e65]/80"></i>
                            Pricing <span class="text-red-500 text-xs ml-1.5">*</span>
                        </h2>
                        <div class="space-y-5">
                            <div class="relative flex w-full p-1 bg-slate-200 rounded-xl">
                                <button type="button" id="pricingTypeFreeBtn" data-value="free"
                                        class="pricing-type-btn relative w-1/2 rounded-lg py-2.5 text-sm font-medium whitespace-nowrap focus:outline-none focus:z-10 focus:ring-2 focus:ring-[#091e65]/50 transition-all duration-200 ease-in-out flex items-center justify-center gap-1.5 {% if submitted_values.pricing_type == 'free' or not submitted_values.pricing_type %}bg-[#091e65] text-white shadow-md{% else %}text-slate-500 hover:text-[#091e65]{% endif %}">
                                    <i class="fas fa-gift"></i> Free
                                </button>
                                <button type="button" id="pricingTypePaidBtn" data-value="paid"
                                        class="pricing-type-btn relative w-1/2 rounded-lg py-2.5 text-sm font-medium whitespace-nowrap focus:outline-none focus:z-10 focus:ring-2 focus:ring-[#091e65]/50 transition-all duration-200 ease-in-out flex items-center justify-center gap-1.5 {% if submitted_values.pricing_type == 'paid' %}bg-[#091e65] text-white shadow-md{% else %}text-slate-500 hover:text-[#091e65]{% endif %}">
                                    <i class="fas fa-dollar-sign"></i> Paid
                                </button>
                                <input type="radio" name="pricing_type" id="pricing_type_free_radio" value="free" class="sr-only" {% if submitted_values.pricing_type == 'free' or not submitted_values.pricing_type %}checked{% endif %}>
                                <input type="radio" name="pricing_type" id="pricing_type_paid_radio" value="paid" class="sr-only" {% if submitted_values.pricing_type == 'paid' %}checked{% endif %}>
                            </div>
                             {% if form_errors.pricing_type %}<p class="text-red-500 text-sm mt-1">{{ form_errors.pricing_type }}</p>{% endif %}

                            <div id="priceInputContainer" class="pt-2 {% if submitted_values.pricing_type != 'paid' %}hidden{% endif %}">
                                <label for="price" class="block text-sm font-medium text-slate-700 mb-1.5">Set Price (PKR) <span class="text-red-600">*</span></label>
                                <div class="relative rounded-xl">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 pl-3.5 flex items-center"><span class="text-slate-500 sm:text-sm"> PKR </span></div>
                                    <input type="number" name="price" id="price" step="1" min="0"
                                           class="block w-full pl-14 pr-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out shadow-sm"
                                           placeholder="0" value="{{ submitted_values.price|default_if_none:'' }}">
                                </div>
                                {% if form_errors.price %}<p class="text-red-500 text-sm mt-1">{{ form_errors.price }}</p>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-10">
                    <div class="bg-white p-7 sm:p-8 rounded-2xl shadow-xl border border-transparent hover:border-[#091e65]/30 transition-all duration-300">
                        <h2 class="text-2xl font-semibold text-[#091e65] mb-7 pb-5 border-b border-slate-200 flex items-center">
                            <i class="fas fa-clipboard-list mr-3.5 text-3xl text-[#091e65]/80"></i> Audiobook Details
                        </h2>
                        <div class="space-y-6">
                            <div>
                                <label for="title" class="block text-sm font-medium text-slate-700 mb-1.5">Audiobook Title <span class="text-red-600">*</span></label>
                                <input type="text" name="title" id="title" required
                                       class="block w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out shadow-sm"
                                       placeholder="e.g., The Whispers of the Ancient Forest" value="{{ submitted_values.title|default_if_none:'' }}">
                                {% if form_errors.title %}<p class="text-red-500 text-sm mt-1">{{ form_errors.title }}</p>{% endif %}
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div>
                                    <label for="author" class="block text-sm font-medium text-slate-700 mb-1.5">Author Name <span class="text-red-600">*</span></label>
                                    <input type="text" name="author" id="author" required
                                           class="block w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out shadow-sm"
                                           placeholder="Full name of the author" value="{{ submitted_values.author|default_if_none:'' }}">
                                    {% if form_errors.author %}<p class="text-red-500 text-sm mt-1">{{ form_errors.author }}</p>{% endif %}
                                </div>
                                <div>
                                    <label for="narrator" class="block text-sm font-medium text-slate-700 mb-1.5">Narrator Name <span class="text-red-600">*</span></label>
                                    <input type="text" name="narrator" id="narrator" required
                                           class="block w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out shadow-sm"
                                           placeholder="Full name of the narrator" value="{{ submitted_values.narrator|default_if_none:'' }}">
                                    {% if form_errors.narrator %}<p class="text-red-500 text-sm mt-1">{{ form_errors.narrator }}</p>{% endif %}
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div>
                                    <label for="language" class="block text-sm font-medium text-slate-700 mb-1.5">Language <span class="text-red-600">*</span></label>
                                    <div class="relative">
                                        <select name="language" id="language" required
                                                class="block w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm appearance-none bg-no-repeat transition duration-150 ease-in-out text-slate-700 shadow-sm">
                                            <option value="" disabled {% if not submitted_values.language %}selected{% endif %} class="text-slate-400">Select Language...</option>
                                            {% with current_lang=submitted_values.language %}
                                            <option value="English" {% if current_lang == "English" %}selected{% endif %}>English</option>
                                            <option value="Urdu" {% if current_lang == "Urdu" %}selected{% endif %}>Urdu (اردو)</option>
                                            <option value="Punjabi" {% if current_lang == "Punjabi" %}selected{% endif %}>Punjabi (پنجابی)</option>
                                            <option value="Sindhi" {% if current_lang == "Sindhi" %}selected{% endif %}>Sindhi (سنڌي)</option>
                                            {% endwith %}
                                        </select>
                                        </div>
                                    {% if form_errors.language %}<p class="text-red-500 text-sm mt-1">{{ form_errors.language }}</p>{% endif %}
                                </div>
                                
                                <div id="genreInputContainer">
                                    <div>
                                        <label for="genre" class="block text-sm font-medium text-slate-700 mb-1.5">Genre <span class="text-red-600">*</span></label>
                                        <input type="text" name="genre" id="genre" 
                                               class="block w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out shadow-sm bg-slate-50 cursor-not-allowed"
                                               placeholder="Select language first" value="{{ submitted_values.genre|default_if_none:'' }}" disabled>
                                        {% if form_errors.genre %}<p class="text-red-500 text-sm mt-1" id="genre_error_message_placeholder">{{ form_errors.genre }}</p>{% endif %}
                                        <p class="text-xs text-slate-500 mt-1" id="genre_helper_text_placeholder">Please select a language to see genre options.</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label for="description" class="block text-sm font-medium text-slate-700 mb-1.5">Description <span class="text-red-600">*</span></label>
                                <textarea name="description" id="description" rows="5" required
                                          class="block w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out shadow-sm"
                                          placeholder="A captivating summary of your audiobook...">{{ submitted_values.description|default_if_none:'' }}</textarea>
                                {% if form_errors.description %}<p class="text-red-500 text-sm mt-1">{{ form_errors.description }}</p>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-7 sm:p-8 rounded-2xl shadow-xl border border-transparent hover:border-[#091e65]/30 transition-all duration-300">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-7 pb-5 border-b border-slate-200">
                            <h2 class="text-2xl font-semibold text-[#091e65] flex items-center">
                                <i class="fas fa-list-ol mr-3.5 text-3xl text-[#091e65]/80"></i> Chapters <span class="text-red-600 ml-1.5 text-sm">*</span>
                            </h2>
                            <button type="button" id="addChapterBtn"
                                    class="inline-flex items-center px-5 py-2.5 border border-transparent text-sm font-medium rounded-lg shadow-md text-white bg-[#091e65] hover:bg-[#071852] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#091e65] transition-all duration-150 ease-in-out whitespace-nowrap group transform hover:scale-105">
                                <i class="fas fa-plus mr-2 text-xs group-hover:rotate-90 transition-transform duration-200"></i>
                                Add Chapter
                            </button>
                        </div>

                        <div id="chaptersListContainer" class="space-y-6 max-h-[90vh] overflow-y-auto pr-2 -mr-2">
                            {% if submitted_values.chapters %}
                                {% for chapter_data in submitted_values.chapters %}
                                    <div class="chapter-card border border-slate-200 p-5 rounded-xl bg-slate-50 shadow-lg relative mb-5" data-chapter-id-js="repop_{{ forloop.counter0 }}" data-index-js="{{ chapter_data.original_index }}">
                                        <button type="button" class="remove-chapter-btn absolute top-3.5 right-3.5 p-2 rounded-full leading-none text-red-400 bg-transparent hover:bg-red-100 hover:text-red-600 focus:outline-none focus:ring-1 focus:ring-offset-1 focus:ring-red-500 transition-all duration-150 ease-in-out opacity-50 hover:opacity-100 transform scale-90 hover:scale-100" title="Remove Chapter">
                                            <i class="fas fa-times w-3.5 h-3.5"></i><span class="sr-only">Remove Chapter</span>
                                        </button>
                                        <div class="flex items-center mb-4">
                                            <span class="chapter-number-js flex-shrink-0 w-8 h-8 flex items-center justify-center bg-[#091e65]/10 text-[#091e65] rounded-full text-sm font-semibold mr-3.5">{{ chapter_data.order|default:forloop.counter }}</span>
                                            <h3 class="chapter-title-display-js text-lg font-medium text-gray-800 flex-grow">{{ chapter_data.title|default:"New Chapter" }}</h3>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label class="block text-xs font-medium text-slate-600 mb-1.5">Chapter Audio Source:</label>
                                            <div class="flex rounded-lg p-0.5 bg-slate-200 border border-slate-300">
                                                <button type="button" class="input-type-toggle-btn flex-1 py-2 px-3 text-xs font-medium rounded-md transition-colors {% if chapter_data.input_type == 'file' or not chapter_data.input_type or chapter_data.input_type == 'None' %}active{% endif %}" data-type="file">Upload Audio File</button>
                                                <button type="button" class="input-type-toggle-btn flex-1 py-2 px-3 text-xs font-medium rounded-md transition-colors {% if chapter_data.input_type == 'tts' or chapter_data.input_type == 'generated_tts' %}active{% endif %}" data-type="tts">Use AudioX TTS</button>
                                            </div>
                                            <input type="hidden" name="chapters[{{ chapter_data.original_index }}][input_type]" value="{{ chapter_data.input_type|default:'file' }}" class="chapter-input-type-hidden-js">
                                            {% if chapter_data.errors.input_type %}<p class="text-red-500 text-sm mt-1">{{ chapter_data.errors.input_type }}</p>{% endif %}
                                        </div>

                                        <div>
                                            <label for="chapter_title_{{ chapter_data.original_index }}" class="block text-xs font-medium text-slate-600 mb-1">Chapter Title <span class="text-red-600">*</span></label>
                                            <input type="text" name="chapters[{{ chapter_data.original_index }}][title]" id="chapter_title_{{ chapter_data.original_index }}" required value="{{ chapter_data.title|default:'' }}"
                                                   class="chapter-title-input-js block w-full px-3.5 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out shadow-sm"
                                                   placeholder="e.g., The Discovery">
                                            {% if chapter_data.errors.title %}<p class="text-red-500 text-sm mt-1 chapter-title-error-js">{{ chapter_data.errors.title }}</p>{% endif %}
                                        </div>
                                        
                                        <div class="file-upload-controls mt-4 {% if chapter_data.input_type == 'tts' or chapter_data.input_type == 'generated_tts' %}hidden{% endif %}">
                                            <label for="chapter_audio_{{ chapter_data.original_index }}" class="block text-xs font-medium text-slate-600 mb-1">Audio File <span class="text-red-600">*</span></label>
                                            <label class="block w-full px-3.5 py-2.5 border border-slate-300 rounded-lg bg-white hover:border-[#091e65]/50 transition duration-150 ease-in-out cursor-pointer group/file shadow-sm">
                                                <input type="file" name="chapters[{{ chapter_data.original_index }}][audio_file]" id="chapter_audio_{{ chapter_data.original_index }}" accept="audio/mpeg, audio/mp3, audio/wav, audio/ogg, audio/x-m4a, audio/m4a" class="chapter-audio-input-js hidden">
                                                <div class="flex items-center justify-between text-xs text-slate-500 group-hover/file:text-[#091e65]">
                                                    <span class="chapter-filename-js truncate pr-2">{{ chapter_data.audio_filename|default:"Choose audio file..." }}</span>
                                                    <i class="fas fa-upload opacity-60"></i>
                                                </div>
                                            </label>
                                            <p class="text-xs text-slate-500/80 mt-1">MP3, WAV, OGG, M4A (Max 50MB)</p>
                                            {% if chapter_data.errors.audio_file %}<p class="text-red-500 text-sm mt-1 chapter-audio-error-js">{{ chapter_data.errors.audio_file }}</p>{% endif %}
                                        </div>

                                        <div class="tts-generation-controls mt-4 {% if chapter_data.input_type == 'file' or not chapter_data.input_type or chapter_data.input_type == 'None' %}hidden{% endif %}">
                                            <div class="mb-3">
                                                <label for="chapter_text_content_{{ chapter_data.original_index }}" class="block text-xs font-medium text-slate-600 mb-1">Text for TTS <span class="text-red-600">*</span></label>
                                                <textarea name="chapters[{{ chapter_data.original_index }}][text_content]" id="chapter_text_content_{{ chapter_data.original_index }}" rows="4" 
                                                          class="chapter-text-content-input-js block w-full px-3.5 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out shadow-sm"
                                                          placeholder="Enter text for this chapter's audio...">{{ chapter_data.text_content|default:'' }}</textarea>
                                                {% if chapter_data.errors.text_content %}<p class="text-red-500 text-sm mt-1 chapter-text-error-js">{{ chapter_data.errors.text_content }}</p>{% endif %}
                                            </div>
                                            <div class="mb-3">
                                                <label for="chapter_tts_voice_{{ chapter_data.original_index }}" class="block text-xs font-medium text-slate-600 mb-1">Narrator Voice <span class="text-red-600">*</span></label>
                                                <div class="relative">
                                                    <select name="chapters[{{ chapter_data.original_index }}][tts_voice]" id="chapter_tts_voice_{{ chapter_data.original_index }}" class="chapter-tts-voice-select-js block w-full px-3.5 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm appearance-none bg-no-repeat transition duration-150 ease-in-out text-slate-700 shadow-sm">
                                                        <option value="default" {% if chapter_data.tts_voice == 'default' or not chapter_data.tts_voice %}selected{% endif %}>Select Narrator...</option>
                                                        <option value="ali_narrator" {% if chapter_data.tts_voice == 'ali_narrator' %}selected{% endif %}>Ali Narrator (Male)</option>
                                                        <option value="aisha_narrator" {% if chapter_data.tts_voice == 'aisha_narrator' %}selected{% endif %}>Aisha Narrator (Female)</option>
                                                    </select>
                                                    </div>
                                                {% if chapter_data.errors.tts_voice %}<p class="text-red-500 text-sm mt-1 chapter-voice-error-js">{{ chapter_data.errors.tts_voice }}</p>{% endif %}
                                            </div>
                                            
                                            <div class="chapter-tts-preview-player-container hidden my-3">
                                                <audio controls class="chapter-tts-preview-player w-full"></audio>
                                            </div>
                                            <div class="chapter-tts-message text-xs my-2 min-h-[16px]"></div>
                                            <div class="flex flex-wrap gap-2 items-center">
                                                <button type="button" class="generate-chapter-tts-preview-btn text-xs py-2 px-4 rounded-lg text-white shadow-md transition-colors flex items-center gap-1.5">
                                                    <span class="btn-text"><i class="fas fa-magic mr-1.5"></i>Generate & Preview Audio</span>
                                                    <span class="spinner hidden"><svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></span>
                                                </button>
                                                <button type="button" class="confirm-use-generated-audio-btn hidden text-xs py-2 px-4 rounded-lg bg-green-600 hover:bg-green-700 text-white shadow-md transition-colors flex items-center gap-1.5">
                                                    <i class="fas fa-check-circle mr-1.5"></i>Use This Audio for Chapter
                                                </button>
                                            </div>
                                            {% if chapter_data.errors.tts_general %}<p class="text-red-500 text-sm mt-1">{{ chapter_data.errors.tts_general }}</p>{% endif %}
                                        </div>
                                        
                                        <div class="locked-generated-audio-display mt-4 {% if chapter_data.input_type != 'generated_tts' or not chapter_data.generated_tts_audio_url %}hidden{% endif %}">
                                            <p class="text-xs font-medium text-slate-700 mb-1">Selected Audio for this Chapter:</p>
                                            <div class="info-box p-3 border rounded-lg text-sm">
                                                <i class="fas fa-volume-up mr-2 text-blue-600"></i>
                                                <span class="chapter-generated-tts-filename-js font-medium">
                                                    {{ chapter_data.audio_filename|default:"Generated Audio" }} 
                                                    {% if chapter_data.tts_voice_display_name %} 
                                                        (Voice: {{ chapter_data.tts_voice_display_name }})
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <input type="hidden" name="chapters[{{ chapter_data.original_index }}][generated_tts_audio_url]" value="{{ chapter_data.generated_tts_audio_url|default:'' }}" class="chapter-generated-tts-url-input-js">
                                            {% if chapter_data.errors.generated_tts %}<p class="text-red-500 text-sm mt-1">{{ chapter_data.errors.generated_tts }}</p>{% endif %}
                                        </div>

                                        <input type="hidden" name="chapters[{{ chapter_data.original_index }}][order]" value="{{ chapter_data.order|default:forloop.counter }}" class="chapter-order-input-js">
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        
                        <div id="noChaptersMessage" class="text-center py-16 px-6 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50 {% if submitted_values.chapters %}hidden{% endif %}">
                            <i class="fas fa-folder-open text-5xl text-slate-300"></i>
                            <p class="mt-4 text-base font-medium text-slate-600">No chapters yet.</p>
                            <p class="mt-1 text-sm text-slate-500">Click 'Add Chapter' to upload audio files or generate from text.</p>
                        </div>
                         {% if form_errors.chapters_general %}<p class="my-3 text-sm text-red-600 text-center bg-red-50 p-3 rounded-md border border-red-200">{{ form_errors.chapters_general }}</p>{% endif %}
                    </div>
                    
                    {% if form_errors.general_error %}
                        <div class="mt-5 p-3.5 bg-red-50 border-l-4 border-red-500 rounded-md">
                            <p class="text-sm text-red-700 font-medium flex items-center"><i class="fas fa-exclamation-circle mr-2"></i>{{ form_errors.general_error }}</p>
                        </div>
                    {% endif %}

                    <div class="mt-12 pt-8 border-t border-slate-200 flex flex-col sm:flex-row justify-end items-center gap-4">
                        <a href="{% url 'AudioXApp:creator_my_audiobooks' %}" class="px-7 py-3 text-sm font-medium text-slate-700 hover:text-[#091e65] hover:bg-slate-200 rounded-lg transition-colors duration-150 border border-slate-300 hover:border-slate-400">
                            Cancel
                        </a>
                        <button type="submit" id="publishButton"
                                class="w-full sm:w-auto inline-flex justify-center items-center py-3.5 px-10 border border-transparent rounded-lg shadow-lg text-base font-semibold text-white bg-[#091e65] hover:bg-[#071852] focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-[#091e65]/50 disabled:opacity-70 disabled:cursor-not-allowed transition-all duration-200 ease-in-out transform hover:scale-105 group">
                            <span id="publishButtonText" class="inline-flex items-center">
                                <i class="fas fa-rocket mr-2.5 opacity-90 transition-transform duration-300 group-hover:translate-x-1"></i>Publish Audiobook
                            </span>
                            <span id="publishingSpinner" class="hidden items-center">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                Publishing...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <div id="loadingOverlay" class="fixed inset-0 z-[9999] flex items-center justify-center bg-slate-900/75 backdrop-blur-sm hidden">
            <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md w-full">
                <div class="mb-6">
                    <svg class="animate-spin h-16 w-16 text-[#091e65] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <h2 id="loaderMessage" class="text-2xl font-semibold text-[#091e65] mb-3">Publishing Audiobook...</h2>
                <p class="text-slate-600 text-base">Please wait, this may take a moment...</p>
            </div>
        </div>
    </div>

    <template id="chapterTemplate">
        <div class="chapter-card border border-slate-200 p-5 rounded-xl bg-slate-50 shadow-lg relative mb-5" data-chapter-id-js="" data-index-js="">
            <button type="button" class="remove-chapter-btn absolute top-3.5 right-3.5 p-2 rounded-full leading-none text-red-400 bg-transparent hover:bg-red-100 hover:text-red-600 focus:outline-none focus:ring-1 focus:ring-offset-1 focus:ring-red-500 transition-all duration-150 ease-in-out opacity-50 hover:opacity-100 transform scale-90 hover:scale-100" title="Remove Chapter">
                <i class="fas fa-times w-3.5 h-3.5"></i><span class="sr-only">Remove Chapter</span>
            </button>
            <div class="flex items-center mb-4">
                <span class="chapter-number-js flex-shrink-0 w-8 h-8 flex items-center justify-center bg-[#091e65]/10 text-[#091e65] rounded-full text-sm font-semibold mr-3.5"></span>
                <h3 class="chapter-title-display-js text-lg font-medium text-gray-800 flex-grow">New Chapter</h3>
            </div>

            <div class="mb-4">
                <label class="block text-xs font-medium text-slate-600 mb-1.5">Chapter Audio Source:</label>
                <div class="flex rounded-lg p-0.5 bg-slate-200 border border-slate-300">
                    <button type="button" class="input-type-toggle-btn flex-1 py-2 px-3 text-xs font-medium rounded-md transition-colors active" data-type="file">Upload Audio File</button>
                    <button type="button" class="input-type-toggle-btn flex-1 py-2 px-3 text-xs font-medium rounded-md transition-colors" data-type="tts">Use AudioX TTS</button>
                </div>
                <input type="hidden" name="" value="file" class="chapter-input-type-hidden-js">
                <p class="text-red-500 text-sm mt-1 chapter-input-type-error-js"></p>
            </div>

            <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">Chapter Title <span class="text-red-600">*</span></label>
                <input type="text" name="" required
                       class="chapter-title-input-js block w-full px-3.5 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out shadow-sm"
                       placeholder="e.g., The Discovery">
                <p class="text-red-500 text-sm mt-1 chapter-title-error-js"></p>
            </div>
            
            <div class="file-upload-controls mt-4">
                <label class="block text-xs font-medium text-slate-600 mb-1">Audio File <span class="text-red-600">*</span></label>
                <label class="block w-full px-3.5 py-2.5 border border-slate-300 rounded-lg bg-white hover:border-[#091e65]/50 transition duration-150 ease-in-out cursor-pointer group/file shadow-sm">
                    <input type="file" name="" required accept="audio/mpeg, audio/mp3, audio/wav, audio/ogg, audio/x-m4a, audio/m4a"
                           class="chapter-audio-input-js hidden">
                    <div class="flex items-center justify-between text-xs text-slate-500 group-hover/file:text-[#091e65]">
                        <span class="chapter-filename-js truncate pr-2">Choose audio file...</span>
                        <i class="fas fa-upload opacity-60"></i>
                    </div>
                </label>
                <p class="text-xs text-slate-500/80 mt-1">MP3, WAV, OGG, M4A (Max 50MB)</p>
                <p class="text-red-500 text-sm mt-1 chapter-audio-error-js"></p>
            </div>

            <div class="tts-generation-controls mt-4 hidden">
                <div class="mb-3">
                    <label class="block text-xs font-medium text-slate-600 mb-1">Text for TTS <span class="text-red-600">*</span></label>
                    <textarea name="" rows="4" 
                              class="chapter-text-content-input-js block w-full px-3.5 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm placeholder-slate-400 transition duration-150 ease-in-out shadow-sm"
                              placeholder="Enter text for this chapter's audio..."></textarea>
                    <p class="text-red-500 text-sm mt-1 chapter-text-error-js"></p>
                </div>
                <div class="mb-3">
                    <label class="block text-xs font-medium text-slate-600 mb-1">Narrator Voice <span class="text-red-600">*</span></label>
                    <div class="relative">
                        <select name="" class="chapter-tts-voice-select-js block w-full px-3.5 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-[#091e65]/70 focus:border-[#091e65] sm:text-sm appearance-none bg-no-repeat transition duration-150 ease-in-out text-slate-700 shadow-sm">
                            <option value="default" selected>Select Narrator...</option>
                            <option value="ali_narrator">Ali Narrator (Male)</option>
                            <option value="aisha_narrator">Aisha Narrator (Female)</option>
                        </select>
                        </div>
                    <p class="text-red-500 text-sm mt-1 chapter-voice-error-js"></p>
                </div>
                <div class="chapter-tts-preview-player-container hidden my-3">
                    <audio controls class="chapter-tts-preview-player w-full"></audio>
                </div>
                <div class="chapter-tts-message text-xs my-2 min-h-[16px]"></div>
                <div class="flex flex-wrap gap-2 items-center">
                    <button type="button" class="generate-chapter-tts-preview-btn text-xs py-2 px-4 rounded-lg text-white shadow-md transition-colors flex items-center gap-1.5"> 
                        <span class="btn-text"><i class="fas fa-magic mr-1.5"></i>Generate & Preview Audio</span>
                        <span class="spinner hidden"><svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></span>
                    </button>
                    <button type="button" class="confirm-use-generated-audio-btn hidden text-xs py-2 px-4 rounded-lg bg-green-600 hover:bg-green-700 text-white shadow-md transition-colors flex items-center gap-1.5">
                        <i class="fas fa-check-circle mr-1.5"></i>Use This Audio for Chapter
                    </button>
                </div>
                <p class="text-red-500 text-sm mt-1 chapter-tts-general-error-js"></p> 
            </div>
            
            <div class="locked-generated-audio-display mt-4 hidden">
                <p class="text-xs font-medium text-slate-700 mb-1">Selected Audio for this Chapter:</p>
                <div class="info-box p-3 border rounded-lg text-sm">
                       <i class="fas fa-volume-up mr-2 text-blue-600"></i>
                    <span class="chapter-generated-tts-filename-js font-medium">Generated Audio</span>
                </div>
                <input type="hidden" name="" class="chapter-generated-tts-url-input-js"> 
                <p class="text-red-500 text-sm mt-1 chapter-generated-tts-error-js"></p>
            </div>

            <input type="hidden" name="" class="chapter-order-input-js">
        </div>
    </template>

    <script id="form-errors-data-script" type="application/json">{{ form_errors|json_script:"form-errors-data-script" }}</script>
    <script id="submitted-values-data-script" type="application/json">{{ submitted_values|json_script:"submitted-values-data-script" }}</script>
    <div id="django-messages-data" style="display:none;">{{ django_messages_json|safe }}</div>
    <script id="generate-tts-preview-url" type="text/plain">{% url 'AudioXApp:generate_tts_preview_audio' %}</script>

{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/creator/creator_upload_audiobooks.js' %}"></script>
{% endblock %}

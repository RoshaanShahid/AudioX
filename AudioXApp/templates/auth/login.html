{% load static %}
{% load socialaccount %} {# ADDED for django-allauth #}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - AudioX | Access Your Account</title>

    <link rel="stylesheet" href="{% static 'css/output.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Minimal style for potential Tailwind JIT features if CDN version is limited, or for very specific overrides. */
        /* Ensure fade-in animations are defined if not in output.css or if output.css is minimal */
        .animate-fade-in-custom { animation: fadeInCustomKeyframe 0.5s ease-out forwards; }
        .opacity-0-custom { opacity: 0; } /* Ensure this is available */
        @keyframes fadeInCustomKeyframe { /* Renamed to avoid conflict if output.css has fadeIn */
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-900 font-inter antialiased overflow-x-hidden h-full">

    <div id="customNotificationModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 p-4 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div id="customNotificationBox" class="bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-11/12 max-w-md transform transition-all duration-300 scale-95 opacity-0">
            <div class="flex items-start justify-between mb-4">
                <h3 id="notificationTitle" class="text-xl font-bold text-[#091e65]">Notification</h3>
                <button id="closeNotificationButton" type="button" class="text-gray-400 hover:text-gray-600 transition-colors focus:outline-none -mt-1 -mr-1">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div id="notificationContent" class="text-center">
                <div id="notificationLoader" class="hidden my-5">
                    <div class="flex justify-center items-center space-x-2">
                        <div class="w-3 h-3 bg-[#091e65] rounded-full animate-ping"></div>
                        <div class="w-3 h-3 bg-[#091e65] rounded-full animate-ping" style="animation-delay: 0.15s;"></div>
                        <div class="w-3 h-3 bg-[#091e65] rounded-full animate-ping" style="animation-delay: 0.3s;"></div>
                    </div>
                </div>
                <div id="notificationIconContainer" class="hidden text-5xl mb-4 mt-2">
                    {# Icon will be injected by JS #}
                </div>
                <p id="notificationMessage" class="text-sm text-gray-700 leading-relaxed">Message goes here.</p>
            </div>
            <div id="notificationActions" class="mt-6 text-right hidden">
                    <button id="notificationConfirmButton" type="button" class="px-6 py-2.5 rounded-lg font-semibold text-sm text-white bg-[#091e65] hover:bg-[#0b267a] focus:outline-none focus:ring-2 ring-offset-2 ring-[#091e65] transition-colors">OK</button>
            </div>
        </div>
    </div>

    <div class="w-full min-h-screen grid grid-cols-1 lg:grid-cols-2">
        <div class="bg-theme-bg-card flex flex-col justify-center items-center p-8 sm:p-12 lg:p-16 order-last lg:order-first relative overflow-hidden">
            <div class="absolute -top-10 -left-10 w-48 h-48 border-[16px] border-brand-navy-surface rounded-full opacity-50"></div>
            <div class="absolute -bottom-16 -right-16 w-72 h-72 bg-brand-navy-surface rounded-full opacity-60"></div>
            <div class="text-center max-w-md relative z-10">
                <div class="mb-8 inline-block">
                    <svg class="w-16 h-16 text-theme-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.63 2.25a14.98 14.98 0 00-6.16 12.12A14.98 14.98 0 009.63 21.75a6 6 0 015.96-7.38z"></path></svg>
                </div>
                <h2 class="text-3xl lg:text-4xl font-bold mb-4 text-theme-text-primary animate-fade-in-custom opacity-0-custom" style="animation-delay: 0.1s;">
                    Welcome Back to AudioX
                </h2>
                <p class="text-base lg:text-lg text-theme-text-secondary mb-10 leading-relaxed animate-fade-in-custom opacity-0-custom" style="animation-delay: 0.2s;">
                    Sign in to continue your journey through sound. Access your library, playlists, and more.
                </p>
                <div class="text-sm text-theme-text-secondary animate-fade-in-custom opacity-0-custom" style="animation-delay: 0.3s;">
                    <p>Don't have an account?</p>
                    <a href="{% url 'AudioXApp:signup' %}" class="mt-3 inline-block px-6 py-2.5 border border-theme-primary bg-brand-navy-surface text-theme-primary rounded-lg font-semibold hover:bg-theme-primary/[.10] transition duration-200 transform hover:scale-[1.03]">
                        Create Account
                    </a>
                </div>
            </div>
        </div>

        <div class="bg-gray-100 flex flex-col justify-center p-6 sm:p-10 lg:p-16 order-first lg:order-last">
            <div class="w-full max-w-md mx-auto">
                <div class="bg-theme-bg-card p-8 sm:p-10 rounded-2xl shadow-lg animate-fade-in-custom opacity-0-custom" style="animation-delay: 0.4s;">
                    <div class="text-center mb-8">
                        <h1 class="text-2xl font-bold text-theme-text-primary mb-1">Sign In</h1>
                        <p class="text-sm text-theme-text-secondary">Access your AudioX account.</p>
                    </div>

                    <div class="mb-6">
                        <a href="/accounts/google/login/?process=login" class="w-full flex items-center justify-center py-2.5 px-4 border border-theme-border bg-theme-bg-card hover:bg-gray-50 transition-colors duration-200 rounded-lg text-theme-text-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-theme-bg-card focus:ring-theme-primary focus:ring-opacity-50 text-sm font-medium transform hover:scale-[1.02] shadow-sm">
                            <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M21.8 10.1c0-.7-.1-1.4-.2-2.1H12v3.9h5.5c-.2 1.3-.9 2.4-1.9 3.2v2.5h3.2c1.9-1.7 3-4.2 3-7.5z" fill="#4285F4"/><path d="M12 22c2.7 0 4.9-.9 6.6-2.4l-3.2-2.5c-.9.6-2 .9-3.4.9-2.6 0-4.8-1.8-5.6-4.2H3.1v2.6C4.8 19.9 8.1 22 12 22z" fill="#34A853"/><path d="M6.4 13.7c-.2-.6-.3-1.2-.3-1.8s.1-1.2.3-1.8V7.6H3.1C2.4 9 2 10.5 2 12s.4 3 1.1 4.4l3.3-2.7z" fill="#FBBC05"/><path d="M12 5.9c1.5 0 2.8.5 3.8 1.5l2.8-2.8C16.9 2.9 14.7 2 12 2 8.1 2 4.8 4.1 3.1 7.6l3.3 2.7c.8-2.4 3-4.2 5.6-4.2z" fill="#EA4335"/></svg>
                            Sign in with Google
                        </a>
                    </div>
                    <div class="flex items-center my-6">
                        <hr class="flex-grow border-gray-200" />
                        <span class="px-3 text-gray-400 text-xs font-medium uppercase">OR</span>
                        <hr class="flex-grow border-gray-200" />
                    </div>

                    {% with common_input_classes="form-input w-full block px-4 py-3 border border-theme-border bg-theme-input-bg placeholder-gray-400 text-theme-text-primary text-sm transition duration-150 ease-in-out rounded-lg shadow-sm appearance-none focus:border-theme-primary focus:ring-2 focus:ring-theme-primary focus:ring-opacity-30" %}
                    <div id="login-form-container">
                        <form id="loginForm" method="post" class="space-y-5">
                            {% csrf_token %}
                            <div id="credentials-section">
                                <div class="relative">
                                    <label for="loginIdentifier" class="sr-only">Email or Username</label>
                                    <input class="{{ common_input_classes }} pl-11" placeholder="Email or Username" type="text" name="loginIdentifier" id="loginIdentifier" required />
                                    <i class="input-icon fas fa-user text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none transition-colors duration-150"></i>
                                </div>
                                <div class="relative mt-4">
                                    <label for="password" class="sr-only">Password</label>
                                    <input class="{{ common_input_classes }} pl-11 pr-12 password-field" placeholder="Password" type="password" name="password" id="password" required />
                                    <i class="input-icon fas fa-lock text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none transition-colors duration-150"></i>
                                    <button type="button" class="password-toggle-btn absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-[#091e65] cursor-pointer p-2 z-10" aria-label="Toggle password visibility">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="text-right mt-3">
                                    <a href="{% url 'AudioXApp:forgot_password' %}" class="text-[#091e65] hover:text-[#0b267a] text-xs font-medium transition duration-150 ease-in-out">Forgot Password?</a>
                                </div>
                            </div>
                            <button id="submitButton" class="w-full bg-[#091e65] hover:bg-[#0b267a] text-white py-3 rounded-lg font-semibold transition-all duration-300 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-theme-bg-card focus:ring-[#091e65] text-sm mt-6 transform hover:-translate-y-0.5" type="submit">
                                Sign In
                            </button>
                        </form>
                    </div>

                    <div id="otp-form-container" class="hidden animate-fade-in-custom">
                        <h2 class="text-xl font-bold text-theme-text-primary mb-2 text-center">Enter Verification Code</h2>
                        <p class="text-theme-text-secondary mb-6 text-center text-sm">
                            A 6-digit code was sent to <strong id="otp-email-display" class="font-medium text-theme-text-primary">your email</strong>.
                        </p>
                        <form id="otpForm" method="post" class="space-y-5"> {% csrf_token %} <div class="flex justify-center space-x-1 sm:space-x-2" dir="ltr">
                                <input type="text" name="otp1" class="otp-input form-input w-12 h-14 sm:w-14 sm:h-[3.75rem] text-center text-lg sm:text-xl font-semibold border border-theme-border bg-theme-input-bg text-theme-text-primary rounded-lg transition-colors duration-200 ease-in-out focus:border-[#091e65] focus:ring-2 focus:ring-[#091e65] focus:ring-opacity-30 appearance-none" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                                <input type="text" name="otp2" class="otp-input form-input w-12 h-14 sm:w-14 sm:h-[3.75rem] text-center text-lg sm:text-xl font-semibold border border-theme-border bg-theme-input-bg text-theme-text-primary rounded-lg transition-colors duration-200 ease-in-out focus:border-[#091e65] focus:ring-2 focus:ring-[#091e65] focus:ring-opacity-30 appearance-none" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                                <input type="text" name="otp3" class="otp-input form-input w-12 h-14 sm:w-14 sm:h-[3.75rem] text-center text-lg sm:text-xl font-semibold border border-theme-border bg-theme-input-bg text-theme-text-primary rounded-lg transition-colors duration-200 ease-in-out focus:border-[#091e65] focus:ring-2 focus:ring-[#091e65] focus:ring-opacity-30 appearance-none" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                                <input type="text" name="otp4" class="otp-input form-input w-12 h-14 sm:w-14 sm:h-[3.75rem] text-center text-lg sm:text-xl font-semibold border border-theme-border bg-theme-input-bg text-theme-text-primary rounded-lg transition-colors duration-200 ease-in-out focus:border-[#091e65] focus:ring-2 focus:ring-[#091e65] focus:ring-opacity-30 appearance-none" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                                <input type="text" name="otp5" class="otp-input form-input w-12 h-14 sm:w-14 sm:h-[3.75rem] text-center text-lg sm:text-xl font-semibold border border-theme-border bg-theme-input-bg text-theme-text-primary rounded-lg transition-colors duration-200 ease-in-out focus:border-[#091e65] focus:ring-2 focus:ring-[#091e65] focus:ring-opacity-30 appearance-none" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                                <input type="text" name="otp6" class="otp-input form-input w-12 h-14 sm:w-14 sm:h-[3.75rem] text-center text-lg sm:text-xl font-semibold border border-theme-border bg-theme-input-bg text-theme-text-primary rounded-lg transition-colors duration-200 ease-in-out focus:border-[#091e65] focus:ring-2 focus:ring-[#091e65] focus:ring-opacity-30 appearance-none" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                            </div>
                            <input type="hidden" name="full_otp" id="full_otp">
                            <div class="text-center text-xs">
                                <button type="button" id="resendOtpButton" class="text-[#091e65] hover:text-[#0b267a] font-medium transition duration-150 ease-in-out disabled:opacity-60 disabled:cursor-not-allowed disabled:text-gray-500 disabled:no-underline">Resend Code</button>
                                <span id="resendTimer" class="text-gray-500 ml-2"></span>
                            </div>
                            <button id="verifyOtpButton" class="w-full bg-[#091e65] hover:bg-[#0b267a] text-white py-3 rounded-lg font-semibold transition-all duration-300 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-theme-bg-card focus:ring-[#091e65] text-sm mt-6 transform hover:-translate-y-0.5" type="button">
                                Verify Code
                            </button>
                            <div class="text-center mt-4">
                                <button type="button" id="backToLoginButton" class="text-sm text-gray-500 hover:text-[#091e65] transition duration-150 ease-in-out">Back to Login</button>
                            </div>
                        </form>
                    </div>
                    {% endwith %}

                    <div class="mt-8 text-center text-xs text-theme-text-secondary">
                        <span>Don't have an account?
                            <a href="{% url 'AudioXApp:signup' %}" class="font-semibold text-[#091e65] hover:text-[#0b267a] transition duration-150 ease-in-out">Sign Up</a>
                        </span>
                        <span class="mx-2">|</span>
                        <a href="{% url 'AudioXApp:home' %}" class="hover:text-[#091e65] transition duration-150 ease-in-out">Go to Home</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- DOM Elements for Custom Notification ---
    const customNotificationModal = document.getElementById('customNotificationModal');
    const customNotificationBox = document.getElementById('customNotificationBox');
    const notificationTitleEl = document.getElementById('notificationTitle');
    const notificationMessageEl = document.getElementById('notificationMessage');
    const notificationIconContainerEl = document.getElementById('notificationIconContainer');
    const notificationLoaderEl = document.getElementById('notificationLoader');
    const closeNotificationButton = document.getElementById('closeNotificationButton');
    const notificationConfirmButton = document.getElementById('notificationConfirmButton');
    const notificationActions = document.getElementById('notificationActions');

    // --- DOM Elements for Login Page ---
    const loginForm = document.getElementById('loginForm');
    const otpFormContainer = document.getElementById('otp-form-container');
    const loginFormContainer = document.getElementById('login-form-container');
    const submitButton = document.getElementById('submitButton'); 
    const verifyOtpButton = document.getElementById('verifyOtpButton');
    const otpEmailDisplay = document.getElementById('otp-email-display');
    const otpInputs = document.querySelectorAll('.otp-input');
    const fullOtpInput = document.getElementById('full_otp');
    const backToLoginButton = document.getElementById('backToLoginButton');
    const resendOtpButton = document.getElementById('resendOtpButton');
    const resendTimer = document.getElementById('resendTimer');
    const passwordToggleButtons = document.querySelectorAll('.password-toggle-btn');
    const djangoMessagesElement = document.getElementById('django-messages');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    const allStandardFormInputs = document.querySelectorAll('#loginForm .form-input');

    let resendInterval;
    let currentNotificationCallback = null;

    // --- Custom Notification Functions ---
    function showCustomNotification(title, message, type = 'info', showLoader = false, confirmText = 'OK', callback = null) {
        notificationTitleEl.textContent = title;
        notificationMessageEl.innerHTML = message; 
        currentNotificationCallback = callback;

        notificationLoaderEl.classList.add('hidden');
        notificationIconContainerEl.classList.add('hidden');
        notificationIconContainerEl.innerHTML = ''; 
        notificationConfirmButton.classList.remove(
            'bg-green-500', 'hover:bg-green-600', 'focus:ring-green-500',
            'bg-red-500', 'hover:bg-red-600', 'focus:ring-red-500',
            'bg-yellow-400', 'hover:bg-yellow-500', 'focus:ring-yellow-400', 'text-black',
            'bg-blue-500', 'hover:bg-blue-600', 'focus:ring-blue-500' 
        );
        notificationConfirmButton.classList.add('bg-[#091e65]', 'hover:bg-[#0b267a]', 'focus:ring-[#091e65]', 'text-white');
        notificationConfirmButton.textContent = confirmText;

        if (showLoader || type === 'loading') {
            notificationLoaderEl.classList.remove('hidden');
            notificationActions.classList.add('hidden');
        } else {
            notificationActions.classList.remove('hidden');
            let iconClass = '';
            let colorClass = 'text-[#091e65]';

            switch (type) {
                case 'success':
                    iconClass = 'fas fa-check-circle'; 
                    colorClass = 'text-[#091e65]'; 
                    notificationConfirmButton.classList.add('text-white');
                    notificationConfirmButton.classList.remove('text-black'); 
                    break;
                case 'error':
                    iconClass = 'fas fa-times-circle'; 
                    colorClass = 'text-red-500'; 
                    notificationConfirmButton.classList.remove('bg-[#091e65]', 'hover:bg-[#0b267a]', 'focus:ring-[#091e65]');
                    notificationConfirmButton.classList.add('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-500', 'text-white');
                    notificationConfirmButton.classList.remove('text-black');
                    break;
                case 'warning':
                    iconClass = 'fas fa-exclamation-triangle'; 
                    colorClass = 'text-yellow-500'; // Changed warning icon color
                    notificationConfirmButton.classList.remove('bg-[#091e65]', 'hover:bg-[#0b267a]', 'focus:ring-[#091e65]');
                    notificationConfirmButton.classList.add('bg-yellow-400', 'hover:bg-yellow-500', 'focus:ring-yellow-400', 'text-black');
                    notificationConfirmButton.classList.remove('text-white');
                    break;
                case 'banned': 
                    iconClass = 'fas fa-ban'; // Specific icon for banned
                    colorClass = 'text-red-600'; 
                    notificationConfirmButton.classList.remove('bg-[#091e65]', 'hover:bg-[#0b267a]', 'focus:ring-[#091e65]');
                    notificationConfirmButton.classList.add('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-600', 'text-white');
                    notificationConfirmButton.classList.remove('text-black');
                    break;
                case 'info':
                    iconClass = 'fas fa-info-circle'; 
                    colorClass = 'text-[#091e65]'; 
                    notificationConfirmButton.classList.add('text-white');
                    notificationConfirmButton.classList.remove('text-black');
                    break;
            }
            if (iconClass) {
                notificationIconContainerEl.innerHTML = `<i class="${iconClass} ${colorClass}"></i>`;
                notificationIconContainerEl.classList.remove('hidden');
            }
        }

        customNotificationModal.classList.remove('opacity-0', 'pointer-events-none');
        customNotificationModal.classList.add('opacity-100', 'pointer-events-auto');
        customNotificationBox.classList.remove('scale-95', 'opacity-0');
        customNotificationBox.classList.add('scale-100', 'opacity-100');
    }

    function hideCustomNotification() {
        customNotificationModal.classList.add('opacity-0', 'pointer-events-none');
        customNotificationModal.classList.remove('opacity-100', 'pointer-events-auto');
        customNotificationBox.classList.add('scale-95', 'opacity-0');
        customNotificationBox.classList.remove('scale-100', 'opacity-100');
        if (currentNotificationCallback && typeof currentNotificationCallback === 'function') {
            setTimeout(() => {
                currentNotificationCallback();
                currentNotificationCallback = null; 
            }, 300); 
        }
    }

    closeNotificationButton.addEventListener('click', hideCustomNotification);
    notificationConfirmButton.addEventListener('click', hideCustomNotification);

    function updateInputIconColor(inputElement, colorClass) {
        const icon = inputElement.parentElement?.querySelector('.input-icon');
        if (icon) {
            icon.classList.remove('text-gray-400', 'text-[#091e65]', 'text-red-500');
            if (colorClass) {
                icon.classList.add(colorClass);
            } else {
                icon.classList.add('text-gray-400');
            }
        }
    }
    
    function markInputError(inputElement) {
        if (!inputElement) return;
        inputElement.classList.remove('border-theme-border', 'focus:border-[#091e65]', 'focus:ring-[#091e65]');
        inputElement.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        if (!inputElement.classList.contains('otp-input')) {
            updateInputIconColor(inputElement, 'text-red-500');
        }
    }

    function clearInputVisualState(inputElement) {
        if (!inputElement) return;
        inputElement.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        inputElement.classList.add('border-theme-border', 'focus:border-[#091e65]', 'focus:ring-[#091e65]');
        if (!inputElement.classList.contains('otp-input')) {
            updateInputIconColor(inputElement, null); 
        }
    }

    function clearAllInputErrors() {
        allStandardFormInputs.forEach(clearInputVisualState);
        otpInputs.forEach(clearInputVisualState);
    }

    allStandardFormInputs.forEach(input => {
        input.addEventListener('focus', function(e) {
            const icon = e.target.parentElement?.querySelector('.input-icon');
            if (icon && !e.target.classList.contains('border-red-500')) {
                icon.classList.remove('text-gray-400');
                icon.classList.add('text-[#091e65]');
            }
        });
        input.addEventListener('blur', function(e) {
            const icon = e.target.parentElement?.querySelector('.input-icon');
            if (icon && !e.target.classList.contains('border-red-500')) {
                icon.classList.remove('text-[#091e65]');
                icon.classList.add('text-gray-400');
            }
        });
    });
    
    function startResendTimer(duration = 60) {
        let timer = duration;
        resendOtpButton.disabled = true;
        resendTimer.textContent = `(${timer}s)`;
        clearInterval(resendInterval);
        resendInterval = setInterval(() => {
            timer--;
            resendTimer.textContent = `(${timer}s)`;
            if (timer <= 0) {
                clearInterval(resendInterval);
                resendTimer.textContent = '';
                resendOtpButton.disabled = false;
                resendOtpButton.innerHTML = 'Resend Code';
            }
        }, 1000);
    }

    function showOtpForm(email) {
        clearAllInputErrors();
        loginFormContainer.classList.add('hidden');
        otpFormContainer.classList.remove('hidden');
        otpFormContainer.classList.add('animate-fade-in-custom');
        if (otpEmailDisplay && email) {
            otpEmailDisplay.textContent = email;
        }
        otpInputs.forEach(input => input.value = '');
        if(fullOtpInput) fullOtpInput.value = '';
        if(otpInputs.length > 0) otpInputs[0].focus();
        startResendTimer();
    }

    function showLoginForm() {
        clearAllInputErrors();
        otpFormContainer.classList.add('hidden');
        otpFormContainer.classList.remove('animate-fade-in-custom');
        loginFormContainer.classList.remove('hidden');
        loginFormContainer.classList.add('animate-fade-in-custom');
        clearInterval(resendInterval);
        if(resendTimer) resendTimer.textContent = ''; 
        if (resendOtpButton) {
            resendOtpButton.disabled = false;
            resendOtpButton.innerHTML = 'Resend Code';
        }
        const loginIdentifierEl = document.getElementById('loginIdentifier');
        if(loginIdentifierEl) loginIdentifierEl.focus();
        if(submitButton) { 
            submitButton.disabled = false;
            submitButton.innerHTML = 'Sign In';
        }
    }

    // --- Event Listeners for Custom Login Form ---
    if (loginForm && submitButton) { 
        loginForm.addEventListener('submit', function(event) {
            event.preventDefault();
            clearAllInputErrors();
            const formData = new FormData(this);
            submitButton.disabled = true;
            submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Signing In...`;
            showCustomNotification('Processing...', 'Please wait while we sign you in.', 'loading', true);

            fetch("{% url 'AudioXApp:login' %}", {
                method: 'POST', body: formData,
                headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(async response => {
                const responseData = await response.json().catch(() => null); // Try to parse JSON, but don't fail if no body or not JSON
                if (!response.ok) {
                    let errorMsg = "Login failed. Please check your credentials or connection.";
                    let errorType = 'error';
                    if (responseData) {
                        errorMsg = responseData.message || errorMsg;
                        if (responseData.is_banned) {
                            errorType = 'banned'; // Use 'banned' type for notification
                        }
                    }
                    const error = new Error(errorMsg);
                    error.status = response.status;
                    error.data = responseData; // Attach the parsed data to the error object
                    error.type = errorType; // Attach our custom error type
                    throw error;
                }
                return responseData;
            })
            .then(data => { // This block is for response.ok === true
                hideCustomNotification(); // Hide loading
                if (data.status === 'success') {
                    showCustomNotification('Success!', 'Login successful! Redirecting...', 'success', false, 'Go to Home', () => {
                        window.location.href = data.redirect_url || "{% url 'AudioXApp:home' %}";
                    });
                } else if (data.status === '2fa_required') {
                    showOtpForm(data.email);
                } else if (data.status === 'profile_incomplete') { // Handle profile incomplete
                    showCustomNotification('Profile Incomplete', data.message || 'Please complete your profile to continue.', 'warning', false, 'Complete Profile', () => {
                        window.location.href = data.redirect_url || "{% url 'AudioXApp:complete_profile' %}";
                    });
                } else { // Other non-200 but ok responses, or 'error' status in a 200 response
                    showCustomNotification('Login Error', data.message || 'An unexpected issue occurred.', 'error');
                    submitButton.disabled = false; submitButton.innerHTML = 'Sign In';
                }
            })
            .catch(error => { // This block catches thrown errors (e.g., from !response.ok or network errors)
                console.error('Login Fetch Error:', error);
                const message = error.message || 'Could not connect or an unknown error occurred. Please try again.';
                const type = error.type || 'error'; // Use custom type if set, otherwise 'error'
                const title = type === 'banned' ? 'Account Blocked' : 'Login Error';
                
                showCustomNotification(title, message, type);
                submitButton.disabled = false; submitButton.innerHTML = 'Sign In';

                if (error.data?.errors) { // If backend sent specific field errors
                    Object.keys(error.data.errors).forEach(fieldName => {
                        const inputField = document.querySelector(`[name=${fieldName}]`);
                        if(inputField) markInputError(inputField);
                    });
                } else if (error.status === 401 || (error.data && error.data.message && (error.data.message.toLowerCase().includes("credentials") || error.data.message.toLowerCase().includes("password") || error.data.message.toLowerCase().includes("user")))) {
                     // For generic auth failure not specifically marked as banned
                    if (type !== 'banned') { // Don't mark inputs if it's a ban message
                        markInputError(document.getElementById('loginIdentifier'));
                        markInputError(document.getElementById('password'));
                    }
                }
            });
        });
    }

    // --- OTP Form Logic & other existing JS (ensure it's complete as per your file) ---
    otpInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            const value = input.value;
            if (value.length === 1 && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }
            let combinedOtp = '';
            otpInputs.forEach(i => combinedOtp += i.value);
            if(fullOtpInput) fullOtpInput.value = combinedOtp;
            clearInputVisualState(input);
            if (combinedOtp.length === otpInputs.length && verifyOtpButton) {
                verifyOtpButton.focus();
            }
        });
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && input.value.length === 0 && index > 0) {
                otpInputs[index - 1].focus();
                clearInputVisualState(otpInputs[index - 1]);
            }
            if (!/[0-9]/.test(e.key) && !['Backspace', 'ArrowLeft', 'ArrowRight', 'Tab', 'Delete', 'Enter', 'Meta', 'Control', 'v', 'c', 'a', 'x'].includes(e.key) && !(e.metaKey || e.ctrlKey)) {
                e.preventDefault();
            }
            if (e.key !== 'Backspace' || input.value.length > 0) {
                clearInputVisualState(input);
            }
        });
        input.addEventListener('paste', (e) => {
            e.preventDefault();
            const pasteData = (e.clipboardData || window.clipboardData).getData('text').trim();
            const digits = pasteData.replace(/\D/g, '');
            if (digits.length >= 1) {
                let currentDigitIndex = 0;
                for (let i = index; i < otpInputs.length && currentDigitIndex < digits.length; i++) {
                    otpInputs[i].value = digits[currentDigitIndex];
                    clearInputVisualState(otpInputs[i]);
                    currentDigitIndex++;
                    if (i < otpInputs.length - 1 && currentDigitIndex < digits.length) {
                        otpInputs[i + 1].focus();
                    } else if (i === otpInputs.length - 1 || currentDigitIndex === digits.length) {
                        otpInputs[i].focus();
                    }
                }
                let combinedOtp = ''; otpInputs.forEach(i => combinedOtp += i.value);
                if(fullOtpInput) fullOtpInput.value = combinedOtp;
                if (combinedOtp.length === otpInputs.length && verifyOtpButton) verifyOtpButton.focus();
            }
        });
        input.addEventListener('focus', () => input.select());
    });

    if (verifyOtpButton) {
        verifyOtpButton.addEventListener('click', function() {
            const enteredOtp = fullOtpInput ? fullOtpInput.value : "";
            let isComplete = true;
            otpInputs.forEach(input => {
                if (!input.value) { markInputError(input); isComplete = false; }
                else { clearInputVisualState(input); }
            });

            if (!isComplete || enteredOtp.length !== otpInputs.length) {
                showCustomNotification('Incomplete Code', `Please enter all ${otpInputs.length} digits.`, 'warning');
                const firstEmpty = Array.from(otpInputs).find(input => !input.value);
                if (firstEmpty) firstEmpty.focus();
                return;
            }
            verifyOtpButton.disabled = true;
            verifyOtpButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verifying...';
            showCustomNotification('Verifying Code', 'Please wait...', 'loading', true);

            fetch("{% url 'AudioXApp:verify_login_otp' %}", {
                method: 'POST', body: JSON.stringify({ otp: enteredOtp }),
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(async response => {
                const responseData = await response.json().catch(() => null);
                if (!response.ok) {
                    let errorMsg = "OTP verification failed.";
                    let errorType = 'error';
                    if(responseData) {
                        errorMsg = responseData.message || errorMsg;
                        if (responseData.is_banned) errorType = 'banned';
                    }
                    const error = new Error(errorMsg); 
                    error.data = responseData; 
                    error.type = errorType;
                    throw error;
                }
                return responseData;
            })
            .then(data => {
                hideCustomNotification();
                if (data.status === 'success') {
                    showCustomNotification('Success!', data.message || 'Verification successful! Logging in...', 'success', false, 'OK', () => {
                        setTimeout(() => window.location.href = data.redirect_url || "{% url 'AudioXApp:home' %}", 300);
                    });
                } else if (data.status === 'profile_incomplete') {
                     showCustomNotification('Profile Incomplete', data.message || 'Please complete your profile.', 'warning', false, 'Complete Profile', () => {
                        window.location.href = data.redirect_url || "{% url 'AudioXApp:complete_profile' %}";
                    });
                } else { // Includes data.is_banned if backend logic sends it this way for OTP verify failures
                    const type = data.is_banned ? 'banned' : 'error';
                    const title = data.is_banned ? 'Account Blocked' : 'Verification Failed';
                    showCustomNotification(title, data.message || 'Invalid OTP entered.', type);
                    otpInputs.forEach(markInputError);
                    if(fullOtpInput) fullOtpInput.value = '';
                    if(otpInputs.length > 0) otpInputs[0].focus();
                }
            })
            .catch(error => {
                console.error('OTP Verification Error:', error);
                const message = error.message || 'Could not connect or an unknown error occurred. Please try again.';
                const type = error.type || 'error';
                const title = type === 'banned' ? 'Account Blocked' : 'Error';
                showCustomNotification(title, message, type);
                otpInputs.forEach(markInputError);
                if(fullOtpInput) fullOtpInput.value = '';
                if(otpInputs.length > 0) otpInputs[0].focus();
            })
            .finally(() => {
                const isSuccessNotificationVisible = customNotificationModal.classList.contains('opacity-100') && 
                                                    notificationIconContainerEl.querySelector('.fa-check-circle');
                const isBannedNotificationVisible = customNotificationModal.classList.contains('opacity-100') &&
                                                    (notificationTitleEl.textContent === 'Account Blocked');                                        
                if (!isSuccessNotificationVisible && !isBannedNotificationVisible) { 
                    verifyOtpButton.disabled = false;
                    verifyOtpButton.innerHTML = 'Verify Code';
                } else if (isBannedNotificationVisible) { 
                    showLoginForm(); // If banned during OTP, kick back to login form
                }
            });
        });
    }

    if (resendOtpButton) {
        resendOtpButton.addEventListener('click', function() {
            const userEmail = otpEmailDisplay ? otpEmailDisplay.textContent : null;
            if (!userEmail || userEmail === 'your email') {
                showCustomNotification('Error', 'Could not determine email to resend OTP.', 'error'); return;
            }
            resendOtpButton.disabled = true;
            resendOtpButton.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i>';
            
            fetch("{% url 'AudioXApp:send_otp' %}", {
                method: 'POST', body: JSON.stringify({ email: userEmail, purpose: 'login' }), // Assuming 'login' is the purpose for 2FA
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(async response => {
                const responseData = await response.json().catch(() => null);
                if (!response.ok) {
                    let errorMsg = "Failed to resend OTP.";
                     if(responseData?.message) errorMsg = responseData.message;
                    const error = new Error(errorMsg); 
                    error.data = responseData; 
                    throw error;
                } return responseData;
            })
            .then(data => {
                if (data.status === 'success') {
                    showCustomNotification('Code Resent', data.message || 'A new verification code has been sent.', 'success');
                    startResendTimer();
                    otpInputs.forEach(input => { input.value = ''; clearInputVisualState(input); });
                    if(fullOtpInput) fullOtpInput.value = '';
                    if(otpInputs.length > 0) otpInputs[0].focus();
                } else {
                    showCustomNotification('Resend Failed', data.message || 'Could not resend code.', 'error');
                    resendOtpButton.disabled = false; resendOtpButton.innerHTML = 'Resend Code';
                }
            })
            .catch(error => {
                console.error('Resend OTP Error:', error);
                showCustomNotification('Error', error.message || 'Could not resend code. Please try again.', 'error');
                resendOtpButton.disabled = false; resendOtpButton.innerHTML = 'Resend Code';
            });
        });
    }

    if (backToLoginButton) {
        backToLoginButton.addEventListener('click', () => { showLoginForm(); });
    }

    passwordToggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const parent = this.closest('div.relative');
            const targetInput = parent?.querySelector('input.password-field');
            const icon = this.querySelector('i');
            if (targetInput && icon) {
                const isPassword = targetInput.type === 'password';
                targetInput.type = isPassword ? 'text' : 'password';
                icon.classList.toggle('fa-eye', !isPassword);
                icon.classList.toggle('fa-eye-slash', isPassword);
                targetInput.focus();
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        if (djangoMessagesElement && djangoMessagesElement.textContent.trim() !== '' && djangoMessagesElement.textContent.trim() !== '[]') {
            try {
                const messagesData = JSON.parse(djangoMessagesElement.textContent);
                if (Array.isArray(messagesData)) { 
                    messagesData.forEach(message => {
                        let iconType = 'info';
                        let title = 'Notification';
                        if (message.tags) { 
                            if (message.tags.includes('success')) { iconType = 'success'; title = 'Success!'; }
                            else if (message.tags.includes('error')) { iconType = 'error'; title = 'Error!'; }
                            else if (message.tags.includes('warning')) { iconType = 'warning'; title = 'Warning!'; }
                            else { title = message.tags.charAt(0).toUpperCase() + message.tags.slice(1); }
                        }
                        showCustomNotification(title, message.message, iconType);
                    });
                }
            } catch (e) { console.error("Could not parse Django messages:", e, "\nContent:", djangoMessagesElement.textContent); }
        }
    });
    </script>

    <script id="django-messages" type="application/json" style="display: none;">
        {% autoescape off %}
        [
            {% for message in messages %}
                {
                    "message": "{{ message.message|escapejs }}",
                    "tags": "{{ message.tags|escapejs }}",
                    "level": {{ message.level }}
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
        {% endautoescape %}
    </script>

</body>
</html>
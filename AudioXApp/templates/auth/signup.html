{% load static %}
{% load socialaccount %} {# ADDED for django-allauth #}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign Up - AudioX | Create Your Account</title>

    <link rel="stylesheet" href="{% static 'css/output.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Minimal style for potential Tailwind JIT features if CDN version is limited, or for very specific overrides. */
        /* Ensure fade-in animations are defined if not in output.css or if output.css is minimal */
        .animate-fade-in-custom { animation: fadeInCustomKeyframe 0.5s ease-out forwards; }
        .opacity-0-custom { opacity: 0; } /* Ensure this is available */
        @keyframes fadeInCustomKeyframe { /* Renamed to avoid conflict if output.css has fadeIn */
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Additional animation delays if not directly settable via Tailwind or if more complex sequences are needed */
        .animation-delay-100 { animation-delay: 0.1s; }
        .animation-delay-200 { animation-delay: 0.2s; }
        .animation-delay-300 { animation-delay: 0.3s; }
        .animation-delay-400 { animation-delay: 0.4s; }
    </style>
</head>

<body class="bg-gray-100 text-gray-900 font-inter antialiased overflow-x-hidden h-full">

    <div id="customNotificationModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 p-4 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div id="customNotificationBox" class="bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-11/12 max-w-md transform transition-all duration-300 scale-95 opacity-0">
            <div class="flex items-start justify-between mb-4">
                <h3 id="notificationTitle" class="text-xl font-bold text-[#091e65]">Notification</h3>
                <button id="closeNotificationButton" type="button" class="text-gray-400 hover:text-gray-600 transition-colors focus:outline-none -mt-1 -mr-1">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div id="notificationContent" class="text-center">
                <div id="notificationLoader" class="hidden my-5">
                    <div class="flex justify-center items-center space-x-2">
                        <div class="w-3 h-3 bg-[#091e65] rounded-full animate-ping"></div>
                        <div class="w-3 h-3 bg-[#091e65] rounded-full animate-ping" style="animation-delay: 0.15s;"></div>
                        <div class="w-3 h-3 bg-[#091e65] rounded-full animate-ping" style="animation-delay: 0.3s;"></div>
                    </div>
                </div>
                <div id="notificationIconContainer" class="hidden text-5xl mb-4 mt-2">
                    {/* Icon will be injected here by JS */}
                </div>
                <p id="notificationMessage" class="text-sm text-gray-700 leading-relaxed">Message goes here.</p>
            </div>
            <div id="notificationActions" class="mt-6 text-right hidden">
                   <button id="notificationConfirmButton" type="button" class="px-6 py-2.5 rounded-lg font-semibold text-sm text-white bg-[#091e65] hover:bg-[#0b267a] focus:outline-none focus:ring-2 ring-offset-2 ring-[#091e65] transition-colors">OK</button>
            </div>
        </div>
    </div>

    <div class="w-full min-h-screen grid grid-cols-1 lg:grid-cols-2">
        <div class="bg-theme-bg-card flex flex-col justify-center items-center p-8 sm:p-12 lg:p-16 order-last lg:order-first relative overflow-hidden">
            <div class="absolute -top-10 -left-10 w-48 h-48 border-[16px] border-brand-navy-surface rounded-full opacity-50"></div>
            <div class="absolute -bottom-16 -right-16 w-72 h-72 bg-brand-navy-surface rounded-full opacity-60"></div>
            <div class="text-center max-w-md relative z-10">
                <div class="mb-8 inline-block p-5 bg-brand-navy-surface border border-brand-navy-surface rounded-full shadow-lg transform transition duration-500 hover:scale-105">
                    <i class="fas fa-user-plus text-4xl text-theme-primary"></i>
                </div>
                <h2 class="text-3xl lg:text-4xl font-bold mb-4 text-theme-text-primary animate-fade-in-custom opacity-0-custom animation-delay-100">Join the Audio Revolution</h2>
                <p class="text-base lg:text-lg text-theme-text-secondary mb-10 leading-relaxed animate-fade-in-custom opacity-0-custom animation-delay-200">Create your AudioX account to unlock a world of premium sound quality and personalized audio experiences.</p>
                <div class="space-y-3 text-left text-theme-text-secondary text-sm font-medium animate-fade-in-custom opacity-0-custom animation-delay-300">
                    <div class="flex items-center p-3 bg-gray-50 border border-theme-border rounded-lg hover:bg-gray-100 transition duration-200 transform hover:scale-[1.02]"><i class="fa-solid fa-check-circle text-theme-primary w-5 h-5 mr-3 shrink-0"></i><span>Simple and Secure Sign Up</span></div>
                    <div class="flex items-center p-3 bg-gray-50 border border-theme-border rounded-lg hover:bg-gray-100 transition duration-200 transform hover:scale-[1.02] animation-delay-200"><i class="fa-solid fa-headphones-simple text-theme-primary w-5 h-5 mr-3 shrink-0"></i><span>Instant Access to Millions of Tracks</span></div>
                    <div class="flex items-center p-3 bg-gray-50 border border-theme-border rounded-lg hover:bg-gray-100 transition duration-200 transform hover:scale-[1.02] animation-delay-400"><i class="fa-solid fa-sliders text-theme-primary w-5 h-5 mr-3 shrink-0"></i><span>Personalize Your Listening Profile</span></div>
                </div>
            </div>
        </div>

        <div class="bg-gray-100 flex flex-col justify-center p-6 sm:p-10 lg:p-16 order-first lg:order-last">
            <div class="w-full max-w-md mx-auto">
                <div class="bg-theme-bg-card p-8 sm:p-10 rounded-2xl shadow-lg animate-fade-in-custom opacity-0-custom animation-delay-400">
                    <div class="text-center mb-8">
                        <h1 class="text-2xl font-bold text-theme-text-primary mb-1">Create Account</h1>
                        <p class="text-sm text-theme-text-secondary">Start your premium audio journey.</p>
                    </div>

                    <div class="mb-6">
                        <a href="{% provider_login_url 'google' %}" class="w-full flex items-center justify-center py-2.5 px-4 border border-theme-border bg-theme-bg-card hover:bg-gray-50 transition-colors duration-200 rounded-lg text-theme-text-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-theme-bg-card focus:ring-theme-primary focus:ring-opacity-50 text-sm font-medium transform hover:scale-[1.02] shadow-sm">
                            <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M21.8 10.1c0-.7-.1-1.4-.2-2.1H12v3.9h5.5c-.2 1.3-.9 2.4-1.9 3.2v2.5h3.2c1.9-1.7 3-4.2 3-7.5z" fill="#4285F4"/><path d="M12 22c2.7 0 4.9-.9 6.6-2.4l-3.2-2.5c-.9.6-2 .9-3.4.9-2.6 0-4.8-1.8-5.6-4.2H3.1v2.6C4.8 19.9 8.1 22 12 22z" fill="#34A853"/><path d="M6.4 13.7c-.2-.6-.3-1.2-.3-1.8s.1-1.2.3-1.8V7.6H3.1C2.4 9 2 10.5 2 12s.4 3 1.1 4.4l3.3-2.7z" fill="#FBBC05"/><path d="M12 5.9c1.5 0 2.8.5 3.8 1.5l2.8-2.8C16.9 2.9 14.7 2 12 2 8.1 2 4.8 4.1 3.1 7.6l3.3 2.7c.8-2.4 3-4.2 5.6-4.2z" fill="#EA4335"/></svg>
                            Sign up with Google
                        </a>
                    </div>
                    <div class="flex items-center my-6">
                        <hr class="flex-grow border-gray-200" />
                        <span class="px-3 text-gray-400 text-xs font-medium uppercase">OR</span>
                        <hr class="flex-grow border-gray-200" />
                    </div>

                    <form id="signupForm" method="post" class="space-y-4">
                        {% csrf_token %}
                        {% with common_input_classes="form-input w-full block px-4 py-3 border border-theme-border bg-theme-input-bg placeholder-gray-400 text-theme-text-primary text-sm transition duration-150 ease-in-out rounded-lg shadow-sm appearance-none focus:border-[#091e65] focus:ring-2 focus:ring-[#091e65] focus:ring-opacity-30" %}
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="relative">
                                    <label for="full_name" class="sr-only">Full Name</label>
                                    <input class="{{ common_input_classes }} pl-11" placeholder="Full Name" type="text" name="full_name" id="full_name" required />
                                    <i class="input-icon fas fa-user text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none transition-colors duration-150"></i>
                                </div>
                                <div class="relative">
                                    <label for="username" class="sr-only">Username</label>
                                    <input class="{{ common_input_classes }} pl-11" placeholder="Username" type="text" name="username" id="username" required />
                                    <i class="input-icon fas fa-at text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none transition-colors duration-150"></i>
                                </div>
                            </div>

                            <div>
                                <label for="email" class="sr-only">Email Address</label>
                                <div class="flex flex-col sm:flex-row gap-3">
                                    <div class="relative flex-grow">
                                        <input class="{{ common_input_classes }} pl-11" placeholder="Email Address" type="email" name="email" id="email" required />
                                        <i class="input-icon fas fa-envelope text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none transition-colors duration-150"></i>
                                    </div>
                                    <button type="button" id="sendOtpButton" class="w-full sm:w-auto shrink-0 bg-[#091e65] text-white px-4 py-3 rounded-lg font-semibold hover:bg-[#0b267a] transition-all duration-200 disabled:opacity-60 disabled:cursor-not-allowed whitespace-nowrap text-xs shadow-md hover:shadow-lg transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-theme-bg-card focus:ring-[#091e65]">
                                        Send OTP
                                    </button>
                                </div>
                            </div>

                            <div class="relative">
                                <label for="otp" class="sr-only">Enter OTP</label>
                                <input class="{{ common_input_classes }} pl-11" placeholder="Enter 6-Digit OTP" type="text" name="otp" id="otp" required inputmode="numeric" maxlength="6" />
                                <i class="input-icon fas fa-key text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none transition-colors duration-150"></i>
                                <input type="hidden" name="emailVerified" id="emailVerified" value="false">
                                <p id="otp-error" class="text-red-500 text-xs mt-1.5 hidden"><i class="fas fa-exclamation-circle mr-1"></i>Invalid OTP entered.</p>
                                <p id="otp-success" class="text-green-500 text-xs mt-1.5 hidden"><i class="fas fa-check-circle mr-1"></i>OTP Verified!</p>
                            </div>

                            <div class="relative">
                                <label for="phone_number_only" class="sr-only">Phone Number</label>
                                <div class="flex items-center">
                                    <span class="phone-prefix absolute left-px top-px bottom-px flex items-center pl-3 pr-2 text-sm text-gray-500 pointer-events-none border-r border-theme-border bg-gray-50 rounded-l-lg z-10 h-[calc(100%-2px)]">
                                        <span class="flag" aria-label="Pakistan Flag">🇵🇰</span>&nbsp;+92
                                    </span>
                                    <input class="{{ common_input_classes }} pl-[5.75rem]" placeholder="Mobile Number (e.g. 3001234567)" type="tel" name="phone_number_only" id="phone_number_only" pattern="[0-9]{10}" title="Enter 10 digit phone number (e.g., 3001234567)" inputmode="numeric" required />
                                </div>
                                <input type="hidden" name="phone" id="phone">
                                <p id="phone-error" class="text-red-500 text-xs mt-1.5 hidden"><i class="fas fa-exclamation-circle mr-1"></i>Please enter a valid 10-digit number.</p>
                            </div>

                            <div class="relative">
                                <label for="password" class="sr-only">Password</label>
                                <input class="{{ common_input_classes }} pl-11 pr-12 password-field" placeholder="Password" type="password" name="password" id="password" required />
                                <i class="input-icon fas fa-lock text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none transition-colors duration-150"></i>
                                <button type="button" class="password-toggle-btn absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-[#091e65] cursor-pointer p-2 z-10" aria-label="Toggle password visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>

                            <div class="relative">
                                <label for="confirm-password" class="sr-only">Confirm Password</label>
                                <input class="{{ common_input_classes }} pl-11 pr-12 password-field" placeholder="Confirm Password" type="password" name="confirm-password" id="confirm-password" required/>
                                <i class="input-icon fas fa-check-circle text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none transition-colors duration-150"></i>
                                <button type="button" class="password-toggle-btn absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-[#091e65] cursor-pointer p-2 z-10" aria-label="Toggle confirm password visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <p id="password-match-error" class="text-red-500 text-xs mt-1.5 hidden"><i class="fas fa-exclamation-circle mr-1"></i> Passwords do not match.</p>
                            </div>

                            <div class="flex items-start space-x-2 pt-2">
                                <input type="checkbox" id="terms" name="terms" class="form-checkbox h-4 w-4 mt-0.5 shrink-0 rounded border-theme-border bg-theme-input-bg text-[#091e65] focus:ring-[#091e65] focus:ring-opacity-50 focus:ring-offset-theme-bg-card" required>
                                <label for="terms" class="text-xs text-theme-text-secondary">
                                    I agree to the
                                    <a href="#" class="font-medium text-[#091e65] hover:text-[#0b267a] transition duration-150 ease-in-out">Terms of Service</a> and
                                    <a href="#" class="font-medium text-[#091e65] hover:text-[#0b267a] transition duration-150 ease-in-out">Privacy Policy</a>.
                                </label>
                            </div>

                            <button id="submitButton" class="w-full bg-[#091e65] hover:bg-[#0b267a] text-white py-3 rounded-lg font-semibold transition-all duration-300 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-theme-bg-card focus:ring-[#091e65] text-sm mt-6 transform hover:-translate-y-0.5" type="submit">
                                Create Account
                            </button>
                        {% endwith %}
                    </form>

                    <div class="mt-8 text-center text-xs text-theme-text-secondary">
                        <span>Already have an account?
                            <a href="{% url 'AudioXApp:login' %}" class="font-semibold text-[#091e65] hover:text-[#0b267a] transition duration-150 ease-in-out">Sign In</a>
                        </span>
                        <span class="mx-2">|</span>
                        <a href="{% url 'AudioXApp:home' %}" class="hover:text-[#091e65] transition duration-150 ease-in-out">Go to Home</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- DOM Elements for Custom Notification ---
    const customNotificationModal = document.getElementById('customNotificationModal');
    const customNotificationBox = document.getElementById('customNotificationBox');
    const notificationTitleEl = document.getElementById('notificationTitle');
    const notificationMessageEl = document.getElementById('notificationMessage');
    const notificationIconContainerEl = document.getElementById('notificationIconContainer');
    const notificationLoaderEl = document.getElementById('notificationLoader');
    const closeNotificationButton = document.getElementById('closeNotificationButton');
    const notificationConfirmButton = document.getElementById('notificationConfirmButton');
    const notificationActions = document.getElementById('notificationActions');
    
    // --- DOM Elements for Signup Page ---
    const sendOtpButton = document.getElementById('sendOtpButton');
    const emailInput = document.getElementById('email');
    const otpInput = document.getElementById('otp');
    const emailVerifiedInput = document.getElementById('emailVerified'); // This might not be needed if OTP verification is implicit
    const signupForm = document.getElementById('signupForm');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const passwordMatchError = document.getElementById('password-match-error');
    const phoneInput = document.getElementById('phone'); // Hidden input for full phone number
    const phoneNumberOnlyInput = document.getElementById('phone_number_only'); // Visible input for digits
    const phoneError = document.getElementById('phone-error');
    const termsCheckbox = document.getElementById('terms');
    const submitButton = document.getElementById('submitButton');
    const passwordToggleButtons = document.querySelectorAll('.password-toggle-btn');
    const djangoMessagesElement = document.getElementById('django-messages');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    const allFormInputs = document.querySelectorAll('#signupForm .form-input, #signupForm #phone_number_only, #signupForm #terms'); // More specific selector
    const otpErrorMsgEl = document.getElementById('otp-error');
    const otpSuccessMsgEl = document.getElementById('otp-success');

    let currentNotificationCallback = null; // For handling callbacks after notification closes

    // --- Custom Notification Functions ---
    function showCustomNotification(title, message, type = 'info', showLoader = false, confirmText = 'OK', callback = null) {
        notificationTitleEl.textContent = title;
        notificationMessageEl.textContent = message;
        currentNotificationCallback = callback;

        notificationLoaderEl.classList.add('hidden');
        notificationIconContainerEl.classList.add('hidden');
        notificationIconContainerEl.innerHTML = '';
        notificationConfirmButton.classList.remove(
            'bg-green-500', 'hover:bg-green-600', 'focus:ring-green-500',
            'bg-red-500', 'hover:bg-red-600', 'focus:ring-red-500',
            'bg-yellow-400', 'hover:bg-yellow-500', 'focus:ring-yellow-400', 'text-black',
            'bg-blue-500', 'hover:bg-blue-600', 'focus:ring-blue-500'
        );
        notificationConfirmButton.classList.add('bg-[#091e65]', 'hover:bg-[#0b267a]', 'focus:ring-[#091e65]', 'text-white');
        notificationConfirmButton.textContent = confirmText;

        if (showLoader || type === 'loading') {
            notificationLoaderEl.classList.remove('hidden');
            notificationActions.classList.add('hidden');
        } else {
            notificationActions.classList.remove('hidden');
            let iconClass = '';
            let colorClass = 'text-[#091e65]'; 

            switch (type) {
                case 'success':
                    iconClass = 'fas fa-check-circle'; 
                    colorClass = 'text-[#091e65]'; // Theme color for icon
                    notificationConfirmButton.classList.add('text-white');
                    notificationConfirmButton.classList.remove('text-black'); 
                    break;
                case 'error':
                    iconClass = 'fas fa-times-circle'; 
                    colorClass = 'text-red-500'; // Red for icon
                    notificationConfirmButton.classList.remove('bg-[#091e65]', 'hover:bg-[#0b267a]', 'focus:ring-[#091e65]');
                    notificationConfirmButton.classList.add('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-500', 'text-white');
                    notificationConfirmButton.classList.remove('text-black');
                    break;
                case 'warning':
                    iconClass = 'fas fa-exclamation-triangle'; 
                    colorClass = 'text-[#091e65]'; // Theme color for icon
                    notificationConfirmButton.classList.add('text-white');
                    notificationConfirmButton.classList.remove('text-black');
                    break;
                case 'info':
                    iconClass = 'fas fa-info-circle'; 
                    colorClass = 'text-[#091e65]'; // Theme color for icon
                    notificationConfirmButton.classList.add('text-white');
                    notificationConfirmButton.classList.remove('text-black');
                    break;
            }
            if (iconClass) {
                notificationIconContainerEl.innerHTML = `<i class="${iconClass} ${colorClass}"></i>`;
                notificationIconContainerEl.classList.remove('hidden');
            }
        }
        customNotificationModal.classList.remove('opacity-0', 'pointer-events-none');
        customNotificationModal.classList.add('opacity-100', 'pointer-events-auto');
        customNotificationBox.classList.remove('scale-95', 'opacity-0');
        customNotificationBox.classList.add('scale-100', 'opacity-100');
    }

    function hideCustomNotification() {
        customNotificationModal.classList.add('opacity-0', 'pointer-events-none');
        customNotificationModal.classList.remove('opacity-100', 'pointer-events-auto');
        customNotificationBox.classList.add('scale-95', 'opacity-0');
        customNotificationBox.classList.remove('scale-100', 'opacity-100');
        if (currentNotificationCallback && typeof currentNotificationCallback === 'function') {
            setTimeout(() => { currentNotificationCallback(); currentNotificationCallback = null; }, 300);
        }
    }
    closeNotificationButton.addEventListener('click', hideCustomNotification);
    notificationConfirmButton.addEventListener('click', hideCustomNotification);

    // --- Input Styling & Validation Utilities ---
    function updateInputIconColor(inputEl, colorClass) {
        const icon = inputEl.parentElement?.querySelector('.input-icon');
        if (icon) {
            icon.classList.remove('text-gray-400', 'text-[#091e65]', 'text-red-500', 'text-green-500');
            icon.classList.add(colorClass || 'text-gray-400');
        }
    }

    function markInputError(inputEl, showInlineError = true, message = null) {
        if (!inputEl) return;
        inputEl.classList.remove('border-theme-border', 'border-green-500', 'focus:border-[#091e65]', 'focus:ring-[#091e65]', 'focus:border-green-500', 'focus:ring-green-500');
        inputEl.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        updateInputIconColor(inputEl, 'text-red-500');
        
        const errorMsgDisplayElement = document.getElementById(inputEl.id + '-error');
        if (errorMsgDisplayElement && showInlineError) {
            if(message) errorMsgDisplayElement.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i>${message}`;
            errorMsgDisplayElement.classList.remove('hidden');
        }
        const successMsgDisplayElement = document.getElementById(inputEl.id + '-success');
        if (successMsgDisplayElement) successMsgDisplayElement.classList.add('hidden');
    }

    function markInputSuccess(inputEl, showInlineSuccess = true, message = null) {
        if (!inputEl) return;
        inputEl.classList.remove('border-theme-border', 'border-red-500', 'focus:border-[#091e65]', 'focus:ring-[#091e65]', 'focus:border-red-500', 'focus:ring-red-500');
        inputEl.classList.add('border-green-500', 'focus:border-green-500', 'focus:ring-green-500');
        updateInputIconColor(inputEl, 'text-green-500');

        const successMsgDisplayElement = document.getElementById(inputEl.id + '-success');
        if (successMsgDisplayElement && showInlineSuccess) {
            if(message) successMsgDisplayElement.innerHTML = `<i class="fas fa-check-circle mr-1"></i>${message}`;
            successMsgDisplayElement.classList.remove('hidden');
        }
        const errorMsgDisplayElement = document.getElementById(inputEl.id + '-error');
        if (errorMsgDisplayElement) errorMsgDisplayElement.classList.add('hidden');
    }
    
    function clearInputVisualState(inputEl) {
        if (!inputEl) return;
        inputEl.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500', 'border-green-500', 'focus:border-green-500', 'focus:ring-green-500');
        inputEl.classList.add('border-theme-border', 'focus:border-[#091e65]', 'focus:ring-[#091e65]');
        updateInputIconColor(inputEl, null); 

        const errorMsgDisplayElement = document.getElementById(inputEl.id + '-error');
        if (errorMsgDisplayElement) errorMsgDisplayElement.classList.add('hidden');
        const successMsgDisplayElement = document.getElementById(inputEl.id + '-success');
        if (successMsgDisplayElement) successMsgDisplayElement.classList.add('hidden');
    }

    function clearAllFormErrors() {
        allFormInputs.forEach(input => {
            if(input.type !== 'checkbox'){ 
                clearInputVisualState(input);
            }
        });
        if(passwordMatchError) passwordMatchError.classList.add('hidden');
        if(phoneError) phoneError.classList.add('hidden');
        if(otpErrorMsgEl) otpErrorMsgEl.classList.add('hidden');
        if(otpSuccessMsgEl) otpSuccessMsgEl.classList.add('hidden');
    }

    allFormInputs.forEach(input => {
        if(input.type === 'checkbox' || input.id === 'phone_number_only') return; 
        input.addEventListener('focus', function(e) {
            const icon = e.target.parentElement?.querySelector('.input-icon');
            if (icon && !e.target.classList.contains('border-red-500') && !e.target.classList.contains('border-green-500')) {
                icon.classList.remove('text-gray-400');
                icon.classList.add('text-[#091e65]');
            }
        });
        input.addEventListener('blur', function(e) {
            const icon = e.target.parentElement?.querySelector('.input-icon');
            if (icon && !e.target.classList.contains('border-red-500') && !e.target.classList.contains('border-green-500')) {
                icon.classList.remove('text-[#091e65]');
                icon.classList.add('text-gray-400');
            }
        });
    });

    if (phoneNumberOnlyInput && phoneInput && phoneError) {
        phoneNumberOnlyInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); 
            value = value.slice(0, 10); 
            e.target.value = value;
            const isValid = value.length === 10;
            const isEmpty = value.length === 0;
            phoneInput.value = isValid ? '+92' + value : '';

            if (isEmpty) {
                clearInputVisualState(phoneNumberOnlyInput);
                phoneError.classList.add('hidden');
            } else if (isValid) {
                markInputSuccess(phoneNumberOnlyInput, false); 
                phoneError.classList.add('hidden');
            } else {
                markInputError(phoneNumberOnlyInput, true, 'Please enter a valid 10-digit number.'); 
                phoneError.classList.remove('hidden'); 
            }
        });
        const initialPhoneValue = phoneNumberOnlyInput.value.replace(/\D/g, '');
        if (initialPhoneValue.length > 0 && initialPhoneValue.length !== 10) {
            markInputError(phoneNumberOnlyInput, true, 'Please enter a valid 10-digit number.');
        } else if (initialPhoneValue.length === 10) {
            markInputSuccess(phoneNumberOnlyInput, false);
            phoneInput.value = '+92' + initialPhoneValue;
        }
    }

    if (sendOtpButton && emailInput && otpInput && csrfToken) {
        sendOtpButton.addEventListener('click', function() {
            const emailVal = emailInput.value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            clearInputVisualState(emailInput);
            clearInputVisualState(otpInput); 
            if(emailVerifiedInput) emailVerifiedInput.value = 'false';

            if (!emailVal || !emailRegex.test(emailVal)) {
                showCustomNotification('Invalid Email', 'Please enter a valid email address.', 'warning');
                markInputError(emailInput);
                emailInput.focus();
                return;
            }

            sendOtpButton.disabled = true;
            sendOtpButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-1.5 text-xs"></i> Sending...`;
            showCustomNotification('Sending OTP', 'Please wait...', 'loading', true);

            fetch("{% url 'AudioXApp:send_otp' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
                body: JSON.stringify({ email: emailVal, purpose: 'signup' })
            })
            .then(async response => {
                const isJson = response.headers.get('content-type')?.includes('application/json');
                const data = isJson ? await response.json() : null;
                if (!response.ok) {
                    const errorMsg = data?.message || response.statusText || `HTTP error! Status: ${response.status}`;
                    throw new Error(errorMsg);
                }
                return data;
            })
            .then(data => {
                if (data?.status === 'success') {
                    showCustomNotification('OTP Sent!', data.message || 'An OTP has been sent to your email.', 'success');
                    otpInput.focus();
                    markInputSuccess(emailInput, false); 
                } else {
                    throw new Error(data?.message || 'Could not send OTP.');
                }
            })
            .catch(error => {
                console.error('Error sending OTP:', error);
                showCustomNotification('OTP Error', error.message || 'An unknown error occurred while sending OTP.', 'error');
                markInputError(emailInput);
            })
            .finally(() => {
                sendOtpButton.disabled = false;
                sendOtpButton.innerHTML = 'Send OTP';
            });
        });
    }

    const validatePasswords = () => {
        if (!passwordInput || !confirmPasswordInput || !passwordMatchError) return true;
        const pass1 = passwordInput.value;
        const pass2 = confirmPasswordInput.value;
        const match = pass1 === pass2;
        const confirmHasValue = pass2.length > 0;
        const pass1HasValue = pass1.length > 0;
        const confirmIconEl = confirmPasswordInput.parentElement?.querySelector('.input-icon');

        if (!pass1HasValue && !confirmHasValue) { 
            clearInputVisualState(confirmPasswordInput);
            passwordMatchError.classList.add('hidden');
            if(confirmIconEl) confirmIconEl.className = 'input-icon fas fa-check-circle text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none transition-colors duration-150';
            return true; 
        }
        if (pass1HasValue && !confirmHasValue && passwordInput.classList.contains('border-red-500')) {
           // If main password has an error, don't mark confirm as success yet
        } else if (match && pass1HasValue) { 
            markInputSuccess(confirmPasswordInput, false);
            passwordMatchError.classList.add('hidden');
            if(confirmIconEl) confirmIconEl.className = 'input-icon fas fa-check-circle text-green-500 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none transition-colors duration-150';
        } else if (confirmHasValue) { 
            markInputError(confirmPasswordInput, false); 
            passwordMatchError.classList.remove('hidden');
            if(confirmIconEl) confirmIconEl.className = 'input-icon fas fa-times-circle text-red-500 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none transition-colors duration-150';
        } else { 
            clearInputVisualState(confirmPasswordInput);
            passwordMatchError.classList.add('hidden');
            if(confirmIconEl) confirmIconEl.className = 'input-icon fas fa-check-circle text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none transition-colors duration-150';
        }
        return match;
    };
    if (passwordInput && confirmPasswordInput) {
        passwordInput.addEventListener('input', validatePasswords);
        confirmPasswordInput.addEventListener('input', validatePasswords);
    }

    if (signupForm && submitButton && termsCheckbox && csrfToken) {
        signupForm.addEventListener('submit', function(event) {
            event.preventDefault();
            clearAllFormErrors();
            let isValid = true;
            const requiredInputs = [
                { id: 'full_name', el: document.getElementById('full_name') },
                { id: 'username', el: document.getElementById('username') },
                { id: 'email', el: emailInput },
                { id: 'otp', el: otpInput },
                { id: 'password', el: passwordInput },
                { id: 'confirm-password', el: confirmPasswordInput },
                { id: 'phone_number_only', el: phoneNumberOnlyInput}
            ];

            requiredInputs.forEach(item => {
                if (item.el && !item.el.value.trim()) {
                    markInputError(item.el, true, `${item.el.placeholder || item.el.name.replace(/_/g, ' ')} is required.`);
                    isValid = false;
                }
            });
            
            const phoneDigits = phoneNumberOnlyInput.value.replace(/\D/g, '');
            if (phoneNumberOnlyInput.value.trim() !== '' && phoneDigits.length !== 10) {
                markInputError(phoneNumberOnlyInput, true, 'Please enter a valid 10-digit phone number.');
                isValid = false;
            } else if (phoneDigits.length === 10){
                phoneInput.value = '+92' + phoneDigits; 
            }

            if (!validatePasswords() && passwordInput.value && confirmPasswordInput.value) { 
                isValid = false;
            }

            if (!termsCheckbox.checked) {
                showCustomNotification('Agreement Required', 'Please agree to the Terms & Privacy Policy.', 'warning');
                termsCheckbox.classList.add('ring-2', 'ring-yellow-500', 'ring-offset-1'); 
                setTimeout(() => termsCheckbox.classList.remove('ring-2', 'ring-yellow-500', 'ring-offset-1'), 2000);
                isValid = false;
            }

            if (!isValid) {
                showCustomNotification('Incomplete Form', 'Please check the highlighted fields and try again.', 'error');
                const firstError = signupForm.querySelector('.border-red-500');
                if (firstError) firstError.focus();
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-1.5 text-xs"></i> Creating Account...`;
            showCustomNotification('Creating Account', 'Please wait...', 'loading', true);
            
            const formData = new FormData(this);

            fetch("{% url 'AudioXApp:signup' %}", {
                method: 'POST', body: formData,
                headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(async response => {
                const isJson = response.headers.get('content-type')?.includes('application/json');
                const data = isJson ? await response.json() : null;
                if (!response.ok || data?.status !== 'success') {
                    const errorMsg = data?.message || response.statusText || `Signup failed! Status: ${response.status}`;
                    const error = new Error(errorMsg);
                    error.data = data; 
                    throw error;
                }
                return data;
            })
            .then(data => {
                showCustomNotification('Account Created!', data.message || 'Success! Redirecting you to login...', 'success', false, 'Login Now', () => {
                    window.location.href = "{% url 'AudioXApp:login' %}";
                });
            })
            .catch(error => {
                console.error('Signup Error:', error, error.data);
                showCustomNotification('Signup Error', error.message || 'An error occurred. Please check details and try again.', 'error');
                
                if (error.data?.errors) {
                    Object.keys(error.data.errors).forEach(fieldName => {
                        let inputId = fieldName;
                        if (fieldName === 'phone_number_only' || fieldName === 'phone') inputId = 'phone_number_only';
                        if (fieldName === 'confirm_password' || fieldName === 'password2') inputId = 'confirm-password';
                        
                        const inputField = document.getElementById(inputId);
                        const fieldErrorMessage = Array.isArray(error.data.errors[fieldName]) ? error.data.errors[fieldName][0] : error.data.errors[fieldName];

                        if (inputField) {
                            markInputError(inputField, true, fieldErrorMessage);
                        }
                    });
                    const firstBackendErrorFieldKey = Object.keys(error.data.errors)[0];
                    let firstBackendErrorFieldId = firstBackendErrorFieldKey;
                    if (firstBackendErrorFieldKey === 'phone_number_only' || firstBackendErrorFieldKey === 'phone') firstBackendErrorFieldId = 'phone_number_only';
                    if (firstBackendErrorFieldKey === 'confirm_password' || firstBackendErrorFieldKey === 'password2') firstBackendErrorFieldId = 'confirm-password';
                    const firstBackendErrorField = document.getElementById(firstBackendErrorFieldId);
                    if(firstBackendErrorField) firstBackendErrorField.focus();
                } else if (error.message && error.message.toLowerCase().includes('otp')) {
                       markInputError(otpInput, true, error.message);
                       if(otpErrorMsgEl) otpErrorMsgEl.classList.remove('hidden'); 
                       if(otpSuccessMsgEl) otpSuccessMsgEl.classList.add('hidden');
                       otpInput.focus();
                }
            })
            .finally(() => {
               const isSuccessNotificationVisible = customNotificationModal.classList.contains('opacity-100') && 
                                                   notificationIconContainerEl.querySelector('.fa-check-circle');
                if (!isSuccessNotificationVisible) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Create Account';
                }
            });
        });
    }

    passwordToggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const parent = this.closest('.relative');
            const targetInput = parent?.querySelector('.password-field');
            const icon = this.querySelector('i');
            if (targetInput && icon) {
                const isPassword = targetInput.type === 'password';
                targetInput.type = isPassword ? 'text' : 'password';
                icon.classList.toggle('fa-eye', !isPassword);
                icon.classList.toggle('fa-eye-slash', isPassword);
                targetInput.focus();
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        if (djangoMessagesElement && djangoMessagesElement.textContent.trim() !== '' && djangoMessagesElement.textContent.trim() !== '[]') {
            try {
                const messagesData = JSON.parse(djangoMessagesElement.textContent);
                if(Array.isArray(messagesData)){
                    messagesData.forEach(message => {
                        let iconType = 'info'; let title = 'Notification';
                        if (message.tags) {
                            if (message.tags.includes('success')) { iconType = 'success'; title = 'Success!'; }
                            else if (message.tags.includes('error')) { iconType = 'error'; title = 'Error!'; }
                            else if (message.tags.includes('warning')) { iconType = 'warning'; title = 'Warning!'; }
                            else { title = message.tags.charAt(0).toUpperCase() + message.tags.slice(1); }
                        }
                        showCustomNotification(title, message.message, iconType);
                    });
                }
            } catch (e) { console.error("Could not parse Django messages:", e, "\nContent:", djangoMessagesElement.textContent); }
        }
    });
    </script>

    <script id="django-messages" type="application/json" style="display: none;">
        {% autoescape off %}
        [
            {% for message in messages %}
                {
                    "message": "{{ message.message|escapejs }}",
                    "tags": "{{ message.tags|escapejs }}",
                    "level": {{ message.level }}
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
        {% endautoescape %}
    </script>

</body>
</html>

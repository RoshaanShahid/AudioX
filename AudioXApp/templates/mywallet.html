{% extends 'Homepage.html' %}
{% load static %}

{% block title %}AudioX - My Wallet{% endblock %}

{% block content %}
<div class="bg-gray-100 min-h-screen py-12">
    <div class="container mx-auto px-4">
        <h1 class="text-4xl md:text-5xl font-extrabold text-center text-[#091e65] mb-6 md:mb-10">
            My AudioX Wallet
        </h1>
        <p class="text-center text-gray-600 text-lg md:text-xl mb-12 md:mb-16 max-w-3xl mx-auto">
            Manage your coins and send gifts to your friends.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
            <div class="bg-white rounded-3xl shadow-xl p-6 md:p-10 relative overflow-hidden">
                <div class="flex flex-col items-center justify-center text-center">
                    <div class="inline-flex items-center justify-center p-4 bg-[#091e65] rounded-full mb-4">
                        <i class="fas fa-coins text-4xl md:text-5xl text-white"></i>
                    </div>
                    <p class="text-[#091e65] text-xl md:text-2xl font-medium mb-2">Current Coins</p>
                    <span class="text-3xl md:text-5xl font-extrabold text-[#091e65] mb-6" id="coin-balance">{{ user.coins }}</span>
                    <a href="{% url 'buycoins' %}" class="w-full md:w-auto px-6 py-3 bg-gradient-to-r from-[#091e65] to-[#06134d] hover:from-[#06134d] hover:to-[#091e65] text-white rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 font-semibold text-base md:text-lg">
                        <i class="fas fa-plus mr-2"></i> Buy Coins
                    </a>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-xl p-6 md:p-8 relative overflow-hidden">
                <h2 class="text-2xl md:text-3xl font-bold text-[#091e65] mb-6 text-center">Send a Gift</h2>
                <form id="gift-form" method="post" action="{% url 'gift_coins' %}">
                    {% csrf_token %}
                    <div class="space-y-6">
                        <div>
                            <label for="recipient" class="block text-sm font-medium text-gray-700">Recipient Username or Email</label>
                            <input type="text" name="recipient" id="recipient" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-[#091e65] focus:border-[#091e65] text-gray-900 placeholder-gray-400 focus:outline-none" required>
                        </div>
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700">Amount</label>
                            <input type="number" name="amount" id="amount" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-[#091e65] focus:border-[#091e65] text-gray-900 placeholder-gray-400 appearance-none focus:outline-none" placeholder="0" min="1" required>
                        </div>
                    </div>
                    <button type="button" id="send-gift-btn" class="mt-6 w-full px-6 py-3 bg-[#091e65] hover:bg-opacity-90 text-white rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 font-semibold text-base md:text-lg focus:outline-none">
                        <i class="fas fa-gift mr-2"></i> Send Gift
                    </button>
                </form>
                <div id="gift-message" class="mt-4 text-center"></div>
            </div>
        </div>

        <div class="mt-10 text-center">
            <p class="text-gray-600">Want to earn more coins?  <a href="{% url 'buycoins' %}" class="text-red-500 hover:text-red-600 font-semibold transition-colors">Explore our coin packs!</a></p>
        </div>

        <div class="mt-12">
            <h2 class="text-2xl md:text-3xl font-bold text-[#091e65] text-center mb-6">Transaction History</h2>

            <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
                <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="myTab" data-tabs-toggle="#myTabContent" role="tablist">
                    <li class="mr-2" role="presentation">
                        <button class="inline-block p-4 border-b-2 rounded-t-lg" id="purchased-tab" data-tabs-target="#purchased" type="button" role="tab" aria-controls="purchased" aria-selected="false">Purchased Coin Packs</button>
                    </li>
                    <li class="mr-2" role="presentation">
                        <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" id="received-tab" data-tabs-target="#received" type="button" role="tab" aria-controls="received" aria-selected="false">Received Gift Coins</button>
                    </li>
                    <li class="mr-2" role="presentation">
                        <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" id="sent-tab" data-tabs-target="#sent" type="button" role="tab" aria-controls="sent" aria-selected="false">Sent Gift Coins</button>
                    </li>
                </ul>
            </div>
            <div id="myTabContent">
                 <div class="hidden p-4 rounded-lg bg-white shadow-xl" id="purchased" role="tabpanel" aria-labelledby="purchased-tab">
                    <div class="grid grid-cols-1 gap-4">
                        {% for transaction in gift_history %}
                            {% if transaction.transaction_type == 'purchase' %}
                                <div class="bg-white rounded-xl shadow p-4 flex items-center justify-between hover:shadow-lg transition-shadow duration-200">
                                     <div class="flex items-center space-x-4">
                                         <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                                            <i class="fas fa-shopping-cart"></i>
                                        </div>
                                        <div>
                                            <p class="text-lg font-semibold text-[#091e65]">{{ transaction.pack_name }}</p>
                                             <p class="text-gray-500 text-sm">{{ transaction.amount }} Coins</p>
                                            <p class="text-gray-500 text-sm">{{ transaction.transaction_date|date:"M d, Y" }}</p>
                                        </div>
                                    </div>
                                     <div class="text-right">
                                        <p class="text-lg font-bold text-[#091e65]">PKR {{ transaction.price|floatformat:2 }}</p>

                                    </div>
                                </div>
                            {% endif %}
                        {% empty %}
                            <p class="text-gray-500 text-center py-4">No purchase history found.</p>
                        {% endfor %}
                    </div>
                </div>
                <div class="hidden p-4 rounded-lg bg-white shadow-xl" id="received" role="tabpanel" aria-labelledby="received-tab">
                    <div class="grid grid-cols-1 gap-4">
                        {% for transaction in gift_history %}
                            {% if transaction.transaction_type == 'gift_received' %}
                               <div class="bg-white rounded-xl shadow p-4 flex items-center justify-between hover:shadow-lg transition-shadow duration-200">
                                    <div class="flex items-center space-x-4">
                                         <div class="w-12 h-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                            <i class="fas fa-gift"></i>
                                        </div>
                                        <div>
                                            <p class="text-lg font-semibold text-[#091e65]">From: {{ transaction.sender.email }}</p>
                                            <p class="text-gray-500 text-sm">{{ transaction.transaction_date|date:"M d, Y" }}</p>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-xl font-bold text-[#091e65]">{{ transaction.amount }} Coins</p>
                                    </div>
                                </div>
                            {% endif %}
                        {% empty %}
                            <p class="text-gray-500 text-center py-4">No received gifts found.</p>
                        {% endfor %}
                    </div>
                </div>
                <div class="hidden p-4 rounded-lg bg-white shadow-xl" id="sent" role="tabpanel" aria-labelledby="sent-tab">
                    <div class="grid grid-cols-1 gap-4">
                        {% for transaction in gift_history %}
                            {% if transaction.transaction_type == 'gift_sent' %}
                                <div class="bg-white rounded-xl shadow p-4 flex items-center justify-between hover:shadow-lg transition-shadow duration-200">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 rounded-full bg-red-100 text-red-600 flex items-center justify-center">
                                            <i class="fas fa-paper-plane"></i>  </div>
                                        <div>
                                            <p class="text-lg font-semibold text-[#091e65]">To: {{ transaction.recipient.email }}</p>
                                            <p class="text-gray-500 text-sm">{{ transaction.transaction_date|date:"M d, Y" }}</p>
                                        </div>
                                    </div>
                                     <div>
                                        <p class="text-xl font-bold text-[#091e65]">{{ transaction.amount }} Coins</p>
                                    </div>
                                </div>
                            {% endif %}
                        {% empty %}
                            <p class="text-gray-500 text-center py-4">No sent gifts found.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="relative bg-white rounded-2xl shadow-lg w-full max-w-md mx-4 sm:mx-auto">
        <button type="button" id="close-modal-btn" class="absolute top-3 right-4 text-gray-600 hover:text-gray-800 focus:outline-none">
            <i class="fas fa-times text-xl"></i>
        </button>

        <div class="p-6 sm:p-8">
           <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-[#091e65] via-blue-400 to-[#06134d] rounded-t-2xl"></div>

            <div class="flex items-center justify-center mb-6">
                <i class="fas fa-gift text-5xl text-[#091e65]"></i>
            </div>
            <h2 id="modal-title" class="text-2xl font-bold text-[#091e65] text-center mb-1">Confirm Gift</h2>
            <p class="text-gray-400 text-sm text-center mb-6">Please review the details before sending.</p>

            <div class="mb-6">
                <div class="flex justify-between items-center border-b border-gray-200 py-2">
                    <span class="text-gray-600">From:</span>
                    <span id="confirm-from" class="font-medium text-gray-900">{{ user.email }}</span>
                </div>
                <div class="flex justify-between items-center border-b border-gray-200 py-2">
                    <span class="text-gray-600">To:</span>
                    <span id="confirm-to" class="font-medium text-gray-900"></span>
                </div>
                <div class="flex justify-between items-center pt-2">
                    <span class="text-gray-600">Amount:</span>
                    <span id="confirm-amount" class="font-bold text-xl text-[#091e65]"></span>
                </div>
            </div>

            <div class="flex justify-center space-x-4">
                <button id="confirm-send" class="px-8 py-3 bg-gradient-to-r from-[#091e65] to-[#06134d] hover:from-[#06134d] hover:to-[#091e65] text-white rounded-full shadow-lg transition duration-300 ease-in-out font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transform hover:scale-105">
                    Confirm
                </button>
                <button id="cancel-send" class="px-8 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full shadow-md transition duration-300 ease-in-out font-semibold focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                    Cancel
                </button>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 w-full h-2 bg-gradient-to-r from-[#06134d] via-blue-400 to-[#091e65] rounded-b-2xl"></div>
    </div>
</div>



<script src="https://unpkg.com/flowbite@1.5.1/dist/flowbite.js"></script> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script>
// Existing JavaScript for gift sending (remains mostly the same, updated selectors)
document.addEventListener('DOMContentLoaded', function() {
    const giftForm = document.getElementById('gift-form');
    const messageDiv = document.getElementById('gift-message');
    const sendGiftBtn = document.getElementById('send-gift-btn');
    const confirmationModal = document.getElementById('confirmation-modal');
    const confirmFrom = document.getElementById('confirm-from');
    const confirmTo = document.getElementById('confirm-to');
    const confirmAmount = document.getElementById('confirm-amount');
    const confirmSendBtn = document.getElementById('confirm-send');
    const cancelSendBtn = document.getElementById('cancel-send');
    const closeModalBtn = document.getElementById('close-modal-btn');
    let giftData = {};

    function showModal() {
        confirmationModal.classList.remove('hidden');
    }

    function hideModal() {
        confirmationModal.classList.add('hidden');
        giftData = {};
    }

    function showMessage(message, type) {
        messageDiv.innerHTML = ''; // Clear previous messages
        const messageElement = document.createElement('div');
        messageElement.classList.add(
            'py-2', 'px-4', 'rounded-full', 'text-sm', 'font-semibold', 'mb-4', 'inline-block' // Added inline-block
        );

        if (type === 'success') {
            messageElement.classList.add('bg-green-100', 'text-green-600');
            messageElement.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
        } else if (type === 'error') {
            messageElement.classList.add('bg-red-100', 'text-red-600');
            messageElement.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
        }
        messageDiv.appendChild(messageElement);
    }



    sendGiftBtn.addEventListener('click', function(event) {
        event.preventDefault();
        messageDiv.innerHTML = ''; // Clear any previous messages

        const recipient = document.getElementById('recipient').value.trim();
        const amount = parseInt(document.getElementById('amount').value, 10);

        if (isNaN(amount) || amount <= 0) {
            showMessage("Please enter a valid, positive number for the amount.", 'error');
            return;
        }
        if (!recipient) {
            showMessage("Recipient is required.", 'error');
            return
        }

        giftData = { recipient, amount };
        confirmTo.textContent = recipient;
        confirmAmount.textContent = amount;
        confirmFrom.textContent = document.getElementById('confirm-from').textContent;
        showModal();
    });

    cancelSendBtn.addEventListener('click', hideModal);
    closeModalBtn.addEventListener('click', hideModal);

    confirmSendBtn.addEventListener('click', function() {
        confirmSendBtn.disabled = true;
        cancelSendBtn.disabled = true;

        fetch("{% url 'gift_coins' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(giftData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errData => {
                    throw new Error(errData.message || 'Unknown Error');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                showMessage(data.message, 'success');
                document.getElementById('coin-balance').textContent = data.new_balance;
                setTimeout(function() {
                    location.reload(); //Reload completely only if the gift send is successfull.
                }, 3000);
            } else {
                showMessage(data.message, 'error');
            }
            giftForm.reset();
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage(error.message, 'error');

        })
        .finally(() => {
            confirmSendBtn.disabled = false;
            cancelSendBtn.disabled = false;
            hideModal();
        });
    });

    function animateValue(element, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            element.textContent = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    const coinBalanceElement = document.getElementById('coin-balance');
    if (coinBalanceElement) {
        const endValue = parseInt(coinBalanceElement.textContent);
        animateValue(coinBalanceElement, 0, endValue, 1500);
    }
});
</script>
{% endblock %}
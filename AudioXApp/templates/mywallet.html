{% extends 'Homepage.html' %}
{% load static %}

{% block title %}AudioX - My Wallet{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
    :root {
        --theme-primary: #091e65;
        --theme-primary-hover: #1e3a8a;
        --theme-primary-rgb: 9, 30, 101;
        --theme-focus-ring: rgba(var(--theme-primary-rgb), 0.25);
        --theme-light-bg: rgba(var(--theme-primary-rgb), 0.05);
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: #ffffff;
        color: #1f2937;
    }

    .theme-gradient-bg-v3 {
        background: linear-gradient(135deg, var(--theme-primary-hover) 0%, var(--theme-primary) 100%);
    }

    .card-v3 {
        background-color: #ffffff;
        border-radius: 0.875rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -2px rgba(0, 0, 0, 0.04);
        border: 1px solid #f3f4f6;
        overflow: hidden;
    }

    .form-input-v3 {
        border: 1px solid #e5e7eb;
        border-radius: 0.625rem;
        padding: 0.75rem 1.125rem;
        padding-left: 3rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        width: 100%;
        font-size: 0.875rem;
        color: #1f2937;
        background-color: #f9fafb;
    }
    .form-input-v3::placeholder {
        color: #9ca3af;
    }
    .form-input-v3:focus {
        border-color: var(--theme-primary);
        box-shadow: 0 0 0 3px var(--theme-focus-ring);
        outline: none;
        background-color: #ffffff;
    }
    .input-icon-wrapper-v3 {
        position: relative;
    }
    .input-icon-v3 {
        position: absolute;
        left: 1.125rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        pointer-events: none;
        font-size: 0.875rem;
    }

    .btn-v3 {
        padding: 0.75rem 1.75rem;
        border-radius: 0.625rem;
        font-weight: 600;
        transition: all 0.25s ease-in-out;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.625rem;
        border: none;
        line-height: 1.25rem;
        font-size: 0.875rem;
        text-align: center;
    }
    .btn-v3-primary {
        background-color: var(--theme-primary);
        color: white;
        box-shadow: 0 1px 2px 0 rgba(var(--theme-primary-rgb), 0.1), 0 1px 1px 0 rgba(var(--theme-primary-rgb), 0.06);
    }
    .btn-v3-primary:hover {
        background-color: var(--theme-primary-hover);
        box-shadow: 0 4px 6px -1px rgba(var(--theme-primary-rgb), 0.1), 0 2px 4px -2px rgba(var(--theme-primary-rgb), 0.1);
        transform: translateY(-1px);
    }
    .btn-v3-secondary {
        background-color: #f3f4f6;
        color: #374151;
        border: 1px solid #e5e7eb;
    }
    .btn-v3-secondary:hover {
        background-color: #e5e7eb;
        border-color: #d1d5db;
    }

    #historyTabs-v3 {
        position: relative;
        border-bottom: 1px solid #e5e7eb;
    }
    #historyTabs-v3 button {
        padding: 0.875rem 0.5rem;
        margin-right: 1.75rem;
        font-size: 0.9rem;
        font-weight: 500;
        color: #6b7280;
        border-bottom: 3px solid transparent;
        transition: color 0.2s ease, border-color 0.2s ease;
        margin-bottom: -1px;
        position: relative;
    }
    #historyTabs-v3 button[aria-selected="true"] {
        color: var(--theme-primary);
        border-bottom-color: var(--theme-primary);
        font-weight: 600;
    }
    #historyTabs-v3 button:hover:not([aria-selected="true"]) {
        color: #111827;
    }

    .transaction-item-v3 {
        display: flex;
        align-items: center;
        padding: 1.125rem 0.375rem;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.2s ease;
    }
    .transaction-item-v3:last-child {
        border-bottom: none;
    }
     .transaction-item-v3:hover {
        background-color: #f9fafb;
     }

    .transaction-icon-v3 {
        width: 2.75rem;
        height: 2.75rem;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-right: 1.125rem;
        font-size: 1rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    .transaction-details-v3 {
        flex-grow: 1;
        min-width: 0;
        font-size: 0.875rem;
        line-height: 1.35rem;
    }
    .transaction-details-v3 .description {
        font-weight: 500;
        color: #1f2937;
        margin-bottom: 0.1rem;
    }
    .transaction-details-v3 .date {
        color: #6b7280;
        font-size: 0.8rem;
    }
    .transaction-amount-v3 {
        text-align: right;
        flex-shrink: 0;
        margin-left: 1rem;
        font-size: 0.95rem;
        font-weight: 600;
    }
    .transaction-amount-v3 .amount-value {
        display: block;
    }
    .transaction-amount-v3 .amount-currency {
        font-size: 0.75rem;
        font-weight: 400;
        color: #9ca3af;
        margin-top: 0.1rem;
    }
    .text-positive-v3 { color: #15803d; }
    .text-negative-v3 { color: #b91c1c; }
    .bg-positive-light-v3 { background-color: #f0fdf4; }
    .bg-negative-light-v3 { background-color: #fef2f2; }
    .bg-theme-light-v3 { background-color: var(--theme-light-bg); }
    .text-theme-v3 { color: var(--theme-primary); }
    .bg-amber-50-v3 { background-color: #fffbeb; }
    .bg-gray-100-v3 { background-color: #f3f4f6; }
    .text-amber-600-v3 { color: #b45309; }
    .text-gray-500-v3 { color: #6b7280; }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        appearance: none;
        margin: 0;
    }
    input[type=number] {
        -moz-appearance: textfield;
        appearance: textfield;
    }

    #confirmation-modal {
        transition: opacity 0.3s ease;
    }
    #modal-content-el {
        transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .no-activity-message-v3 {
        text-align: center;
        padding: 4rem 1rem;
        color: #9ca3af;
    }
    .no-activity-message-v3 i {
        font-size: 2.5rem;
        margin-bottom: 1.25rem;
        color: #e5e7eb;
    }
    .no-activity-message-v3 p {
        font-size: 0.95rem;
        font-weight: 500;
        color: #6b7280;
    }

</style>

<div class="min-h-screen py-10 md:py-12">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">

        <h1 class="text-2xl md:text-3xl font-semibold text-center text-gray-900 mb-8 md:mb-12">
            My Wallet Overview
        </h1>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8">

            <div class="lg:col-span-4 flex flex-col gap-6 md:gap-8">
                <div class="card-v3 theme-gradient-bg-v3 text-white p-6 md:p-7 relative overflow-hidden">
                     <div class="absolute -top-8 -left-8 w-36 h-36 bg-white/5 rounded-full opacity-60"></div>
                     <div class="absolute -bottom-12 -right-12 w-48 h-48 bg-white/10 rounded-full opacity-60"></div>
                     <div class="relative z-10">
                         <div class="flex items-center justify-between mb-2 opacity-80">
                             <h2 class="text-base font-medium">Available Balance</h2>
                             <i class="fas fa-wallet text-xl opacity-70"></i>
                         </div>
                         <div class="my-5">
                             <span id="coin-balance" class="text-5xl md:text-6xl font-bold block leading-none tracking-tight text-white">{{ user.coins }}</span>
                             <span class="text-xs font-medium opacity-80 tracking-wider mt-1 inline-block">AUDIOX COINS</span>
                         </div>
                         <a href="{% url 'AudioXApp:buycoins' %}" class="btn-v3 bg-white w-full hover:bg-opacity-95 text-sm font-semibold shadow-sm" style="color: var(--theme-primary);">
                             <i class="fas fa-plus-circle text-base"></i> Add Coins
                         </a>
                     </div>
                </div>

                <div class="card-v3 p-6 md:p-7">
                     <h2 class="text-lg font-semibold text-gray-800 mb-5 flex items-center">
                         <i class="fas fa-gift mr-3 opacity-90" style="color: var(--theme-primary);"></i> Send AudioX Gift
                     </h2>
                     <form id="gift-form" method="post" action="{% url 'AudioXApp:gift_coins' %}">
                         {% csrf_token %}
                         <div class="space-y-4">
                             <div class="input-icon-wrapper-v3">
                                 <label for="recipient" class="sr-only">Recipient Username or Email</label>
                                 <i class="fas fa-at input-icon-v3"></i>
                                 <input type="text" id="recipient" name="recipient" class="form-input-v3" placeholder="Recipient Username or Email" required>
                             </div>
                             <div class="input-icon-wrapper-v3">
                                 <label for="amount" class="sr-only">Amount of Coins</label>
                                 <i class="fas fa-coins input-icon-v3"></i>
                                 <input type="number" id="amount" name="amount" class="form-input-v3" placeholder="Amount of Coins" min="1" required>
                             </div>
                         </div>
                         <button type="button" id="send-gift-btn" class="btn-v3 btn-v3-primary w-full mt-6">
                             <i class="fas fa-paper-plane text-base"></i> Send Gift
                         </button>
                     </form>
                     <div id="gift-message" class="mt-4 text-center h-5 text-sm"></div>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div class="card-v3">
                    <div class="p-5 md:p-6">
                        <h2 class="text-lg font-semibold text-gray-800">Transaction History</h2>
                    </div>

                    <div id="historyTabs-v3" class="px-5 md:px-6">
                        <ul class="flex" role="tablist">
                            <li role="presentation">
                                <button class="inline-block" id="all-tab" data-tabs-target="#all" type="button" role="tab" aria-controls="all" aria-selected="true">All</button>
                            </li>
                            <li role="presentation">
                                <button class="inline-block" id="purchased-tab" data-tabs-target="#purchased" type="button" role="tab" aria-controls="purchased" aria-selected="false">Purchases</button>
                            </li>
                            <li role="presentation">
                                <button class="inline-block" id="received-tab" data-tabs-target="#received" type="button" role="tab" aria-controls="received" aria-selected="false">Received</button>
                            </li>
                            <li role="presentation">
                                <button class="inline-block" id="sent-tab" data-tabs-target="#sent" type="button" role="tab" aria-controls="sent" aria-selected="false">Sent</button>
                            </li>
                        </ul>
                    </div>

                    <div id="historyTabContent" class="p-5 md:p-6 min-h-[250px]">
                        <div id="all" role="tabpanel" aria-labelledby="all-tab">
                            <ul class="history-list space-y-1">
                                {% for transaction in gift_history %}
                                    <li class="transaction-item-v3">
                                        <div class="transaction-icon-v3
                                            {% if transaction.transaction_type == 'purchase' %} bg-theme-light-v3 text-theme-v3
                                            {% elif transaction.transaction_type == 'gift_sent' %} bg-negative-light-v3 text-negative-v3
                                            {% elif transaction.transaction_type == 'gift_received' %} bg-positive-light-v3 text-positive-v3
                                            {% elif transaction.transaction_type == 'reward' %} bg-amber-50-v3 text-amber-600-v3
                                            {% elif transaction.transaction_type == 'spent' %} bg-negative-light-v3 text-negative-v3
                                            {% elif transaction.transaction_type == 'refund' %} bg-gray-100-v3 text-gray-500-v3
                                            {% else %} bg-gray-100-v3 text-gray-500-v3 {% endif %}">
                                            <i class="fas fa-fw
                                                {% if transaction.transaction_type == 'purchase' %} fa-shopping-cart
                                                {% elif transaction.transaction_type == 'gift_sent' %} fa-paper-plane
                                                {% elif transaction.transaction_type == 'gift_received' %} fa-gift
                                                {% elif transaction.transaction_type == 'reward' %} fa-star
                                                {% elif transaction.transaction_type == 'spent' %} fa-arrow-down
                                                {% elif transaction.transaction_type == 'refund' %} fa-undo
                                                {% else %} fa-info-circle {% endif %}"></i>
                                        </div>
                                        <div class="transaction-details-v3">
                                            <p class="description truncate" title="{% if transaction.transaction_type == 'purchase' %}{{ transaction.pack_name|default:'Coin Purchase' }}{% elif transaction.transaction_type == 'gift_sent' %}Sent to: {{ transaction.recipient.username|default:'N/A' }}{% elif transaction.transaction_type == 'gift_received' %}Received from: {{ transaction.sender.username|default:'N/A' }}{% else %}{{ transaction.get_transaction_type_display }}{% endif %}">
                                                {% if transaction.transaction_type == 'purchase' %}{{ transaction.pack_name|default:'Coin Purchase' }}{% elif transaction.transaction_type == 'gift_sent' %}Sent to: {{ transaction.recipient.username|default:'N/A' }}{% elif transaction.transaction_type == 'gift_received' %}Received from: {{ transaction.sender.username|default:'N/A' }}{% else %}{{ transaction.get_transaction_type_display }}{% endif %}
                                            </p>
                                            <p class="date">{{ transaction.transaction_date|date:"M d, Y, h:i A" }}</p>
                                        </div>
                                        <div class="transaction-amount-v3">
                                            <span class="amount-value
                                                {% if transaction.transaction_type == 'gift_sent' or transaction.transaction_type == 'spent' %} text-negative-v3
                                                {% elif transaction.transaction_type == 'gift_received' or transaction.transaction_type == 'purchase' or transaction.transaction_type == 'reward' or transaction.transaction_type == 'refund' %} text-positive-v3
                                                {% else %} text-gray-700 {% endif %}">
                                                {% if transaction.transaction_type == 'gift_sent' or transaction.transaction_type == 'spent' %}- {{ transaction.amount }}
                                                {% elif transaction.transaction_type == 'gift_received' or transaction.transaction_type == 'purchase' or transaction.transaction_type == 'reward' or transaction.transaction_type == 'refund' %}+ {{ transaction.amount }}
                                                {% else %}{{ transaction.amount }}{% endif %}
                                            </span>
                                            {% if transaction.transaction_type == 'purchase' and transaction.price %}
                                                <span class="amount-currency">PKR {{ transaction.price|floatformat:2 }}</span>
                                            {% endif %}
                                        </div>
                                    </li>
                                {% empty %}
                                    <li class="no-activity-message-v3">
                                        <i class="fas fa-receipt"></i>
                                        <p>No transactions recorded yet.</p>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="hidden" id="purchased" role="tabpanel" aria-labelledby="purchased-tab">
                             <ul class="history-list space-y-1">
                                {% for transaction in gift_history %}
                                    {% if transaction.transaction_type == 'purchase' %}
                                        <li class="transaction-item-v3">
                                            <div class="transaction-icon-v3 bg-theme-light-v3 text-theme-v3">
                                                <i class="fas fa-fw fa-shopping-cart"></i>
                                            </div>
                                            <div class="transaction-details-v3">
                                                <p class="description truncate" title="{{ transaction.pack_name|default:'Coin Purchase' }}">{{ transaction.pack_name|default:'Coin Purchase' }}</p>
                                                <p class="date">{{ transaction.transaction_date|date:"M d, Y, h:i A" }}</p>
                                            </div>
                                            <div class="transaction-amount-v3">
                                                <span class="amount-value text-positive-v3">+ {{ transaction.amount }}</span>
                                                {% if transaction.price %}
                                                    <span class="amount-currency">PKR {{ transaction.price|floatformat:2 }}</span>
                                                {% endif %}
                                            </div>
                                        </li>
                                    {% endif %}
                                {% empty %}
                                     <li class="no-activity-message-v3">
                                         <i class="fas fa-shopping-cart"></i>
                                         <p>No purchases recorded yet.</p>
                                     </li>
                                {% endfor %}
                             </ul>
                        </div>
                        <div class="hidden" id="received" role="tabpanel" aria-labelledby="received-tab">
                             <ul class="history-list space-y-1">
                                {% for transaction in gift_history %}
                                    {% if transaction.transaction_type == 'gift_received' %}
                                        <li class="transaction-item-v3">
                                            <div class="transaction-icon-v3 bg-positive-light-v3 text-positive-v3">
                                                <i class="fas fa-fw fa-gift"></i>
                                            </div>
                                            <div class="transaction-details-v3">
                                                <p class="description truncate" title="Received from: {{ transaction.sender.username|default:'N/A' }}">Received from: {{ transaction.sender.username|default:'N/A' }}</p>
                                                <p class="date">{{ transaction.transaction_date|date:"M d, Y, h:i A" }}</p>
                                            </div>
                                            <div class="transaction-amount-v3">
                                                <span class="amount-value text-positive-v3">+ {{ transaction.amount }}</span>
                                            </div>
                                        </li>
                                    {% endif %}
                                {% empty %}
                                    <li class="no-activity-message-v3">
                                        <i class="fas fa-gift"></i>
                                        <p>No received gifts recorded yet.</p>
                                    </li>
                                {% endfor %}
                             </ul>
                        </div>
                        <div class="hidden" id="sent" role="tabpanel" aria-labelledby="sent-tab">
                             <ul class="history-list space-y-1">
                                {% for transaction in gift_history %}
                                    {% if transaction.transaction_type == 'gift_sent' %}
                                        <li class="transaction-item-v3">
                                            <div class="transaction-icon-v3 bg-negative-light-v3 text-negative-v3">
                                                <i class="fas fa-fw fa-paper-plane"></i>
                                            </div>
                                            <div class="transaction-details-v3">
                                                <p class="description truncate" title="Sent to: {{ transaction.recipient.username|default:'N/A' }}">Sent to: {{ transaction.recipient.username|default:'N/A' }}</p>
                                                <p class="date">{{ transaction.transaction_date|date:"M d, Y, h:i A" }}</p>
                                            </div>
                                            <div class="transaction-amount-v3">
                                                <span class="amount-value text-negative-v3">- {{ transaction.amount }}</span>
                                            </div>
                                        </li>
                                    {% endif %}
                                {% empty %}
                                    <li class="no-activity-message-v3">
                                        <i class="fas fa-paper-plane"></i>
                                        <p>No sent gifts recorded yet.</p>
                                    </li>
                                {% endfor %}
                             </ul>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-md mx-auto transform transition-all scale-95 opacity-0" id="modal-content-el">
        <button type="button" id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none p-1 rounded-full hover:bg-gray-100 transition-colors">
            <i class="fas fa-times text-base"></i>
            <span class="sr-only">Close modal</span>
        </button>

        <div class="p-6 sm:p-7 pt-7 sm:pt-8">
            <div class="text-center mb-6">
                 <div class="inline-flex items-center justify-center w-12 h-12 rounded-full mb-3" style="background-color: var(--theme-light-bg);">
                    <i class="fas fa-paper-plane text-xl" style="color: var(--theme-primary);"></i>
                 </div>
                 <h2 id="modal-title" class="text-lg font-semibold text-gray-900">Confirm Gift Transfer</h2>
                 <p class="text-gray-500 text-sm mt-1.5">Double-check the details before sending.</p>
            </div>

            <div class="mb-7 space-y-3 bg-gray-50 p-4 sm:p-5 rounded-lg border border-gray-200 text-sm">
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">From:</span>
                    <span id="confirm-from" class="font-medium text-gray-800">{{ user.username }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">To:</span>
                    <span id="confirm-to" class="font-medium text-gray-800 break-all text-right"></span>
                </div>
                <div class="flex justify-between items-center pt-1.5">
                    <span class="text-gray-600">Amount:</span>
                    <div class="text-right">
                        <span id="confirm-amount" class="font-semibold text-base" style="color: var(--theme-primary);"></span>
                        <span class="text-gray-600 text-xs ml-0.5">Coins</span>
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button id="cancel-send" type="button" class="btn-v3 btn-v3-secondary">
                    Cancel
                </button>
                <button id="confirm-send" type="button" class="btn-v3 btn-v3-primary">
                    Confirm & Send
                </button>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const giftForm = document.getElementById('gift-form');
    const sendGiftBtn = document.getElementById('send-gift-btn');
    const confirmationModal = document.getElementById('confirmation-modal');
    const modalContentEl = document.getElementById('modal-content-el');
    const confirmFrom = document.getElementById('confirm-from');
    const confirmTo = document.getElementById('confirm-to');
    const confirmAmount = document.getElementById('confirm-amount');
    const confirmSendBtn = document.getElementById('confirm-send');
    const cancelSendBtn = document.getElementById('cancel-send');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const coinBalanceElement = document.getElementById('coin-balance');
    const historyTabs = document.querySelectorAll('#historyTabs-v3 button[role="tab"]');
    const historyTabContents = document.querySelectorAll('#historyTabContent div[role="tabpanel"]');

    let giftData = {};

    function showModal() {
        if(confirmationModal && modalContentEl) {
            confirmationModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                confirmationModal.classList.remove('opacity-0');
                modalContentEl.classList.remove('opacity-0', 'scale-95');
                modalContentEl.classList.add('opacity-100', 'scale-100');
            });
        }
    }

    function hideModal() {
        if(confirmationModal && modalContentEl) {
             modalContentEl.classList.remove('opacity-100', 'scale-100');
             modalContentEl.classList.add('opacity-0', 'scale-95');
             confirmationModal.classList.add('opacity-0');
             setTimeout(() => {
                 confirmationModal.classList.add('hidden');
             }, 300);
        }
        giftData = {};
    }

    function showGiftMessage(message, type = 'info') {
         const icon = type === 'success' ? 'success' : (type === 'error' ? 'error' : 'info');
         Swal.fire({
             title: type.charAt(0).toUpperCase() + type.slice(1),
             text: message,
             icon: icon,
             confirmButtonColor: '#091e65',
             timer: type === 'success' ? 3000 : null,
             timerProgressBar: type === 'success',
             customClass: {
                popup: 'rounded-xl shadow-lg text-sm',
                confirmButton: 'btn-v3 btn-v3-primary px-4 py-1.5 text-xs',
                title: 'text-base font-semibold',
             },
             buttonsStyling: false,
         });
      }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

     function animateValue(element, start, end, duration) {
         let startTimestamp = null;
         const step = (timestamp) => {
             if (!startTimestamp) startTimestamp = timestamp;
             const progress = Math.min((timestamp - startTimestamp) / duration, 1);
             const easedProgress = 1 - Math.pow(1 - progress, 3);
             const currentValue = Math.floor(easedProgress * (end - start) + start);
             element.textContent = new Intl.NumberFormat('en-US').format(currentValue);
             if (progress < 1) {
                 window.requestAnimationFrame(step);
             } else {
                 element.textContent = new Intl.NumberFormat('en-US').format(end);
             }
         };
         window.requestAnimationFrame(step);
     }

    if (sendGiftBtn && giftForm) {
        sendGiftBtn.addEventListener('click', function(event) {
            event.preventDefault();
            const recipientInput = giftForm.querySelector('#recipient');
            const amountInput = giftForm.querySelector('#amount');
            const recipient = recipientInput.value.trim();
            const amount = parseInt(amountInput.value, 10);

            if (!recipient) {
                showGiftMessage("Please enter the recipient's username or email.", 'error');
                recipientInput.focus(); return;
            }
            if (isNaN(amount) || amount <= 0) {
                showGiftMessage("Please enter a valid, positive amount of coins.", 'error');
                amountInput.focus(); return;
            }
            const currentBalanceText = coinBalanceElement?.textContent?.replace(/,/g, '') || '0';
            const currentBalance = parseInt(currentBalanceText, 10);
            if (isNaN(currentBalance) || amount > currentBalance) {
                showGiftMessage("Insufficient balance for this gift amount.", 'error');
                amountInput.focus(); return;
            }

            giftData = { recipient, amount };
            if (confirmTo) confirmTo.textContent = recipient;
            if (confirmAmount) confirmAmount.textContent = amount.toLocaleString('en-US');
            showModal();
        });
    }

    if (cancelSendBtn) cancelSendBtn.addEventListener('click', hideModal);
    if (closeModalBtn) closeModalBtn.addEventListener('click', hideModal);
    if (confirmationModal) {
        confirmationModal.addEventListener('click', (event) => {
            if (event.target === confirmationModal) hideModal();
        });
    }

    if (confirmSendBtn) {
        confirmSendBtn.addEventListener('click', function() {
            confirmSendBtn.disabled = true;
            cancelSendBtn.disabled = true;
            confirmSendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Sending...';

            fetch("{% url 'AudioXApp:gift_coins' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(giftData)
            })
            .then(async response => {
                const isJson = response.headers.get('content-type')?.includes('application/json');
                const responseData = isJson ? await response.json() : null;
                if (!response.ok) { throw new Error(responseData?.message || `Server error: ${response.status}`); }
                if (responseData?.status !== 'success') { throw new Error(responseData?.message || 'Gift transfer failed.'); }
                return responseData;
            })
            .then(data => {
                 hideModal();
                 showGiftMessage(data.message || 'Gift sent successfully!', 'success');
                 if (coinBalanceElement && typeof data.new_balance !== 'undefined') {
                     const startBalance = parseInt(coinBalanceElement.textContent.replace(/,/g, ''), 10) || 0;
                     animateValue(coinBalanceElement, startBalance, data.new_balance, 800);
                 }
                 if (giftForm) giftForm.reset();

                 const transaction = data.transaction || {
                     transaction_date: new Date().toISOString(),
                     amount: giftData.amount,
                     recipient: { username: giftData.recipient },
                     transaction_type: 'gift_sent',
                 };
                 addTransactionToHistory(transaction, 'sent');
                 addTransactionToHistory(transaction, 'all');

            })
            .catch(error => {
                console.error('Error sending gift:', error);
                hideModal();
                showGiftMessage(error.message || 'An error occurred while sending the gift.', 'error');
            })
            .finally(() => {
                confirmSendBtn.disabled = false;
                cancelSendBtn.disabled = false;
                confirmSendBtn.innerHTML = 'Confirm & Send';
            });
        });
    }

    function activateTab(selectedTab) {
        historyTabs.forEach(tab => {
            const targetId = tab.dataset.tabsTarget;
            const targetContent = document.querySelector(targetId);
            if (!targetContent) return;

            if (tab === selectedTab) {
                tab.setAttribute('aria-selected', 'true');
                targetContent.classList.remove('hidden');
            } else {
                tab.setAttribute('aria-selected', 'false');
                targetContent.classList.add('hidden');
            }
        });
        const activeContentId = selectedTab.dataset.tabsTarget;
        const activeContentList = document.querySelector(activeContentId + ' .history-list');
        checkAndDisplayNoActivity(activeContentList);
    }

    historyTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            activateTab(e.currentTarget);
        });
    });

    const initialTab = document.getElementById('all-tab');
    if(initialTab && initialTab.closest('#historyTabs-v3')) {
        activateTab(initialTab);
    } else if (historyTabs.length > 0) {
        activateTab(historyTabs[0]);
    }

    function createTransactionHtml(transaction) {
        let iconClass = 'fa-info-circle';
        let iconBgClass = 'bg-gray-100-v3 text-gray-500-v3';
        let mainText = transaction.transaction_type?.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) || 'Unknown Transaction';
        let amountTextClass = 'text-gray-700';
        let amountPrefix = '';
        let formattedAmount = 'N/A';
        let priceHtml = '';

        let dateText = 'Invalid Date';
        try {
            const date = new Date(transaction.transaction_date);
            if (!isNaN(date)) {
                dateText = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true });
            }
        } catch (e) { }

        if (typeof transaction.amount === 'number' && !isNaN(transaction.amount)) {
            formattedAmount = Math.abs(transaction.amount).toLocaleString('en-US');
        }

        switch (transaction.transaction_type) {
            case 'gift_sent':
                iconClass = 'fa-paper-plane'; iconBgClass = 'bg-negative-light-v3 text-negative-v3';
                mainText = `Sent to: ${transaction.recipient?.username || 'N/A'}`;
                amountTextClass = 'text-negative-v3'; amountPrefix = '- ';
                break;
            case 'gift_received':
                iconClass = 'fa-gift'; iconBgClass = 'bg-positive-light-v3 text-positive-v3';
                mainText = `Received from: ${transaction.sender?.username || 'N/A'}`;
                amountTextClass = 'text-positive-v3'; amountPrefix = '+ ';
                break;
            case 'purchase':
                iconClass = 'fa-shopping-cart'; iconBgClass = 'bg-theme-light-v3 text-theme-v3';
                mainText = transaction.pack_name || 'Coin Purchase';
                amountTextClass = 'text-positive-v3'; amountPrefix = '+ ';
                if (transaction.price && !isNaN(parseFloat(transaction.price))) {
                    priceHtml = `<span class="amount-currency">PKR ${parseFloat(transaction.price).toFixed(2)}</span>`;
                }
                break;
            case 'reward':
                 iconClass = 'fa-star'; iconBgClass = 'bg-amber-50-v3 text-amber-600-v3';
                 mainText = 'Reward Received';
                 amountTextClass = 'text-positive-v3'; amountPrefix = '+ ';
                 break;
            case 'spent':
                 iconClass = 'fa-arrow-down'; iconBgClass = 'bg-negative-light-v3 text-negative-v3';
                 mainText = 'Coins Spent';
                 amountTextClass = 'text-negative-v3'; amountPrefix = '- ';
                 break;
            case 'refund':
                 iconClass = 'fa-undo'; iconBgClass = 'bg-gray-100-v3 text-gray-500-v3';
                 mainText = 'Refund Processed';
                 amountTextClass = 'text-positive-v3'; amountPrefix = '+ ';
                 break;
        }

        return `
            <li class="transaction-item-v3">
                <div class="transaction-icon-v3 ${iconBgClass}">
                    <i class="fas fa-fw ${iconClass}"></i>
                </div>
                <div class="transaction-details-v3">
                    <p class="description truncate" title="${mainText}">${mainText}</p>
                    <p class="date">${dateText}</p>
                </div>
                <div class="transaction-amount-v3">
                    <span class="amount-value ${amountTextClass}">${amountPrefix}${formattedAmount}</span>
                    ${priceHtml}
                </div>
            </li>
        `;
    }

    function addTransactionToHistory(transaction, type) {
        const listSelector = `#${type} .history-list`;
        const listContainer = document.querySelector(listSelector);
        if (!listContainer) return;

        const noActivityMessage = listContainer.querySelector('.no-activity-message-v3');
        if (noActivityMessage) {
            noActivityMessage.remove();
        }

        const transactionHtml = createTransactionHtml(transaction);
        listContainer.insertAdjacentHTML('afterbegin', transactionHtml);
    }

    function checkAndDisplayNoActivity(listContainer) {
        if (!listContainer) return;
        const hasItems = listContainer.querySelector('.transaction-item-v3');
        let noActivityLi = listContainer.querySelector('.no-activity-message-v3');

        if (!hasItems && !noActivityLi) {
            let messageText = "No transactions in this category yet.";
            let iconClass = "fa-list-alt";
            const listId = listContainer.closest('[role="tabpanel"]')?.id;
             switch(listId) {
                case 'purchased': messageText = "No purchases recorded yet."; iconClass="fa-shopping-cart"; break;
                case 'received': messageText = "No received gifts recorded yet."; iconClass="fa-gift"; break;
                case 'sent': messageText = "No sent gifts recorded yet."; iconClass="fa-paper-plane"; break;
                case 'all': messageText = "No transactions recorded yet."; iconClass="fa-receipt"; break;
            }
            const noActivityHtml = `
                <li class="no-activity-message-v3">
                    <i class="fas ${iconClass}"></i>
                    <p>${messageText}</p>
                </li>`;
            listContainer.innerHTML = noActivityHtml;
        } else if (hasItems && noActivityLi) {
            noActivityLi.remove();
        }
    }

    document.querySelectorAll('.history-list').forEach(checkAndDisplayNoActivity);

    if (coinBalanceElement) {
        const endValueText = coinBalanceElement.textContent.trim();
        const endValue = parseInt(endValueText.replace(/,/g, ''), 10);
        if (!isNaN(endValue) && endValue >= 0) {
            coinBalanceElement.textContent = '0';
            setTimeout(() => {
                 animateValue(coinBalanceElement, 0, endValue, 1000);
            }, 50);
        } else {
             coinBalanceElement.textContent = '0';
        }
    }

});
</script>

{% endblock %}

{% extends 'Homepage.html' %}

{% load static %}
{% load humanize %}
{% load mathfilters %}
{% load i18n %}
{% load audio_filters %}

{% block title %}{{ audiobook_data_for_display.title|default:audiobook.title|default:"Audiobook" }} - Details{% endblock %}

{% block head_extra %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {# Added back Font Awesome for icons like stars, lock etc. if SVGs are not used everywhere #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    {# Stripe JS is now loaded in Homepage.html (base template) #}
    <style>
        /* Styles for tab navigation and active states */
        .tab-button.active {
            border-color: #DC2626; /* Tailwind red-600 */
            color: #DC2626; /* Tailwind red-600 */
            font-weight: 600;
        }
        .tab-button {
            border-color: transparent;
        }
        .chapter-item.playing { /* Style for currently playing chapter in the list */
            background-color: #FEE2E2; /* Tailwind red-100 */
            /* Consider using a more subtle playing indicator if border makes layout jump */
        }
        /* Custom styles for the player seek bar accent color */
        #player-seek-bar.accent-red-600::-webkit-slider-thumb {
            background-color: #DC2626; /* Tailwind red-600 */
        }
        #player-seek-bar.accent-red-600::-moz-range-thumb {
            background-color: #DC2626; /* Tailwind red-600 */
        }

        /* Star rating input styling (if still using Font Awesome for input) */
        .star-rating-input .fa-star:hover,
        .star-rating-input .fa-star.selected,
        .star-rating-input .fa-star.hovered {
            color: #FACC15; /* Tailwind yellow-400 */
        }
        .star-rating-input .fa-star {
            transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }

        .chapter-progress-bar-container {
            width: 100%;
            background-color: #e2e8f0; /* A light gray background */
            border-radius: 9999px;
            height: 6px;
            margin-top: 8px; /* Add some space above the bar */
            display: none; /* It will be hidden by default, JS will show it if there is progress */
        }
        .chapter-progress-bar-inner {
            height: 100%;
            width: 0%; /* JS will update this width */
            background-color: #DC2626; /* Using your theme's red color */
            border-radius: 9999px;
            transition: width 0.3s ease-out;
        }

        /* NEW: Chapter Unlock Styles */
        .chapter-unlock-section {
            margin-top: 12px;
            padding: 12px;
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border: 2px solid #F59E0B;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.1);
        }

        .chapter-unlock-btn {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
            font-size: 0.875rem;
        }

        .chapter-unlock-btn:hover {
            background: linear-gradient(135deg, #D97706 0%, #B45309 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }

        .chapter-unlock-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .chapter-already-unlocked {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            border: 2px solid #10B981;
        }

        /* Coin Purchase Styles */
        .coin-purchase-section {
            margin-top: 15px;
            padding: 16px;
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border: 2px solid #F59E0B;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.1);
        }

        .coin-purchase-btn {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
        }

        .coin-purchase-btn:hover {
            background: linear-gradient(135deg, #D97706 0%, #B45309 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }

        .coin-purchase-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .coin-balance-display {
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            color: #92400E;
            font-weight: 500;
        }

        .purchase-method-divider {
            display: flex;
            align-items: center;
            margin: 16px 0;
            color: #6B7280;
            font-size: 0.875rem;
        }

        .purchase-method-divider::before,
        .purchase-method-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #E5E7EB;
        }

        .purchase-method-divider span {
            padding: 0 12px;
            background: white;
        }

        .coin-insufficient {
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
            border: 2px solid #F87171;
        }

        .coin-already-purchased {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            border: 2px solid #10B981;
        }
    </style>
{% endblock %}

{% block content %}
{% csrf_token %}

<div class="bg-white min-h-screen font-sans antialiased text-[#09065E]">

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 pt-10 pb-16 md:pt-16 md:pb-20">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-x-8 gap-y-10 lg:gap-x-12 items-start">
            <div class="lg:col-span-4 xl:col-span-4">
                <div class="aspect-[3/4] w-full max-w-xs sm:max-w-sm mx-auto lg:max-w-none rounded-lg overflow-hidden border-2 border-[#09065E]/10 shadow-xl shadow-[#09065E]/10">
                    {% with current_book_display=audiobook_data_for_display|default:audiobook %}
                        {% if current_book_display.cover_image %}
                            {% if current_book_display.cover_image.url %} {# For DB FileField #}
                                <img id="main-cover-image"
                                     src="{{ current_book_display.cover_image.url }}"
                                     alt="{{ current_book_display.title }} Cover"
                                     class="w-full h-full object-cover">
                            {% else %} {# For external URL string #}
                                <img id="main-cover-image"
                                     src="{{ current_book_display.cover_image }}"
                                     alt="{{ current_book_display.title }} Cover"
                                     class="w-full h-full object-cover">
                            {% endif %}
                        {% else %}
                            <div id="main-cover-image" class="w-full h-full bg-[#09065E]/5 flex items-center justify-center text-center p-4">
                                <img src="https://placehold.co/375x500/09065E/FFFFFF?text={{ current_book_display.title|slice:':20'|urlencode|default:'No%20Cover' }}&font=sans"
                                     alt="{{ current_book_display.title }} - No Cover Available"
                                     class="w-full h-full object-contain">
                            </div>
                        {% endif %}
                    {% endwith %}
                </div>
            </div>

            <div class="lg:col-span-8 xl:col-span-8 flex flex-col space-y-6">
                {% with current_book_display=audiobook_data_for_display|default:audiobook %}
                    {% if current_book_display.genre %}
                    <span class="mb-1 inline-block bg-red-100 text-red-700 px-4 py-1.5 rounded-md text-xs font-semibold uppercase tracking-wider self-start">{{ current_book_display.genre }}</span>
                    {% endif %}

                    <h1 class="text-4xl sm:text-5xl font-bold text-[#09065E] leading-tight tracking-tight">
                        {{ current_book_display.title|default:"Untitled Audiobook" }}
                    </h1>

                    <div class="text-xl sm:text-2xl text-[#09065E]/70 font-medium">
                        {% if current_book_display.author %}
                            By <span class="hover:text-red-600 transition-colors duration-150">{{ current_book_display.author }}</span>
                        {% elif is_creator_book_page and current_book_display.creator.creator_name %}
                            By <span class="hover:text-red-600 transition-colors duration-150">{{ current_book_display.creator.creator_name }}</span>
                        {% else %}
                            By <span class="italic">Unknown Author</span>
                        {% endif %}
                        {% if current_book_display.narrator %}
                            <span class="block text-base sm:text-lg mt-1">Narrated by <span class="hover:text-red-600 transition-colors duration-150">{{ current_book_display.narrator }}</span></span>
                        {% endif %}
                    </div>
                {% endwith %}

                <div class="flex flex-wrap items-center gap-x-6 gap-y-3 text-sm text-[#09065E]/70">
    {% if audiobook.average_rating is not None and audiobook.average_rating > 0 %}
    <div class="flex items-center space-x-1.5">
        {% with rating_value=audiobook.average_rating|floatformat:0|add:"0" %}
            {% for i in "12345" %}
                <svg class="w-5 h-5 {% if i <= rating_value %}text-red-500{% else %}text-[#09065E]/20{% endif %}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
            {% endfor %}
        {% endwith %}
        <span class="text-[#09065E] font-semibold pt-px">{{ audiobook.average_rating|floatformat:1 }}</span>
        <span class="text-[#09065E]/60 pt-px">({{ reviews|length|default:0 }} review{{ reviews|length|pluralize }})</span>
    </div>
    {% else %}
    <div class="flex items-center space-x-1.5">
        {% for i in "12345" %}
            <svg class="w-5 h-5 text-[#09065E]/20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
            </svg>
        {% endfor %}
        <span class="ml-1.5 text-[#09065E]/60 pt-px">No ratings yet</span>
    </div>
    {% endif %}

    {% with current_book_display=audiobook_data_for_display|default:audiobook %}
        {% if current_book_display.language %}
        <span class="inline-flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5 text-[#09065E]/50" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 2a1 1 0 011 1v1h3a1 1 0 110 2H9.578a18.029 18.029 0 01-1.192 2.336A18.023 18.023 0 017.189 9.5L7 9.73V10a2 2 0 002 2v1a1 1 0 01-1 1H4a1 1 0 110-2h1.001A18.03 18.03 0 016.335 9.61 18.03 18.03 0 017.68 8.313l-.001-.001a17.94 17.94 0 011.085-.92l.001-.001L10 6.04l.005-.006a17.98 17.98 0 011.609-1.89 18.032 18.032 0 011.192-2.336H14V3a1 1 0 011-1h1a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
            <span class="pt-px">{{ current_book_display.language }}</span>
        </span>
        {% endif %}
        {% if current_book_display.source %}
        <span class="inline-flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5 text-[#09065E]/50" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z" /><path fill-rule="evenodd" d="M2 5a3 3 0 013-3h10a3 3 0 013 3v10a3 3 0 01-3 3H5a3 3 0 01-3-3V5zm3-1a1 1 0 00-1 1v10a1 1 0 001 1h10a1 1 0 001-1V5a1 1 0 00-1-1H5z" clip-rule="evenodd" /></svg>
            <span class="pt-px">Source: {{ current_book_display.get_source_display|default:current_book_display.source|capfirst }}</span>
        </span>
        {% endif %}
    {% endwith %}

    {% if audiobook.total_views is not None %}
    <span class="inline-flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5 text-[#09065E]/50" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
        <span class="pt-px">{{ audiobook.total_views|intcomma }} View{{ audiobook.total_views|pluralize }}</span>
    </span>
    {% endif %}

    {% if request.user.is_authenticated and audiobook and audiobook.audiobook_id %}
    <div x-data="{ open: false }" class="relative">
        <button @click="open = !open" class="inline-flex items-center text-[#09065E]/70 hover:text-red-600 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500/70 rounded-md">
            <i class="fas fa-flag mr-1.5"></i>
            <span class="pt-px">Report</span>
        </button>

        <div x-show="open"
             @click.outside="open = false"
             x-transition:enter="transition ease-out duration-100"
             x-transition:enter-start="transform opacity-0 scale-95"
             x-transition:enter-end="transform opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-75"
             x-transition:leave-start="transform opacity-100 scale-100"
             x-transition:leave-end="transform opacity-0 scale-95"
             class="absolute z-50 mt-2 w-72 -right-4 sm:right-0 bg-white rounded-lg shadow-2xl border border-slate-200 p-4"
             style="display: none;">
            
            <form action="{% url 'AudioXApp:submit_content_report' audiobook.audiobook_id %}" method="post">
                {% csrf_token %}
                <h4 class="font-semibold text-slate-800 mb-2 text-base">Report this Audiobook</h4>
                <div class="space-y-3">
                    <div>
                        <label for="reason" class="sr-only">Reason</label>
                        <select name="reason" id="reason" required class="mt-1 block w-full pl-3 pr-10 py-2 text-sm border-slate-300 focus:outline-none focus:ring-red-500 focus:border-red-500 rounded-md">
                            <option value="" disabled selected>Select a reason...</option>
                            <option value="HATE_SPEECH">Hate Speech</option>
                            <option value="ABUSIVE_CONTENT">Abusive or Harassing</option>
                            <option value="VIOLENT_CONTENT">Violent or Graphic Content</option>
                            <option value="COPYRIGHT_INFRINGEMENT">Copyright Infringement</option>
                            <option value="MISINFORMATION">Misinformation or Spam</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="details" class="sr-only">Additional Details</label>
                        <textarea name="details" id="details" rows="3" class="mt-1 block w-full p-2 text-sm border border-slate-300 rounded-md shadow-sm" placeholder="Additional details (optional)"></textarea>
                    </div>
                    <div>
                        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md text-sm">Submit Report</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

</div>

                <div class="text-[#09065E]/80 leading-relaxed line-clamp-3 sm:line-clamp-4 selection:bg-red-200 selection:text-red-800">
                    {{ audiobook_data_for_display.description|striptags|safe|default:"No description available for this audiobook." }}
                </div>

                {% with current_book_display=audiobook_data_for_display|default:audiobook %}
                    {% if is_creator_book_page and current_book_display.is_paid %}
                        <div class="mt-5 p-4 bg-red-50 border border-red-200 rounded-lg shadow-sm space-y-3">
                            <h3 class="text-lg font-semibold text-red-700">Premium Audiobook</h3>
                            <p class="text-sm text-red-600">Price: <span class="font-bold">PKR {{ current_book_display.price|floatformat:2 }}</span></p>
                            {% if user.is_authenticated %}
                                {% if user_has_purchased %}
                                    <div class="bg-green-100 border border-green-300 text-green-700 px-4 py-2.5 rounded-md text-sm font-medium text-center" role="alert">
                                        <i class="fas fa-check-circle mr-1.5"></i> Purchased & Unlocked
                                    </div>
                                {% else %}
                                    <div class="coin-purchase-section" id="coinPurchaseSection">
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="text-base font-semibold text-amber-800 flex items-center">
                                                <i class="fas fa-coins mr-2 text-amber-600"></i>
                                                Pay with Coins
                                            </h4>
                                            <div class="coin-balance-display" id="coinBalanceDisplay">
                                                Your balance: <span id="userCoinBalance">{{ user.coins|default:0 }}</span> coins
                                            </div>
                                        </div>
                                        
                                        <button id="coinPurchaseBtn" class="coin-purchase-btn w-full">
                                            <i class="fas fa-coins mr-2"></i>
                                            Purchase with <span id="coinsRequired">{{ current_book_display.price|floatformat:0 }}</span> Coins
                                        </button>
                                        
                                        <div id="coinPurchaseStatus" class="mt-3 text-sm"></div>
                                    </div>

                                    <div class="purchase-method-divider" id="purchaseMethodDivider">
                                        <span>or</span>
                                    </div>

                                    <button id="purchase-button"
                                            data-audiobook-slug="{{ current_book_display.slug }}"
                                            class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500/70 disabled:opacity-60 disabled:cursor-not-allowed transition-all duration-300 ease-in-out transform hover:-translate-y-0.5 active:translate-y-0">
                                        <i class="fas fa-shopping-cart mr-2"></i> Purchase with Card (PKR {{ current_book_display.price|floatformat:2 }})
                                    </button>
                                    <p class="text-xs text-center text-red-500 mt-1.5">Secure payment via Stripe.</p>
                                {% endif %}
                            {% else %}
                                <div class="bg-yellow-50 border border-yellow-300 text-yellow-700 px-4 py-2.5 rounded-md text-sm text-center">
                                    <a href="{% url 'AudioXApp:login' %}?next={{ request.path|urlencode }}" class="font-semibold hover:underline text-red-600">Log in</a> or
                                    <a href="{% url 'AudioXApp:signup' %}?next={{ request.path|urlencode }}" class="font-semibold hover:underline text-red-600">Sign up</a> to purchase.
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endwith %}

                <div class="mt-auto pt-5 flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3.5">
                    <button id="play-first-chapter-btn" class="w-full sm:w-auto flex items-center justify-center space-x-3 px-8 py-3.5 border-2 border-[#091e65] text-[#091e65] rounded-lg shadow-lg hover:bg-[#091e65] hover:text-white transition-all duration-200 ease-in-out text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#091e65]/70">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z" /></svg>
                        <span>Play First Episode</span>
                    </button>
                    <div class="flex items-center space-x-2 sm:space-x-3">
                        <button id="add-to-library-button" data-audiobook-id="{{ audiobook.audiobook_id|default:''|escapejs }}" class="w-full sm:w-auto flex items-center justify-center space-x-2.5 px-7 py-3.5 text-white rounded-lg shadow-md transition-all duration-150 ease-in-out text-base font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 {% if is_in_library %}bg-[#091e65] hover:bg-opacity-90 focus:ring-[#091e65]/70{% else %}bg-red-600 hover:bg-red-700 focus:ring-red-600/70{% endif %}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>
                            <span id="add-to-library-text">{% if is_in_library %}In Library{% else %}Add to Library{% endif %}</span>
                        </button>
                        <button id="download-full-audiobook-btn" data-audiobook-id="{{ audiobook.audiobook_id|default:''|escapejs }}" class="w-full sm:w-auto flex items-center justify-center space-x-2 px-5 py-3 border border-[#09065E]/40 text-[#09065E]/90 rounded-lg hover:bg-[#09065E]/5 hover:border-[#09065E]/60 transition-all duration-150 ease-in-out text-sm font-medium focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-[#09065E]/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            <span id="download-full-audiobook-text">Download All</span>
                        </button>
                        <button id="share-button" title="Share Audiobook" class="p-3 border border-[#09065E]/40 text-[#09065E]/90 rounded-lg hover:bg-[#09065E]/5 hover:border-[#09065E]/60 transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-[#09065E]/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg>
                        </button>
                    </div>
                </div>
                <div id="download-status-messages" class="text-xs text-[#09065E]/70 mt-2 min-h-[1rem]"></div>
                <div id="overall-download-progress-bar-container" class="w-full bg-[#09065E]/10 rounded-full h-2 mt-1.5 hidden">
                    <div id="overall-download-progress-bar" class="bg-red-600 h-2 rounded-full transition-all duration-300 ease-linear" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b-2 border-[#09065E]/10">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex space-x-1 sm:space-x-2 justify-start md:justify-center overflow-x-auto -mb-px">
                <button onclick="showTab('about')" id="tab-about" class="tab-button whitespace-nowrap py-4 px-4 sm:px-6 border-b-2 font-semibold text-base text-red-600 border-red-600" aria-current="page">ABOUT</button>
                <button onclick="showTab('episodes')" id="tab-episodes" class="tab-button whitespace-nowrap py-4 px-4 sm:px-6 border-b-2 font-medium text-base text-[#09065E]/60 hover:text-red-600 hover:border-red-500/80 border-transparent transition-colors duration-150">EPISODES & CHAT ({{ chapters_to_display|length|default:"0" }})</button>
                <button onclick="showTab('reviews')" id="tab-reviews" class="tab-button whitespace-nowrap py-4 px-4 sm:px-6 border-b-2 font-medium text-base text-[#09065E]/60 hover:text-red-600 hover:border-red-500/80 border-transparent transition-colors duration-150">REVIEWS (<span id="review-count-tab">{{ reviews|length|default:0 }}</span>)</button>
                <button onclick="showTab('recommendations')" id="tab-recommendations" class="tab-button whitespace-nowrap py-4 px-4 sm:px-6 border-b-2 font-medium text-base text-[#09065E]/60 hover:text-red-600 hover:border-red-500/80 border-transparent transition-colors duration-150">YOU MIGHT LIKE</button>
                <button onclick="showTab('summaries')" id="tab-summaries" data-audiobook-id="{{ audiobook.audiobook_id|default:''|escapejs }}" class="tab-button whitespace-nowrap py-4 px-4 sm:px-6 border-b-2 font-medium text-base text-[#09065E]/60 hover:text-red-600 hover:border-red-500/80 border-transparent transition-colors duration-150">AI SUMMARY</button>
            </nav>
        </div>
    </div>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-16">
        <div class="bg-white p-6 sm:p-8 md:p-10 rounded-xl shadow-2xl shadow-[#09065E]/10 border border-[#09065E]/10 min-h-[450px]">
            
            <div id="content-about" class="tab-content">
                <h3 class="text-2xl md:text-3xl font-semibold text-[#09065E] mb-6 tracking-tight">About This Audiobook</h3>
                {% with current_book_display=audiobook_data_for_display|default:audiobook %}
                <div class="prose prose-base max-w-none text-[#09065E]/80 leading-relaxed space-y-4 selection:bg-red-200 selection:text-red-800 prose-headings:font-semibold prose-headings:text-[#09065E] prose-p:text-[#09065E]/80 prose-strong:text-[#09065E] prose-a:text-red-600 hover:prose-a:text-red-700 hover:prose-a:underline">
                    {{ current_book_display.description|safe|default:"<p>No detailed description available for this audiobook.</p>" }}
                </div>
                {% endwith %}
            </div>

            <div id="content-episodes" class="tab-content hidden">
                <h3 class="text-2xl md:text-3xl font-semibold text-[#09065E] mb-8 tracking-tight">Episodes & Community Chat</h3>

                {% with current_book_display=audiobook_data_for_display|default:audiobook %}
                {% if is_creator_book_page and current_book_display.is_paid and not user_has_purchased and audiobook_lock_message %}
                    <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-lg text-sm flex items-center space-x-2 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                        <span>{{ audiobook_lock_message }}</span>
                    </div>
                {% endif %}
                {% endwith %}

                <div id="chapter-clip-editor-area" class="hidden mb-10 p-5 sm:p-6 bg-red-50 border border-dashed border-red-400/70 rounded-xl">
                    <div class="flex justify-between items-center mb-5">
                        <h4 class="text-xl font-semibold text-[#09065E]">Create Clip: <span id="clip-editor-chapter-title" class="text-red-700"></span></h4>
                        <button id="close-clip-editor-btn" class="text-[#09065E]/60 hover:text-red-600 p-1.5 rounded-full hover:bg-red-200/70 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    <audio id="clip-editor-player" controls class="w-full h-12 mb-5 rounded-md accent-red-600"></audio>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-5 gap-y-4 mb-5 items-end">
                        <div>
                            <button id="set-start-time-btn" class="w-full text-sm py-2.5 px-4 bg-[#09065E] hover:bg-[#09065E]/90 text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#09065E]/70 focus:ring-offset-1 transition-colors duration-150">Set Start</button>
                            <p class="text-sm text-[#09065E]/80 mt-2">Start: <span id="clip-editor-start-time-display" class="font-mono bg-[#09065E]/10 text-[#09065E] py-1 px-2 rounded text-xs">0:00</span></p>
                        </div>
                        <div>
                            <button id="set-end-time-btn" class="w-full text-sm py-2.5 px-4 bg-[#09065E] hover:bg-[#09065E]/90 text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#09065E]/70 focus:ring-offset-1 transition-colors duration-150">Set End</button>
                            <p class="text-sm text-[#09065E]/80 mt-2">End: <span id="clip-editor-end-time-display" class="font-mono bg-[#09065E]/10 text-[#09065E] py-1 px-2 rounded text-xs">0:00</span></p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <button id="generate-clip-btn-inline" class="w-full text-base font-medium py-3 px-5 bg-red-600 hover:bg-red-700 text-white rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-red-600/70 focus:ring-offset-1 transition-colors duration-150 disabled:opacity-70">
                            <span class="generate-text-inline">Generate Clip</span>
                            <span class="generating-text-inline hidden items-center justify-center">
                                <svg class="animate-spin -ml-1 mr-2.5 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Generating...
                            </span>
                        </button>
                    </div>
                    <div id="clip-editor-status" class="text-sm text-center text-[#09065E]/70 min-h-[1.75em] py-1"></div>
                    <div id="generated-clip-area-inline" class="hidden mt-4 p-4 bg-white rounded-lg border-2 border-[#09065E]/20 shadow-sm">
                        <h5 class="text-md font-semibold text-[#09065E] mb-2.5">Your Generated Clip:</h5>
                        <audio id="generated-clip-player-inline" controls class="w-full mb-3.5 h-11 rounded-md accent-red-600"></audio>
                        <div class="flex flex-col sm:flex-row gap-2.5">
                            <a id="download-generated-clip-link-inline" href="#" download="audio_clip.mp3" class="flex-1 text-center text-sm py-2.5 px-4 bg-[#09065E] text-white rounded-md hover:bg-[#09065E]/90 transition-colors duration-150 font-medium">Download Clip</a>
                            <button id="share-generated-clip-btn-inline" class="flex-1 text-sm py-2.5 px-4 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-150 font-medium">Share Clip</button>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-5">
                    {% if chapters_to_display %}
                        {% for chapter_display_item in chapters_to_display %}
                        <div class="chapter-container bg-white p-4 sm:p-5 rounded-lg border border-[#09065E]/20 hover:border-[#09065E]/30 shadow-lg hover:shadow-xl shadow-[#09065E]/[0.07] hover:shadow-[#09065E]/10 transition-all duration-200 ease-in-out">
                            <div class="chapter-item flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 group"
                                 data-chapter-title="{{ chapter_display_item.chapter_title|escapejs|default:"Untitled Episode" }}"
                                 data-chapter-index="{{ chapter_display_item.chapter_index }}"
                                 data-chapter-id="{{ chapter_display_item.chapter_id|default:'' }}"
                                 data-audio-url-template="{{ chapter_display_item.audio_url_template|default:'' }}"
                                 data-is-accessible="{{ chapter_display_item.is_accessible|yesno:'true,false' }}"
                                 data-lock-reason="{{ chapter_display_item.lock_reason|default:'' }}"
                                 data-duration-seconds="{{ chapter_display_item.duration_seconds|default:0 }}">
                                
                                <div class="flex items-center space-x-4 flex-grow min-w-0">
                                    <div class="flex-shrink-0">
                                        {% if chapter_display_item.is_accessible %}
                                        <button onclick="playChapter(this)" title="Play Episode {{ forloop.counter }}"
                                                class="play-button flex items-center justify-center w-12 h-12 bg-red-100 hover:bg-red-200 text-red-700 rounded-full transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                            <svg class="w-6 h-6 play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z" /></svg> 
                                            <svg class="w-6 h-6 pause-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.75 4.75a.75.75 0 00-1.5 0v10.5a.75.75 0 001.5 0V4.75zM15.75 4.75a.75.75 0 00-1.5 0v10.5a.75.75 0 001.5 0V4.75z" /></svg>
                                            <svg class="w-6 h-6 loading-icon hidden animate-spin text-red-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                        </button>
                                        {% else %}
                                        <div title="Episode locked" class="flex items-center justify-center w-12 h-12 bg-[#09065E]/10 text-[#09065E]/40 rounded-full cursor-not-allowed">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="flex-grow min-w-0">
                                        <p class="text-lg font-semibold {% if chapter_display_item.is_accessible %}text-[#09065E] group-hover:text-red-700{% else %}text-[#09065E]/50{% endif %} transition-colors duration-150 truncate" title="{{ chapter_display_item.chapter_title|default:"Untitled Episode" }}">
                                            <span class="text-base {% if chapter_display_item.is_accessible %}text-[#09065E]/60{% else %}text-[#09065E]/40{% endif %} mr-1.5">{{ forloop.counter }}.</span> {{ chapter_display_item.chapter_title|default:"Untitled Episode" }}
                                        </p>
                                        <p class="text-sm {% if chapter_display_item.is_accessible %}text-[#09065E]/70{% else %}text-[#09065E]/50{% endif %} font-mono mt-1">
                                            Duration: {{ chapter_display_item.duration_seconds|format_duration }}
                                        </p>
                                        <div class="chapter-progress-bar-container">
                                            <div class="chapter-progress-bar-inner"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-2 sm:space-x-2.5 flex-shrink-0 mt-3 sm:mt-0 self-start sm:self-center">
                                    {% if chapter_display_item.is_accessible %}
                                    <div class="relative chapter-download-container flex flex-col items-center">
                                        <button 
                                            class="download-chapter-btn p-2.5 rounded-full text-[#09065E]/70 hover:text-red-600 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-red-500/70 hover:bg-red-100 transition-all duration-150"
                                            title="Download Episode {{ forloop.counter }}"
                                            data-chapter-unique-id="{{ audiobook.slug|default:audiobook.audiobook_id|default:'defaultaudiobook' }}_{{ chapter_display_item.chapter_id|default:chapter_display_item.chapter_index }}"
                                            data-chapter-id="{{ chapter_display_item.chapter_id|default:'' }}"
                                            data-chapter-index="{{ chapter_display_item.chapter_index }}"
                                            data-audiobook-slug="{{ audiobook.slug|default:audiobook.audiobook_id|default:'' }}"
                                            >
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 download-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 downloaded-icon hidden text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                            <svg class="h-5 w-5 downloading-icon hidden animate-spin text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                        </button>
                                        <span class="chapter-download-status text-xs text-[#09065E]/60 mt-0.5 whitespace-nowrap min-h-[1em]"></span>
                                    </div>
                                    {% else %}
                                    <div class="p-2 w-10 h-10"></div> {# Spacer to align with accessible items #}
                                    {% endif %}

                                    {% if chapter_display_item.is_accessible %}
                                    <div class="relative chapter-clip-container flex flex-col items-center">
                                        <button
                                            class="clip-chapter-btn p-2.5 rounded-full text-[#09065E]/70 hover:text-red-600 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-red-500/70 hover:bg-red-100 transition-all duration-150"
                                            title="Create Clip for Episode {{ forloop.counter }}"
                                            data-chapter-id="{{ chapter_display_item.chapter_id|default:'' }}"
                                            data-chapter-index="{{ chapter_display_item.chapter_index }}"
                                            data-chapter-title="{{ chapter_display_item.chapter_title|escapejs|default:'Untitled Episode' }}"
                                            data-chapter-duration="{{ chapter_display_item.duration_seconds|default:0 }}"
                                            data-audio-url-template="{{ chapter_display_item.audio_url_template|default:'' }}" 
                                            >
                                            <svg class="h-5 w-5 clip-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M7.25 3.25A2.25 2.25 0 005 5.5v1.75A2.25 2.25 0 002.75 9.5h-.5a.75.75 0 000 1.5H4a.75.75 0 000-1.5H2.75A.75.75 0 013.5 8.75V5.5a.75.75 0 01.75-.75h10.5a.75.75 0 01.75.75v3.25A.75.75 0 0114.5 9.5H14a.75.75 0 000 1.5h1.25a2.25 2.25 0 002.25-2.25V5.5a2.25 2.25 0 00-2.25-2.25H7.25z"/>
                                                <path fill-rule="evenodd" d="M6.5 6.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5zM15 6.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5zM7.5 14a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM12.5 14a2.5 2.5 0 100-5 2.5 2.5 0 000 5z" clip-rule="evenodd"/>
                                            </svg>
                                        </button>
                                        <span class="chapter-clip-status text-xs text-[#09065E]/60 mt-0.5 whitespace-nowrap min-h-[1em]"></span>
                                    </div>
                                    {% else %}
                                    <div class="p-2 w-10 h-10"></div> {# Spacer #}
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if not chapter_display_item.is_accessible and user.is_authenticated and chapter_display_item.lock_reason == 'coin_unlock_available' %}
                                <div class="chapter-unlock-section" id="unlock-section-{{ chapter_display_item.chapter_id }}">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-sm font-semibold text-amber-800 flex items-center">
                                            <i class="fas fa-coins mr-2 text-amber-600"></i>
                                            Unlock this Chapter
                                        </h4>
                                        <div class="text-xs bg-white/80 px-2 py-1 rounded text-amber-800">
                                            Your balance: <span id="user-coins-{{ chapter_display_item.chapter_id }}">{{ user.coins|default:0 }}</span> coins
                                        </div>
                                    </div>
                                    
                                    <p class="text-xs text-amber-700 mb-3">
                                        Unlock "{{ chapter_display_item.chapter_title }}" for {{ chapter_display_item.unlock_cost }} coins and listen anytime!
                                    </p>
                                    
                                    <button onclick="unlockChapterWithCoins('{{ chapter_display_item.chapter_id }}')" 
                                            class="chapter-unlock-btn w-full"
                                            id="unlock-btn-{{ chapter_display_item.chapter_id }}"
                                            data-unlock-cost="{{ chapter_display_item.unlock_cost }}"
                                            {% if user.coins|default:0 < chapter_display_item.unlock_cost %}disabled{% endif %}>
                                        <i class="fas fa-unlock mr-2"></i>
                                        {% if user.coins|default:0 >= chapter_display_item.unlock_cost %}
                                            Unlock for {{ chapter_display_item.unlock_cost }} Coins
                                        {% else %}
                                            Need {{ chapter_display_item.unlock_cost|sub:user.coins|default:0 }} more coins
                                        {% endif %}
                                    </button>
                                    
                                    {% if user.coins|default:0 < chapter_display_item.unlock_cost %}
                                    <p class="text-xs text-center mt-2 text-amber-700">
                                        <a href="{% url 'AudioXApp:buycoins' %}" class="font-bold underline hover:text-amber-800">Buy more coins</a> to unlock this chapter
                                    </p>
                                    {% endif %}
                                    
                                    <div id="unlock-status-{{ chapter_display_item.chapter_id }}" class="mt-2 text-sm"></div>
                                </div>
                            {% endif %}
                            
                            <div id="review-form-{{ chapter_display_item.chapter_id|default:forloop.counter }}" class="chapter-review-section hidden mt-5 pt-5 border-t-2 border-[#09065E]/10">
                                <h4 class="text-lg font-semibold text-[#09065E]/90 mb-4">Community Chat for: <span class="text-red-700">{{ chapter_display_item.chapter_title|default:"Untitled Episode" }}</span></h4>
                                <div class="chat-messages-list max-h-72 overflow-y-auto space-y-4 mb-4 pr-2.5 mt-2">
                                    <div class="flex items-start space-x-3.5 text-sm">
                                        <img src="https://placehold.co/40x40/09065E/FFFFFF?text=U1&font=sans" alt="User 1" class="w-10 h-10 rounded-full flex-shrink-0 border-2 border-white shadow-sm">
                                        <div class="flex-1">
                                            <p class="font-semibold text-[#09065E]">User One <span class="text-xs text-[#09065E]/50 font-normal ml-2">2 mins ago</span></p>
                                            <p class="text-[#09065E]/90 bg-[#09065E]/5 p-3 rounded-lg rounded-tl-none mt-1.5 shadow-sm">This part was absolutely amazing! Really captured the essence.</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start space-x-3.5 text-sm">
                                        <img src="https://placehold.co/40x40/DD2C00/FFFFFF?text=U2&font=sans" alt="User 2" class="w-10 h-10 rounded-full flex-shrink-0 border-2 border-white shadow-sm">
                                        <div class="flex-1">
                                            <p class="font-semibold text-red-700">User Two <span class="text-xs text-[#09065E]/50 font-normal ml-2">1 min ago</span></p>
                                            <p class="text-[#09065E]/90 bg-red-50 p-3 rounded-lg rounded-tl-none mt-1.5 shadow-sm">I agree! The narration here was top-notch.</p>
                                        </div>
                                    </div>
                                </div>
                                {% if user.is_authenticated %}
                                <form class="chat-input-form flex items-center space-x-3 mt-3" data-chapter-id-chat="{{ chapter_display_item.chapter_id|default:'' }}">
                                    <textarea rows="1" class="flex-grow p-3 border-2 border-[#09065E]/20 rounded-lg shadow-sm focus:ring-2 focus:ring-red-500/70 focus:border-red-500/70 text-sm text-[#09065E] placeholder-[#09065E]/50 resize-none transition-colors duration-150" placeholder="Share your thoughts on this episode..."></textarea>
                                    <button type="submit" class="p-3 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-600/70 flex-shrink-0 transition-colors duration-150">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 16.571V11.5a1 1 0 011-1h.094a1 1 0 01.803.424l4.25 5.5a1 1 0 001.6-.25L17.894 3.962a1 1 0 00-.999-1.409l-7 .001z" /></svg>
                                    </button>
                                </form>
                                {% else %}
                                <p class="text-sm text-[#09065E]/70 text-center py-3 mt-3 bg-[#09065E]/5 rounded-lg border border-[#09065E]/10">
                                    <a href="{% url 'AudioXApp:login' %}?next={{ request.path|urlencode }}#content-episodes" class="font-semibold text-red-600 hover:underline">Log in</a> or <a href="{% url 'AudioXApp:signup' %}?next={{ request.path|urlencode }}#content-episodes" class="font-semibold text-red-600 hover:underline">Sign up</a> to join the chat.
                                </p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-[#09065E]/70 py-12">
                            <svg class="mx-auto h-12 w-12 text-[#09065E]/30 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p class="text-lg font-medium">No episodes available for this audiobook yet.</p>
                            <p class="text-sm text-[#09065E]/60 mt-1">Please check back later.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div id="content-reviews" class="tab-content hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 pb-6 border-b-2 border-[#09065E]/10">
                    <h3 class="text-2xl md:text-3xl font-semibold text-[#09065E] mb-3 md:mb-0 tracking-tight">Listener Reviews (<span id="review-count">{{ reviews|length|default:0 }}</span>)</h3>
                    <div class="flex items-center text-sm space-x-1.5">
                        {% with overall_rating_value=audiobook.average_rating %}
                            {% if overall_rating_value is not None and overall_rating_value > 0 %}
                                {% with overall_full_stars=overall_rating_value|floatformat:0|add:"0" %}
                                    {% for i_star in "12345" %}
                                    <svg class="w-5 h-5 {% if i_star <= overall_full_stars %}text-red-500{% else %}text-[#09065E]/20{% endif %}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                    {% endfor %}
                                {% endwith %}
                                <span class="font-semibold text-[#09065E] ml-1 pt-px">{{ overall_rating_value|floatformat:1 }} average rating</span>
                            {% else %}
                                <span class="text-[#09065E]/70 italic pt-px">No average rating yet.</span>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>

                {% if user.is_authenticated %}
                    {% if can_user_review %}
                        <form id="review-form" class="mb-10 p-6 border-2 border-dashed border-red-400/60 rounded-xl bg-red-50 {% if current_user_has_reviewed %}hidden{% endif %}" data-add-url="{% url 'AudioXApp:add_review' audiobook_slug=audiobook.slug %}">
                            {% csrf_token %}
                            <h4 class="text-xl font-semibold text-[#09065E] mb-2">Share Your Thoughts</h4>
                            <p class="text-sm text-[#09065E]/70 mb-6">Help others discover this audiobook by leaving your review.</p>
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-[#09065E]/90 mb-2">Your Rating <span class="text-red-600">*</span></label>
                                <div id="review-rating-input" class="flex items-center space-x-1.5 cursor-pointer text-[#09065E]/30">
                                    {% for i_star_val in "12345" %}
                                    <svg class="w-9 h-9 star-input-icon hover:text-red-400 transition-colors duration-150" data-rating-value="{{ i_star_val }}" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                    </svg>
                                    {% endfor %}
                                </div>
                                <input type="hidden" name="rating" id="rating-value-input" value="0" required>
                                <div id="rating-error" class="text-red-600 text-xs mt-2 h-4"></div>
                            </div>
                            <div class="mb-6">
                                <label for="comment-input" class="block text-sm font-medium text-[#09065E]/90 mb-2">Your Comment (Optional)</label>
                                <textarea name="comment" id="comment-input" rows="5" class="w-full px-4 py-3 border-2 border-[#09065E]/20 rounded-lg shadow-sm focus:ring-2 focus:ring-red-500/70 focus:border-red-500/70 sm:text-sm text-[#09065E] placeholder-[#09065E]/50 transition-colors duration-150" placeholder="What did you think about this audiobook?"></textarea>
                            </div>
                            <div class="flex justify-end items-center space-x-4">
                                <div id="form-message" class="text-sm flex-grow text-[#09065E]/80"></div>
                                <button type="submit" id="submit-review-btn" class="inline-flex items-center px-7 py-3 bg-[#09065E] border border-transparent rounded-lg shadow-md text-base font-semibold text-white hover:bg-[#09065E]/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#09065E]/70 disabled:opacity-70 transition-all duration-150">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2.5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 16.571V11.5a1 1 0 011-1h.094a1 1 0 01.803.424l4.25 5.5a1 1 0 001.6-.25L17.894 3.962a1 1 0 00-.999-1.409l-7 .001z" /></svg>
                                    Submit Review
                                </button>
                            </div>
                        </form>
                    {% else %}
                        <div class="mb-6 p-4 bg-gray-100 border border-gray-200 text-gray-700 rounded-lg text-sm text-center shadow-sm">
                            <i class="fas fa-lock mr-2 text-gray-500"></i> Purchase this audiobook to leave a review.
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-md text-[#09065E]/80 mb-8 bg-[#09065E]/5 p-5 rounded-xl border-2 border-[#09065E]/10 shadow-sm text-center">
                        <a href="{% url 'AudioXApp:login' %}?next={{ request.path|urlencode }}#content-reviews" class="font-semibold text-red-600 hover:underline">Log in</a> or <a href="{% url 'AudioXApp:signup' %}?next={{ request.path|urlencode }}#content-reviews" class="font-semibold text-red-600 hover:underline">Sign up</a> to leave a review.
                    </p>
                {% endif %}
                <div id="edit-review-prompt" class="mb-8 text-center p-5 bg-[#09065E]/5 rounded-xl border-2 border-[#09065E]/10 {% if not current_user_has_reviewed %}hidden{% endif %}">
                    <p class="text-md text-[#09065E]/80 mb-2.5">You've already reviewed this audiobook.</p>
                    {% if user_review_object %}
                    <p class="text-sm text-[#09065E]/70 mb-2 flex items-center justify-center space-x-1">Your rating:
                        {% with rating_value=user_review_object.rating %}
                            {% for i in ""|center:rating_value %}<svg class="w-4 h-4 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>{% endfor %}{% with empty_stars_count=5|sub:rating_value %}{% for i in ""|center:empty_stars_count %}<svg class="w-4 h-4 text-[#09065E]/20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>{% endfor %}{% endwith %}
                        {% endwith %}
                    </p>
                    {% if user_review_object.comment %}
                    <p class="text-sm text-[#09065E]/60 mb-3 italic">"{{ user_review_object.comment|truncatewords:20 }}"</p>
                    {% endif %}
                    {% endif %}
                    <button id="edit-my-review-button" class="text-sm font-semibold text-red-600 hover:text-red-700 hover:underline focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500/70 rounded px-2 py-1 transition-colors duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1.5 align-text-bottom" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>Edit Your Review
                    </button>
                </div>

                <h4 class="text-xl md:text-2xl font-semibold text-[#09065E]/90 mb-6 mt-10 pt-8 border-t-2 border-[#09065E]/10 tracking-tight">What Listeners Are Saying</h4>
                <div id="reviews-list" class="space-y-8">
                    {% if reviews %}
                        {% for review_item in reviews %}
                        <article class="review-item flex space-x-4 sm:space-x-5 p-5 sm:p-6 bg-white rounded-xl border border-[#09065E]/20 shadow-lg shadow-[#09065E]/[0.07]" id="review-{{ review_item.review_id }}">
                            <div class="flex-shrink-0 pt-1">
                                {% if review_item.user.profile_pic %}
                                    <img class="h-12 w-12 sm:h-14 sm:w-14 rounded-full object-cover border-2 border-white shadow-md" src="{{ review_item.user.profile_pic.url }}" alt="{{ review_item.user.username }}">
                                {% else %}
                                    <span class="h-12 w-12 sm:h-14 sm:w-14 rounded-full bg-[#09065E]/10 flex items-center justify-center text-[#09065E]/50 border-2 border-white shadow-md">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                    </span>
                                {% endif %}
                            </div>
                            <div class="flex-grow">
                                <div class="flex items-baseline justify-between mb-1.5">
                                    <h5 class="text-lg font-semibold text-[#09065E]">{{ review_item.user.full_name|default:review_item.user.username }}</h5>
                                    <time datetime="{{ review_item.created_at|date:"c" }}" class="flex-shrink-0 ml-4 text-xs text-[#09065E]/60">{{ review_item.created_at|timesince }} ago</time>
                                </div>
                                <div class="mb-2.5 flex items-center text-xs space-x-0.5">
                                    {% with rating_value=review_item.rating %}
                                        {% for i in ""|center:rating_value %}<svg class="w-4 h-4 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>{% endfor %}{% with empty_stars_count=5|sub:rating_value %}{% for i in ""|center:empty_stars_count %}<svg class="w-4 h-4 text-[#09065E]/20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>{% endfor %}{% endwith %}
                                    {% endwith %}
                                </div>
                                {% if review_item.comment %}
                                <div class="text-sm text-[#09065E]/80 prose prose-sm max-w-none leading-relaxed selection:bg-red-200 selection:text-red-800 prose-p:text-[#09065E]/80">
                                    <p>{{ review_item.comment|linebreaksbr }}</p>
                                </div>
                                {% endif %}
                                {% if review_item.user == request.user %}
                                <div class="mt-4 text-xs">
                                    <button data-review-id="{{ review_item.review_id }}"
                                            data-rating="{{ review_item.rating }}"
                                            data-comment="{{ review_item.comment|default:''|escapejs }}"
                                            class="edit-user-review-button text-red-600 hover:text-red-700 hover:underline font-semibold focus:outline-none focus:ring-1 focus:ring-offset-1 focus:ring-red-500/70 rounded px-1.5 py-0.5 transition-colors duration-150">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 inline mr-1 align-text-bottom" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>Edit
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </article>
                        {% endfor %}
                    {% else %}
                        <div id="no-reviews-message" class="text-center text-[#09065E]/70 py-12">
                             <svg class="mx-auto h-12 w-12 text-[#09065E]/30 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                            </svg>
                            <p class="text-lg font-medium">No reviews yet for this audiobook.</p>
                            <p class="text-sm text-[#09065E]/60 mt-1">Be the first to share your thoughts!</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div id="content-recommendations" class="tab-content hidden">
                <h3 class="text-2xl md:text-3xl font-semibold text-[#09065E] mb-8 tracking-tight">Similar Audiobooks You Might Like</h3>
                {% if recommended_audiobooks %}
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-x-6 gap-y-10">
                        {% for rec_book in recommended_audiobooks %}
                        <a href="{% url 'AudioXApp:audiobook_detail' audiobook_slug=rec_book.slug %}" class="group block transition-all duration-200 ease-in-out hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-4 rounded-lg">
                            <div class="aspect-[3/4] rounded-lg shadow-xl shadow-[#09065E]/10 overflow-hidden border border-[#09065E]/10 group-hover:border-red-500/50 group-hover:shadow-2xl group-hover:shadow-red-500/10 transition-all duration-200 ease-in-out">
                                {% if rec_book.cover_image %}
                                    {% if rec_book.cover_image.url %}
                                        <img src="{{ rec_book.cover_image.url }}" alt="{{ rec_book.title }} Cover" class="w-full h-full object-cover">
                                    {% else %}
                                        <img src="{{ rec_book.cover_image }}" alt="{{ rec_book.title }} Cover" class="w-full h-full object-cover">
                                    {% endif %}
                                {% else %}
                                    <div class="w-full h-full bg-[#09065E]/5 flex items-center justify-center p-2">
                                        <img src="https://placehold.co/300x400/09065E/FFFFFF?text={{ rec_book.title|slice:':15'|urlencode|default:'No%20Cover' }}&font=sans" alt="{{ rec_book.title }} - No Cover Available" class="w-full h-full object-contain">
                                    </div>
                                {% endif %}
                            </div>
                            <div class="mt-4 px-1">
                                <h4 class="text-md font-semibold text-[#09065E] truncate group-hover:text-red-600 transition-colors duration-150" title="{{ rec_book.title }}">{{ rec_book.title }}</h4>
                                {% if rec_book.author %}
                                    <p class="text-sm text-[#09065E]/70 truncate mt-0.5" title="{{ rec_book.author }}">{{ rec_book.author }}</p>
                                {% elif rec_book.creator.creator_name %}
                                     <p class="text-sm text-[#09065E]/70 truncate mt-0.5" title="{{ rec_book.creator.creator_name }}">{{ rec_book.creator.creator_name }}</p>
                                {% endif %}
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                {% else %}
                     <div class="text-center text-[#09065E]/70 py-12">
                        <svg class="mx-auto h-12 w-12 text-[#09065E]/30 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                        </svg>
                        <p class="text-lg font-medium">No recommendations available at this time.</p>
                        <p class="text-sm text-[#09065E]/60 mt-1">Explore other audiobooks, and we'll find some suggestions for you.</p>
                    </div>
                {% endif %}
            </div>

            <div id="content-summaries" class="tab-content hidden">
                <div id="ai-summary-container">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h3 class="text-2xl md:text-3xl font-semibold text-[#09065E] mb-3 sm:mb-0 tracking-tight">AI Generated Summary</h3>
                        <button id="regenerate-ai-summary-btn" class="text-sm py-2.5 px-5 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-600/70 focus:ring-offset-2 font-semibold self-start sm:self-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2 align-text-bottom" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                            Regenerate Summary
                        </button>
                    </div>
                    <div id="ai-summary-placeholder" class="text-[#09065E]/80 text-sm p-6 bg-white rounded-xl border-2 border-[#09065E]/10 shadow-lg shadow-[#09065E]/[0.07]">
                        <p class="italic">Click "Regenerate Summary" to load an AI-generated summary of this audiobook. This process may take a few moments and works best for audiobooks with available transcripts.</p>
                    </div>
                    <div id="ai-summary-loading" class="hidden text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-600"></div>
                        <p class="text-lg text-[#09065E]/70 mt-4 font-medium">Generating summary, please hold on...</p>
                    </div>
                    <div id="ai-summary-content" class="prose prose-lg max-w-none text-[#09065E]/80 hidden leading-relaxed bg-white p-6 rounded-xl border-2 border-[#09065E]/10 shadow-lg shadow-[#09065E]/[0.07] selection:bg-red-200 selection:text-red-800 prose-headings:font-semibold prose-headings:text-[#09065E] prose-p:text-[#09065E]/80 prose-strong:text-[#09065E] prose-a:text-red-600 hover:prose-a:text-red-700 hover:prose-a:underline"></div>
                    <div id="ai-summary-error" class="text-red-700 hidden text-sm p-5 bg-red-100 rounded-xl border-2 border-red-300/70"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="bottom-player-bar"
         class="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-[#09065E]/10 shadow-[0_-8px_20px_rgba(9,6,101,0.08)] p-3 sm:p-4 z-[60] transform translate-y-full transition-transform duration-300 ease-in-out">
        <audio id="audioPlayer" class="hidden" preload="metadata" autoplay="false" data-audiobook-id="{{ audiobook.audiobook_id|default:'' }}"></audio>
        <div class="max-w-screen-lg mx-auto flex items-center gap-3 sm:gap-5">
            <div class="flex items-center space-x-3 flex-shrink-0 w-1/3 sm:w-auto sm:max-w-[200px] md:max-w-[280px] min-w-0">
                <img id="player-cover-image" src="https://placehold.co/80x80/09065E/FFFFFF?text=N/A&font=sans" alt="Now Playing"
                     class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 rounded-md object-cover shadow-sm border border-[#09065E]/10">
                <div class="overflow-hidden">
                    <p id="player-episode-title" class="text-sm font-semibold text-[#09065E] truncate"
                       title="Select an episode">Select an episode</p>
                    <p id="player-episode-number" class="text-xs text-[#09065E]/70 truncate mt-0.5">Episode N/A</p>
                </div>
            </div>
            <div class="flex-grow flex flex-col items-center space-y-1.5 min-w-0">
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button id="player-prev-button" onclick="playPreviousChapter()" title="Previous Episode"
                            class="p-2 text-[#09065E]/70 hover:text-red-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150 rounded-full hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500/70">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" viewBox="0 0 20 20"
                             fill="currentColor">
                            <path d="M8.447 13.947A1 1 0 017 13.242V6.758a1 1 0 011.447-.895l5 3.242a1 1 0 010 1.789l-5 3.242z" />
                            <path d="M3 5a1 1 0 011-1h1a1 1 0 110 2H4a1 1 0 01-1-1z" />
                        </svg>
                    </button>
                    <button id="player-play-pause-button" onclick="togglePlayPause()" title="Play/Pause"
                            class="p-3 bg-white text-black rounded-full shadow-lg hover:bg-gray-100 border-2 border-gray-300 hover:border-gray-400 transition-all duration-150 transform active:scale-90 focus:outline-none focus:ring-2 focus:ring-[#09065E]/50 focus:ring-offset-1">
                        <svg id="player-play-icon" xmlns="http://www.w3.org/2000/svg"
                             class="h-7 w-7 sm:h-8 sm:w-8" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                  d="M7.596 4.237a1.5 1.5 0 012.808 0l5.665 9.914A1.5 1.5 0 0114.565 17H5.435a1.5 1.5 0 01-1.504-2.849l5.665-9.914z"
                                  clip-rule="evenodd" transform="rotate(90 10 10)" />
                        </svg>
                        <svg id="player-pause-icon" xmlns="http://www.w3.org/2000/svg"
                             class="h-7 w-7 sm:h-8 sm:w-8 hidden" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M5.75 4.75a.75.75 0 00-1.5 0v10.5a.75.75 0 001.5 0V4.75zM15.75 4.75a.75.75 0 00-1.5 0v10.5a.75.75 0 001.5 0V4.75z" />
                        </svg>
                    </button>
                    <button id="player-next-button" onclick="playNextChapter()" title="Next Episode"
                            class="p-2 text-[#09065E]/70 hover:text-red-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150 rounded-full hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500/70">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" viewBox="0 0 20 20"
                             fill="currentColor">
                            <path d="M11.553 6.053A1 1 0 0113 6.758v6.484a1 1 0 01-1.447.895l-5-3.242a1 1 0 010-1.789l5-3.242zM17 5a1 1 0 00-1-1h-1a1 1 0 100 2h1a1 1 0 001-1z" />
                        </svg>
                    </button>
                </div>
                <div class="w-full flex items-center space-x-2 sm:space-x-3 px-1 max-w-md">
                    <span id="player-current-time" class="text-xs text-[#09065E]/70 font-mono w-12 text-right tabular-nums">0:00</span>
                    <input type="range" id="player-seek-bar" value="0" max="100" step="0.1"
                           class="w-full h-2 bg-[#09065E]/20 rounded-full appearance-none cursor-pointer accent-red-600 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-red-500/70">
                    <span id="player-duration" class="text-xs text-[#09065E]/70 font-mono w-12 text-left tabular-nums">0:00</span>
                </div>
            </div>
            <div class="flex items-center space-x-2 sm:space-x-3 flex-shrink-0">
                <button id="player-speed-button" onclick="cyclePlaybackSpeed()" title="Playback Speed"
                        class="p-1.5 text-[#09065E] hover:text-red-600 hover:bg-red-100 rounded-full transition-colors duration-150 text-xs font-semibold w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center border-2 border-[#09065E]/20 hover:border-red-400/70 focus:outline-none focus:ring-2 focus:ring-red-500/70 tabular-nums">
                    1x
                </button>
                <button onclick="closePlayer()" title="Close Player"
                        class="p-2 text-[#09065E]/60 hover:text-red-700 hover:bg-red-100 rounded-full transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-red-500/70">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                              clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

<div id="audiox-popup-overlay" class="fixed inset-0 bg-[#09065E]/80 backdrop-blur-sm flex items-center justify-center p-4 z-[100] hidden opacity-0 transition-opacity duration-300 ease-out">
    <div id="audiox-popup-content" class="bg-white rounded-lg shadow-2xl w-full max-w-md transform opacity-0 scale-95 transition-all duration-300 ease-out">
        <div id="audiox-popup-header" class="p-5 border-b-2 flex justify-between items-center">
            <h3 id="audiox-popup-title" class="text-xl font-bold text-[#09065E]">Popup Title</h3>
            <button id="audiox-popup-close-btn-icon" class="text-[#09065E]/60 hover:text-red-600 transition-colors duration-150 p-1 rounded-full hover:bg-red-100 -mr-2 -mt-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div id="audiox-popup-body" class="p-6 text-[#09065E]/90 text-base leading-relaxed">
            <p>Popup message goes here.</p>
        </div>
        <div id="audiox-popup-footer" class="p-4 bg-white flex justify-end space-x-3 rounded-b-lg border-t-2">
            <button id="audiox-popup-cancel-btn" class="px-6 py-2.5 rounded-md text-sm font-semibold border-2 border-[#09065E] text-[#09065E] bg-white hover:bg-[#09065E]/5 transition-colors duration-150">Cancel</button>
            <button id="audiox-popup-confirm-btn" class="px-6 py-2.5 rounded-md text-sm font-semibold text-white bg-red-600 hover:bg-red-700 transition-colors duration-150">Confirm</button>
        </div>
    </div>
</div>

</div>

<script id="page-context-data-detail" type="application/json">
    {{ page_context_data_dict|safe }}
</script>
<script id="listening-history-data" type="application/json">
    {{ listening_history_json|safe }}
</script>

<script src="{% static 'js/audiobook_detail.js' %}"></script>

{% endblock %}